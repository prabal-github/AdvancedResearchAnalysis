{% extends "layout.html" %}
{% block title %}Investor Registration - Research QA{% endblock %}

{% block head %}
<style>
    .register-container {
        max-width: 1040px;
        margin: 2rem auto;
        padding: 1.25rem;
    }

    .register-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        overflow: hidden;
    }

    .register-header {
        background: linear-gradient(135deg, #5b7cfa 0%, #7a55d8 100%);
        color: white;
        padding: 1.75rem 2rem;
        text-align: center;
    }

    .register-header h2 { margin: 0; font-weight: 700; letter-spacing: 0.2px; }
    .register-header p { margin: 0.5rem 0 0 0; opacity: 0.95; }

    .register-body { padding: 1.5rem; }

    /* Two-column responsive layout */
    .register-grid { display: grid; grid-template-columns: 1fr; grid-gap: 1.5rem; }
    @media (min-width: 992px) {
        .register-body { padding: 2rem; }
        .register-grid { grid-template-columns: 1.25fr 0.85fr; grid-gap: 2rem; }
    }

    .form-group { margin-bottom: 1.1rem; }
    .form-label { font-weight: 600; color: #2c3e50; margin-bottom: 0.35rem; display: block; }
    .form-text-muted { font-size: 0.85rem; color: #6c757d; }

    .form-control { border-radius: 10px; border: 2px solid #e9ecef; padding: 12px 14px; font-size: 1rem; transition: all 0.2s ease; }
    .form-control:focus { border-color: #5b7cfa; box-shadow: 0 0 0 0.18rem rgba(91,124,250,0.2); }

    .btn-register {
        background: linear-gradient(135deg, #5b7cfa 0%, #7a55d8 100%);
        border: none; border-radius: 10px; padding: 12px 24px; font-size: 1.05rem; font-weight: 700; color: white; width: 100%; transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .btn-register:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(91,124,250,0.35); color: white; }

    .btn-secondary { background: #6c757d; border-color: #6c757d; color: white; transition: all 0.2s ease; }
    .btn-secondary:hover { background: #5a6268; border-color: #545b62; transform: translateY(-1px); }

    .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; }
    .input-group .btn { border-top-left-radius: 0; border-bottom-left-radius: 0; }

    .pan-info { background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 10px; padding: 0.85rem; margin-bottom: 0.75rem; }
    .pan-info h6 { color: #0b6bd3; margin-bottom: 0.4rem; }
    .pan-info ul { margin: 0; padding-left: 1.2rem; }
    .pan-info li { color: #0b6bd3; font-size: 0.9rem; }

    .security-note { background: #f8f9fa; border-left: 4px solid #28a745; padding: 1rem; border-radius: 8px; }
    .security-note h6 { color: #28a745; margin-bottom: 0.4rem; }
    .security-note p { margin: 0; color: #6c757d; font-size: 0.92rem; }

    .verification-steps { background: #fff8e6; border: 1px solid #ffe7a9; border-radius: 10px; padding: 1rem; }
    .verification-steps h6 { color: #856404; margin-bottom: 0.5rem; }
    .step { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .step-number { background: #ffc107; color: #212529; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; margin-right: 0.5rem; }
    .step-text { color: #856404; font-size: 0.9rem; margin: 0; }

    .login-link { text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef; }
    .login-link a { color: #5b7cfa; text-decoration: none; font-weight: 600; }
    .login-link a:hover { text-decoration: underline; }

    .aside { position: relative; }
    @media (min-width: 992px) { .aside { position: sticky; top: 1.25rem; height: fit-content; } }

    .flash-messages { margin-bottom: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="register-container">
    <div class="register-card">
        <div class="register-header">
            <h2><i class="bi bi-person-plus me-2"></i>Investor Registration</h2>
            <p>Join our research platform and get access to professional investment insights</p>
        </div>
        
        <div class="register-body">
            <!-- Flash messages -->
            <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'warning' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <div class="register-grid">
                <!-- Left: Registration Form -->
                <div>
                    <form method="POST" id="registrationForm" novalidate>
                        <div class="form-group">
                            <label class="form-label" for="name">
                                <i class="bi bi-person me-2"></i>Full Name
                            </label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter your full name as per PAN" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="email">
                                <i class="bi bi-envelope me-2"></i>Email Address
                            </label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email address" required>
                            <div id="email-validation-message" class="email-validation-message"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="mobile">
                                <i class="bi bi-phone me-2"></i>Mobile Number
                            </label>
                            <input type="tel" class="form-control" id="mobile" name="mobile" placeholder="Enter your mobile number (10 digits)" pattern="[0-9]{10}" maxlength="10" required>
                            <div class="form-text-muted">We may use this to contact you about your registration.</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="pan_number">
                                <i class="bi bi-credit-card me-2"></i>PAN Number
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="pan_number" name="pan_number" placeholder="ABCDE1234F" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" maxlength="10" style="text-transform: uppercase" aria-describedby="panHelp" required>
                                <button class="btn btn-secondary" type="button" id="verifyPanButton">
                                    <i class="bi bi-patch-check me-1"></i>Verify PAN
                                </button>
                            </div>
                            <small id="panHelp" class="form-text-muted">Format: 5 letters + 4 digits + 1 letter. PAN is auto-verified.</small>
                            <div id="panVerificationResult" class="mt-2" style="display: none;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="password"><i class="bi bi-lock me-2"></i>Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" placeholder="Create a secure password (min 6 characters)" minlength="6" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword"><i class="bi bi-eye"></i></button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="confirm_password"><i class="bi bi-lock-fill me-2"></i>Confirm Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Confirm your password" minlength="6" required>
                        </div>

                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-register" id="registerButton">
                                <i class="bi bi-person-check me-2"></i>Complete Registration
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">PAN verification will run automatically on submit if not already verified.</small>
                        </div>
                    </form>

                    <div class="login-link">
                        <p>Already have an account? <a href="{{ url_for('investor_login') }}">Login here</a></p>
                    </div>
                </div>

                <!-- Right: Helpful Info -->
                

                    <div class="pan-info mb-3">
                        <h6><i class="bi bi-shield-check me-1"></i>PAN Guidelines</h6>
                        <ul>
                            <li>Use uppercase letters (Aâ€“Z)</li>
                            <li>Example: ABCDE1234F</li>
                            <li>If verification fails, admin will review manually</li>
                        </ul>
                    </div>

                    <div class="security-note">
                        <h6><i class="bi bi-shield-lock me-2"></i>Data Security</h6>
                        <p>Your information is encrypted and securely stored. PAN verification uses official APIs. Admin approval ensures authenticity.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const panInput = document.getElementById('pan_number');
    const mobileInput = document.getElementById('mobile');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const verifyPanButton = document.getElementById('verifyPanButton');
    const panVerificationResult = document.getElementById('panVerificationResult');
    const registerButton = document.getElementById('registerButton');
    const togglePassword = document.getElementById('togglePassword');
    
    let panVerified = false;
    
    // Auto-uppercase PAN input
    panInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
        // Reset verification status when PAN is changed
        panVerified = false;
        panVerificationResult.style.display = 'none';
    });
    
    // Mobile number validation
    mobileInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
        }
    });
    
    // Password match validation
    function validatePasswords() {
        if (passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.setCustomValidity('Passwords do not match');
        } else {
            confirmPasswordInput.setCustomValidity('');
        }
    }
    
    passwordInput.addEventListener('input', validatePasswords);
    confirmPasswordInput.addEventListener('input', validatePasswords);
    
    // Toggle password visibility
    if (togglePassword) {
        togglePassword.addEventListener('click', function () {
            const isText = passwordInput.getAttribute('type') === 'text';
            passwordInput.setAttribute('type', isText ? 'password' : 'text');
            this.innerHTML = isText ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
        });
    }
    
    // PAN Verification
    verifyPanButton.addEventListener('click', function() {
        const panNumber = panInput.value.trim();
        if (!panNumber) {
            alert('Please enter PAN number first');
            return;
        }
        
        // Validate PAN format
        const panPattern = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
        if (!panPattern.test(panNumber)) {
            panVerificationResult.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Invalid PAN format. Please check and try again.</div>';
            panVerificationResult.style.display = 'block';
            return;
        }
        
        // Show loading state
        verifyPanButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';
        verifyPanButton.disabled = true;
        panVerificationResult.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split me-2"></i>Verifying your PAN, please wait...</div>';
        panVerificationResult.style.display = 'block';
        
        // Call the PAN verification API
    fetch('/verify_pan_api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pan_number: panNumber })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                panVerified = true;
                panVerificationResult.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>PAN verified successfully!</div>';
            } else {
                panVerified = false;
                let message = data.error || data.message || 'PAN verification failed.';
                let note = data.note || 'Admin will review your application manually.';
                panVerificationResult.innerHTML = `<div class="alert alert-warning"><i class="bi bi-exclamation-circle me-2"></i>${message}. ${note}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            panVerified = false;
            panVerificationResult.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error during verification. Please try again.</div>';
        })
        .finally(() => {
            verifyPanButton.innerHTML = '<i class="bi bi-patch-check me-1"></i>Verify PAN';
            verifyPanButton.disabled = false;
        });
    });
    
    // Form submission with loading state
    form.addEventListener('submit', function(e) {
        if (passwordInput.value !== confirmPasswordInput.value) {
            e.preventDefault();
            alert('Passwords do not match!');
            return;
        }
        
        registerButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing Registration...';
        registerButton.disabled = true;
        
        // Re-enable button after 5 seconds to prevent permanent disable
        setTimeout(() => {
            registerButton.innerHTML = '<i class="bi bi-person-check me-2"></i>Complete Registration';
            registerButton.disabled = false;
        }, 5000);
    });
});
</script>

<!-- Email Role Validation Script -->
<script src="{{ url_for('static', filename='js/email-role-validation.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const emailInput = document.getElementById('email');
    const validationContainer = document.getElementById('email-validation-message');
    
    if (emailInput && validationContainer) {
        initializeEmailValidation(emailInput, validationContainer, 'investor');
    }
});
</script>
{% endblock %}
