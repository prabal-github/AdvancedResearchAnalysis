{% extends "layout.html" %}

{% block title %}Options Analyzer - Advanced Trading Analytics{% endblock %}

{% block content %}
{% include 'partials/_brand_header.html' %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Options Analyzer</h1>
                    <p class="text-muted">Advanced options chain analysis and strategy insights</p>
                </div>
                <div>
                    <button id="refreshBtn" class="btn btn-outline-primary me-2">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button id="saveSnapshotBtn" class="btn btn-success me-2">
                        <i class="bi bi-camera"></i> Save Snapshot
                    </button>
                    <button id="settingsBtn" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                </div>
            </div>

            <!-- Alert Bar -->
            <div id="alertBar" class="alert alert-info d-none" role="alert">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="alertMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="assetSymbol" class="form-label">Asset Symbol</label>
                            <select class="form-select" id="assetSymbol">
                                <option value="">Loading symbols...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="expiryDate" class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="expiryDate" value="2025-08-14">
                        </div>
                        <div class="col-md-3">
                            <label for="strategyType" class="form-label">Strategy Type</label>
                            <select class="form-select" id="strategyType">
                                <option value="PC_CHAIN">Put-Call Chain</option>
                                <option value="CALL_SPREAD">Call Spread</option>
                                <option value="PUT_SPREAD">Put Spread</option>
                                <option value="IRON_CONDOR">Iron Condor</option>
                                <option value="STRADDLE">Straddle</option>
                                <option value="STRANGLE">Strangle</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="fetchDataBtn" class="btn btn-primary w-100">
                                <i class="bi bi-download"></i> Fetch Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-panel" type="button" role="tab">
                        <i class="bi bi-graph-up"></i> Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="enhanced-tab" data-bs-toggle="tab" data-bs-target="#enhanced-panel" type="button" role="tab">
                        <i class="bi bi-cpu"></i> Enhanced Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="snapshots-tab" data-bs-toggle="tab" data-bs-target="#snapshots-panel" type="button" role="tab">
                        <i class="bi bi-camera"></i> Snapshots
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights-panel" type="button" role="tab">
                        <i class="bi bi-lightbulb"></i> Insights
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts-panel" type="button" role="tab">
                        <i class="bi bi-bell"></i> Alerts
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                <!-- Analysis Panel -->
                <div class="tab-pane fade show active" id="analysis-panel" role="tabpanel">
                    <div class="row">
                        <!-- Options Chain Table -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Options Chain</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" id="exportTableBtn">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" id="columnInfoBtn" data-bs-toggle="modal" data-bs-target="#columnInfoModal">
                                            <i class="bi bi-info-circle"></i> Column Info
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="optionsTable" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Strike</th>
                                                    <th>Call Bid</th>
                                                    <th>Call Ask</th>
                                                    <th>Call Volume</th>
                                                    <th>Call IV</th>
                                                    <th>Put Bid</th>
                                                    <th>Put Ask</th>
                                                    <th>Put Volume</th>
                                                    <th>Put IV</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="10" class="text-center text-muted">
                                                        <i class="bi bi-info-circle me-2"></i>Click "Fetch Data" to load options chain
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts and Metrics -->
                        <div class="col-lg-4">
                            <!-- Volatility Chart -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Implied Volatility Smile</h6>
                                </div>
                                <div class="card-body">
                                    <div id="volatilityChart" style="height: 200px;"></div>
                                </div>
                            </div>

                            <!-- Key Metrics -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Key Metrics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="text-center">
                                                <div class="h5 mb-0" id="totalVolume">-</div>
                                                <small class="text-muted">Total Volume</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center">
                                                <div class="h5 mb-0" id="putCallRatio">-</div>
                                                <small class="text-muted">P/C Ratio</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center">
                                                <div class="h5 mb-0" id="maxPain">-</div>
                                                <small class="text-muted">Max Pain</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center">
                                                <div class="h5 mb-0" id="avgIV">-</div>
                                                <small class="text-muted">Avg IV</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Expected Move -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Expected Move</h6>
                                </div>
                                <div class="card-body">
                                    <div class="text-center">
                                        <div class="h4 mb-1" id="expectedMove">±-</div>
                                        <div class="text-muted small" id="expectedMoveRange">-</div>
                                        <button class="btn btn-sm btn-outline-primary mt-2" id="backtestBtn">
                                            <i class="bi bi-graph-up"></i> Backtest
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Predictive Pricing -->
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Predictive Pricing (User Spot & Expected Move)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-6">
                                            <label class="form-label">Current Spot</label>
                                            <input type="number" step="0.01" class="form-control" id="userSpotInput" placeholder="e.g., 24000">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Expected Move (₹)</label>
                                            <input type="number" step="0.01" class="form-control" id="userMoveInput" placeholder="e.g., 250">
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-primary w-100 mt-2" id="predictPricesBtn"><i class="bi bi-magic"></i> Predict Bid/Ask</button>
                                        </div>
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-sm" id="predictivePricesTable">
                                            <thead>
                                                <tr>
                                                    <th>Strike</th>
                                                    <th>Call Bid</th>
                                                    <th>Call Ask</th>
                                                    <th>Put Bid</th>
                                                    <th>Put Ask</th>
                                                    <th class="text-muted small">Range Mid (Call/Put)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr><td colspan="6" class="text-center text-muted">Enter values and click Predict.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy Analysis -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Strategy Profit/Loss Chart</h5>
                                </div>
                                <div class="card-body">
                                    <div id="strategyChart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Analytics Panel -->
                <div class="tab-pane fade" id="enhanced-panel" role="tabpanel">
                    <!-- Enhanced Live Controls -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="small text-muted">Enhanced Analytics Live</div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch mb-0 me-2">
                                <input class="form-check-input" type="checkbox" id="enhLiveSwitch" checked>
                                <label class="form-check-label small" for="enhLiveSwitch">Live Mode</label>
                            </div>
                            <select id="enhLiveInterval" class="form-select form-select-sm" style="width:auto">
                                <option value="10">10s</option>
                                <option value="15" selected>15s</option>
                                <option value="30">30s</option>
                                <option value="60">60s</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" id="enhRefreshBtn">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Gamma Exposure Analysis -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Gamma Exposure Profile</h5>
                                    <button class="btn btn-sm btn-outline-primary" id="refreshGammaBtn">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="gammaExposureChart" style="height: 300px;"></div>
                                    <div class="row mt-3">
                                        <div class="col-4 text-center">
                                            <div class="h6 mb-0" id="totalGammaExposure">₹125.5M</div>
                                            <small class="text-muted">Total Gamma Exposure</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="h6 mb-0" id="gammaFlipPoint">22000</div>
                                            <small class="text-muted">Gamma Flip Point</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="h6 mb-0" id="gammaRisk">Medium</div>
                                            <small class="text-muted">Gamma Risk Level</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Volatility Surface -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Volatility Surface Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <div id="volatilitySurfaceChart" style="height: 300px;"></div>
                                    <div class="row mt-3">
                                        <div class="col-4 text-center">
                                            <div class="h6 mb-0" id="volSkew">-2.5%</div>
                                            <small class="text-muted">Vol Skew</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="h6 mb-0" id="termStructure">Contango</div>
                                            <small class="text-muted">Term Structure</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="h6 mb-0" id="volCluster">High</div>
                                            <small class="text-muted">Vol Clustering</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Real-Time Scanner -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card mb-4">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <div>
                                        <h5 class="mb-0">Real-Time Scanner</h5>
                                        <small class="text-muted">Live unusual options activity and movers</small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted me-2">Last updated: <span id="rtLastUpdated">-</span></small>
                                        <div class="form-check form-switch me-2">
                                            <input class="form-check-input" type="checkbox" id="rtAutoRefreshSwitch" checked>
                                            <label class="form-check-label small" for="rtAutoRefreshSwitch">Auto Refresh</label>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" id="rtRefreshBtn">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="realtimeScannerChart" style="height: 280px;"></div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <h6 class="mb-2">Unusual Activity</h6>
                                            <div id="rtUnusualList" class="small text-muted">-</div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="mb-2">Top Movers</h6>
                                            <div id="rtMoversList" class="small text-muted">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Flow Analysis -->
                        <div class="col-xl-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Options Flow Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-8">
                                            <div id="flowPatternChart" style="height: 250px;"></div>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 mb-3">Flow Metrics</div>
                                            <div class="mb-2">
                                                <small class="text-muted">Call/Put Ratio</small>
                                                <div class="progress mb-1" style="height: 8px;">
                                                    <div class="progress-bar" id="callPutProgress" style="width: 65%"></div>
                                                </div>
                                                <small id="callPutRatioValue">1.3</small>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">Unusual Activity</small>
                                                <div class="progress mb-1" style="height: 8px;">
                                                    <div class="progress-bar bg-warning" id="unusualActivityProgress" style="width: 45%"></div>
                                                </div>
                                                <small id="unusualActivityValue">45.2%</small>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">Institutional Flow</small>
                                                <div class="progress mb-1" style="height: 8px;">
                                                    <div class="progress-bar bg-success" id="institutionalProgress" style="width: 72%"></div>
                                                </div>
                                                <small id="institutionalValue">72.5%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Structure -->
                        <div class="col-xl-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Market Structure</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-2">Support Levels</h6>
                                        <div id="supportLevels">
                                            <div class="badge bg-success me-1">₹21850</div>
                                            <div class="badge bg-success me-1">₹21750</div>
                                            <div class="badge bg-success me-1">₹21650</div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-2">Resistance Levels</h6>
                                        <div id="resistanceLevels">
                                            <div class="badge bg-danger me-1">₹22150</div>
                                            <div class="badge bg-danger me-1">₹22250</div>
                                            <div class="badge bg-danger me-1">₹22350</div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-2">Risk Metrics</h6>
                                        <div class="small">
                                            <div class="d-flex justify-content-between">
                                                <span>VaR (95%):</span>
                                                <span id="var95">₹1,250</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Expected Shortfall:</span>
                                                <span id="expectedShortfall">₹1,890</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Tail Risk:</span>
                                                <span id="tailRisk">3.2%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Analytics Summary -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">AI-Powered Market Insights</h5>
                                </div>
                                <div class="card-body">
                                    <div id="enhancedInsights">
                                        <div class="alert alert-info mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-lightbulb me-2"></i>
                                                <div>
                                                    <strong>Gamma Analysis:</strong> Significant gamma exposure concentrated around 22000 strike suggests potential support level with increased volatility expected near this price.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-warning mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                <div>
                                                    <strong>Flow Pattern:</strong> Unusual put buying activity detected in 21900-22000 range indicating potential hedging or bearish positioning.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-success mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-check-circle me-2"></i>
                                                <div>
                                                    <strong>Volatility Structure:</strong> Volatility skew favoring put options suggests market participants pricing in downside risk premium.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button class="btn btn-primary" id="generateInsightsBtn">
                                                <i class="bi bi-lightning"></i> Refresh Insights
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Snapshots Panel -->
                <div class="tab-pane fade" id="snapshots-panel" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Saved Snapshots</h5>
                            <button class="btn btn-sm btn-outline-danger" id="clearSnapshotsBtn">
                                <i class="bi bi-trash"></i> Clear All
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="snapshotsList">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-camera-fill fs-1 mb-3"></i>
                                    <p>No snapshots saved yet. Create your first snapshot from the Analysis tab.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="tab-pane fade" id="insights-panel" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">AI Insights</h5>
                                </div>
                                <div class="card-body">
                                    <div id="aiInsights">
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-robot fs-1 mb-3"></i>
                                            <p>AI insights will appear here after data analysis.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Recommendations</h5>
                                    <button id="generateCallRecsBtn" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-lightning-charge"></i> Generate Call Recommendations
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="recommendations">
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-lightbulb fs-1 mb-3"></i>
                                            <p>Strategy recommendations will appear here.</p>
                                        </div>
                                    </div>
                                    <hr/>
                                    <h6 class="mb-2">Predictive Calls</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm" id="predictiveCallTable">
                                            <thead>
                                                <tr>
                                                    <th>Strike</th>
                                                    <th>Confidence</th>
                                                    <th>IV</th>
                                                    <th>LTP</th>
                                                    <th>Last Test</th>
                                                    <th class="text-end">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="predictiveCallRecs">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">
                                                        <i class="bi bi-cpu"></i> Generate to see predictive call picks.
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Panel -->
                <div class="tab-pane fade" id="alerts-panel" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Price Alerts</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createAlertModal">
                                <i class="bi bi-plus-circle"></i> Create Alert
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="alertsList">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-bell fs-1 mb-3"></i>
                                    <p>No alerts configured. Create your first alert to get notified of price movements.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Options Analyzer Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label for="refreshInterval" class="form-label">Auto Refresh Interval (seconds)</label>
                        <input type="number" class="form-control" id="refreshInterval" value="30" min="10">
                    </div>
                    <div class="mb-3">
                        <label for="maxRows" class="form-label">Max Table Rows</label>
                        <input type="number" class="form-control" id="maxRows" value="50" min="10" max="200">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enableNotifications" checked>
                        <label class="form-check-label" for="enableNotifications">
                            Enable Browser Notifications
                        </label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enableAutoRefresh">
                        <label class="form-check-label" for="enableAutoRefresh">
                            Enable Auto Refresh
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Alert Modal -->
<div class="modal fade" id="createAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alertForm">
                    <div class="mb-3">
                        <label for="alertSymbol" class="form-label">Symbol</label>
                        <input type="text" class="form-control" id="alertSymbol" required>
                    </div>
                    <div class="mb-3">
                        <label for="alertType" class="form-label">Alert Type</label>
                        <select class="form-select" id="alertType" required>
                            <option value="price_above">Price Above</option>
                            <option value="price_below">Price Below</option>
                            <option value="iv_above">IV Above</option>
                            <option value="iv_below">IV Below</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="alertValue" class="form-label">Alert Value</label>
                        <input type="number" class="form-control" id="alertValue" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="alertMessage" class="form-label">Custom Message (optional)</label>
                        <textarea class="form-control" id="alertMessage" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createAlertBtn">Create Alert</button>
            </div>
        </div>
    </div>
</div>

<!-- Column Info Modal -->
<div class="modal fade" id="columnInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Column Explanations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="columnExplanations">
                    Loading explanations...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Options Analyzer JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the options analyzer
    const optionsAnalyzer = {
        currentData: null,
        settings: {
            refreshInterval: 30,
            maxRows: 50,
            enableNotifications: true,
            enableAutoRefresh: false
        },
        
        // Initialize the application
        init() {
            this.loadSettings();
            this.bindEvents();
            this.setupCharts();
            this.loadAssetSymbols();
            this.setDefaultExpiry();
        },
        
        // Load available asset symbols
        async loadAssetSymbols() {
            try {
                const response = await fetch('/api/options/asset_symbols');
                const data = await response.json();
                
                const select = document.getElementById('assetSymbol');
                select.innerHTML = '';
                
                if (data.symbols) {
                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol.value;
                        option.textContent = `${symbol.label} (${symbol.type})`;
                        select.appendChild(option);
                    });
                    
                    // Set default to Nifty 50
                    select.value = 'NSE_INDEX|Nifty 50';
                } else {
                    select.innerHTML = '<option value="">Error loading symbols</option>';
                }
            } catch (error) {
                console.error('Error loading asset symbols:', error);
                const select = document.getElementById('assetSymbol');
                select.innerHTML = '<option value="">Error loading symbols</option>';
            }
        },
        
        // Set default expiry to next Thursday (Indian options expiry)
        setDefaultExpiry() {
            const today = new Date();
            const nextThursday = new Date(today);
            
            // Find next Thursday (Indian options typically expire on Thursdays)
            const daysUntilThursday = (4 - today.getDay() + 7) % 7;
            nextThursday.setDate(today.getDate() + (daysUntilThursday === 0 ? 7 : daysUntilThursday));
            
            // Format as YYYY-MM-DD for input[type="date"]
            const formattedDate = nextThursday.toISOString().split('T')[0];
            document.getElementById('expiryDate').value = formattedDate;
        },
        
        // Bind event listeners
        bindEvents() {
            document.getElementById('fetchDataBtn').addEventListener('click', () => this.fetchOptionsData());
            document.getElementById('refreshBtn').addEventListener('click', () => this.fetchOptionsData());
            document.getElementById('saveSnapshotBtn').addEventListener('click', () => this.saveSnapshot());
            document.getElementById('saveSettingsBtn').addEventListener('click', () => this.saveSettings());
            document.getElementById('createAlertBtn').addEventListener('click', () => this.createAlert());
            document.getElementById('columnInfoBtn').addEventListener('click', () => this.loadColumnExplanations());
            document.getElementById('backtestBtn').addEventListener('click', () => this.runBacktest());
            const genBtn = document.getElementById('generateCallRecsBtn');
            if (genBtn) {
                genBtn.addEventListener('click', () => this.generateCallRecommendations());
            }
            const predBtn = document.getElementById('predictPricesBtn');
            if (predBtn) {
                predBtn.addEventListener('click', () => this.predictPrices());
            }
            
            // Enhanced analytics event bindings
            const refreshGammaBtn = document.getElementById('refreshGammaBtn');
            if (refreshGammaBtn) {
                refreshGammaBtn.addEventListener('click', () => this.loadGammaExposure());
            }
            
            const generateInsightsBtn = document.getElementById('generateInsightsBtn');
            if (generateInsightsBtn) {
                generateInsightsBtn.addEventListener('click', () => this.loadEnhancedAnalytics());
            }
            
            // Auto-load enhanced analytics when Enhanced tab is shown
            const enhancedTab = document.getElementById('enhanced-tab');
            if (enhancedTab) {
                enhancedTab.addEventListener('shown.bs.tab', () => {
                    if (this.hasChainData()) this.loadEnhancedAnalytics();
                    this.startRealtimeAutoRefresh();
                    this.startEnhancedLive();
                });
                enhancedTab.addEventListener('hidden.bs.tab', () => {
                    this.stopRealtimeAutoRefresh();
                    this.stopEnhancedLive();
                });
            }

            // Real-time scanner controls
            const rtBtn = document.getElementById('rtRefreshBtn');
            if (rtBtn) rtBtn.addEventListener('click', () => this.loadRealtimeScanner());
            const rtSwitch = document.getElementById('rtAutoRefreshSwitch');
            if (rtSwitch) rtSwitch.addEventListener('change', () => this.toggleRealtimeAuto());

            // Enhanced live controls
            const enhBtn = document.getElementById('enhRefreshBtn');
            if (enhBtn) enhBtn.addEventListener('click', () => this.refreshEnhancedLiveOnce());
            const enhSwitch = document.getElementById('enhLiveSwitch');
            if (enhSwitch) enhSwitch.addEventListener('change', () => this.toggleEnhancedLive());
            const enhInterval = document.getElementById('enhLiveInterval');
            if (enhInterval) enhInterval.addEventListener('change', () => this.restartEnhancedLive());
        },
        
        // Setup chart containers
        setupCharts() {
            // Initialize empty Plotly charts
            Plotly.newPlot('volatilityChart', [], {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            });
            
            Plotly.newPlot('strategyChart', [], {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            });
            
            // Initialize enhanced analytics charts
            this.setupEnhancedCharts();
            // Initialize real-time scanner chart
            if (typeof this.setupRealtimeChart === 'function') {
                this.setupRealtimeChart();
            }
        },
        
        // Setup enhanced analytics charts
        setupEnhancedCharts() {
            // Gamma Exposure Chart with sample data
            const sampleGammaTraces = [
                {
                    x: [21800, 21900, 22000, 22100, 22200],
                    y: [150, 200, 300, 180, 120],
                    type: 'bar',
                    name: 'Call Gamma',
                    marker: { color: 'rgba(52, 168, 83, 0.7)' }
                },
                {
                    x: [21800, 21900, 22000, 22100, 22200],
                    y: [-80, -120, -180, -140, -90],
                    type: 'bar',
                    name: 'Put Gamma',
                    marker: { color: 'rgba(234, 67, 53, 0.7)' }
                }
            ];
            
            Plotly.newPlot('gammaExposureChart', sampleGammaTraces, {
                title: 'Sample Gamma Exposure (Load real data)',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                xaxis: { title: 'Strike Price' },
                yaxis: { title: 'Gamma Exposure' },
                barmode: 'group'
            });
            
            // Volatility Surface Chart with sample data
            const sampleVolTraces = [
                {
                    x: [21800, 21900, 22000, 22100, 22200],
                    y: [18.5, 17.2, 16.0, 16.8, 18.1],
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Call IV',
                    line: { color: 'rgba(52, 168, 83, 0.8)' }
                },
                {
                    x: [21800, 21900, 22000, 22100, 22200],
                    y: [19.1, 17.8, 16.5, 17.2, 18.5],
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Put IV',
                    line: { color: 'rgba(234, 67, 53, 0.8)' }
                }
            ];
            
            Plotly.newPlot('volatilitySurfaceChart', sampleVolTraces, {
                title: 'Sample Volatility Skew (Load real data)',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                xaxis: { title: 'Strike Price' },
                yaxis: { title: 'Implied Volatility %' }
            });
            
            // Flow Pattern Chart with sample data
            const sampleFlowTraces = [
                {
                    x: [21800, 21900, 22000, 22100, 22200],
                    y: [15000, 25000, 35000, 20000, 12000],
                    type: 'bar',
                    name: 'Call Volume',
                    marker: { color: 'rgba(52, 168, 83, 0.7)' }
                },
                {
                    x: [21800, 21900, 22000, 22100, 22200],
                    y: [8000, 18000, 28000, 15000, 22000],
                    type: 'bar',
                    name: 'Put Volume',
                    marker: { color: 'rgba(234, 67, 53, 0.7)' }
                }
            ];
            
            Plotly.newPlot('flowPatternChart', sampleFlowTraces, {
                title: 'Sample Options Flow (Load real data)',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                xaxis: { title: 'Strike Price' },
                yaxis: { title: 'Volume' },
                barmode: 'group'
            });
        },

        // Predictive pricing using user spot and expected move
        async predictPrices() {
            if (!this.currentData || !this.currentData.ok) {
                this.showAlert('Please fetch options data first.', 'warning');
                return;
            }
            const spotEl = document.getElementById('userSpotInput');
            const moveEl = document.getElementById('userMoveInput');
            const spot = parseFloat(spotEl.value || this.currentData.underlying_price || 0);
            const move = parseFloat(moveEl.value || 0);
            const btn = document.getElementById('predictPricesBtn');
            const tableBody = document.querySelector('#predictivePricesTable tbody');
            btn.disabled = true;
            const old = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Predicting...';
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Predicting...</td></tr>';
            try {
                const res = await fetch('/api/options/predict_prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chain: this.currentData, user_spot: spot, expected_move: move })
                });
                const json = await res.json();
                if (!json.ok) throw new Error(json.error || 'Failed');
                const rows = (json.predictions || []).map(p => `
                    <tr>
                        <td class="fw-semibold">₹${p.strike}</td>
                        <td>₹${p.call_bid_pred.toFixed(2)}</td>
                        <td>₹${p.call_ask_pred.toFixed(2)}</td>
                        <td>₹${p.put_bid_pred.toFixed(2)}</td>
                        <td>₹${p.put_ask_pred.toFixed(2)}</td>
                        <td class="small text-muted">C: ₹${p.range_lower.call_mid}→₹${p.range_upper.call_mid} / P: ₹${p.range_lower.put_mid}→₹${p.range_upper.put_mid}</td>
                    </tr>`).join('');
                tableBody.innerHTML = rows || '<tr><td colspan="6" class="text-center text-muted">No predictions.</td></tr>';
            } catch (e) {
                this.showAlert('Predict error: ' + e.message, 'danger');
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Prediction failed.</td></tr>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = old;
            }
        },

        // Generate predictive call recommendations and render them
        async generateCallRecommendations() {
            if (!this.currentData || !this.currentData.ok) {
                this.showAlert('Please fetch options data first.', 'warning');
                return;
            }

            const btn = document.getElementById('generateCallRecsBtn');
            const container = document.getElementById('predictiveCallRecs');
            btn.disabled = true;
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Generating...';
            container.innerHTML = '<div class="text-muted small">Generating recommendations...</div>';

            try {
                const res = await fetch('/api/options/call_recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.currentData)
                });
                const json = await res.json();
                if (!res.ok || !json.success) {
                    throw new Error(json.error || 'Failed to generate recommendations');
                }
                this.renderCallRecommendations(json.recommendations || []);
                this.showAlert(`Saved ${json.count || 0} call recommendations`, 'success');
            } catch (err) {
                this.showAlert('Error: ' + err.message, 'danger');
                container.innerHTML = '<div class="text-danger small">Failed to generate recommendations.</div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            }
        },

        // Render list with test actions per row
        renderCallRecommendations(recs) {
            const tbody = document.getElementById('predictiveCallRecs');
            if (!recs || recs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No recommendations generated.</td></tr>';
                return;
            }

            const formatPct = (v) => v == null ? '-' : `${Number(v).toFixed(1)}%`;
            const formatRs = (v) => v == null ? '-' : `₹${Number(v).toFixed(2)}`;
            const rowHtml = (r) => {
                const last = r.last_test || {};
                const lastText = last.metrics ? `${formatRs(last.metrics.mean)} (P50 ${formatRs(last.metrics.p50)})` : '-';
                return `
                    <tr>
                        <td class="fw-semibold">₹${r.strike}</td>
                        <td>${r.confidence ?? '-' }%</td>
                        <td>${r.call_iv != null ? formatPct(r.call_iv*100) : '-'}</td>
                        <td>${formatRs(r.call_ltp)}</td>
                        <td>${lastText}</td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" onclick="optionsAnalyzer.runCallTest(${r.id}, 'backtest')"><i class='bi bi-graph-up'></i></button>
                                <button class="btn btn-outline-info" onclick="optionsAnalyzer.runCallTest(${r.id}, 'forwardtest')"><i class='bi bi-fast-forward'></i></button>
                                <button class="btn btn-outline-secondary" onclick="optionsAnalyzer.viewCallRec(${r.id})" title="View test history"><i class='bi bi-card-list'></i></button>
                                <button class="btn btn-outline-dark" onclick="optionsAnalyzer.explainCallRec(${r.id})" title="Explain latest"><i class='bi bi-chat-text'></i></button>
                            </div>
                            <div id="call-rec-metrics-${r.id}" class="small mt-1 text-muted"></div>
                        </td>
                    </tr>`;
            };
            tbody.innerHTML = recs.map(rowHtml).join('');
        },

        async viewCallRec(recId) {
            // Fetch test history and show in a simple modal with a mini histogram from samples
            try {
                const res = await fetch(`/api/options/call_recommendations/${recId}/tests`);
                const tests = await res.json();
                const body = (tests && tests.length) ? tests.map(t => {
                    const m = t.metrics || {};
                    const mean = m.mean != null ? `Mean: ₹${m.mean}` : '';
                    const p50 = m.p50 != null ? `P50: ₹${m.p50}` : '';
                    const p05 = m.p05 != null ? `P5: ₹${m.p05}` : '';
                    const p95 = m.p95 != null ? `P95: ₹${m.p95}` : '';
                    const head = `<div class='fw-semibold mb-1'>${t.test_type} • ${t.horizon_days}d • n=${t.n_scenarios}</div>`;
                    const stats = `<div class='small text-muted mb-1'>${[mean,p50,p05,p95].filter(Boolean).join(' | ')}</div>`;
                    // Mini sparkline from samples (fallback to text if no Plotly available)
                    const id = `hist-${recId}-${t.id}`;
                    const histDiv = `<div id='${id}' style='height:120px;'></div>`;
                    setTimeout(() => {
                        if (window.Plotly && t.samples && t.samples.length > 1) {
                            const trace = { x: t.samples, type: 'histogram', marker: { color: '#6c757d' } };
                            Plotly.newPlot(id, [trace], { margin: {t:10,r:10,b:30,l:30}, paper_bgcolor: 'transparent', plot_bgcolor: 'transparent' });
                        } else if (document.getElementById(id)) {
                            document.getElementById(id).innerHTML = '<div class="text-muted small">No sample distribution available.</div>';
                        }
                    }, 0);
                    return `<div class='mb-3'>${head}${stats}${histDiv}</div>`;
                }).join('') : '<div class="text-muted">No tests yet.</div>';

                const modalHtml = `
                    <div class="modal fade" id="callRecModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Recommendation Tests</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${body}</div>
                            </div>
                        </div>
                    </div>`;
                const existing = document.getElementById('callRecModal');
                if (existing) existing.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('callRecModal'));
                modal.show();
            } catch (e) {
                this.showAlert('Failed to load tests: ' + e.message, 'danger');
            }
        },

        async explainCallRec(recId) {
            try {
                const res = await fetch(`/api/options/call_recommendations/${recId}/explain`);
                const json = await res.json();
                if (!json.ok) throw new Error(json.error || 'Explain failed');
                const e = json.explanation || {};
                const modalHtml = `
                    <div class="modal fade" id="callRecExplainModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">AI Summary</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${e.short_summary || ''}</p>
                                    <p class="small text-muted">${e.detailed_analysis || ''}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                const existing = document.getElementById('callRecExplainModal');
                if (existing) existing.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('callRecExplainModal')).show();
            } catch (err) {
                this.showAlert('Explain error: ' + err.message, 'danger');
            }
        },

        // Run synthetic test for a recommendation id and show metrics
        async runCallTest(recId, type) {
            try {
                const horizonDefault = 10;
                const nDefault = type === 'forwardtest' ? 500 : 200;
                const horizon = parseInt(prompt('Horizon days?', horizonDefault) || horizonDefault);
                const n = parseInt(prompt('Number of scenarios?', nDefault) || nDefault);
                const slippage = parseFloat(prompt('Slippage (₹ per contract)?', '0') || '0');
                const fees = parseFloat(prompt('Fees (₹ per contract)?', '0') || '0');

                const metricsEl = document.getElementById(`call-rec-metrics-${recId}`);
                metricsEl.innerHTML = '<span class="text-primary">Running simulation...</span>';

                const res = await fetch(`/api/options/call_recommendations/${recId}/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ horizon_days: horizon, n_scenarios: n, slippage, fees })
                });
                const json = await res.json();
                if (!res.ok) {
                    throw new Error(json.error || 'Simulation failed');
                }
                const m = json.metrics || {};
                metricsEl.innerHTML = `
                    <span class="me-2">Mean: ₹${(m.mean ?? 0).toFixed(2)}</span>
                    <span class="me-2">Median: ₹${(m.p50 ?? 0).toFixed(2)}</span>
                    <span class="me-2">P5: ₹${(m.p05 ?? 0).toFixed(2)}</span>
                    <span class="me-2">P95: ₹${(m.p95 ?? 0).toFixed(2)}</span>
                `;
            } catch (err) {
                this.showAlert('Error: ' + err.message, 'danger');
                const metricsEl = document.getElementById(`call-rec-metrics-${recId}`);
                if (metricsEl) metricsEl.innerHTML = '<span class="text-danger">Failed to run simulation.</span>';
            }
        },
        
        // Fetch options data from API
    async fetchOptionsData() {
            const symbol = document.getElementById('assetSymbol').value;
            const expiryInput = document.getElementById('expiryDate').value;
            const strategy = document.getElementById('strategyType').value;
            
            if (!symbol || !expiryInput) {
                this.showAlert('Please select both symbol and expiry date', 'warning');
                return;
            }
            
            // Convert date format from YYYY-MM-DD to DD-MM-YYYY for Upstox API
            const dateParts = expiryInput.split('-');
            const expiry = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            
            try {
                this.showLoading(true);
                const response = await fetch(`/api/options/strategy_chain?symbol=${encodeURIComponent(symbol)}&expiry=${expiry}&strategy=${strategy}`);
                const data = await response.json();
                
                if (data.ok) {
                    this.currentData = data;
                    this.updateOptionsTable(data);
                    this.updateCharts(data);
                    this.updateMetrics(data);
                    this.loadInsights();
                    this.showAlert('Data loaded successfully', 'success');
                    return true;
                } else {
                    this.currentData = null;
                    this.showAlert('Failed to load options data: ' + (data.error || 'Unknown error'), 'danger');
                    return false;
                }
            } catch (error) {
                this.currentData = null;
                this.showAlert('Error fetching data: ' + error.message, 'danger');
                return false;
            } finally {
                this.showLoading(false);
            }
        },
        hasChainData() {
            return !!(this.currentData && this.currentData.ok && Array.isArray(this.currentData.options_chain) && this.currentData.options_chain.length > 0);
        },
        drawNoData(divId, title) {
            if (!document.getElementById(divId)) return;
            const layout = {
                title: title || 'No data available',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                xaxis: { visible: false },
                yaxis: { visible: false },
                annotations: [{ text: 'No data available', showarrow: false, font: { color: '#6c757d' } }]
            };
            Plotly.react(divId, [], layout);
        },
        
        // Update options table
        updateOptionsTable(data) {
            const tbody = document.querySelector('#optionsTable tbody');
            tbody.innerHTML = '';
            
            if (data.raw && data.raw.length > 0) {
                data.raw.forEach(option => {
                    const row = tbody.insertRow();
                    
                    // Format Indian currency
                    const formatCurrency = (value) => {
                        return value && value > 0 ? `₹${value.toFixed(2)}` : '-';
                    };
                    
                    // Format percentage
                    const formatPercent = (value) => {
                        return value && value > 0 ? `${(value * 100).toFixed(1)}%` : '-';
                    };
                    
                    row.innerHTML = `
                        <td class="fw-bold">${option.strike}</td>
                        <td class="text-success">${formatCurrency(option.call_bid)}</td>
                        <td class="text-danger">${formatCurrency(option.call_ask)}</td>
                        <td>${option.call_volume || 0}</td>
                        <td>${formatPercent(option.call_iv)}</td>
                        <td class="text-success">${formatCurrency(option.put_bid)}</td>
                        <td class="text-danger">${formatCurrency(option.put_ask)}</td>
                        <td>${option.put_volume || 0}</td>
                        <td>${formatPercent(option.put_iv)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="optionsAnalyzer.analyzeStrike(${option.strike})" title="Analyze Strike">
                                <i class="bi bi-graph-up"></i>
                            </button>
                        </td>
                    `;
                    
                    // Highlight ATM or near ATM strikes
                    if (option.strike && data.metrics && data.metrics.max_pain) {
                        const diff = Math.abs(option.strike - data.metrics.max_pain);
                        if (diff < 50) { // Within 50 points of max pain
                            row.classList.add('table-warning');
                        }
                    }
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4"><i class="bi bi-info-circle me-2"></i>No options data available for selected parameters</td></tr>';
            }
        },
        
        // Update charts
        updateCharts(data) {
            if (data.metrics && data.metrics.volatility_smile) {
                this.updateVolatilityChart(data.metrics.volatility_smile);
            }
            
            if (data.metrics && data.metrics.strategy_payoff) {
                this.updateStrategyChart(data.metrics.strategy_payoff);
            }
        },
        
        // Update volatility chart
        updateVolatilityChart(volatilityData) {
            const trace = {
                x: volatilityData.strikes,
                y: volatilityData.ivs,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Implied Volatility',
                line: { color: '#007bff' }
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Strike' },
                yaxis: { title: 'IV' },
                margin: { t: 20, r: 20, b: 40, l: 40 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };
            
            Plotly.newPlot('volatilityChart', [trace], layout);
        },
        
        // Update strategy chart
        updateStrategyChart(strategyData) {
            const trace = {
                x: strategyData.stock_prices,
                y: strategyData.profits,
                type: 'scatter',
                mode: 'lines',
                fill: 'tonexty',
                name: 'P&L',
                line: { color: '#28a745' }
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Stock Price' },
                yaxis: { title: 'Profit/Loss' },
                margin: { t: 20, r: 20, b: 40, l: 40 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };
            
            Plotly.newPlot('strategyChart', [trace], layout);
        },
        
        // Update key metrics
        updateMetrics(data) {
            if (data.metrics) {
                document.getElementById('totalVolume').textContent = 
                    data.metrics.total_volume ? data.metrics.total_volume.toLocaleString('en-IN') : '-';
                document.getElementById('putCallRatio').textContent = 
                    data.metrics.put_call_ratio ? data.metrics.put_call_ratio.toFixed(2) : '-';
                document.getElementById('maxPain').textContent = 
                    data.metrics.max_pain ? '₹' + data.metrics.max_pain.toFixed(2) : '-';
                document.getElementById('avgIV').textContent = 
                    data.metrics.avg_iv ? (data.metrics.avg_iv * 100).toFixed(1) + '%' : '-';
                document.getElementById('expectedMove').textContent = 
                    data.metrics.expected_move ? '±₹' + data.metrics.expected_move.toFixed(2) : '±-';
                
                if (data.metrics.expected_move_range) {
                    document.getElementById('expectedMoveRange').textContent = 
                        `₹${data.metrics.expected_move_range.lower} - ₹${data.metrics.expected_move_range.upper}`;
                }
            }
        },
        
        // Load AI insights
        async loadInsights() {
            try {
                const response = await fetch('/api/options/insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.currentData)
                });
                const insights = await response.json();
                
                document.getElementById('aiInsights').innerHTML = this.formatInsights(insights.insights);
                
                const recResponse = await fetch('/api/options/recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.currentData)
                });
                const recommendations = await recResponse.json();
                
                document.getElementById('recommendations').innerHTML = this.formatRecommendations(recommendations.recommendations);
            } catch (error) {
                console.error('Error loading insights:', error);
            }
        },
        
        // Format insights for display
        formatInsights(insights) {
            if (!insights || insights.length === 0) {
                return '<p class="text-muted">No insights available.</p>';
            }
            
            return insights.map(insight => `
                <div class="mb-3">
                    <h6>${insight.title}</h6>
                    <p class="small">${insight.description}</p>
                    <span class="badge bg-${insight.severity === 'high' ? 'danger' : insight.severity === 'medium' ? 'warning' : 'info'}">${insight.severity}</span>
                </div>
            `).join('');
        },
        
        // Format recommendations for display
        formatRecommendations(recommendations) {
            if (!recommendations || recommendations.length === 0) {
                return '<p class="text-muted">No recommendations available.</p>';
            }
            
            return recommendations.map(rec => `
                <div class="mb-3">
                    <h6>${rec.strategy}</h6>
                    <p class="small">${rec.description}</p>
                    <div class="small text-muted">
                        <strong>Confidence:</strong> ${rec.confidence}% | 
                        <strong>Risk:</strong> ${rec.risk_level}
                    </div>
                </div>
            `).join('');
        },
        
        // Save current data as snapshot
        async saveSnapshot() {
            if (!this.currentData) {
                this.showAlert('No data to save. Please fetch data first.', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/options/save_chain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.currentData,
                        user_key: 'user_' + Date.now(),
                        snapshot_name: `${this.currentData.assetKey}_${new Date().toISOString().split('T')[0]}`
                    })
                });
                
                if (response.ok) {
                    this.showAlert('Snapshot saved successfully', 'success');
                    this.loadSnapshots();
                } else {
                    this.showAlert('Failed to save snapshot', 'danger');
                }
            } catch (error) {
                this.showAlert('Error saving snapshot: ' + error.message, 'danger');
            }
        },
        
        // Load saved snapshots
        async loadSnapshots() {
            try {
                const response = await fetch('/api/options/snapshots');
                const snapshots = await response.json();
                
                const container = document.getElementById('snapshotsList');
                if (snapshots.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-camera-fill fs-1 mb-3"></i>
                            <p>No snapshots saved yet.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = snapshots.map(snapshot => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${snapshot.asset_key} - ${snapshot.expiry}</h6>
                                        <small class="text-muted">${new Date(snapshot.created_at).toLocaleString()}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="optionsAnalyzer.loadSnapshot(${snapshot.id})">
                                            Load
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="optionsAnalyzer.deleteSnapshot(${snapshot.id})">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading snapshots:', error);
            }
        },
        
        // Create alert
        async createAlert() {
            const form = document.getElementById('alertForm');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/options/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: formData.get('alertSymbol'),
                        alert_type: formData.get('alertType'),
                        value: parseFloat(formData.get('alertValue')),
                        message: formData.get('alertMessage')
                    })
                });
                
                if (response.ok) {
                    this.showAlert('Alert created successfully', 'success');
                    form.reset();
                    bootstrap.Modal.getInstance(document.getElementById('createAlertModal')).hide();
                    this.loadAlerts();
                }
            } catch (error) {
                this.showAlert('Error creating alert: ' + error.message, 'danger');
            }
        },
        
        // Load column explanations
        async loadColumnExplanations() {
            try {
                const response = await fetch('/api/options/column_explanations');
                const explanations = await response.json();
                
                document.getElementById('columnExplanations').innerHTML = explanations.map(exp => `
                    <div class="mb-3">
                        <h6>${exp.column}</h6>
                        <p class="small">${exp.explanation}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading explanations:', error);
            }
        },
        
        // Show alert message
        showAlert(message, type = 'info') {
            const alertBar = document.getElementById('alertBar');
            const alertMessage = document.getElementById('alertMessage');
            
            alertBar.className = `alert alert-${type}`;
            alertMessage.textContent = message;
            alertBar.classList.remove('d-none');
            
            setTimeout(() => alertBar.classList.add('d-none'), 5000);
        },
        
        // Show/hide loading state
        showLoading(show) {
            const btn = document.getElementById('fetchDataBtn');
            if (show) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Loading...';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download"></i> Fetch Data';
            }
        },
        
        // Load settings from localStorage
        loadSettings() {
            const saved = localStorage.getItem('optionsAnalyzerSettings');
            if (saved) {
                this.settings = { ...this.settings, ...JSON.parse(saved) };
                this.applySettings();
            }
        },
        
        // Save settings to localStorage
        saveSettings() {
            const form = document.getElementById('settingsForm');
            const formData = new FormData(form);
            
            this.settings = {
                refreshInterval: parseInt(formData.get('refreshInterval')),
                maxRows: parseInt(formData.get('maxRows')),
                enableNotifications: formData.get('enableNotifications') === 'on',
                enableAutoRefresh: formData.get('enableAutoRefresh') === 'on'
            };
            
            localStorage.setItem('optionsAnalyzerSettings', JSON.stringify(this.settings));
            this.applySettings();
            
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            this.showAlert('Settings saved successfully', 'success');
        },
        
        // Apply settings
        applySettings() {
            // Update form values
            document.getElementById('refreshInterval').value = this.settings.refreshInterval;
            document.getElementById('maxRows').value = this.settings.maxRows;
            document.getElementById('enableNotifications').checked = this.settings.enableNotifications;
            document.getElementById('enableAutoRefresh').checked = this.settings.enableAutoRefresh;
            
            // Setup auto refresh if enabled
            if (this.autoRefreshInterval) {
                clearInterval(this.autoRefreshInterval);
            }
            
            if (this.settings.enableAutoRefresh) {
                this.autoRefreshInterval = setInterval(() => {
                    if (this.currentData) {
                        this.fetchOptionsData();
                    }
                }, this.settings.refreshInterval * 1000);
            }
        },
        
        // Analyze individual strike
        analyzeStrike(strike) {
            if (!this.currentData || !this.currentData.raw) {
                this.showAlert('No data available for analysis', 'warning');
                return;
            }
            
            const strikeData = this.currentData.raw.find(opt => opt.strike === strike);
            if (!strikeData) {
                this.showAlert('Strike data not found', 'warning');
                return;
            }
            
            // Create analysis modal content
            const analysisHtml = `
                <div class="modal fade" id="strikeAnalysisModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Strike Analysis: ₹${strike}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Call Option</h6>
                                        <table class="table table-sm">
                                            <tr><td>Bid Price:</td><td class="text-success">₹${strikeData.call_bid || 0}</td></tr>
                                            <tr><td>Ask Price:</td><td class="text-danger">₹${strikeData.call_ask || 0}</td></tr>
                                            <tr><td>Volume:</td><td>${strikeData.call_volume || 0}</td></tr>
                                            <tr><td>Implied Volatility:</td><td>${(strikeData.call_iv * 100).toFixed(1)}%</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Put Option</h6>
                                        <table class="table table-sm">
                                            <tr><td>Bid Price:</td><td class="text-success">₹${strikeData.put_bid || 0}</td></tr>
                                            <tr><td>Ask Price:</td><td class="text-danger">₹${strikeData.put_ask || 0}</td></tr>
                                            <tr><td>Volume:</td><td>${strikeData.put_volume || 0}</td></tr>
                                            <tr><td>Implied Volatility:</td><td>${(strikeData.put_iv * 100).toFixed(1)}%</td></tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6>Analysis</h6>
                                    <p class="small">
                                        ${this.generateStrikeAnalysis(strikeData, strike)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal and add new one
            const existingModal = document.getElementById('strikeAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', analysisHtml);
            const modal = new bootstrap.Modal(document.getElementById('strikeAnalysisModal'));
            modal.show();
        },
        
        // Generate analysis text for strike
        generateStrikeAnalysis(strikeData, strike) {
            let analysis = [];
            
            // Volume analysis
            const totalVolume = (strikeData.call_volume || 0) + (strikeData.put_volume || 0);
            if (totalVolume > 1000) {
                analysis.push(`High trading activity with ${totalVolume.toLocaleString('en-IN')} total contracts.`);
            } else if (totalVolume > 100) {
                analysis.push(`Moderate trading activity with ${totalVolume.toLocaleString('en-IN')} total contracts.`);
            } else {
                analysis.push(`Low trading activity with ${totalVolume.toLocaleString('en-IN')} total contracts.`);
            }
            
            // IV analysis
            const avgIV = ((strikeData.call_iv || 0) + (strikeData.put_iv || 0)) / 2;
            if (avgIV > 0.3) {
                analysis.push('High implied volatility suggests market expects significant price movement.');
            } else if (avgIV > 0.15) {
                analysis.push('Moderate implied volatility indicates normal market expectations.');
            } else {
                analysis.push('Low implied volatility suggests market expects limited price movement.');
            }
            
            // Put-call ratio
            const pcRatio = (strikeData.put_volume || 0) / Math.max(strikeData.call_volume || 1, 1);
            if (pcRatio > 1.5) {
                analysis.push('High put-call ratio indicates bearish sentiment at this strike.');
            } else if (pcRatio < 0.7) {
                analysis.push('Low put-call ratio indicates bullish sentiment at this strike.');
            }
            
            return analysis.join(' ');
        },
        
        // ========== ENHANCED ANALYTICS FUNCTIONS ==========
        
        // Load comprehensive enhanced analytics
        async loadEnhancedAnalytics() {
            if (!this.hasChainData()) {
                this.drawNoData('gammaExposureChart', 'Gamma Exposure (no data)');
                this.drawNoData('volatilitySurfaceChart', 'Volatility Surface (no data)');
                this.drawNoData('flowPatternChart', 'Options Flow (no data)');
                this.updateEnhancedInsights([]);
                this.setEnhancedAnalyticsLoading(false);
                return;
            }
            
            try {
                // Show loading state
                this.setEnhancedAnalyticsLoading(true);
                
                // Load all enhanced analytics in parallel
                await Promise.all([
                    this.loadGammaExposure(),
                    this.loadVolatilitySurface(),
                    this.loadFlowAnalysis(),
                    this.loadMarketStructure()
                ]);
                
                this.showAlert('Enhanced analytics loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading enhanced analytics:', error);
                this.showAlert('Error loading enhanced analytics: ' + error.message, 'danger');
            } finally {
                this.setEnhancedAnalyticsLoading(false);
            }
        },
        
        // Load gamma exposure analysis
        async loadGammaExposure() {
            if (!this.hasChainData()) { this.drawNoData('gammaExposureChart', 'Gamma Exposure (no data)'); return; }
            try {
                const response = await fetch('/api/options/gamma_exposure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        options_chain: this.currentData.options_chain || [],
                        spot_price: this.currentData.underlying_price || 22000
                    })
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                
                this.renderGammaExposureChart(data.data);
                this.updateGammaMetrics(data.data);
                
            } catch (error) {
                console.error('Error loading gamma exposure:', error);
                document.getElementById('totalGammaExposure').textContent = '—';
                this.drawNoData('gammaExposureChart', 'Gamma Exposure (error)');
            }
        },
        
        // Load volatility surface analysis
        async loadVolatilitySurface() {
            if (!this.hasChainData()) { this.drawNoData('volatilitySurfaceChart', 'Volatility Surface (no data)'); return; }
            try {
                const response = await fetch('/api/options/volatility_surface', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        options_chain: this.currentData.options_chain || []
                    })
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                
                this.renderVolatilitySurfaceChart(data.data);
                this.updateVolatilityMetrics(data.data);
                
            } catch (error) {
                console.error('Error loading volatility surface:', error);
                document.getElementById('volSkew').textContent = '—';
                this.drawNoData('volatilitySurfaceChart', 'Volatility Surface (error)');
            }
        },
        
        // Load flow analysis
        async loadFlowAnalysis() {
            if (!this.hasChainData()) { this.drawNoData('flowPatternChart', 'Options Flow (no data)'); return; }
            try {
                const response = await fetch('/api/options/flow_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        options_chain: this.currentData.options_chain || []
                    })
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                
                this.renderFlowPatternChart(data.data);
                this.updateFlowMetrics(data.data);
                
            } catch (error) {
                console.error('Error loading flow analysis:', error);
                document.getElementById('callPutRatioValue').textContent = '—';
                this.drawNoData('flowPatternChart', 'Options Flow (error)');
            }
        },
        
        // Load market structure analysis
        async loadMarketStructure() {
            if (!this.hasChainData()) {
                document.getElementById('var95').textContent = '—';
                document.getElementById('expectedShortfall').textContent = '—';
                document.getElementById('tailRisk').textContent = '—';
                document.getElementById('supportLevels').innerHTML = '<div class="text-center text-muted"><small>No data</small></div>';
                document.getElementById('resistanceLevels').innerHTML = '<div class="text-center text-muted"><small>No data</small></div>';
                return;
            }
            try {
                const response = await fetch('/api/options/market_structure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        options_chain: this.currentData.options_chain || [],
                        spot_price: this.currentData.underlying_price || 22000
                    })
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                
                this.updateMarketStructure(data.data);
                this.updateEnhancedInsights(data.data.market_insights);
                
            } catch (error) {
                console.error('Error loading market structure:', error);
                document.getElementById('var95').textContent = '—';
            }
        },
        
        // Render gamma exposure chart
        renderGammaExposureChart(data) {
            const gammaProfile = data.gamma_profile || [];
            
            const traces = [
                {
                    x: gammaProfile.map(p => p.strike),
                    y: gammaProfile.map(p => p.call_gamma_exposure),
                    type: 'bar',
                    name: 'Call Gamma',
                    marker: { color: 'rgba(52, 168, 83, 0.7)' }
                },
                {
                    x: gammaProfile.map(p => p.strike),
                    y: gammaProfile.map(p => p.put_gamma_exposure),
                    type: 'bar',
                    name: 'Put Gamma',
                    marker: { color: 'rgba(234, 67, 53, 0.7)' }
                }
            ];
            
            const layout = {
                title: 'Gamma Exposure by Strike',
                xaxis: { title: 'Strike Price' },
                yaxis: { title: 'Gamma Exposure' },
                barmode: 'group',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };
            
            Plotly.react('gammaExposureChart', traces, layout);
        },
        
        // Render volatility surface chart
        renderVolatilitySurfaceChart(data) {
            const surface = data.volatility_surface || [];
            
            const traces = [
                {
                    x: surface.map(s => s.strike),
                    y: surface.map(s => s.call_iv * 100),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Call IV',
                    line: { color: 'rgba(52, 168, 83, 0.8)' }
                },
                {
                    x: surface.map(s => s.strike),
                    y: surface.map(s => s.put_iv * 100),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Put IV',
                    line: { color: 'rgba(234, 67, 53, 0.8)' }
                }
            ];
            
            const layout = {
                title: 'Implied Volatility Skew',
                xaxis: { title: 'Strike Price' },
                yaxis: { title: 'Implied Volatility (%)' },
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };
            
            Plotly.react('volatilitySurfaceChart', traces, layout);
        },
        
        // Render flow pattern chart
        renderFlowPatternChart(data) {
            const flowData = data.strike_flow_analysis || [];
            
            const traces = [
                {
                    x: flowData.map(f => f.strike),
                    y: flowData.map(f => f.call_volume),
                    type: 'bar',
                    name: 'Call Volume',
                    marker: { color: 'rgba(52, 168, 83, 0.7)' }
                },
                {
                    x: flowData.map(f => f.strike),
                    y: flowData.map(f => f.put_volume),
                    type: 'bar',
                    name: 'Put Volume',
                    marker: { color: 'rgba(234, 67, 53, 0.7)' }
                }
            ];
            
            const layout = {
                title: 'Options Flow by Strike',
                xaxis: { title: 'Strike Price' },
                yaxis: { title: 'Volume' },
                barmode: 'group',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };
            
            Plotly.react('flowPatternChart', traces, layout);
        },
        
        // Update gamma metrics
        updateGammaMetrics(data) {
            const totalExposure = data.total_gamma_exposure || 0;
            const flipPoint = data.gamma_analysis?.gamma_flip_point || 'N/A';
            const riskLevel = Math.abs(totalExposure) > 100000000 ? 'High' : 
                            Math.abs(totalExposure) > 50000000 ? 'Medium' : 'Low';
            
            document.getElementById('totalGammaExposure').textContent = 
                '₹' + (totalExposure / 1000000).toFixed(1) + 'M';
            document.getElementById('gammaFlipPoint').textContent = flipPoint;
            document.getElementById('gammaRisk').textContent = riskLevel;
        },
        
        // Update volatility metrics
        updateVolatilityMetrics(data) {
            const analytics = data.volatility_analytics || {};
            
            document.getElementById('volSkew').textContent = 
                ((analytics.volatility_skew || 0) * 100).toFixed(2) + '%';
            document.getElementById('termStructure').textContent = 
                analytics.term_structure_slope > 0 ? 'Contango' : 'Backwardation';
            document.getElementById('volCluster').textContent = 
                analytics.volatility_clustering > 0.5 ? 'High' : 'Low';
        },
        
        // Update flow metrics
        updateFlowMetrics(data) {
            const flowAnalysis = data.flow_analysis || {};
            
            const callPutRatio = flowAnalysis.call_put_ratio || 0;
            const unusualActivity = flowAnalysis.unusual_activity_score || 0;
            const institutionalFlow = flowAnalysis.institutional_flow_indicator || 0;
            
            document.getElementById('callPutRatioValue').textContent = callPutRatio.toFixed(2);
            document.getElementById('callPutProgress').style.width = 
                Math.min(callPutRatio * 50, 100) + '%';
            
            document.getElementById('unusualActivityValue').textContent = 
                (unusualActivity * 100).toFixed(1) + '%';
            document.getElementById('unusualActivityProgress').style.width = 
                (unusualActivity * 100) + '%';
            
            document.getElementById('institutionalValue').textContent = 
                (institutionalFlow * 100).toFixed(1) + '%';
            document.getElementById('institutionalProgress').style.width = 
                (institutionalFlow * 100) + '%';
        },
        
        // Update market structure
        updateMarketStructure(data) {
            const supportResistance = data.support_resistance || {};
            const riskMetrics = data.risk_metrics || {};
            
            // Support levels
            const supportContainer = document.getElementById('supportLevels');
            const supportLevels = supportResistance.support_levels || [];
            supportContainer.innerHTML = supportLevels.length > 0 ? 
                supportLevels.map(level => 
                    `<div class="badge bg-success me-1">₹${level.toFixed(0)}</div>`
                ).join('') : 
                '<div class="text-center text-muted"><small>No data</small></div>';
            
            // Resistance levels
            const resistanceContainer = document.getElementById('resistanceLevels');
            const resistanceLevels = supportResistance.resistance_levels || [];
            resistanceContainer.innerHTML = resistanceLevels.length > 0 ? 
                resistanceLevels.map(level => 
                    `<div class="badge bg-danger me-1">₹${level.toFixed(0)}</div>`
                ).join('') : 
                '<div class="text-center text-muted"><small>No data</small></div>';
            
            // Risk metrics
            document.getElementById('var95').textContent = 
                '₹' + (riskMetrics.value_at_risk_95 || 0).toFixed(0);
            document.getElementById('expectedShortfall').textContent = 
                '₹' + (riskMetrics.expected_shortfall || 0).toFixed(0);
            document.getElementById('tailRisk').textContent = 
                ((riskMetrics.tail_risk || 0) * 100).toFixed(1) + '%';
        },
        
        // Update enhanced insights
        updateEnhancedInsights(insights) {
            const container = document.getElementById('enhancedInsights');
            
            if (insights && insights.length > 0) {
                const insightsHtml = insights.map(insight => `
                    <div class="alert alert-info mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-lightbulb me-2"></i>
                            <div>
                                <strong>${insight.category || 'Insight'}:</strong>
                                ${insight.message || insight}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = insightsHtml;
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-cpu fs-1 mb-3"></i>
                        <p>No enhanced insights available at this time.</p>
                    </div>
                `;
            }
        },
        
        // Set loading state for enhanced analytics
        setEnhancedAnalyticsLoading(isLoading) {
            const elements = [
                'totalGammaExposure', 'gammaFlipPoint', 'gammaRisk',
                'volSkew', 'termStructure', 'volCluster',
                'callPutRatioValue', 'unusualActivityValue', 'institutionalValue',
                'var95', 'expectedShortfall', 'tailRisk'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = isLoading ? '...' : '-';
                }
            });
            
            if (isLoading) {
                document.getElementById('enhancedInsights').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Loading enhanced analytics...
                    </div>
                `;
            }
        },
        // ========== ENHANCED LIVE (REAL-TIME) LOOP ==========
        async refreshEnhancedLiveOnce() {
            try {
                const ok = await this.fetchOptionsData();
                if (ok && this.hasChainData()) {
                    await this.loadEnhancedAnalytics();
                } else {
                    this.drawNoData('gammaExposureChart', 'Gamma Exposure (no data)');
                    this.drawNoData('volatilitySurfaceChart', 'Volatility Surface (no data)');
                    this.drawNoData('flowPatternChart', 'Options Flow (no data)');
                    this.updateEnhancedInsights([]);
                }
            } catch (e) {
                console.error('Enhanced live refresh failed', e);
            }
        },
        startEnhancedLive() {
            const enhSwitch = document.getElementById('enhLiveSwitch');
            if (!enhSwitch || !enhSwitch.checked) return;
            this.stopEnhancedLive();
            const enhInterval = document.getElementById('enhLiveInterval');
            const seconds = parseInt(enhInterval?.value || '15', 10);
            // Immediate refresh once, then schedule
            this.refreshEnhancedLiveOnce();
            this._enhTimer = setInterval(() => this.refreshEnhancedLiveOnce(), seconds * 1000);
        },
        stopEnhancedLive() {
            if (this._enhTimer) {
                clearInterval(this._enhTimer);
                this._enhTimer = null;
            }
        },
        toggleEnhancedLive() {
            const enhSwitch = document.getElementById('enhLiveSwitch');
            if (enhSwitch && enhSwitch.checked) this.startEnhancedLive(); else this.stopEnhancedLive();
        },
        restartEnhancedLive() {
            this.stopEnhancedLive();
            this.startEnhancedLive();
        }
        ,
        // Setup real-time scanner chart with placeholder
        setupRealtimeChart() {
            if (!document.getElementById('realtimeScannerChart')) return;
            Plotly.newPlot('realtimeScannerChart', [], {
                title: 'Live Unusual Activity (Volume Ratio)',
                margin: { t: 40, r: 20, b: 40, l: 60 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                xaxis: { title: 'Symbol/Strike' },
                yaxis: { title: 'Volume Ratio (×)' }
            });
        },
        // Fetch and render real-time scanner
        async loadRealtimeScanner() {
            if (!document.getElementById('realtimeScannerChart')) return;
            try {
                const resp = await fetch('/api/options/realtime_scanner');
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Failed');
                const data = json.data || {};
                // Update timestamp
                const ts = new Date(data.timestamp || Date.now());
                const tsEl = document.getElementById('rtLastUpdated');
                if (tsEl) tsEl.textContent = ts.toLocaleTimeString();
                // Build chart from unusual activity
                const ua = data.unusual_activity || [];
                const labels = ua.map(u => `${u.symbol} ${u.strike} ${String(u.type||'').toUpperCase()[0]}`);
                const ratios = ua.map(u => u.volume_ratio || 0);
                const trace = [{ x: labels, y: ratios, type: 'bar', marker: { color: 'rgba(33, 150, 243, 0.7)' }, name: 'Vol Ratio' }];
                const layout = { title: 'Live Unusual Activity (Volume Ratio)', margin: { t: 40, r: 20, b: 80, l: 60 }, paper_bgcolor: 'transparent', plot_bgcolor: 'transparent', xaxis: { tickangle: -30 } };
                Plotly.react('realtimeScannerChart', trace, layout);
                // Lists
                const uaEl = document.getElementById('rtUnusualList');
                if (uaEl) uaEl.innerHTML = ua.length ? ua.map(u => `
                    <div class="mb-1">
                        <span class="badge bg-warning text-dark me-1">${(u.alert_type||'').replace('_',' ')}</span>
                        <strong>${u.symbol}</strong> ${u.strike} ${u.type?.toUpperCase()}
                        <span class="ms-2">Vol: ${u.unusual_volume?.toLocaleString('en-IN')} (<span class="text-primary">×${(u.volume_ratio||0).toFixed(1)}</span>)</span>
                        <span class="ms-2">Imp Move: ${(u.implied_move||0).toFixed(1)}%</span>
                    </div>`).join('') : '<span class="text-muted">No unusual activity.</span>';
                const movers = data.top_movers || [];
                const mvEl = document.getElementById('rtMoversList');
                if (mvEl) mvEl.innerHTML = movers.length ? movers.map(m => `
                    <div class="mb-1">
                        <strong>${m.symbol}</strong> ${m.strike} ${m.type?.toUpperCase()}
                        <span class="ms-2">IV Δ: <span class="text-${(m.iv_change||0) >= 0 ? 'success' : 'danger'}">${(m.iv_change||0).toFixed(1)}%</span></span>
                        <span class="ms-2">Vol: ${m.volume?.toLocaleString('en-IN')}</span>
                    </div>`).join('') : '<span class="text-muted">No movers.</span>';
            } catch (e) {
                console.error('Realtime scanner error', e);
            }
        },
        // Realtime auto refresh controls
        startRealtimeAutoRefresh() {
            if (this._rtTimer) clearInterval(this._rtTimer);
            const rtSwitch = document.getElementById('rtAutoRefreshSwitch');
            if (rtSwitch && rtSwitch.checked) {
                this.loadRealtimeScanner();
                this._rtTimer = setInterval(() => this.loadRealtimeScanner(), 15000);
            }
        },
        stopRealtimeAutoRefresh() {
            if (this._rtTimer) {
                clearInterval(this._rtTimer);
                this._rtTimer = null;
            }
        },
        toggleRealtimeAuto() {
            const rtSwitch = document.getElementById('rtAutoRefreshSwitch');
            if (rtSwitch && rtSwitch.checked) {
                this.startRealtimeAutoRefresh();
            } else {
                this.stopRealtimeAutoRefresh();
            }
        }
    };
    
    // Initialize the application
    optionsAnalyzer.init();
    
    // Load snapshots when snapshots tab is clicked
    document.getElementById('snapshots-tab').addEventListener('click', () => {
        optionsAnalyzer.loadSnapshots();
    });
    
    // Make optionsAnalyzer globally available
    window.optionsAnalyzer = optionsAnalyzer;
});
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    background-color: transparent;
    border-bottom: 2px solid #007bff;
    color: #007bff;
}
</style>
{% endblock %}
