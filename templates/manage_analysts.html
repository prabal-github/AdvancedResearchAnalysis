{% extends "layout.html" %}

{% block title %}Manage Analysts - Admin Dashboard{% endblock %}

{% block extra_head %}
<style>
    .analyst-card {
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
    }
    .analyst-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .status-active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .stat-item {
        text-align: center;
        padding: 0.25rem;
        background: #f8f9fa;
        border-radius: 0.25rem;
    }
    .action-buttons {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-people-fill text-primary me-2"></i>
                        Manage Analysts
                    </h2>
                    <p class="text-muted mb-0">Create, activate, deactivate, and manage analyst accounts</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/admin/create_analyst" class="btn btn-success">
                        <i class="bi bi-person-plus me-1"></i>
                        Create New Analyst
                    </a>
                    <a href="/admin/bulk_create_analysts" class="btn btn-primary">
                        <i class="bi bi-cloud-upload me-1"></i>
                        Bulk Create Analysts
                    </a>
                    <a href="/admin_dashboard" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary bg-opacity-10 border-primary">
                        <div class="card-body text-center">
                            <h3 class="text-primary mb-1">{{ analysts|length }}</h3>
                            <small class="text-muted">Total Analysts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success bg-opacity-10 border-success">
                        <div class="card-body text-center">
                            <h3 class="text-success mb-1">{{ analysts|selectattr('is_active')|list|length }}</h3>
                            <small class="text-muted">Active Analysts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning bg-opacity-10 border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-1">{{ analysts|rejectattr('is_active')|list|length }}</h3>
                            <small class="text-muted">Inactive Analysts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info bg-opacity-10 border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info mb-1">{{ analysts|sum(attribute='reports_count') }}</h3>
                            <small class="text-muted">Total Reports</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysts Grid -->
            {% if analysts %}
            <div class="row">
                {% for analyst in analysts %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card analyst-card h-100">
                        <div class="card-body">
                            <!-- Header with Status -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1">{{ analyst.full_name or analyst.name }}</h5>
                                    <small class="text-muted">{{ analyst.analyst_id }}</small>
                                </div>
                                <span class="badge status-badge {% if analyst.is_active %}status-active{% else %}status-inactive{% endif %}">
                                    {% if analyst.is_active %}
                                        <i class="bi bi-check-circle me-1"></i>Active
                                    {% else %}
                                        <i class="bi bi-x-circle me-1"></i>Inactive
                                    {% endif %}
                                </span>
                                <span class="badge status-badge ms-1 {% if analyst.connect_enabled %}status-active{% else %}status-inactive{% endif %}" title="Session booking permission">
                                    {% if analyst.connect_enabled %}
                                        <i class="bi bi-camera-video-fill me-1"></i>Sessions On
                                    {% else %}
                                        <i class="bi bi-camera-video-off me-1"></i>Sessions Off
                                    {% endif %}
                                </span>
                            </div>

                            <!-- Basic Info -->
                            <div class="mb-3">
                                <p class="mb-1">
                                    <i class="bi bi-envelope text-muted me-2"></i>
                                    <small>{{ analyst.email }}</small>
                                </p>
                                {% if analyst.specialization %}
                                <p class="mb-1">
                                    <i class="bi bi-star text-muted me-2"></i>
                                    <small>{{ analyst.specialization }}</small>
                                </p>
                                {% endif %}
                                <p class="mb-1">
                                    <i class="bi bi-calendar text-muted me-2"></i>
                                    <small>{{ analyst.experience_years }} years experience</small>
                                </p>
                                <p class="mb-0">
                                    <i class="bi bi-clock text-muted me-2"></i>
                                    <small>Joined: {{ analyst.created_at }}</small>
                                </p>
                            </div>

                            <!-- Statistics -->
                            <div class="stats-grid mb-3">
                                <div class="stat-item">
                                    <div class="fw-bold text-primary">{{ analyst.reports_count }}</div>
                                    <small class="text-muted">Reports</small>
                                </div>
                                <div class="stat-item">
                                    <div class="fw-bold text-success">{{ analyst.tasks_count }}</div>
                                    <small class="text-muted">Tasks</small>
                                </div>
                                <div class="stat-item">
                                    <div class="fw-bold text-info">{{ analyst.login_count }}</div>
                                    <small class="text-muted">Logins</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">
                                    <i class="bi bi-person-check me-1"></i>
                                    Last login: {{ analyst.last_login }}
                                </small>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <a href="/admin/analyst/{{ analyst.id }}/edit" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </a>
                                
                <button type="button" class="btn btn-outline-{% if analyst.is_active %}warning{% else %}success{% endif %} btn-sm btn-toggle-status" 
                    data-analyst-id="{{ analyst.id }}" data-analyst-name="{{ analyst.name }}" data-active="{{ 1 if analyst.is_active else 0 }}">
                                    <i class="bi bi-{% if analyst.is_active %}pause{% else %}play{% endif %} me-1"></i>
                                    {% if analyst.is_active %}Deactivate{% else %}Activate{% endif %}
                                </button>
                                
                <button type="button" class="btn btn-outline-danger btn-sm btn-delete-analyst" 
                    data-analyst-id="{{ analyst.id }}" data-analyst-name="{{ analyst.name }}">
                                    <i class="bi bi-trash me-1"></i>Delete
                                </button>
                <button type="button" class="btn btn-outline-{% if analyst.connect_enabled %}secondary{% else %}info{% endif %} btn-sm btn-toggle-connect" 
                    data-analyst-id="{{ analyst.id }}" data-analyst-name="{{ analyst.name }}" data-connect="{{ 1 if analyst.connect_enabled else 0 }}">
                                    <i class="bi bi-camera-video{% if analyst.connect_enabled %}-off{% endif %} me-1"></i>
                                    {% if analyst.connect_enabled %}Disable Sessions{% else %}Enable Sessions{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-people display-1 text-muted"></i>
                <h3 class="mt-3 text-muted">No Analysts Found</h3>
                <p class="text-muted">Create your first analyst account to get started.</p>
                <a href="/admin/create_analyst" class="btn btn-primary">
                    <i class="bi bi-person-plus me-2"></i>Create Analyst
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Content will be set by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function toggleAnalystStatus(analystId, analystName, currentStatus) {
    const action = currentStatus ? 'deactivate' : 'activate';
    const actionWord = currentStatus ? 'Deactivated' : 'Activated';
    
    document.getElementById('confirmModalTitle').textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} Analyst`;
    document.getElementById('confirmModalBody').innerHTML = `
        <p>Are you sure you want to <strong>${action}</strong> analyst <strong>${analystName}</strong>?</p>
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            ${currentStatus ? 'The analyst will no longer be able to log in or access the system.' : 'The analyst will be able to log in and access the system again.'}
        </div>
    `;
    
    const confirmBtn = document.getElementById('confirmActionBtn');
    confirmBtn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
    confirmBtn.className = `btn ${currentStatus ? 'btn-warning' : 'btn-success'}`;
    
    confirmBtn.onclick = function() {
        fetch(`/admin/analyst/${analystId}/toggle_status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({})
        })
        .then(async response => {
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Unexpected response (status ${response.status}).`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert('danger', data.error || 'Failed to update analyst status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while updating analyst status');
        });
        
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function deleteAnalyst(analystId, analystName) {
    document.getElementById('confirmModalTitle').textContent = 'Delete Analyst';
    document.getElementById('confirmModalBody').innerHTML = `
        <p>Are you sure you want to <strong>permanently delete</strong> analyst <strong>${analystName}</strong>?</p>
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action cannot be undone. All associated data will be lost.
        </div>
    `;
    
    const confirmBtn = document.getElementById('confirmActionBtn');
    confirmBtn.textContent = 'Delete';
    confirmBtn.className = 'btn btn-danger';
    
    confirmBtn.onclick = function() {
        fetch(`/admin/analyst/${analystId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({})
        })
        .then(async response => {
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Unexpected response (status ${response.status}).`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert('danger', data.error || 'Failed to delete analyst');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while deleting analyst');
        });
        
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// New delegated handlers
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.btn-toggle-status').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-analyst-id');
            const name = btn.getAttribute('data-analyst-name');
            const active = btn.getAttribute('data-active')==='1';
            toggleAnalystStatus(id, name, active);
        });
    });
    document.querySelectorAll('.btn-delete-analyst').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            deleteAnalyst(btn.getAttribute('data-analyst-id'), btn.getAttribute('data-analyst-name'));
        });
    });
    document.querySelectorAll('.btn-toggle-connect').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-analyst-id');
            const name = btn.getAttribute('data-analyst-name');
            const enabled = btn.getAttribute('data-connect')==='1';
            toggleConnect(id, name, enabled);
        });
    });
});

function toggleConnect(analystId, analystName, currentlyEnabled){
        const action = currentlyEnabled ? 'Disable' : 'Enable';
        document.getElementById('confirmModalTitle').textContent = action + ' Sessions';
        document.getElementById('confirmModalBody').innerHTML = `
                <p>${action} session booking & calendar management for <strong>${analystName}</strong>?</p>
                <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>
                ${currentlyEnabled ? 'They will no longer be able to add or modify availability.' : 'They will be able to set availability for investor booking.'}
                </div>`;
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.textContent = action;
        confirmBtn.className = 'btn ' + (currentlyEnabled ? 'btn-secondary' : 'btn-info');
        confirmBtn.onclick = function(){
                fetch(`/admin/analyst/${analystId}/toggle_connect`, {method:'POST', headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest'}})
                    .then(r=>r.json())
                    .then(j=>{ if(j.success){ showAlert('success', j.message); setTimeout(()=>location.reload(), 1000);} else { showAlert('danger', j.error||'Failed'); } })
                    .catch(()=>showAlert('danger','Request failed'));
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        };
        new bootstrap.Modal(document.getElementById('confirmModal')).show();
}
</script>
{% endblock %}
