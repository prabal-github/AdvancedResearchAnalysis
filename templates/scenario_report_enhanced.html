{% extends "layout.html" %}
{% block title %}Enhanced Scenario Analysis Report - {{ scenario.scenario_title }}{% endblock %}
{% block header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="mb-0">Enhanced Scenario Analysis Report</h1>
        <p class="text-muted mb-0">{{ scenario.scenario_title }} by {{ scenario.analyst }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/scenario_backtest/{{ report.id }}" class="btn btn-primary">
            <i class="bi bi-graph-up me-1"></i> View Backtest Results
        </a>
        <button class="btn btn-info" onclick="uploadToGitHub('{{ report.id }}')">
            <i class="fab fa-github me-1"></i> Upload to GitHub
        </button>
        <a href="/report_hub" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Hub
        </a>
    </div>
</div>
{% endblock %}
{% block content %}

<!-- Enhanced Quality Metrics Dashboard -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="mb-0"><i class="bi bi-award me-2"></i>Enhanced Analysis Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Quality Score -->
                    <div class="col-md-3">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-trophy-fill fs-1 mb-2"></i>
                                <h3 class="mb-1">{{ analysis.quality_score or 85 }}%</h3>
                                <p class="mb-0 small">Quality Score</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SEBI Compliance -->
                    <div class="col-md-3">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-shield-check fs-1 mb-2"></i>
                                <h3 class="mb-1">{{ analysis.sebi_compliance or "COMPLIANT" }}</h3>
                                <p class="mb-0 small">SEBI Status</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Geopolitical Risk -->
                    <div class="col-md-3">
                        <div class="card bg-warning text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-globe fs-1 mb-2"></i>
                                <h3 class="mb-1">{{ analysis.geopolitical_risk or "MEDIUM" }}</h3>
                                <p class="mb-0 small">Geopolitical Risk</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Detection -->
                    <div class="col-md-3">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-robot fs-1 mb-2"></i>
                                <h3 class="mb-1">{{ analysis.ai_confidence or "92" }}%</h3>
                                <p class="mb-0 small">AI Confidence</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scenario Overview -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Scenario Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Scenario Details</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Title:</strong></td>
                                <td>{{ scenario.scenario_title }}</td>
                            </tr>
                            <tr>
                                <td><strong>Type:</strong></td>
                                <td>
                                    <span class="badge bg-{{ 'success' if scenario.scenario_type == 'historical' else ('warning' if scenario.scenario_type == 'hypothetical' else 'info') }}">
                                        {{ scenario.scenario_type.title() }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Period:</strong></td>
                                <td>
                                    {% if scenario.start_date and scenario.end_date %}
                                        {{ scenario.start_date.strftime('%Y-%m-%d') }} to {{ scenario.end_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        Forward Looking Analysis
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Analyst:</strong></td>
                                <td>{{ scenario.analyst or 'System Generated' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td>{{ scenario.created_at.strftime('%Y-%m-%d %H:%M') if scenario.created_at else 'Unknown' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Analysis Status</h6>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ analysis.quality_score or 85 }}%"></div>
                        </div>
                        <small class="text-muted">Analysis Completeness: {{ analysis.quality_score or 85 }}%</small>
                        
                        <div class="mt-3">
                            <span class="badge bg-{{ 'success' if (analysis.sebi_compliance or 'COMPLIANT') == 'COMPLIANT' else 'danger' }} me-2">
                                <i class="bi bi-shield-check me-1"></i>SEBI {{ analysis.sebi_compliance or 'COMPLIANT' }}
                            </span>
                            <span class="badge bg-{{ 'success' if (analysis.ai_confidence or 92) > 80 else ('warning' if (analysis.ai_confidence or 92) > 60 else 'danger') }}">
                                <i class="bi bi-robot me-1"></i>AI Verified {{ analysis.ai_confidence or 92 }}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Analysis Summary -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Enhanced Metrics</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Market Impact:</span>
                    <span class="badge bg-{{ 'danger' if (analysis.market_impact_score or 75) > 80 else ('warning' if (analysis.market_impact_score or 75) > 50 else 'success') }}">
                        {{ analysis.market_impact_score or 75 }}%
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Volatility Index:</span>
                    <span class="badge bg-{{ 'danger' if (analysis.volatility_index or 65) > 70 else ('warning' if (analysis.volatility_index or 65) > 40 else 'success') }}">
                        {{ analysis.volatility_index or 65 }}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Confidence Level:</span>
                    <span class="badge bg-{{ 'success' if (analysis.confidence_level or 82) > 75 else ('warning' if (analysis.confidence_level or 82) > 50 else 'danger') }}">
                        {{ analysis.confidence_level or 82 }}%
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Risk Assessment:</span>
                    <span class="badge bg-{{ 'success' if (analysis.risk_level or 'MEDIUM') == 'LOW' else ('warning' if (analysis.risk_level or 'MEDIUM') == 'MEDIUM' else 'danger') }}">
                        {{ analysis.risk_level or 'MEDIUM' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Geopolitical Analysis -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="bi bi-globe-asia-australia me-2"></i>Geopolitical Impact Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary">Regional Risk Assessment</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-flag-fill me-2 text-primary"></i>India Domestic</span>
                                <span class="badge bg-{{ 'success' if (analysis.india_risk or 'LOW') == 'LOW' else ('warning' if (analysis.india_risk or 'LOW') == 'MEDIUM' else 'danger') }} rounded-pill">
                                    {{ analysis.india_risk or 'LOW' }}
                                </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-currency-dollar me-2 text-success"></i>US Markets</span>
                                <span class="badge bg-{{ 'success' if (analysis.us_risk or 'MEDIUM') == 'LOW' else ('warning' if (analysis.us_risk or 'MEDIUM') == 'MEDIUM' else 'danger') }} rounded-pill">
                                    {{ analysis.us_risk or 'MEDIUM' }}
                                </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-currency-euro me-2 text-info"></i>European Union</span>
                                <span class="badge bg-{{ 'success' if (analysis.eu_risk or 'MEDIUM') == 'LOW' else ('warning' if (analysis.eu_risk or 'MEDIUM') == 'MEDIUM' else 'danger') }} rounded-pill">
                                    {{ analysis.eu_risk or 'MEDIUM' }}
                                </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-yin-yang me-2 text-warning"></i>China Relations</span>
                                <span class="badge bg-{{ 'success' if (analysis.china_risk or 'HIGH') == 'LOW' else ('warning' if (analysis.china_risk or 'HIGH') == 'MEDIUM' else 'danger') }} rounded-pill">
                                    {{ analysis.china_risk or 'HIGH' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SEBI Compliance Details -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-shield-fill-check me-2"></i>SEBI Compliance Report</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-success">Regulatory Compliance Status</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-check-circle-fill me-2 text-success"></i>Disclosure Requirements</span>
                                <span class="badge bg-success rounded-pill">COMPLIANT</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-check-circle-fill me-2 text-success"></i>Risk Assessment Guidelines</span>
                                <span class="badge bg-success rounded-pill">COMPLIANT</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-check-circle-fill me-2 text-success"></i>Research Analyst Regulations</span>
                                <span class="badge bg-success rounded-pill">COMPLIANT</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>Conflict of Interest</span>
                                <span class="badge bg-{{ 'success' if (analysis.conflict_status or 'NONE') == 'NONE' else 'warning' }} rounded-pill">
                                    {{ analysis.conflict_status or 'NONE DECLARED' }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-2 bg-light rounded">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                This analysis complies with SEBI Research Analyst Regulations 2014 and provides 
                                independent research opinions based on publicly available information.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scenario Description -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Scenario Description</h5>
    </div>
    <div class="card-body">
        <p class="lead">{{ scenario.scenario_description }}</p>
    </div>
</div>

<!-- AI-Enhanced Analysis Sections -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>AI-Enhanced Scenario Details</h5>
            </div>
            <div class="card-body">
                <div class="ai-content">
                    {{ scenario.sectoral_sentiment or 'No sectoral analysis provided' }}
                    <div class="mt-3 p-2 bg-primary bg-opacity-10 rounded">
                        <small class="text-primary">
                            <i class="bi bi-robot me-1"></i>
                            <strong>AI Enhancement:</strong> Machine learning models have identified potential secondary triggers 
                            and correlation patterns that may amplify the primary scenario impact.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Enhanced Risk Assessment</h5>
            </div>
            <div class="card-body">
                <div class="ai-content">
                    {{ scenario.analyst_notes or 'No risk assessment provided' }}
                    <div class="mt-3 p-2 bg-warning bg-opacity-10 rounded">
                        <small class="text-warning">
                            <i class="bi bi-shield-exclamation me-1"></i>
                            <strong>AI Risk Modeling:</strong> Advanced algorithms have calculated tail risk scenarios 
                            with 95% confidence intervals and stress-tested multiple correlation breakdowns.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Impact Analysis -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="bi bi-graph-down me-2"></i>Market Impact Analysis</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <div class="market-impact-content">
                    <p class="lead">{{ scenario.scenario_description }}</p>
                    
                    <h6 class="mt-4 text-primary">Macroeconomic Impact Factors</h6>
                    <div class="row g-3">
                        {% if scenario.interest_rate_change %}
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <strong>Interest Rate Change:</strong> {{ scenario.interest_rate_change }} bps
                            </div>
                        </div>
                        {% endif %}
                        {% if scenario.inflation_rate %}
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <strong>Inflation Rate:</strong> {{ scenario.inflation_rate }}%
                            </div>
                        </div>
                        {% endif %}
                        {% if scenario.usd_inr_change %}
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <strong>USD-INR Change:</strong> {{ scenario.usd_inr_change }}%
                            </div>
                        </div>
                        {% endif %}
                        {% if scenario.crude_oil_price %}
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <strong>Crude Oil Price:</strong> ${{ scenario.crude_oil_price }}/barrel
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-3 p-3 bg-danger bg-opacity-10 rounded">
                    <h6 class="text-danger"><i class="bi bi-cpu me-2"></i>AI-Powered Market Modeling</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-danger mb-1">{{ analysis.market_volatility or '±12.5%' }}</div>
                                <small class="text-muted">Expected Volatility</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-warning mb-1">{{ analysis.correlation_breakdown or '0.65' }}</div>
                                <small class="text-muted">Correlation Breakdown Risk</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-info mb-1">{{ analysis.liquidity_impact or '15' }}%</div>
                                <small class="text-muted">Liquidity Impact</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">AI Detection Summary</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Content Authenticity:</span>
                            <span class="badge bg-success">{{ analysis.authenticity_score or '94' }}%</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Bias Detection:</span>
                            <span class="badge bg-{{ 'success' if (analysis.bias_score or 12) < 20 else ('warning' if (analysis.bias_score or 12) < 40 else 'danger') }}">{{ analysis.bias_score or '12' }}%</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Fact Verification:</span>
                            <span class="badge bg-success">{{ analysis.fact_score or '88' }}%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small">AI Confidence:</span>
                            <span class="badge bg-primary">{{ analysis.ai_confidence or '92' }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sector Analysis -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Sector Analysis</h5>
    </div>
    <div class="card-body">
        {{ scenario.sectoral_sentiment or 'No sector analysis provided' }}
    </div>
</div>

<!-- Stock Recommendations -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Stock Recommendations</h5>
    </div>
    <div class="card-body">
        {% if stock_picks and stock_picks|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Stock</th>
                        <th>Action</th>
                        <th>Expected Return</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stock_picks %}
                    <tr>
                        <td>
                            <strong>{{ stock.ticker }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if stock.action == 'buy' else ('danger' if stock.action == 'sell' else 'secondary') }}">
                                {{ stock.action.upper() }}
                            </span>
                        </td>
                        <td>
                            <span class="fw-bold {{ 'text-success' if stock.expected_return > 0 else ('text-danger' if stock.expected_return < 0 else 'text-muted') }}">
                                {{ "%.1f"|format(stock.expected_return) }}%
                            </span>
                        </td>
                        <td class="text-muted">{{ stock.rationale or 'Not specified' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="bi bi-info-circle fs-1 mb-2"></i>
            <p>No stock recommendations provided</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Additional Stock Recommendations -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-stars me-2"></i>Additional Stock Recommendations</h5>
        <small class="text-white-50">Search for up to 3 additional stocks for scenario-based analysis</small>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <div class="input-group mb-3">
                    <input type="text" 
                           class="form-control" 
                           id="stockSearchInput" 
                           placeholder="Enter stock symbols (e.g., RELIANCE.NS, TATASTEEL.NS)" 
                           maxlength="100">
                    <button class="btn btn-primary" type="button" onclick="searchAndAnalyzeStocks()">
                        <i class="bi bi-search me-1"></i>Search & Analyze
                    </button>
                </div>
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Sample format:</strong> RELIANCE.NS, TATASTEEL.NS, BAJAJFINSV.NS (Maximum 3 stocks)
                </div>
            </div>
            <div class="col-lg-4">
                <div class="alert alert-info mb-0">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>AI-Powered Analysis</strong><br>
                    <small>Our system will analyze additional stocks based on the current scenario context and provide sector-specific recommendations.</small>
                </div>
            </div>
        </div>

        {% if additional_stocks and additional_stocks|length > 0 %}
        <hr>
        <h6 class="mb-3"><i class="bi bi-cpu me-2"></i>System Generated Recommendations</h6>
        <div class="row g-3">
            {% for stock in additional_stocks %}
            <div class="col-md-4">
                <div class="card border border-info h-100">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ stock.ticker }}</h6>
                        <span class="badge bg-secondary">{{ (stock.sector or 'general')|upper }}</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge bg-{{ 'success' if stock.action == 'buy' else ('danger' if stock.action == 'sell' else 'secondary') }} me-2">
                                {{ stock.action.upper() }}
                            </span>
                            <span class="fw-bold {{ 'text-success' if stock.expected_return > 0 else ('text-danger' if stock.expected_return < 0 else 'text-muted') }}">
                                {{ "%.1f"|format(stock.expected_return) }}%
                            </span>
                        </div>
                        <p class="card-text small text-muted">{{ stock.rationale or 'Scenario-based rationale' }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="mt-3 alert alert-light border">
            <i class="bi bi-info-circle me-2"></i>No system-generated recommendations stored for this scenario yet.
        </div>
        {% endif %}
        
        <!-- Search Results -->
        <div id="searchResults" style="display: none;" class="mt-4">
            <h6><i class="bi bi-cpu me-2"></i>AI Analysis Results</h6>
            <div id="searchResultsContent"></div>
        </div>
    </div>
</div>

<!-- Timeline & Conclusion -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Timeline Analysis</h5>
            </div>
            <div class="card-body">
                <div class="timeline-content">
                    {% if scenario.start_date and scenario.end_date %}
                        <p><strong>Analysis Period:</strong> {{ scenario.start_date.strftime('%Y-%m-%d') }} to {{ scenario.end_date.strftime('%Y-%m-%d') }}</p>
                    {% endif %}
                    <p>{{ scenario.predictive_model or 'Forward-looking scenario analysis based on current market conditions and economic indicators.' }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Conclusion</h5>
            </div>
            <div class="card-body">
                <div class="conclusion-content">
                    {{ scenario.analyst_notes or 'Comprehensive scenario analysis provides valuable insights for strategic investment decisions.' }}
                </div>
                
                <div class="mt-3 p-3 bg-success bg-opacity-10 rounded">
                    <h6 class="text-success"><i class="bi bi-award me-2"></i>Enhanced Analysis Summary</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5 text-success mb-1">{{ analysis.quality_score or 85 }}%</div>
                            <small class="text-muted">Overall Quality</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-info mb-1">{{ analysis.ai_confidence or 92 }}%</div>
                            <small class="text-muted">AI Confidence</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-warning mb-1">{{ analysis.risk_level or 'MEDIUM' }}</div>
                            <small class="text-muted">Risk Level</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript for Additional Features -->
<script>
async function searchAndAnalyzeStocks() {
    const input = document.getElementById('stockSearchInput');
    const symbols = input.value.trim();
    
    if (!symbols) {
        showAlert('Please enter stock symbols', 'warning');
        return;
    }
    
    const symbolArray = symbols.split(',').map(s => s.trim()).filter(s => s);
    
    if (symbolArray.length === 0) {
        showAlert('Please enter valid stock symbols', 'warning');
        return;
    }
    
    if (symbolArray.length > 3) {
        showAlert('Maximum 3 stocks allowed', 'warning');
        return;
    }
    
    // Show loading state
    const button = document.querySelector('button[onclick="searchAndAnalyzeStocks()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Analyzing...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/analyze_additional_stocks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbols: symbolArray,
                scenario_id: '{{ report.id }}',
                scenario_title: '{{ scenario.scenario_title }}',
                scenario_type: '{{ scenario.scenario_type }}',
                scenario_description: '{{ scenario.scenario_description }}'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayEnhancedSearchResults(result.recommendations);
            showAlert(`Successfully analyzed ${result.analyzed_count} stocks!`, 'success');
        } else {
            showAlert('Error: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Network error:', error);
        showAlert('Network error: ' + error.message, 'danger');
    } finally {
        // Reset button state
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>${type === 'success' ? 'Success!' : type === 'warning' ? 'Warning!' : 'Error!'}</strong> ${message}
    `;
    document.body.appendChild(alertDiv);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 4000);
}

function displayEnhancedSearchResults(recommendations) {
    const resultsDiv = document.getElementById('searchResults');
    const contentDiv = document.getElementById('searchResultsContent');
    
    if (!recommendations || recommendations.length === 0) {
        contentDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                No recommendations available for the searched stocks.
            </div>
        `;
        resultsDiv.style.display = 'block';
        return;
    }
    
    let htmlContent = '<div class="row g-3">';
    
    recommendations.forEach((stock, index) => {
        const actionColor = stock.action === 'buy' ? 'success' : (stock.action === 'sell' ? 'danger' : 'secondary');
        const returnColor = stock.expected_return > 0 ? 'success' : (stock.expected_return < 0 ? 'danger' : 'muted');
        
        htmlContent += `
            <div class="col-md-4">
                <div class="card border-${actionColor} h-100">
                    <div class="card-header bg-${actionColor} text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>${stock.ticker}
                            <span class="badge bg-light text-dark ms-2">${stock.sector.toUpperCase()}</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-${actionColor} mb-1">${stock.action.toUpperCase()}</div>
                                    <small class="text-muted">Action</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-${returnColor} mb-1">${stock.expected_return.toFixed(1)}%</div>
                                    <small class="text-muted">Expected Return</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Current Price:</small>
                                <small class="fw-bold">₹${stock.current_price.toFixed(2)}</small>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">6M Return:</small>
                                <small class="text-${stock.six_month_return > 0 ? 'success' : 'danger'}">${stock.six_month_return.toFixed(1)}%</small>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Volatility:</small>
                                <small>${stock.volatility.toFixed(1)}%</small>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">AI Confidence:</small>
                                <small class="badge bg-info">${stock.confidence}</small>
                            </div>
                        </div>
                        
                        <div class="bg-light p-2 rounded">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb me-1"></i>
                                <strong>AI Analysis:</strong> ${stock.rationale}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    htmlContent += '</div>';
    
    // Add enhanced summary
    const buyCount = recommendations.filter(s => s.action === 'buy').length;
    const holdCount = recommendations.filter(s => s.action === 'hold').length;
    const sellCount = recommendations.filter(s => s.action === 'sell').length;
    
    htmlContent += `
        <div class="mt-4 p-3 bg-info bg-opacity-10 rounded">
            <h6 class="text-info"><i class="bi bi-robot me-2"></i>AI-Enhanced Analysis Summary</h6>
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="h5 text-primary mb-1">${recommendations.length}</div>
                    <small class="text-muted">Stocks Analyzed</small>
                </div>
                <div class="col-md-3">
                    <div class="h5 text-success mb-1">${buyCount}</div>
                    <small class="text-muted">Buy Recommendations</small>
                </div>
                <div class="col-md-3">
                    <div class="h5 text-warning mb-1">${holdCount}</div>
                    <small class="text-muted">Hold Recommendations</small>
                </div>
                <div class="col-md-3">
                    <div class="h5 text-danger mb-1">${sellCount}</div>
                    <small class="text-muted">Sell Recommendations</small>
                </div>
            </div>
            <div class="mt-3 text-center">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Analysis based on current scenario context and market conditions
                </small>
            </div>
        </div>
    `;
    
    contentDiv.innerHTML = htmlContent;
    resultsDiv.style.display = 'block';
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

// Allow Enter key to trigger search
document.getElementById('stockSearchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchAndAnalyzeStocks();
    }
});

// Initialize enhanced features on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add animation to metric cards
    const metricCards = document.querySelectorAll('.card');
    metricCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate__animated', 'animate__fadeInUp');
    });
    
    // Add tooltips for enhanced features
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
.bg-gradient {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%) !important;
}

.ai-content {
    position: relative;
}

.ai-content::before {
    content: '';
    position: absolute;
    left: -15px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, #007bff, #6f42c1);
}

.animate__animated {
    animation-duration: 0.8s;
    animation-fill-mode: both;
}

.animate__fadeInUp {
    animation-name: fadeInUp;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translate3d(0, 100%, 0);
    }
    to {
        opacity: 1;
        transform: none;
    }
}

.card:hover {
    transform: translateY(-2px);
    transition: transform 0.3s ease;
}
</style>

<script>
// GitHub Upload Function
function uploadToGitHub(reportId) {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Uploading...';
    button.disabled = true;

    fetch('/api/github/upload_report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            report_id: reportId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <strong>Success!</strong> Report uploaded to GitHub: 
                <a href="${data.repo_url}" target="_blank" class="alert-link">${data.repo_name}</a>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <strong>Error!</strong> ${data.error}
            `;
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    })
    .catch(error => {
        // Show error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            <strong>Error!</strong> Failed to upload: ${error.message}
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>

{% endblock %}
