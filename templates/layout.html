<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Research QA Dashboard{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional Investment Research Platform with AI-Powered Analytics">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ResearchQA">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Core Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Phase 1 UI Enhancements -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
    
    <!-- Phase 2 UI Enhancements -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"/>
    
    <!-- Phase 3 Advanced Features -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phase3-advanced.css') }}">
    
    <!-- Chart Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Updated Plotly explicit version (avoid deprecated plotly-latest) -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    {# Optional per-page head injections (styles/meta) #}
    {% block extra_head %}{% endblock %}
    <style>
        /* Enhanced CSS Variables for Consistent Theming */
        :root {
            /* Primary Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #4361ee;
            --primary-dark: #3f37c9;
            --primary-light: #7c3aed;
            
            /* Secondary Colors */
            --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            
            /* Neutral Colors */
            --light-bg: #f8fafc;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-family-primary: 'Segoe UI', system-ui, -apple-system, 'Helvetica Neue', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 300ms ease-in-out;
            --transition-slow: 500ms ease-in-out;
        }
        
        /* Enhanced Base Styles */
        body {
            font-family: var(--font-family-primary);
            background: linear-gradient(135deg, var(--gray-50) 0%, #e2e8f0 100%);
            color: var(--gray-700);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Enhanced Card Styles */
        .card {
            border: none;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
            margin-bottom: var(--spacing-xl);
            background: var(--white);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .card.animate-card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* Enhanced Button Styles */
        .btn {
            border-radius: var(--radius-lg);
            font-weight: 600;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            color: var(--white);
        }
        
        .btn-enhanced {
            background: var(--primary-gradient);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all var(--transition-normal);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.6);
            color: white;
        }
        
        /* Enhanced Table Styles */
        .table {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: var(--font-size-xs);
            letter-spacing: 0.5px;
            color: var(--gray-600);
            border-bottom: 2px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
            transform: scale(1.01);
            transition: all var(--transition-fast);
        }
        
        /* Enhanced Navigation */
        .navbar {
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }
        
        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
            font-size: var(--font-size-xl);
        }
        
        /* Enhanced Header Gradient */
        .header-gradient {
            background: var(--primary-gradient);
            color: white;
            padding: var(--spacing-2xl) 0;
            border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
            margin-bottom: var(--spacing-2xl);
            position: relative;
            overflow: hidden;
        }
        
        .header-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }
        
        /* Enhanced Metric Cards */
        .metric-card {
            background: linear-gradient(135deg, var(--white) 0%, var(--gray-50) 100%);
            border: none;
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            text-align: center;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .metric-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .metric-value {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-sm);
        }
        
        /* Enhanced Progress Bars */
        .progress {
            height: 12px;
            border-radius: var(--radius-lg);
            background: var(--gray-200);
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            background: var(--success-gradient);
            border-radius: var(--radius-lg);
            transition: width 1s ease-in-out;
        }
        
        /* Enhanced Badges */
        .badge {
            border-radius: var(--radius-md);
            font-weight: 600;
            padding: 0.5em 1em;
        }
        
        .badge-enhanced {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }
        
        /* Enhanced Sidebar */
        .sidebar {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            backdrop-filter: blur(10px);
        }
        
        /* Enhanced Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }
        
        /* Animation Classes */
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .animate-slide-up {
            animation: slideUp 0.8s ease-out;
        }
        
        .animate-scale-in {
            animation: scaleIn 0.5s ease-out;
        }
        
        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 40px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        
        /* Enhanced Alert Styles */
        .alert {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left-color: #28a745;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left-color: #ffc107;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left-color: #dc3545;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-left-color: #17a2b8;
        }
        
        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .card {
                margin-bottom: var(--spacing-lg);
            }
            
            .header-gradient {
                padding: var(--spacing-lg) 0;
                margin-bottom: var(--spacing-lg);
            }
            
            .metric-card {
                padding: var(--spacing-lg);
            }
        }
        
        /* Loading Spinner Enhancement */
        .spinner-enhanced {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced Focus States */
        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }
        
        /* Enhanced Dropdown */
        .dropdown-menu {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: var(--spacing-sm);
            z-index: 1050; /* Higher z-index to ensure dropdowns appear above other content */
        }
        
        .dropdown-item {
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }
        
        .dropdown-item:hover {
            background: var(--primary-gradient);
            color: var(--white);
            transform: translateX(4px);
        }
        
        /* Ensure navbar elements appear above other content */
        .navbar {
            position: relative;
            z-index: 1040;
        }
        
        /* Phase 2 UI Enhancements */
        
        /* HTMX Loading States */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
        
        /* Enhanced loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Select2 Custom Styling */
        .select2-container--default .select2-selection--single {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            height: 38px;
            padding: 6px 12px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: var(--gray-700);
            line-height: 24px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        
        .select2-dropdown {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }
        
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background: var(--primary-gradient);
            color: white;
        }
        
        /* Enhanced ApexCharts Styling */
        .apexcharts-canvas {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .chart-container {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
        }
        
        /* Enhanced Sidebar Navigation */
        .sidebar {
            background: linear-gradient(180deg, var(--white) 0%, var(--gray-50) 100%);
            border-right: 1px solid var(--gray-200);
            box-shadow: var(--shadow-lg);
            min-height: 100vh;
            font-family: var(--font-family-primary);
            letter-spacing: 0.015em;
        }
        
        .sidebar .nav-link {
            padding: 0.85rem 1rem;
            margin: 0.3rem 0;
            border-radius: var(--radius-md);
            color: var(--gray-800);
            transition: all var(--transition-normal);
            border: none;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sidebar .nav-link:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .sidebar .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .sidebar .nav-link i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        /* Profile/Login Section Styling */
        .profile-section {
            border-top: 1px solid var(--gray-200);
            margin-top: auto;
            padding-top: var(--spacing-md);
        }
        
        .profile-section .nav-link {
            font-size: var(--font-size-sm);
            opacity: 0.8;
        }
        
        .profile-section .nav-link:hover {
            opacity: 1;
        }
        
        /* Enhanced Sidebar Section and Small Link Styling */
        .sidebar h6.text-muted {
            font-size: 0.82rem;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 0.8rem;
            padding-left: 0.3rem;
        }
        
        .sidebar .nav-link.small {
            font-size: 0.875rem;
            padding: 0.5rem 0.7rem;
            margin: 0.1rem 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--gray-700);
        }
        
        .sidebar .nav-link.py-1.small i {
            font-size: 0.9rem;
            width: 18px;
            flex-shrink: 0;
        }
        
        .sidebar .text-muted.small.fw-semibold,
        .sidebar .nav-link.text-muted.small.fw-semibold {
            font-size: 0.82rem;
            font-weight: 600;
            padding: 0.5rem 0.8rem;
            letter-spacing: 0.03em;
            color: var(--gray-600) !important;
            text-transform: uppercase;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        /* Enhanced Content Area */
        .main-content {
            padding: var(--spacing-lg);
            background: var(--gray-50);
            min-height: 100vh;
        }
        
        /* Dynamic Content Transitions */
        .fade-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        
        .fade-transition.htmx-swapping {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        /* Enhanced Form Controls */
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        .btn-enhanced:focus {
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1050;
                width: 280px;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: var(--spacing-md);
            }
        }
        
        /* Dark mode overrides using Bootstrap 5.3 color modes */
        [data-bs-theme='dark'] body {
            background: linear-gradient(135deg, #0b1220 0%, #111827 100%);
            color: #e5e7eb;
        }
        [data-bs-theme='dark'] .card,
        [data-bs-theme='dark'] .chart-container {
            background: #0f172a;
            color: #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        [data-bs-theme='dark'] .main-content { background: #0b1220; }
        [data-bs-theme='dark'] .sidebar {
            background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
            border-right: 1px solid #1f2937;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        [data-bs-theme='dark'] .dropdown-menu { background: #0f172a; border: 1px solid #1f2937; }
        [data-bs-theme='dark'] .dropdown-item { color: #e5e7eb; }
        [data-bs-theme='dark'] .dropdown-item:hover { color: #ffffff; }
        [data-bs-theme='dark'] .table thead th {
            color: #cbd5e1;
            border-bottom-color: #1f2937;
            background: #0f172a;
        }
        [data-bs-theme='dark'] .table-hover tbody tr:hover { background-color: rgba(148, 163, 184, 0.1); }
        [data-bs-theme='dark'] .progress { background: #1f2937; }
        [data-bs-theme='dark'] .alert-success { background: linear-gradient(135deg, #1e3a2a 0%, #234f32 100%); border-left-color: #34d399; }
        [data-bs-theme='dark'] .alert-warning { background: linear-gradient(135deg, #3a2e00 0%, #4b3b05 100%); border-left-color: #fbbf24; }
        [data-bs-theme='dark'] .alert-danger  { background: linear-gradient(135deg, #3b0d0d 0%, #4c0d0d 100%); border-left-color: #f87171; }
        [data-bs-theme='dark'] .alert-info    { background: linear-gradient(135deg, #07304a 0%, #0b3a56 100%); border-left-color: #38bdf8; }
        [data-bs-theme='dark'] .select2-dropdown { background: #0f172a; border-color: #1f2937; }
        [data-bs-theme='dark'] .select2-container--default .select2-selection--single { border-color: #334155; background: #0f172a; color: #e5e7eb; }
        [data-bs-theme='dark'] .select2-container--default .select2-results__option--highlighted[aria-selected] { color: #fff; }
        
        /* Tiny style for theme toggle button */
        .theme-toggle-btn { border-color: rgba(255,255,255,0.35) !important; }
        .theme-toggle-btn:hover { transform: translateY(-1px); }
    </style>
    
    <script>
        // Apply saved or preferred theme early to avoid FOUC
        (function() {
            try {
                var saved = localStorage.getItem('theme');
                var preferred = saved || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                document.documentElement.setAttribute('data-bs-theme', preferred);
                document.documentElement.setAttribute('data-theme', preferred);
            } catch (e) {
                // no-op
            }
        })();
    </script>
    <!-- Expose a lightweight current user identifier for front-end code artifact scripts -->
    <script>
        window.currentUser = "{{ session.analyst_name or session.investor_name or session.admin_name or session.username or '' }}";
    </script>
</head>
<body>
    <!-- Enhanced Navigation with Animations -->
        <!-- Enhanced Navigation with Animations -->
    <nav class="navbar navbar-expand-lg navbar-dark animate__animated animate__fadeInDown" style="background: var(--primary-gradient);">
        <div class="container-fluid">
            <!-- Sidebar Toggle Button -->
            <button class="btn btn-outline-light sidebar-toggle d-lg-none me-2" type="button">
                <i class="bi bi-list"></i>
            </button>
            
          <a class="navbar-brand animate__animated animate__bounceIn d-flex align-items-center" href="/">
             {% if session.user_role == 'analyst' %}
             <!-- PredictRAM Analyst Logo for Analyst Users -->
             <img src="{{ url_for('static', filename='images/predictram-analyst-logo.png') }}" 
                 alt="PredictRAM Analyst" 
                 class="me-2 rounded-3 shadow-sm" 
                 style="height: 40px; width: auto; object-fit: contain;">
             {% elif session.user_role == 'investor' %}
             <!-- Predictram Logo for Investor Users -->
             <img src="https://predictram.com/images/logo.png" 
                 alt="Predictram" 
                 class="me-2 rounded-3 shadow-sm" 
                 style="height: 40px; width: auto; object-fit: contain;" loading="lazy">
             {% else %}
             <i class="bi bi-graph-up-arrow me-2"></i>
             {% endif %}
             Research QA Platform
          </a>
            
            <!-- Right side navigation: Theme toggle + Profile/Login -->
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <!-- Theme toggle (visible to all) -->
                <button class="btn btn-sm btn-outline-light me-2 theme-toggle-btn" id="themeToggleBtn" type="button" title="Toggle dark/light mode" aria-label="Toggle theme">
                    <i class="bi" id="themeIcon"></i>
                </button>
                {% if session.user_role == 'investor' and session.investor_name %}
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle px-3" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>{{ session.investor_name }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/investor_dashboard">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a></li>
                        <li><a class="dropdown-item" href="/retail_investor_hub">
                            <i class="bi bi-piggy-bank me-2"></i>Simple Investing Hub
                        </a></li>
                        <li><a class="dropdown-item" href="/investor/risk_profile">
                            <i class="bi bi-shield-check me-2"></i>Risk Profiling
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/investor_logout">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
                {% elif session.user_role == 'analyst' and session.analyst_name %}
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle px-3" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>{{ session.analyst_name }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/analyst_dashboard">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a></li>
                        <li><a class="dropdown-item" href="/analyst/certificate_request">
                            <i class="bi bi-award me-2"></i>Request Certificate
                        </a></li>
                        <li><a class="dropdown-item" href="/analyst/certificate_status">
                            <i class="bi bi-check-circle me-2"></i>Certificate Status
                        </a></li>
                        <li><a class="dropdown-item" href="/analyst/{{ session.analyst_name }}/profile/edit">
                            <i class="bi bi-pencil-square me-2"></i>Edit Profile
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/analyst_logout">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
                {% else %}
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle px-3" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-plus me-1"></i>Join Us
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/register_analyst">
                            <i class="bi bi-person-badge me-2"></i>Register as Analyst
                        </a></li>
                        <li><a class="dropdown-item" href="/analyst_login">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Analyst Login
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/investor_login">
                            <i class="bi bi-briefcase me-2"></i>Investor Login
                        </a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Enhanced Layout with Sidebar -->
    <div class="d-flex">
        <!-- Left Sidebar - Main Features -->
        <div class="sidebar d-flex flex-column p-3 px-4" style="width: 290px;">
            <div class="mb-4">
                <h6 class="text-muted text-uppercase small fw-bold mb-3" data-aos="fade-right">Main Features</h6>
                
                <!-- Dashboard (Role-Aware) -->
                <a href="{% if session.user_role == 'investor' %}/investor_dashboard{% elif session.user_role == 'analyst' %}/analyst_dashboard{% elif session.user_role == 'admin' %}/admin_dashboard{% else %}/{% endif %}" class="nav-link mb-3" data-aos="fade-right" data-aos-delay="100">
                    <i class="bi bi-speedometer2"></i>Dashboard
                </a>

                <!-- Code Artifacts Dashboard -->
                <a href="/code_artifacts" class="nav-link mb-3" data-aos="fade-right" data-aos-delay="110">
                    <i class="bi bi-folder2-open"></i>Code Artifacts
                </a>

                <!-- VS Terminal -->
                <a href="/vs_terminal" class="nav-link mb-3" data-aos="fade-right" data-aos-delay="120">
                    <i class="bi bi-terminal"></i>VS Terminal
                </a>

                <!-- Published Catalog -->
                <a href="/published" class="nav-link mb-3" data-aos="fade-right" data-aos-delay="130">
                    <i class="bi bi-collection"></i>Published Catalog
                </a>
                
                <!-- Admin Section (Role-Based) -->
                {% if session.user_role == 'admin' or session.get('admin_authenticated') %}
                <div class="mb-4" data-aos="fade-right" data-aos-delay="125">
                    <div class="nav-link text-muted small fw-semibold mb-2">
                        <i class="bi bi-shield-lock"></i>Admin Management
                    </div>
                    <div class="ps-3">
                        <a href="/admin_dashboard" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-speedometer2"></i>Admin Dashboard
                        </a>
                        <a href="/admin/create_investor" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-person-plus"></i>Create Investor
                        </a>
                        <a href="/admin/create_analyst" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-person-badge"></i>Create Analyst
                        </a>
                        <a href="/admin/investor_registrations" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-people"></i>Investor Registrations
                        </a>
                        <a href="/admin/investor_risk_profiles" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-shield-check"></i>Investor Risk Profiles
                        </a>
                        <a href="/admin/certificates" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-award"></i>Manage Certificates
                        </a>
                        <a href="/admin/research_topics" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-tags"></i>Research Topics
                        </a>
                        <a href="/admin/performance" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-graph-up"></i>Admin Analytics
                        </a>
                        <a href="/admin/usage_plans" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-speedometer"></i>Usage & Plans
                        </a>
                        <a href="/mutual_funds" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-currency-exchange"></i>Mutual Fund
                        </a>
                        <a href="/options_analyzer" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-graph-up-arrow"></i>Options Analyzer
                        </a>
                        <a href="/mutual_funds" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-bank"></i>Mutual Funds
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Reports Section -->
                <div class="mb-4" data-aos="fade-right" data-aos-delay="150">
                    <div class="nav-link text-muted small fw-semibold mb-2">
                        <i class="bi bi-file-text"></i>Reports & Analysis
                    </div>
                    <div class="ps-3">
                        <a href="/analyze_new" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-plus-circle"></i>Analyze New Report
                        </a>
                        {% if session.get('user_role') == 'admin' or session.get('analyst_id') %}
                        <a href="/report_hub" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-collection"></i>Report Hub
                        </a>
                        {% endif %}
                        <a href="/compare_reports" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-bar-chart"></i>Compare Reports
                        </a>
                        <a href="/research_templates" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-clipboard-data"></i>Research Templates
                        </a>
                    </div>
                </div>
                
                <!-- AI Tools Section -->
                <div class="mb-4" data-aos="fade-right" data-aos-delay="200">
                    <div class="nav-link text-muted small fw-semibold mb-2">
                        <i class="bi bi-robot"></i>AI Tools
                    </div>
                    <div class="ps-3">
                        <a href="#" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-cpu"></i>AI Simulation Engine
                        </a>
                        <a href="/ai_research_assistant" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-chat-dots"></i>AI Research Assistant
                        </a>
                        <!-- hAi-Edge ML Portfolio temporarily disabled -->
                        <!-- <a href="/hai-edge" class="nav-link py-1 small" hx-boost="true" style="color: #4361ee; font-weight: 600;">
                            <i class="bi bi-brain" style="color: #4361ee;"></i>hAi-Edge ML Portfolio
                        </a> -->
                    </div>
                </div>
                
                <!-- Investment Tools Section (Investors Only) -->
                {% if session.get('investor_authenticated') or session.get('user_role') == 'investor' %}
                <div class="mb-4" data-aos="fade-right" data-aos-delay="250">
                    <div class="nav-link text-muted small fw-semibold mb-2">
                        <i class="bi bi-graph-up"></i>Investment Tools
                    </div>
                    <div class="ps-3">
                        <a href="/investor_dashboard" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-person-check"></i>Investor Dashboard
                        </a>
                        <a href="/portfolio" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-briefcase"></i>Portfolio Analysis
                        </a>
                        <a href="/portfolio_stress_test" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-shield-exclamation"></i>Stress Test
                        </a>
                        <a href="/mutual_funds" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-currency-exchange"></i>Mutual Fund
                        </a>
                        <a href="/options_analyzer" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-graph-up-arrow"></i>Options Analyzer
                        </a>
                        <!-- Newly added investor links -->
                        <a href="/scenario_analysis_dashboard" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-diagram-3"></i>Scenario Analysis Dashboard
                        </a>
                        <a href="/run_backtest" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-play-circle"></i>Run Backtest
                        </a>
                        <a href="/test_additional_stocks" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-stars"></i>Test Additional Stocks
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Analytics Section -->
                <div class="mb-4" data-aos="fade-right" data-aos-delay="300">
                    <div class="nav-link text-muted small fw-semibold mb-2">
                        <i class="bi bi-graph-up-arrow"></i>Analytics
                    </div>
                    <div class="ps-3">
                        <a href="/analysts_list" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-table"></i>Analysts Analytics
                        </a>
                        <a href="/test_analyst_performance_debug" class="nav-link py-1 small" hx-boost="true">
                            <i class="bi bi-graph-up"></i>Performance Test
                        </a>
                        
                    </div>
                </div>
                
                <!-- Other Tools -->
                <div class="mb-4" data-aos="fade-right" data-aos-delay="350">
                    <a href="/alerts" class="nav-link">
                        <i class="bi bi-bell"></i>Alerts & Notifications
                    </a>
                    <a href="/github/setup" class="nav-link">
                        <i class="fab fa-github"></i>GitHub Integration
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content flex-grow-1">
            <div class="container-fluid px-4">
                <div class="header-gradient mb-5 animate__animated animate__fadeInUp">
                    <div class="container">
                        {% block header %}{% endblock %}
                    </div>
                </div>
                
                <div class="container">
                    <!-- Flash Messages with Enhanced Styling -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            <div id="flash-messages" class="mb-4">
                                {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show animate__animated animate__bounceInDown" role="alert">
                                    {% if category == 'success' %}
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                    {% elif category == 'error' or category == 'danger' %}
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    {% elif category == 'warning' %}
                                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                                    {% else %}
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                    {% endif %}
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                {% if session.get('user_role') in ['investor','analyst'] %}
                    {% set plan = effective_plan %}
                    {% if plan and ('retail' in plan|lower or 'small' in plan|lower) %}
                        <div class="alert alert-info d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-info-circle me-2"></i>
                                You're on the {{ 'Retail' if 'retail' in plan|lower else 'Small Analyst' }} plan. Daily limits apply. Need more? Upgrade to Pro.
                            </div>
                            <a class="btn btn-sm btn-primary" href="/request_upgrade">Request Upgrade</a>
                        </div>
                    {% endif %}
                    {% if soft_limit and soft_limit.active %}
                        <div class="alert alert-warning d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-cloud-slash me-2"></i>
                                You're viewing previous data. Live updates are paused due to plan limits. Last updated values are shown.
                            </div>
                            <small class="text-muted">Since: {{ soft_limit.since or 'recent' }}</small>
                        </div>
                    {% endif %}
                {% endif %}

                {% block content %}{% endblock %}
            </div>
        </div>
    </div>
</div>

    <!-- Disclaimer Footer -->
    <footer class="container-fluid bg-light py-3 mt-5 border-top">
        <div class="container">
            <small class="text-muted d-block text-center" style="font-size:0.95rem; line-height:1.6;">
                <strong>Disclaimer:</strong> PredictRAM ParamsData Provider Pvt Ltd is registered with the Securities and Exchange Board of India (SEBI) as a Research Analyst under Registration No. INH000022400 in accordance with the SEBI (Research Analyst) Regulations, 2014.<br>
                The insights, recommendations, research content, and outputs derived from proprietary machine learning models are provided for informational and educational purposes only. These do not constitute investment advice, solicitation, or an offer to buy/sell any financial instruments.<br>
                All machine learning models, dashboards, research content, and analytical tools are proprietary and copyright protected intellectual property of PredictRAM. Any unauthorized reproduction, distribution, or use is strictly prohibited and may attract legal consequences.<br>
                Investments in equity, derivatives, and other securities are subject to market risks. Past performance is not indicative of future results. While reasonable care has been taken, PredictRAM and its employees shall not be liable for any direct or indirect loss or damage arising from use or reliance on the information provided.<br>
                Users are strongly advised to consult with a SEBI-registered Research Analyst and/or a SEBI-registered Investment Advisor before making any investment decisions.
            </small>
        </div>
    </footer>

    <!-- Enhanced Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Phase 2 Enhanced Interaction Libraries -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    
    <script>
        // Theme helpers
        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light';
        }
        function updateThemeMetaColor(theme) {
            var meta = document.querySelector('meta[name="theme-color"]');
            if (meta) meta.setAttribute('content', theme === 'dark' ? '#0b1220' : '#0d6efd');
        }
        function updateThemeToggleIcon(theme) {
            var icon = document.getElementById('themeIcon');
            if (!icon) return;
            icon.className = 'bi ' + (theme === 'dark' ? 'bi-sun-fill' : 'bi-moon-fill');
        }
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            document.documentElement.setAttribute('data-theme', theme);
            try { localStorage.setItem('theme', theme); } catch(e) {}
            updateThemeMetaColor(theme);
            updateThemeToggleIcon(theme);
            // Set global for ApexCharts
            window.apexThemeMode = theme === 'dark' ? 'dark' : 'light';
        }
        // Initialize toggle button state on load
        document.addEventListener('DOMContentLoaded', function() {
            updateThemeToggleIcon(getCurrentTheme());
            var btn = document.getElementById('themeToggleBtn');
            if (btn) {
                btn.addEventListener('click', function() {
                    var newTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
                    applyTheme(newTheme);
                });
            }
        });

        // Initialize Enhanced UI Components
        $(document).ready(function() {
            // Ensure all dropdowns are properly initialized
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            dropdownElementList.map(function (dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });
            
            // Configure Toastr for better notifications
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };

            // Initialize Bootstrap components
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    animation: true,
                    delay: { show: 500, hide: 100 }
                });
            });

            // Initialize popovers
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });

            // Add animation classes to cards on page load
            $('.card').each(function(index) {
                $(this).addClass('animate__animated animate__fadeInUp');
                $(this).css('animation-delay', (index * 0.1) + 's');
            });

            // Enhanced button interactions
            $('.btn').on('mouseenter', function() {
                $(this).addClass('animate__animated animate__pulse');
            }).on('mouseleave', function() {
                $(this).removeClass('animate__animated animate__pulse');
            });

            // Auto-hide flash messages after 5 seconds
            setTimeout(function() {
                $('#flash-messages .alert').each(function() {
                    $(this).addClass('animate__animated animate__fadeOutUp');
                    setTimeout(() => {
                        $(this).alert('close');
                    }, 500);
                });
            }, 5000);

            // Enhanced table row interactions
            $('.table-hover tbody tr').hover(
                function() {
                    $(this).addClass('animate__animated animate__pulse animate__faster');
                },
                function() {
                    $(this).removeClass('animate__animated animate__pulse animate__faster');
                }
            );

            // Smooth scrolling for anchor links
            $('a[href*="#"]').not('[href="#"]').not('[href="#0"]').click(function(event) {
                if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') && location.hostname == this.hostname) {
                    var target = $(this.hash);
                    target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                    if (target.length) {
                        event.preventDefault();
                        $('html, body').animate({
                            scrollTop: target.offset().top - 100
                        }, 1000, "easeInOutExpo");
                    }
                }
            });
            
            // Phase 2 UI Enhancements Initialization
            initializePhase2Enhancements();
        });
        
        // Phase 2: Enhanced Interactions Initialization
        function initializePhase2Enhancements() {
            // Initialize AOS (Animate On Scroll)
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 1000,
                    once: true,
                    offset: 100,
                    easing: 'ease-in-out',
                    delay: 100
                });
            }
            
            // Initialize Select2 for all select elements
            if (typeof $.fn.select2 !== 'undefined') {
                $('.select2').select2({
                    theme: 'bootstrap4',
                    placeholder: 'Select an option...',
                    allowClear: true,
                    width: '100%'
                });
                
                // Enhanced select styling
                $('.select-enhanced').select2({
                    theme: 'bootstrap4',
                    placeholder: 'Choose...',
                    allowClear: true,
                    width: '100%',
                    dropdownCssClass: 'animate__animated animate__fadeIn animate__faster'
                });
            }
            
            // HTMX Configuration
            if (typeof htmx !== 'undefined') {
                // Global HTMX configuration
                htmx.config.requestClass = 'htmx-request';
                htmx.config.settleDelay = 100;
                htmx.config.defaultSwapStyle = 'innerHTML';
                
                // Add loading indicators to HTMX requests
                document.body.addEventListener('htmx:beforeRequest', function(evt) {
                    const target = evt.target;
                    if (target.classList.contains('btn')) {
                        const originalText = target.innerHTML;
                        target.setAttribute('data-original-text', originalText);
                        target.innerHTML = '<span class="loading-spinner me-2"></span>Loading...';
                        target.disabled = true;
                    }
                });
                
                document.body.addEventListener('htmx:afterRequest', function(evt) {
                    const target = evt.target;
                    if (target.classList.contains('btn') && target.hasAttribute('data-original-text')) {
                        target.innerHTML = target.getAttribute('data-original-text');
                        target.removeAttribute('data-original-text');
                        target.disabled = false;
                    }
                });
                
                // Add fade transitions to HTMX swaps
                document.body.addEventListener('htmx:beforeSwap', function(evt) {
                    evt.target.classList.add('fade-transition', 'htmx-swapping');
                });
                
                document.body.addEventListener('htmx:afterSwap', function(evt) {
                    evt.target.classList.remove('htmx-swapping');
                    // Reinitialize enhancements for new content
                    initializeNewContent(evt.target);
                });
            }
            
            // Initialize enhanced sidebar navigation
            initializeSidebarNavigation();
        }
        
        // Initialize new content after HTMX loads
        function initializeNewContent(container) {
            // Reinitialize Select2 for new selects
            $(container).find('.select2').select2({
                theme: 'bootstrap4',
                placeholder: 'Select an option...',
                allowClear: true,
                width: '100%'
            });
            
            // Reinitialize tooltips for new elements
            const tooltips = container.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(function(tooltip) {
                new bootstrap.Tooltip(tooltip);
            });
            
            // Add animations to new cards
            $(container).find('.card').each(function(index) {
                $(this).addClass('animate__animated animate__fadeInUp');
                $(this).css('animation-delay', (index * 0.1) + 's');
            });
            
            // Refresh AOS for new elements
            if (typeof AOS !== 'undefined') {
                AOS.refresh();
            }
        }
        
        // Enhanced Sidebar Navigation
        function initializeSidebarNavigation() {
            // Mobile sidebar toggle
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768 && 
                        !sidebar.contains(e.target) && 
                        !sidebarToggle.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                });
            }
            
            // Active link highlighting
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
                
                // Add hover animations
                link.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateX(4px)';
                });
                
                link.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('active')) {
                        this.style.transform = 'translateX(0)';
                    }
                });
            });
        }
        
        // Enhanced ApexCharts Integration
        function createEnhancedApexChart(elementId, options) {
            const defaultOptions = {
                chart: {
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800,
                        animateGradually: {
                            enabled: true,
                            delay: 150
                        },
                        dynamicAnimation: {
                            enabled: true,
                            speed: 350
                        }
                    },
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    },
                    background: 'transparent'
                },
                theme: {
                    mode: (window.apexThemeMode || (document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light')),
                    palette: 'palette1'
                },
                grid: {
                    borderColor: (document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#1f2937' : '#e2e8f0'),
                    strokeDashArray: 3
                },
                tooltip: {
                    theme: (document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light'),
                    style: {
                        fontSize: '12px',
                        fontFamily: 'Segoe UI, system-ui, sans-serif'
                    }
                }
            };
            
            // Merge user options with defaults
            const mergedOptions = $.extend(true, {}, defaultOptions, options);
            
            const chart = new ApexCharts(document.querySelector(elementId), mergedOptions);
            chart.render();
            
            return chart;
        }
        
        // Dynamic content loading with HTMX
        function loadContent(url, target, showLoading = true) {
            if (showLoading) {
                $(target).html('<div class="text-center p-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading...</p></div>');
            }
            
            htmx.ajax('GET', url, target);
        }
        
        // Enhanced form submission with validation
        function submitEnhancedForm(formId, onSuccess, onError) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Clear previous errors
                form.querySelectorAll('.is-invalid').forEach(field => {
                    field.classList.remove('is-invalid');
                });
                
                form.querySelectorAll('.invalid-feedback').forEach(feedback => {
                    feedback.textContent = '';
                });
                
                // Add loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="loading-spinner me-2"></span>Processing...';
                submitBtn.disabled = true;
                
                // Submit via HTMX
                htmx.ajax('POST', form.action, {
                    source: form,
                    swap: 'none'
                }).then(function(response) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    
                    if (onSuccess) onSuccess(response);
                }).catch(function(error) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    
                    if (onError) onError(error);
                });
            });
        }

        // Enhanced notification functions
        function showSuccessNotification(message, title = 'Success') {
            toastr.success(message, title);
        }

        function showErrorNotification(message, title = 'Error') {
            toastr.error(message, title);
        }

        function showWarningNotification(message, title = 'Warning') {
            toastr.warning(message, title);
        }

        function showInfoNotification(message, title = 'Info') {
            toastr.info(message, title);
        }

        // Enhanced confirmation dialogs with SweetAlert2
        function confirmAction(title, text, confirmText = 'Yes', cancelText = 'No') {
            return Swal.fire({
                title: title,
                text: text,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: 'var(--gray-500)',
                confirmButtonText: confirmText,
                cancelButtonText: cancelText,
                reverseButtons: true,
                customClass: {
                    popup: 'animate__animated animate__zoomIn'
                }
            });
        }

        // Enhanced loading states
        function showLoadingSpinner(element) {
            const spinner = '<div class="spinner-enhanced mx-auto"></div>';
            $(element).html(spinner);
        }

        function hideLoadingSpinner(element, originalContent) {
            $(element).html(originalContent);
        }

        // Enhanced form validation feedback
        function showFieldError(fieldId, message) {
            const field = $('#' + fieldId);
            field.addClass('is-invalid');
            field.siblings('.invalid-feedback').remove();
            field.after('<div class="invalid-feedback animate__animated animate__shakeX">' + message + '</div>');
        }

        function clearFieldError(fieldId) {
            const field = $('#' + fieldId);
            field.removeClass('is-invalid');
            field.siblings('.invalid-feedback').remove();
        }

        // Page transition effects
        function navigateWithAnimation(url) {
            $('body').addClass('animate__animated animate__fadeOut');
            setTimeout(function() {
                window.location.href = url;
            }, 300);
        }

        // Enhanced number counter animation for metrics
        function animateValue(element, start, end, duration) {
            // Handle both element objects and selector strings
            const obj = (typeof element === 'string') ? document.querySelector(element) : element;
            if (!obj) return; // Exit if element not found
            
            const range = end - start;
            const minTimer = 50;
            let stepTime = Math.abs(Math.floor(duration / range));
            stepTime = Math.max(stepTime, minTimer);
            
            const startTime = new Date().getTime();
            const endTime = startTime + duration;
            
            function run() {
                try {
                    const now = new Date().getTime();
                    const remaining = Math.max((endTime - now) / duration, 0);
                    const value = Math.round(end - (remaining * range));
                    if (obj && obj.innerHTML !== undefined) {
                        obj.innerHTML = value.toLocaleString();
                    }
                    
                    if (value == end) {
                        clearInterval(timer);
                    }
                } catch (error) {
                    console.error('Error in animateValue run function:', error);
                    clearInterval(timer);
                }
            }
            
            const timer = setInterval(run, stepTime);
            run();
        }

        // Initialize metric animations when they come into view
        function initMetricAnimations() {
            try {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        try {
                            if (entry.isIntersecting) {
                                const element = entry.target;
                                if (element) {
                                    const finalValue = parseInt(element.dataset.value) || parseInt(element.textContent.replace(/[^\d]/g, ''));
                                    if (!isNaN(finalValue)) {
                                        animateValue(element, 0, finalValue, 2000);
                                    }
                                    observer.unobserve(element);
                                }
                            }
                        } catch (error) {
                            console.error('Error in IntersectionObserver entry processing:', error);
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('.metric-value').forEach(el => {
                    if (el) {
                        observer.observe(el);
                    }
                });
            } catch (error) {
                console.error('Error initializing metric animations:', error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMetricAnimations();
        });
    </script>
    
    <!-- Phase 3: Advanced Features JavaScript -->
    <script src="{{ url_for('static', filename='js/phase3-advanced.js') }}"></script>
    
    <!-- Additional Scripts Block for Child Templates -->
    {% block extra_js %}{% endblock %}
    {% block scripts %}{% endblock %}
</body>
</html>