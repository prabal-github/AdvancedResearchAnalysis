<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VS Terminal</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root { --bg:#1e1e1e; --sidebar:#252526; --panel:#1e1e1e; --border:#333; --accent:#0e639c; --accent-hover:#1177bb; --text:#d4d4d4; --muted:#9e9e9e; }
* { box-sizing:border-box; }
html,body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--text); font-family:Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif; }
body { display:flex; flex-direction:column; }
.vs-frame { flex:1; display:grid; grid-template-columns:40px 270px minmax(0,1fr) 370px; grid-template-rows:1fr 24px; height:100%; width:100%; overflow:hidden; }
.activity-bar { background:#333; display:flex; flex-direction:column; align-items:center; padding:4px 0; gap:2px; border-right:1px solid var(--border); }
.activity-bar button { background:none; border:none; color:var(--muted); cursor:pointer; font-size:16px; width:32px; height:32px; padding:0; display:flex; justify-content:center; align-items:center; position:relative; border-radius:4px; margin:2px 0; transition: all 0.2s ease; }
.activity-bar button.active, .activity-bar button:hover { color:var(--text); background:#404040; }
.activity-bar button.active::before { content:""; position:absolute; left:0; top:2px; bottom:2px; width:2px; background:#007acc; border-radius:0 2px 2px 0; }
.sidebar { background:var(--sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:auto; }
.sidebar-section { padding:12px 14px 8px; border-bottom:1px solid var(--border); }
.sidebar-section h4 { margin:0 0 8px; font-size:12px; font-weight:600; letter-spacing:.5px; color:var(--muted); }
.model-list, .file-list { list-style:none; margin:0; padding:0; max-height:180px; overflow:auto; font-size:13px; }
.model-list li, .file-list li { padding:6px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:6px; }
.model-list li:hover, .file-list li:hover { background:#2d2d2d; }
.model-list li.selected { background:#094771; color:#fff; }
.model-list li i, .file-list li i { color:#ce9178; }
select, textarea, input { width:100%; background:#2d2d2d; border:1px solid #444; color:var(--text); padding:6px 8px; border-radius:4px; font-size:13px; }
select:focus, textarea:focus, input:focus { outline:1px solid #555; }
.main { display:flex; flex-direction:column; min-width:0; position:relative; min-height:0; }
.editor-wrapper { position:relative; border-bottom:1px solid var(--border); min-width:0; height:60%; min-height:120px; }
.editor-wrapper.resizing { user-select:none; cursor:row-resize; }
.CodeMirror { height:100%; }
.resize-handle { height:6px; background:linear-gradient(to bottom,#2a2a2a,#232323); border-top:1px solid #2c2c2c; border-bottom:1px solid #1a1a1a; cursor:row-resize; position:relative; }
.resize-handle::after { content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:60px; height:2px; background:#444; border-radius:2px; }
.run-button { position:absolute; top:10px; right:16px; background:var(--accent); border:none; color:#fff; padding:6px 14px; border-radius:4px; cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px; }
.run-button:hover { background:var(--accent-hover); }
.lower-panels { display:flex; flex-direction:column; flex:1 1 0; min-height:0; overflow:hidden; }
.tab-bar { display:flex; background:#252526; border-bottom:1px solid var(--border); }
.tab-bar button { background:none; border:none; color:var(--muted); padding:6px 14px; cursor:pointer; font-size:12px; }
.tab-bar button.active, .tab-bar button:hover { color:var(--text); background:#1e1e1e; }
.tab-content { flex:1 1 0; display:none; overflow:auto; padding:12px 16px; font-size:13px; min-width:0; }
.tab-content.active { display:block; }
pre.output { white-space:pre-wrap; margin:0; font-family:Consolas,monospace; line-height:1.35; max-height:100%; overflow:auto; }
.right-panel { background:var(--panel); border-left:1px solid var(--border); display:flex; flex-direction:column; position:relative; min-height:0; overflow:hidden; }
.panel-header { padding:10px 14px; font-size:13px; font-weight:600; letter-spacing:.5px; background:#252526; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.chat-history { flex:1 1 0; overflow-y:auto; overflow-x:hidden; padding:12px 14px; display:flex; flex-direction:column; gap:10px; font-size:13px; scroll-behavior:auto; min-height:0; }
.jump-latest-btn { position:absolute; right:10px; bottom:88px; background:#094771; color:#fff; border:none; font-size:11px; padding:4px 8px; border-radius:4px; cursor:pointer; display:none; box-shadow:0 2px 4px rgba(0,0,0,.4); }
.jump-latest-btn:hover { background:#0e73b1; }
#chatBottomAnchor { height:1px; }
#pingStatus { font-size:10px; margin-top:4px; color:var(--muted); }
.msg { padding:10px 12px; border-radius:6px; max-width:100%; line-height:1.4; white-space:pre-wrap; }
.msg.user { background:#2d2d2d; align-self:flex-end; }
.msg.ai { background:#1f2933; border:1px solid #2f3b44; }
.msg.system { background:#333; font-style:italic; }
.chat-input-area { border-top:1px solid var(--border); padding:10px; display:flex; flex-direction:column; gap:6px; flex:0 0 auto; flex-shrink:0; }
.chat-input-row { display:flex; gap:8px; }
.chat-input-row textarea { flex:1; height:70px; resize:vertical; }
.primary-btn { background:var(--accent); border:none; color:#fff; padding:8px 16px; font-size:13px; border-radius:4px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
.primary-btn:hover { background:var(--accent-hover); }
.status-bar { grid-column:1 / span 4; background:#007acc; color:#fff; font-size:12px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; }
.status-bar span { opacity:.9; }
.badge { background:#444; padding:2px 6px; border-radius:4px; font-size:11px; margin-left:6px; }
.report-actions { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
.secondary-btn { background:#2d2d2d; border:1px solid #444; color:var(--text); padding:6px 10px; font-size:12px; border-radius:4px; cursor:pointer; }
.secondary-btn:hover { background:#333; }
/* Added diagnostics panel styling */
#diagPanel { font-size:11px; line-height:1.4; max-height:140px; overflow:auto; background:#1b1b1b; border:1px solid #333; padding:6px 8px; border-radius:4px; margin-top:6px; white-space:pre-wrap; }
#configForm input { width:100%; margin-bottom:4px; }
/* Code block styling (moved correctly inside style tag) */
#chatHistory .code-block { position:relative; background:#111c24; border:1px solid #244556; padding:8px 8px 32px 8px; border-radius:6px; font-family:Consolas,monospace; font-size:12px; overflow:auto; max-height:260px; }
#chatHistory .code-block pre { margin:0; white-space:pre; }
#chatHistory .code-tools { position:absolute; right:6px; bottom:4px; display:flex; gap:4px; }
#chatHistory .code-tools button { background:#094771; color:#fff; border:none; font-size:10px; padding:4px 6px; border-radius:4px; cursor:pointer; }
#chatHistory .code-tools button:hover { background:#0e73b1; }
/* Add-to-report button inside chat messages */
.msg.ai { position:relative; }
.msg.ai .to-report-btn { position:absolute; top:4px; right:4px; background:#094771; border:none; color:#fff; font-size:10px; padding:3px 6px; border-radius:4px; cursor:pointer; opacity:0.8; }
.msg.ai .to-report-btn:hover { background:#0e73b1; opacity:1; }
/* Ensure result tab uses flex so its pre can scroll independently */
#resultTab.active { display:flex; flex-direction:column; }
#resultOutput { flex:1 1 auto; }
#terminalTab.active { display:flex; flex-direction:column; }
.terminal-window { background:#111; border:1px solid #333; padding:8px; border-radius:6px; font-family:Consolas,monospace; font-size:12px; line-height:1.3; height:260px; overflow:auto; white-space:pre-wrap; }
.terminal-window .line.in { color:#9cdcfe; }
.terminal-window .line.out { color:#d4d4d4; }
.terminal-window .line.err { color:#f48771; }
.terminal-window .line.sys { color:#6a9955; font-style:italic; }
.terminal-input-row { display:flex; align-items:center; gap:6px; margin-top:8px; }
.terminal-input-row span { font-family:Consolas,monospace; font-size:12px; color:#888; }
.terminal-input-row input { flex:1; font-family:Consolas,monospace; font-size:12px; background:#1e1e1e; color:#eee; border:1px solid #444; border-radius:4px; padding:4px 6px; }
#chartsTab.active { display:flex; flex-direction:column; }
/* Report tab independent scroll */
#reportTab.active { display:flex; flex-direction:column; }
#reportTab .report-actions { flex:0 0 auto; }
#reportContent { flex:1 1 auto; overflow:auto; }
/* Published models section */
.sidebar-section h4 + div { display:none; }
.sidebar-section h4.active + div { display:block; }

/* Right Panel Tabs */
.right-panel-tabs { 
    display:flex; 
    background:#252526; 
    border-bottom:1px solid var(--border); 
    margin:0; 
    padding:0; 
}
.right-panel-tabs button { 
    background:none; 
    border:none; 
    color:var(--muted); 
    padding:10px 16px; 
    cursor:pointer; 
    font-size:12px; 
    font-weight:600;
    border-bottom:2px solid transparent;
    transition:all 0.2s ease;
    display:flex;
    align-items:center;
    gap:6px;
}
.right-panel-tabs button.active { 
    color:var(--text); 
    background:#1e1e1e; 
    border-bottom-color:#007acc;
}
.right-panel-tabs button:hover { 
    color:var(--text); 
    background:#2d2d2d; 
}
.right-panel-content { 
    flex:1; 
    display:flex; 
    flex-direction:column; 
    min-height:0; 
    overflow:hidden; 
}
.panel-tab-content { 
    display:none; 
    flex:1; 
    flex-direction:column; 
    min-height:0; 
    overflow:hidden; 
}
.panel-tab-content.active { 
    display:flex; 
}

/* Responsive design */
@media (max-width: 1200px) {
    .vs-frame { 
        grid-template-columns: 36px 240px minmax(0,1fr) 300px; 
    }
}

@media (max-width: 1024px) {
    .vs-frame { 
        grid-template-columns: 32px 200px minmax(0,1fr) 280px; 
    }
    .activity-bar { padding: 3px 0; gap: 1px; }
    .activity-bar button { font-size: 14px; width: 28px; height: 28px; }
}

@media (max-width: 768px) {
    .vs-frame { 
        grid-template-columns: 1fr; 
        grid-template-rows: auto 1fr 24px; 
    }
    .activity-bar { 
        flex-direction: row; 
        justify-content: space-between; 
        align-items: center;
        padding: 8px 12px; 
        gap: 8px; 
        height: 48px;
    }
    .activity-bar > button:not(.mobile-sidebar-toggle) {
        display: none;
    }
    .mobile-controls {
        display: flex;
        gap: 8px;
        width: 100%;
        justify-content: space-between;
    }
    .mobile-sidebar-toggle {
        display: flex !important;
        background: var(--accent);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        align-items: center;
        gap: 6px;
    }
    .sidebar { 
        display: none; 
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    .sidebar.mobile-open {
        display: flex;
        transform: translateX(0);
    }
    .mobile-sidebar-toggle {
        display: block !important;
        background: var(--accent);
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .main { 
        grid-column: 1; 
    }
    .right-panel { 
        position: fixed;
        right: 0;
        top: 0;
        width: 100%;
        height: 100vh;
        z-index: 1001;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        display: none;
    }
    .right-panel.mobile-open {
        display: flex;
        transform: translateX(0);
    }
    .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }
    .mobile-overlay.active {
        display: block;
    }
}

@media (max-width: 480px) {
    .tab-bar button { 
        padding: 4px 8px; 
        font-size: 11px; 
    }
    .chat-input-row { 
        flex-direction: column; 
        gap: 6px; 
    }
    .chat-input-row textarea { 
        height: 60px; 
    }
}

/* Mobile sidebar toggle (hidden by default, shown on mobile) */
.mobile-sidebar-toggle {
    display: none;
}

.mobile-controls {
    display: none;
}

/* Desktop activity bar layout */
@media (min-width: 769px) {
    .activity-bar {
        justify-content: flex-start;
    }
}
/* Admin payment settings flyout (moved from body) */
#adminPayPanel{position:fixed; top:60px; right:60px; width:360px; max-width:90%; background:#1f1f1f; border:1px solid #333; border-radius:8px; box-shadow:0 6px 22px rgba(0,0,0,.5); z-index:4000; display:none; flex-direction:column; font-size:12px;}
#adminPayPanel header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#252526; border-bottom:1px solid #333; font-weight:600;}
#adminPayPanel form{padding:12px 14px; display:flex; flex-direction:column; gap:8px;}
#adminPayPanel label{display:flex; flex-direction:column; gap:4px; font-size:11px; letter-spacing:.5px; color:#bbb;}
#adminPayPanel input{background:#2a2a2a; border:1px solid #444; color:#fff; padding:6px 8px; border-radius:4px; font-size:12px;}
#adminPayPanel .actions{display:flex; gap:8px; margin-top:4px;}
#adminPayPanel button{cursor:pointer;}
#adminPayPanel .close-btn{background:none; border:none; color:#aaa; font-size:16px; cursor:pointer;}
#adminPayPanel .close-btn:hover{color:#fff;}
#adminPayPanel .small-note{font-size:10px; color:#777;}
/* Plan / Upgrade panel */
#planPanel{position:fixed; bottom:60px; right:60px; width:380px; max-width:94%; background:#202124; border:1px solid #333; border-radius:10px; box-shadow:0 8px 26px rgba(0,0,0,.55); z-index:3999; display:none; flex-direction:column; font-size:12px;}
#planPanel header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 14px; background:#252526; border-bottom:1px solid #333; font-weight:600; letter-spacing:.5px;}
#planPanel .close-btn{background:none; border:none; color:#aaa; font-size:16px; cursor:pointer;}
#planPanel .close-btn:hover{color:#fff;}
#planPanel .content{padding:12px 14px; display:flex; flex-direction:column; gap:10px; max-height:480px; overflow:auto;}
#planPanel .usage-grid{display:grid; grid-template-columns:1fr auto; gap:4px 10px; font-size:11px;}
#planPanel .badge-plan{background:#094771; color:#fff; padding:2px 8px; border-radius:20px; font-size:11px; letter-spacing:.5px;}
#planPanel .upgrade-actions{display:flex; flex-direction:column; gap:8px;}
#planPanel button.up-btn{background:#0e639c; border:none; color:#fff; padding:8px 12px; border-radius:6px; font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;}
#planPanel button.up-btn.secondary{background:#2d2d2d; border:1px solid #444; color:#ddd;}
#planPanel button.up-btn:hover{background:#1177bb;}
#planPanel .hint{font-size:10px; color:#888; line-height:1.4;}
#planPanel .limit-row.exceeded{color:#f48771;}
</style>
</head>
<body>
<div class="mobile-overlay" onclick="closeMobileSidebar()"></div>
<div class="vs-frame">
    <div class="activity-bar">
        <!-- Logo/Brand at top -->
    <div class="activity-bar-logo" style="width:32px; height:32px; display:flex; align-items:center; justify-content:center; margin-bottom:4px; border-bottom:1px solid #404040; color:#007acc; font-weight:bold; font-size:12px;">
      VS
    </div>
    <div style="writing-mode:vertical-rl; transform:rotate(180deg); font-size:10px; color:#888; line-height:1; margin-bottom:8px; text-align:center; max-height:120px; overflow:hidden;">
      {{ current_analyst }}
    </div>
        
        <!-- Main navigation buttons -->
  <button class="active" title="Explorer"><i class="fa fa-files"></i></button>
        <button title="Search"><i class="fa fa-search"></i></button>
        <button title="Run"><i class="fa fa-play"></i></button>
        <button title="Git"><i class="fa fa-code-branch"></i></button>
        <button title="Extensions"><i class="fa fa-box"></i></button>
        
        <!-- Spacer to push mobile controls to bottom -->
        <div style="flex:1;"></div>
        
        <!-- Mobile controls (hidden on desktop) -->
        <div class="mobile-controls">
            <button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()">
                <i class="fa fa-bars"></i>
            </button>
            <button class="mobile-sidebar-toggle" onclick="toggleMobileChat()" style="background: #28a745;">
                <i class="fa fa-comments"></i>
            </button>
        </div>
    </div>
    <aside class="sidebar">
        <div class="sidebar-section">
            <h4 style="display:flex; align-items:center; gap:6px;">
              <span style="background:#fff; padding:4px; border-radius:6px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.4);">
                <img src="https://predictram.com/images/logo2x.png" alt="PR" style="width:26px; height:26px; object-fit:contain;" />
              </span>
              <span style="font-weight:600; font-size:12px;">VS Terminal EClass</span>
            </h4>
            <select id="llmSelect">
                <option value="mistral:latest">mistral:latest (default)</option>
            </select>
            <div id="llmStatus" style="margin-top:6px; font-size:10px; color:var(--muted);">Loading models...</div>
            <div style="margin-top:8px;">
                <details>
                    <summary style="cursor:pointer; color:var(--muted);">Configure / Diagnostics</summary>
                    <div id="configForm" style="margin-top:6px;">
                        <input id="cfgHost" placeholder="Host (e.g. localhost)" />
                        <input id="cfgPort" placeholder="Port (e.g. 11434)" />
                        <input id="cfgModel" placeholder="Default Model (e.g. mistral:latest)" />
                        <input id="cfgGenTimeout" placeholder="Gen Timeout (sec, e.g. 120)" />
                        <button class="secondary-btn" style="width:100%; margin-top:2px;" type="button" onclick="applyConfig()">Apply</button>
                        <div style="display:flex; gap:6px; margin-top:4px; flex-wrap:wrap;">
                          <button class="secondary-btn" style="flex:1;" type="button" onclick="refreshDiagnostics()">Diagnostics</button>
                          <button class="secondary-btn" style="flex:1;" type="button" onclick="pingLLM()">Ping</button>
                          <button class="secondary-btn" style="flex:1;" type="button" onclick="warmModel()">Warm</button>
                        </div>
                        <div id="pingStatus">Ping: -</div>
                        <div id="warmStatus" style="font-size:10px; margin-top:2px; color:var(--muted);">Warm: -</div>
                        <div id="diagPanel">No diagnostics yet.</div>
                    </div>
                </details>
            </div>
        </div>
        <div class="sidebar-section">
            <h4>ML MODELS</h4>
            <ul class="model-list" id="modelList">
                {% for model in ml_models %}
                <li onclick="selectModel('{{ model }}')"><i class="fa fa-python"></i>{{ model }}</li>
                {% endfor %}
            </ul>
            <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
                <button class="secondary-btn" style="flex:1;" onclick="loadSelectedModel()" title="Load model source into editor">Load</button>
                <button class="secondary-btn" style="flex:1;" onclick="runSelectedModel()" title="Run model demo/test if available">Run Model</button>
            </div>
            <div id="selectedModelDisplay" style="margin-top:6px; font-size:11px; color:var(--muted);">No model selected.</div>
        </div>
        <div class="sidebar-section">
            <h4>CHAT SESSIONS</h4>
            <ul class="file-list" id="chatSessionList" style="max-height:180px; overflow:auto; margin-top:4px;"></ul>
            <button class="secondary-btn" style="width:100%; margin-top:6px;" onclick="refreshChatSessions()">Refresh Sessions</button>
        </div>
        <div class="sidebar-section">
            <h4>REPORTS</h4>
            <ul class="file-list" id="reportList" style="max-height:180px; overflow:auto; margin-top:4px;"></ul>
            <div style="display:flex; gap:4px; margin-top:6px; flex-wrap:wrap;">
                <button class="secondary-btn" style="flex:1;" onclick="refreshReportList()" title="Refresh report list">Refresh</button>
                <button class="secondary-btn" style="flex:1;" onclick="loadSelectedReport()" title="Load selected report into editor">Load</button>
                <button class="secondary-btn" style="flex:1;" onclick="deleteSelectedReport()" title="Delete selected report">Delete</button>
            </div>
        </div>
        <div class="sidebar-section">
            <h4>WORKSPACE FILES</h4>
            <ul class="file-list" id="workspaceFilesList" style="max-height:180px; overflow:auto; margin-top:4px;"></ul>
            <div style="display:flex; gap:4px; margin-top:6px; flex-wrap:wrap;">
                <button class="secondary-btn" style="flex:1;" onclick="refreshWorkspaceFiles()" title="Refresh workspace files">Refresh</button>
                <button class="secondary-btn" style="flex:1;" onclick="loadSelectedWorkspaceFile()" title="Load selected file into editor">Load</button>
                <button class="secondary-btn" style="flex:1;" onclick="deleteSelectedWorkspaceFile()" title="Delete selected file">Delete</button>
            </div>
        </div>
        <div class="sidebar-section">
            <h4>AI PROVIDERS</h4>
            <div style="font-size:10px; color:var(--muted); margin-bottom:4px;">Configure keys (e.g. Perplexity sonar models) then Select Active.</div>
            <div id="aiProvidersList" style="font-size:11px; line-height:1.4; display:flex; flex-direction:column; gap:4px;"></div>
            <button class="secondary-btn" style="width:100%; margin-top:6px;" onclick="refreshAIProviders()">Refresh</button>
            <details style="margin-top:6px;">
              <summary style="cursor:pointer; color:var(--muted); font-size:11px;">Configure Provider</summary>
              <div style="margin-top:6px; display:flex; flex-direction:column; gap:4px;">
                <select id="cfgAIProvider" style="font-size:11px;"></select>
                <input id="cfgAIKey" placeholder="API Key" style="font-size:11px;" />
                <input id="cfgAIModel" placeholder="Model (optional)" style="font-size:11px;" />
                <input id="cfgAIBase" placeholder="Base URL (Azure etc)" style="font-size:11px;" />
                <button class="secondary-btn" type="button" onclick="saveAIProvider()">Save Provider</button>
                <button class="secondary-btn" type="button" onclick="selectAIProvider()">Select Active</button>
                <div id="aiProvStatus" style="font-size:10px; color:var(--muted);">Idle</div>
              </div>
            </details>
        </div>
        <div class="sidebar-section">
            <h4>PUBLISHED</h4>
            <div style="display:flex; gap:4px; flex-wrap:wrap; margin-bottom:4px;">
                <input id="pubSearch" placeholder="Search" style="flex:1; font-size:11px; background:#2d2d2d; border:1px solid #444; color:#ddd; padding:4px 6px; border-radius:4px;" onkeydown="if(event.key==='Enter') refreshPublishedModels(true)" />
                <button class="secondary-btn" style="flex:0 0 auto;" onclick="refreshPublishedModels(true)">Go</button>
            </div>
            <select id="pubCategoryFilter" style="width:100%; font-size:11px; margin-bottom:4px;" onchange="refreshPublishedModels()">
                <option value="">All Categories</option>
                <option value="Ultra Short-Term">Ultra Short-Term</option>
                <option value="Short-Term">Short-Term</option>
                <option value="Medium-Term">Medium-Term</option>
                <option value="Long-Term">Long-Term</option>
                <option value="High Risk">High Risk</option>
                <option value="Medium Risk">Medium Risk</option>
                <option value="Low Risk">Low Risk</option>
                <option value="Fundamental Models">Fundamental Models</option>
                <option value="Technical Models">Technical Models</option>
                <option value="Quantitative">Quantitative</option>
                <option value="Hybrid Models">Hybrid Models</option>
                <option value="Risk Management Models">Risk Management</option>
                <option value="Portfolio Optimization">Portfolio Optimization</option>
            </select>
            <div style="display:flex; gap:4px; flex-wrap:wrap; margin-bottom:4px;">
                <button class="secondary-btn" style="flex:1;" onclick="openPublishPanel()">Publish</button>
                <button class="secondary-btn" style="flex:1;" onclick="refreshPublishedModels()">Refresh</button>
            </div>
            <ul class="file-list" id="publishedModelsList" style="max-height:140px; overflow:auto; margin:0 0 6px 0;"></ul>
            <div id="publishedPagination" style="font-size:10px; display:flex; gap:6px; align-items:center; justify-content:space-between; margin-bottom:4px;">
                <button class="secondary-btn" style="flex:0 0 auto; padding:2px 6px;" onclick="changePublishedPage(-1)">Prev</button>
                <span id="publishedPageInfo" style="flex:1; text-align:center;">-</span>
                <button class="secondary-btn" style="flex:0 0 auto; padding:2px 6px;" onclick="changePublishedPage(1)">Next</button>
            </div>
            <div id="publishedModelDetails" style="font-size:11px; line-height:1.35; max-height:140px; overflow:auto; border:1px solid #333; padding:6px; border-radius:4px; display:none;"></div>
            <div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px;">
                <button class="secondary-btn" style="flex:1;" onclick="runSelectedPublished()" title="Run default (first) allowed function">Run</button>
                <button class="secondary-btn" style="flex:1;" onclick="requestEditSelected()" title="Request edit access">Req Edit</button>
                <button class="secondary-btn" style="flex:1;" onclick="loadEditRequests()" title="View edit requests (author)">Requests</button>
            </div>
            <div id="editRequestsPanel" style="display:none; margin-top:6px; border:1px solid #333; padding:6px; border-radius:4px; max-height:160px; overflow:auto; font-size:10px;"></div>
        </div>
        <div class="sidebar-section">
            <h4>ENV PACKAGES</h4>
            <div style="display:flex; gap:4px; margin-bottom:4px; flex-wrap:wrap;">
                <input id="pkgInstallInput" placeholder="package==version" style="flex:1; font-size:11px; background:#2d2d2d; border:1px solid #444; color:#ddd; padding:4px 6px; border-radius:4px;" />
                <button class="secondary-btn" style="flex:0 0 auto;" onclick="startAsyncInstall()">Install</button>
                <button class="secondary-btn" style="flex:0 0 auto;" onclick="startAsyncUninstall()">Uninstall</button>
            </div>
            <div style="display:flex; gap:4px; margin-bottom:4px;">
                <button class="secondary-btn" style="flex:1;" onclick="loadPackages()">Refresh</button>
                <button class="secondary-btn" style="flex:1;" onclick="filterPackages()">Filter</button>
                <button class="secondary-btn" style="flex:1;" onclick="fetchRequirements()">Reqs</button>
            </div>
            <input id="pkgFilter" placeholder="filter" style="width:100%; font-size:11px; background:#2d2d2d; border:1px solid #444; color:#ddd; padding:4px 6px; border-radius:4px; margin-bottom:4px;" oninput="filterPackages()" />
            <div id="pkgList" style="font-size:10px; line-height:1.3; max-height:140px; overflow:auto; border:1px solid #333; padding:6px; border-radius:4px; background:#1f1f1f;">(empty)</div>
            <div id="pkgStatus" style="font-size:10px; color:#888; margin-top:4px;">Idle</div>
            <details style="margin-top:6px;">
              <summary style="cursor:pointer; font-size:11px; color:#bbb;">Active Task Log</summary>
              <div id="pkgTaskLog" style="font-size:10px; white-space:pre-wrap; background:#151515; border:1px solid #333; padding:6px; border-radius:4px; max-height:120px; overflow:auto; margin-top:4px;">(no task)</div>
            </details>
            <details style="margin-top:6px;">
              <summary style="cursor:pointer; font-size:11px; color:#bbb;">Recent Tasks</summary>
              <div id="pkgTaskList" style="font-size:10px; max-height:120px; overflow:auto; border:1px solid #333; padding:6px; border-radius:4px; margin-top:4px;">(none)</div>
            </details>
            <details style="margin-top:6px;">
              <summary style="cursor:pointer; font-size:11px; color:#bbb;">Requirements.txt</summary>
              <div style="margin-top:4px;">
                <button class="secondary-btn" style="width:100%;" onclick="downloadRequirements()">Download requirements.txt</button>
                <div id="reqOutput" style="font-size:10px; margin-top:4px; max-height:140px; overflow:auto; border:1px solid #333; padding:4px; border-radius:4px; background:#1d1d1d;">(empty)</div>
              </div>
            </details>
        </div>
    </aside>
    <main class="main">
        <div class="editor-wrapper" id="editorWrapper">
            <div style="position:absolute; top:6px; right:12px; display:flex; gap:6px; z-index:10;">
                <label style="display:flex; align-items:center; gap:4px; font-size:11px; background:#222; padding:4px 6px; border:1px solid #333; border-radius:4px; cursor:pointer;">
                    <input type="checkbox" id="capturePlots" style="margin:0;">Plots
                </label>
                <button class="run-button" style="position:static;" onclick="runCodeAsync()" title="Run current editor code asynchronously with progress"><i class="fa fa-terminal"></i> Run</button>
                <button class="secondary-btn" style="background:#8b0000; color:#fff; border:1px solid #550000;" onclick="cancelAsyncRun()" title="Cancel running async execution"><i class="fa fa-stop"></i></button>
                <button class="secondary-btn" style="background:#0e639c; color:#fff; border:1px solid #0e639c;" onclick="saveModel(false)" title="Save code to models folder"><i class="fa fa-save"></i> Save</button>
                <button class="secondary-btn" style="background:#007acc; color:#fff; border:1px solid #007acc;" onclick="publishModel()" title="Publish (versioned copy)"><i class="fa fa-upload"></i> Publish</button>
            </div>
            <textarea id="code-editor"></textarea>
        </div>
        <div class="resize-handle" id="resizeHandle" onmousedown="startDrag(event)" title="Drag to resize editor / results"></div>
        <div class="lower-panels" id="lowerPanels">
            <div class="tab-bar">
                <button class="active" data-tab="resultTab" onclick="switchTab(event)">RESULT</button>
                <button data-tab="chartsTab" onclick="switchTab(event)">CHARTS</button>
                <button data-tab="reportTab" onclick="switchTab(event)">REPORT</button>
                <button data-tab="terminalTab" onclick="switchTab(event)">TERMINAL</button>
            </div>
            <div id="resultTab" class="tab-content active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:8px;">
                    <span style="font-size:12px; color:var(--muted);">Result Output</span>
                    <div style="display:flex; gap:6px;">
                        <button class="secondary-btn" style="padding:4px 8px; font-size:11px;" onclick="addResultToReport()" title="Insert current result output into report">+ To Report</button>
            <button class="secondary-btn" style="padding:4px 8px; font-size:11px;" onclick="addAsyncOutputToReport()" title="Add async run output to report">Async Output</button>
            <button class="secondary-btn" style="padding:4px 8px; font-size:11px;" onclick="prepareInputsForCode()" title="Detect input() prompts and run">Run With Inputs</button>
                    </div>
                </div>
        <div id="asyncRunBar" style="display:none; margin-bottom:6px; background:#222; border:1px solid #333; border-radius:4px; overflow:hidden; height:18px; position:relative;">
          <div id="runProgressInner" style="background:#0e639c; width:0%; height:100%; font-size:11px; line-height:18px; text-align:center; color:#fff;"></div>
          <button id="cancelAsyncBtn" onclick="cancelAsyncRun()" style="position:absolute; right:2px; top:2px; background:#a00; border:none; color:#fff; font-size:10px; padding:0 6px; height:14px; line-height:14px; cursor:pointer; border-radius:3px;">X</button>
        </div>
                <pre id="resultOutput" class="output">Select an ML model or write code. Press Run to execute.</pre>
                <div id="inputsRunSummary" style="display:none; font-size:11px; margin-top:8px; border:1px solid #333; background:#1f1f1f; padding:6px 8px; border-radius:6px; line-height:1.35;"></div>
                <!-- Plot thumbnails in result tab removed; charts live under CHARTS tab -->
                <div id="resultImages" style="display:none;"></div>
            </div>
            <div id="chartsTab" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:8px;">
                    <span style="font-size:12px; color:var(--muted);">Captured Plots (enable Plots & re-run)</span>
                    <div style="display:flex; gap:6px;">
                        <button class="secondary-btn" style="padding:4px 8px; font-size:11px;" onclick="addAllChartsToReport()" title="Insert all charts into report">All To Report</button>
                        <button class="secondary-btn" style="padding:4px 8px; font-size:11px;" onclick="clearCharts()" title="Clear chart view only">Clear</button>
                    </div>
                </div>
                <div id="chartsGrid" style="display:flex; flex-wrap:wrap; gap:14px; align-content:flex-start;"></div>
                <div id="noChartsMsg" style="font-size:12px; color:var(--muted); margin-top:4px;">No charts captured yet.</div>
            </div>
            <div id="reportTab" class="tab-content">
                <div class="report-actions">
                    <button class="secondary-btn" onclick="appendToReport()" title="Add last execution output">Add Last Output</button>
                    <button class="secondary-btn" onclick="toggleMarkdownPreview()" title="Toggle Markdown preview" id="mdToggleBtn">Preview</button>
                    <button class="secondary-btn" onclick="saveReportMarkdown()" title="Save report to file">Save</button>
                    <button class="secondary-btn" onclick="triggerImagePicker()" title="Add image(s) to report">Image</button>
                    <button class="secondary-btn" onclick="downloadLatestReport()" title="Download last saved report" id="downloadBtn" disabled>Download</button>
                    <button class="secondary-btn" onclick="exportReportHTML()" title="Export selected saved report as HTML">Export HTML</button>
                    <button class="secondary-btn" onclick="exportReportPDF()" title="Export selected saved report as PDF">Export PDF</button>
                    <button class="secondary-btn" onclick="clearReport()" title="Clear report">Clear</button>
                </div>
                <input id="reportImageInput" type="file" accept="image/*" multiple style="display:none;" onchange="handleReportImages(event)">
                <div style="display:flex; flex-direction:column; height:100%; gap:6px;">
                    <textarea id="reportEditor" style="flex:1 1 50%; resize:vertical; background:#1b1b1b; color:#d4d4d4; border:1px solid #333; padding:8px; font-family:Consolas,monospace; font-size:13px; line-height:1.35;" placeholder="Markdown report..."></textarea>
                    <div id="reportPreview" style="flex:1 1 50%; overflow:auto; background:#111; border:1px solid #333; padding:10px; font-size:13px; line-height:1.45; display:none;"></div>
                </div>
            </div>
            <div id="terminalTab" class="tab-content">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:8px;">
                <span style="font-size:12px; color:var(--muted);">Interactive Terminal</span>
                <div style="display:flex; gap:6px;">
                  <button class="secondary-btn" style="padding:4px 8px; font-size:11px;" onclick="resetTerminalSession()" title="Reset session namespace">Reset</button>
                </div>
              </div>
              <div id="terminalWindow" class="terminal-window"><div class="line sys">(terminal not started)</div></div>
              <div class="terminal-input-row">
                <span>&gt;&gt;&gt;</span>
                <input id="terminalInput" placeholder="Enter Python code (Enter to send, Shift+Enter newline)" onkeydown="terminalInputKey(event)">
              </div>
              <div style="font-size:10px; color:#666; margin-top:6px;">Session persists variables. Multi-line blocks: end with blank line. Reset clears namespace.</div>
            </div>
        </div>
    </main>
    <section class="right-panel">
        <!-- Tab Headers -->
        <div class="right-panel-tabs">
            <button class="tab-btn active" data-tab="ai-assistant">
                <i class="fa fa-code"></i> AI ASSISTANT
            </button>
            {% if is_admin %}
            <button class="tab-btn" data-tab="report-agent">
                <i class="fa fa-file-pdf"></i> REPORT AGENT AI
            </button>
            {% endif %}
        </div>
        
        <div class="right-panel-content">
            <!-- AI ASSISTANT Tab -->
            <div id="ai-assistant" class="panel-tab-content active">
                <div class="panel-header" style="border-bottom:none;">
                    <span>AI ASSISTANT - Code Generation</span>
                    <span style="font-size:11px; opacity:.7;" id="modelIndicator">mistral:latest</span>
                </div>
                <div id="chatHistory" class="chat-history">
                    <div class="msg system">AI Assistant ready for code generation and development help. Ask about models, code improvements, debugging, or any programming questions.</div>
                    <div id="chatBottomAnchor"></div>
                </div>
                <button id="jumpToLatest" class="jump-latest-btn" type="button" onclick="jumpToLatest()">Jump to latest</button>
                <button id="scrollUpBtn" style="position:absolute; left:10px; bottom:88px; background:#444; color:#fff; border:none; font-size:11px; padding:4px 8px; border-radius:4px; cursor:pointer; display:none;" type="button" onclick="scrollPageUp()">Page up</button>
                <div class="chat-input-area">
                    <div class="chat-input-row">
                        <textarea id="chatInput" placeholder="Ask the AI assistant for code help..."></textarea>
                        <button class="primary-btn" onclick="sendChat()"><i class="fa fa-paper-plane"></i>Send</button>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="secondary-btn" onclick="insertPrompt('Explain this code')">Explain</button>
                        <button class="secondary-btn" onclick="insertPrompt('Optimize this code for performance')">Optimize</button>
                        <button class="secondary-btn" onclick="insertPrompt('Debug this code')">Debug</button>
                        <button class="secondary-btn" onclick="insertPrompt('Refactor this code')">Refactor</button>
                        <button class="secondary-btn" onclick="generateDemoCode()" title="Generate demo code to test Auto-Apply feature" style="background:#28a745; color:white;">🤖 Demo Auto-Apply</button>
                        <button class="secondary-btn" onclick="saveChatSession()" title="Save current chat session"><i class="fa fa-save"></i> Save Chat</button>
                    </div>
                </div>
            </div>
            
            {% if is_admin %}
            <!-- REPORT AGENT AI Tab -->
            <div id="report-agent" class="panel-tab-content">
                <div class="panel-header" style="border-bottom:none;">
                    <span>REPORT AGENT AI - Report Generation</span>
                    <span style="font-size:11px; opacity:.7;">Claude + Ollama</span>
                </div>
                <div id="reportChatHistory" class="chat-history">
                    <div class="msg system">🤖 <strong>Agentic AI Report Agent Active!</strong><br><br>
                    I can generate comprehensive financial reports using data from websites and PDF documents.<br><br>
                    <strong>💡 Smart Detection:</strong><br>
                    ✅ Just share any website URL - I'll automatically scrape and analyze it!<br>
                    ✅ Drop any PDF link - I'll extract and process the content!<br>
                    ✅ Multiple sources supported - combine URLs and PDFs in one message<br>
                    ✅ Auto-generated reports in PDF/DOCX format<br><br>
                    <strong>🚀 Quick Examples:</strong><br>
                    • Share a URL: "https://investor.apple.com/investor-relations/default.aspx"<br>
                    • Share a PDF: "quarterly-results.pdf"<br>
                    • Multiple sources: "Analyze https://tesla.com/investor and earnings-report.pdf"<br>
                    • Specific request: "Generate Tesla report using https://ir.tesla.com in PDF format"</div>
                    <div id="reportChatBottomAnchor"></div>
                </div>
                <button id="jumpToLatestReport" class="jump-latest-btn" type="button" onclick="jumpToLatestReport()">Jump to latest</button>
                <div class="chat-input-area">
                    <div class="chat-input-row">
                        <textarea id="reportChatInput" placeholder="Ask for financial reports with data sources..."></textarea>
                        <button class="primary-btn" onclick="sendReportChat()"><i class="fa fa-chart-line"></i>Generate</button>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="secondary-btn" onclick="insertReportPrompt('Generate a comprehensive financial report on ')">📊 Financial Report</button>
                        <button class="secondary-btn" onclick="insertReportPrompt('https://investor.apple.com')">🌐 URL Example</button>
                        <button class="secondary-btn" onclick="insertReportPrompt('quarterly-report.pdf')">📄 PDF Example</button>
                        <button class="secondary-btn" onclick="insertReportPrompt('Analyze https://ir.tesla.com and earnings.pdf')">🔗 Multi-Source</button>
                        <button class="secondary-btn" onclick="insertReportPrompt('Create investment analysis using https://microsoft.com/investor')">💼 Investment URL</button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
    <footer class="status-bar">
        <div><span>VS Terminal</span><span class="badge">Alpha</span></div>
        <div id="statusMsg">Ready</div>
    </footer>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
<script>
let editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), { lineNumbers:true, mode:'python', theme:'monokai', indentUnit:4, tabSize:4, indentWithTabs:false });
let lastOutput='';
let selectedModel=null;
let lastCharts=[];
let dragging=false; let startY=0; let startHeight=0; const editorWrapper=document.getElementById('editorWrapper');

// Tab functionality for right panel
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.right-panel-tabs .tab-btn');
    const tabContents = document.querySelectorAll('.panel-tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
});
function ensureChatVisible(){ /* placeholder to keep compatibility; could auto-scroll chat if needed */ }
function switchTab(e){ document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById(e.currentTarget.dataset.tab).classList.add('active'); if(e.currentTarget.dataset.tab==='resultTab'){ ensureChatVisible(); } }
function setStatus(m){ document.getElementById('statusMsg').textContent = m; }
function selectModel(n){ selectedModel=n; document.getElementById('selectedModelDisplay').textContent='Selected: '+n; document.querySelectorAll('#modelList li').forEach(li=>li.classList.toggle('selected', li.textContent.trim()===n)); ensureChatVisible(); }
function refreshModelList(){
  fetch('/api/list_saved_models')
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ return; }
      const ul=document.getElementById('modelList');
      if(!ul) return;
      ul.innerHTML='';
      (d.models||[]).forEach(m=>{
        const name = (m && typeof m === 'object') ? (m.name||'') : m;
        if(!name) return;
        const source = (m && m.source && m.source !== 'models') ? ` <span style="color:#888; font-size:10px;">(${m.source})</span>` : '';
        const li=document.createElement('li');
        li.innerHTML='<i class="fa fa-python"></i>'+name+source;
        li.onclick=()=>selectModel(name);
        ul.appendChild(li);
      });
    })
    .catch(()=>{});
}
function loadSelectedModel(){ if(!selectedModel){ setStatus('No model selected'); return;} loadModelCode(selectedModel); }
function loadModelCode(n){
    setStatus('Loading model '+n+' ...');
    fetch('/api/get_model_code?model='+encodeURIComponent(n))
        .then(async r=>{
                const ct=r.headers.get('content-type')||'';
                if(!r.ok){
                    let txt=await r.text();
                    throw new Error('HTTP '+r.status+' '+r.statusText+'\n'+txt.slice(0,500));
                }
                if(ct.includes('application/json')){
                    return r.json();
                } else {
                    const txt=await r.text();
                    throw new Error('Unexpected content-type: '+ct+'\n'+txt.slice(0,400));
                }
        })
        .then(d=>{
                if(d.code){
                    editor.setValue(d.code);
                    setTimeout(()=>editor.refresh(),30);
                    const encInfo=d.encoding?(' ('+d.encoding+')'):'';
                    setStatus('Loaded '+n+encInfo);
                } else {
                    editor.setValue('# Error: '+d.error);
                    setStatus('Load failed');
                }
                ensureChatVisible();
        })
        .catch(err=>{
                editor.setValue('# Error loading model: '+err.message);
                setStatus('Error');
                ensureChatVisible();
        });
}
function runSelectedModel(){ if(!selectedModel){ setStatus('No model selected'); return;} setStatus('Running model '+selectedModel+' ...'); const outEl=document.getElementById('resultOutput'); outEl.textContent='Running model '+selectedModel+' ...'; fetch('/api/run_model',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({model:selectedModel})}).then(r=>r.json()).then(d=>{ lastOutput=d.output||d.error||''; outEl.textContent=lastOutput; setStatus(d.error?'Model error':'Model executed'); ensureChatVisible(); }).catch(e=>{ outEl.textContent='Error: '+e; setStatus('Execution error'); ensureChatVisible(); }); }
// Add result output to report
function addResultToReport(){ const txt=document.getElementById('resultOutput').textContent||''; if(!txt.trim()) { alert('No result to add'); return;} const rep=document.getElementById('reportEditor'); if(rep){ rep.value += '\n\n### Result Output\n\n'+txt.substring(0,8000); setStatus('Result appended to report'); }}
// Add all captured charts to report (as markdown image refs)
function addAllChartsToReport(){ if(!lastCharts.length){ alert('No charts'); return;} const rep=document.getElementById('reportEditor'); if(!rep) return; let md='\n\n### Charts\n'; lastCharts.forEach((c,i)=>{ if(c.type==='img'){ md += `\n![Chart ${i+1}](data:image/png;base64,${c.data.substring(0,200)}...)`; }}); rep.value += md; setStatus('Charts markdown appended (truncated inline data)'); }
function runCode(){ const code=editor.getValue(); const outEl=document.getElementById('resultOutput'); outEl.textContent='Running...'; setStatus('Executing code...'); lastCharts=[]; renderCharts(); const capture=document.getElementById('capturePlots').checked; fetch('/api/run_code',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code, capture_plots:capture})}).then(r=>r.json()).then(d=>{ lastOutput=d.output||d.error||''; outEl.textContent=lastOutput; lastCharts = Array.isArray(d.images)?d.images:[]; renderCharts(); if(lastCharts.length){ // auto-switch to charts tab
        switchTab({currentTarget:document.querySelector('.tab-bar button[data-tab="chartsTab"]')});
    }
    setStatus(d.error?'Completed with errors':'Execution complete'); ensureChatVisible(); }).catch(e=>{ lastOutput=String(e); outEl.textContent='Error: '+e; setStatus('Runtime error'); ensureChatVisible(); }); }
let currentAsyncRun=null; let asyncRunPoll=null;
function resetProgressBar(){ const bar=document.getElementById('runProgressInner'); if(bar){ bar.style.width='0%'; bar.style.background='#0e639c'; bar.textContent=''; } const wrap=document.getElementById('asyncRunBar'); if(wrap){ wrap.style.display='block'; } }
function addAsyncOutputToReport(){ const txt=document.getElementById('resultOutput').textContent||''; if(!txt.trim()){ alert('No output'); return;} const rep=document.getElementById('reportEditor'); if(rep){ rep.value += "\n\n### Async Run Output\n\n"+txt.substring(0,10000); setStatus('Output appended to report'); } }
function extractMissingModule(logText){
  // Looks for patterns: ModuleNotFoundError: No module named 'xxx' OR ImportError: No module named xxx
  const m1 = logText.match(/ModuleNotFoundError: No module named ['\"]([^'\"]+)['\"]/);
  if(m1) return m1[1];
  const m2 = logText.match(/ImportError: No module named ['\"]?([^'\"\s]+)['\"]?/);
  if(m2) return m2[1];
  return null;
}
let autoInstallAttempts = {}; // run_id -> module
function runCodeAsync(){ const code=editor.getValue(); const outEl=document.getElementById('resultOutput'); if(!code.trim()){ alert('No code'); return;} setStatus('Submitting async run...'); outEl.textContent='(async run starting)'; resetProgressBar(); const capture=document.getElementById('capturePlots').checked; fetch('/api/run_code_async',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code, capture_plots:capture, timeout:180})}).then(r=>r.json()).then(d=>{ if(!d.ok){ setStatus('Submit failed'); outEl.textContent='Submit failed: '+(d.error||''); return;} currentAsyncRun=d.run_id; autoInstallAttempts[currentAsyncRun]=0; setStatus('Run started '+currentAsyncRun); asyncRunPoll=setInterval(pollAsyncRun, 1300); }).catch(e=>{ setStatus('Submit error'); outEl.textContent='Submit error: '+e; }); }
// ---- input() assisted run ----
function prepareInputsForCode(){ const code=editor.getValue(); if(!code.trim()){ alert('No code'); return;} fetch('/api/prepare_code_inputs',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code})}).then(r=>r.json()).then(d=>{ if(!d.ok){ alert('Detect error: '+(d.error||'')); return;} const prompts=d.prompts||[]; if(!prompts.length){ if(confirm('No input() calls detected. Run normally?')){ runCode(); } return; } showInputPromptDialog(prompts, code); }).catch(e=> alert('Detect failed: '+e)); }
function showInputPromptDialog(prompts, code){
  let existing=document.getElementById('inputRunDialog'); if(existing) existing.remove();
  const wrap=document.createElement('div'); wrap.id='inputRunDialog'; wrap.style.position='fixed'; wrap.style.top='0'; wrap.style.left='0'; wrap.style.right='0'; wrap.style.bottom='0'; wrap.style.background='rgba(0,0,0,0.55)'; wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.justifyContent='center'; wrap.style.zIndex='9999';
  const panel=document.createElement('div'); panel.style.background='#1e1e1e'; panel.style.border='1px solid #444'; panel.style.padding='16px'; panel.style.borderRadius='8px'; panel.style.width='420px'; panel.style.maxHeight='70vh'; panel.style.overflow='auto'; panel.innerHTML='<div style="font-size:14px; font-weight:600; margin-bottom:8px;">Provide Inputs</div>';
  prompts.forEach(p=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.flexDirection='column'; row.style.gap='4px'; row.style.marginBottom='8px'; row.innerHTML=`<label style='font-size:11px; color:#bbb;'>${p}</label><input data-prompt="${p.replace(/"/g,'&quot;')}" style='background:#2d2d2d; border:1px solid #555; color:#eee; padding:6px 8px; border-radius:4px; font-size:12px;' placeholder='Value'>`; panel.appendChild(row); });
  const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='4px'; actions.innerHTML=`<button id='inputRunCancel' class='secondary-btn' style='flex:1;'>Cancel</button><button id='inputRunExec' class='secondary-btn' style='flex:1; background:#0e639c; border-color:#0e639c; color:#fff;'>Run</button>`; panel.appendChild(actions);
  const status=document.createElement('div'); status.id='inputRunStatus2'; status.style.fontSize='11px'; status.style.color='#888'; status.style.marginTop='6px'; status.textContent='Idle'; panel.appendChild(status);
  wrap.appendChild(panel); document.body.appendChild(wrap);
  document.getElementById('inputRunCancel').onclick=()=>wrap.remove();
  document.getElementById('inputRunExec').onclick=()=>{
    const vals={}; panel.querySelectorAll('input[data-prompt]').forEach(inp=>{ vals[inp.getAttribute('data-prompt')]=inp.value; });
    status.textContent='Running...';
    fetch('/api/run_code_with_user_inputs',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code, inputs:vals})})
      .then(r=>r.json()).then(d=>{ if(!d.ok && d.missing){ alert('Missing inputs: '+d.missing.join(', ')); status.textContent='Missing inputs'; return;} const outEl=document.getElementById('resultOutput'); outEl.textContent=d.output || d.error || '(no output)'; if(d.error){ status.textContent='Completed with errors'; } else { status.textContent='Done'; } // show summary
        try { const sum=document.getElementById('inputsRunSummary'); if(sum){ sum.style.display='block'; const esc=window.escapeHtml?window.escapeHtml:(s=>s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))); sum.innerHTML='<strong style="color:#bbb;">Inputs Used:</strong><br>'+Object.entries(vals).map(([k,v])=>`<code style="background:#222; padding:2px 4px; border-radius:4px;">${esc(k)}</code>: ${esc(String(v))}`).join('<br>'); } } catch(_){}
        wrap.remove(); switchTab({currentTarget:document.querySelector('.tab-bar button[data-tab="resultTab"]')}); })
      .catch(e=>{ alert('Run failed: '+e); status.textContent='Error'; });
  };
}
function runWithInputs(){
  const code=editor.getValue(); if(!code.trim()){ alert('No code'); return; }
  let inputs={};
  const raw=document.getElementById('inputsJson').value.trim();
  if(raw){
    // Try JSON first
    let parsed=null; let jsonTried=false;
    if((raw.startsWith('{')&&raw.endsWith('}'))||(raw.startsWith('[')&&raw.endsWith(']'))){
      jsonTried=true; try{ parsed=JSON.parse(raw);}catch(e){ parsed=null; }
    }
    if(parsed && typeof parsed==='object' && !Array.isArray(parsed)){
      inputs=parsed;
    } else if(!jsonTried){
      // Parse key=value lines
      const lines=raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      lines.forEach(line=>{ const eq=line.indexOf('='); if(eq>0){ const k=line.slice(0,eq).trim(); let v=line.slice(eq+1).trim(); if(/^[-+]?[0-9]*\.?[0-9]+$/.test(v)){ v=parseFloat(v); } inputs[k]=v; } });
    } else if(parsed===null){
      alert('Inputs parse error: invalid JSON'); return;
    }
  }
  const invocation=document.getElementById('invocationExpr').value.trim();
  const statusEl=document.getElementById('inputRunStatus'); const outEl=document.getElementById('resultOutput');
  statusEl.textContent='Running with inputs...'; setStatus('Running with inputs'); outEl.textContent='(running with inputs)';
  fetch('/api/run_code_with_inputs',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code, inputs, invocation})})
    .then(r=>r.json()).then(d=>{ if(d.error) { outEl.textContent=(d.output||'')+'\nERROR:\n'+d.error; statusEl.textContent='Error'; } else { outEl.textContent=d.output; statusEl.textContent='Done'; if(d.result!==undefined){ outEl.textContent += '\nResult: '+JSON.stringify(d.result); } } scrollChatBottom(true); })
    .catch(e=>{ outEl.textContent='Error: '+e; statusEl.textContent='Fail'; });
}
function toggleInputsPanel(){ const body=document.getElementById('inputRunnerBody'); if(!body) return; const hidden=body.style.display==='none'; body.style.display= hidden? 'flex':'none'; }
function cancelAsyncRun(){ if(!currentAsyncRun){ return;} fetch('/api/run_code_async/'+currentAsyncRun+'/cancel',{method:'POST'}).then(r=>r.json()).then(d=>{ if(d.ok){ setStatus('Canceling...'); } }).catch(()=>{}); }
function pollAsyncRun(){ if(!currentAsyncRun){ return;} fetch('/api/run_code_async/'+currentAsyncRun).then(r=>r.json()).then(d=>{ if(!d.ok){ return;} const run=d.run; const outEl=document.getElementById('resultOutput'); if(run.status==='running'){ updateProgressBar(run); outEl.textContent=run.log.slice(-80).join('\n'); } else { clearInterval(asyncRunPoll); asyncRunPoll=null; updateProgressBar(run,true); outEl.textContent=(run.error?('ERROR: '+run.error+'\n'):'') + (run.output||''); if(run.images && run.images.length){ lastCharts = run.images.map((b64,i)=>({type:'img', data:b64, idx:i})); renderCharts(); } setStatus('Run '+run.status); maybeAutoInstall(run); document.getElementById('cancelAsyncBtn').style.display='none'; } }).catch(()=>{}); }
function updateProgressBar(run, done){ const bar=document.getElementById('runProgressInner'); if(!bar) return; if(done){ bar.style.width='100%'; let color='#198754'; if(run.status==='failed') color='#d9534f'; else if(run.status==='timeout') color='#ff9800'; else if(run.status==='canceled') color='#6c757d'; bar.style.background=color; bar.textContent=run.status; return;} const pct = (run.progress_percent != null)? run.progress_percent : Math.min(95, (run.log.length/600)*100); bar.style.width=pct+'%'; bar.textContent=''+Math.round(pct)+'%'; }
function maybeAutoInstall(run){ if(run.status!=='failed' && run.status!=='error'){ return;} const combined = (run.log||[]).join('\n') + '\n' + (run.output||'') + '\n' + (run.error||''); const missing = extractMissingModule(combined); if(!missing) return; if(autoInstallAttempts[currentAsyncRun] && autoInstallAttempts[currentAsyncRun] >=1) return; autoInstallAttempts[currentAsyncRun] = (autoInstallAttempts[currentAsyncRun]||0)+1; if(!confirm(`Missing module "${missing}" detected. Auto-install and re-run?`)) return; setStatus('Auto-installing '+missing+' ...'); const bar=document.getElementById('runProgressInner'); if(bar){ bar.style.width='0%'; bar.style.background='#0e639c'; bar.textContent='install'; } fetch('/api/env/install_async',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({package:missing, timeout:180})}).then(r=>r.json()).then(d=>{ if(!d.ok){ setStatus('Auto-install failed'); return;} const tid=d.task_id; const poll = setInterval(()=>{ fetch('/api/env/task/'+tid).then(r=>r.json()).then(td=>{ if(!td.ok) return; const t=td.task; if(t.status==='running'){ setStatus('Installing '+missing+' ...'); } else { clearInterval(poll); if(t.status==='success'){ setStatus('Re-running after install '+missing); setTimeout(()=> runCodeAsync(), 800); } else { setStatus('Install '+missing+' '+t.status); } } }).catch(()=>{}); }, 2000); }).catch(()=>{ setStatus('Auto-install error'); }); }
// ---- Chat Assistant (Sessions + Code Blocks) ----
let chatAutoScroll=true;
let currentChatSession=null; // session id
let chatSessions=[]; // cached list
function escapeHtml(s){ return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
function scrollChatBottom(force){ const box=document.getElementById('chatHistory'); if(!box) return; if(force||chatAutoScroll){ box.scrollTop=box.scrollHeight; } }
function renderChatMessage(role, text){
  const box=document.getElementById('chatHistory'); if(!box) return;
  const wrap=document.createElement('div'); wrap.className='msg '+(role==='user'?'user':'ai');
  // Parse markdown-ish code fences
  const parts=[]; let lastIndex=0; const fence=/```(\w+)?\n([\s\S]*?)```/g; let m;
  while((m=fence.exec(text))){
    if(m.index>lastIndex){ parts.push({type:'text', value:text.slice(lastIndex,m.index)}); }
    parts.push({type:'code', lang:(m[1]||'').trim(), value:m[2]});
    lastIndex=fence.lastIndex;
  }
  if(lastIndex < text.length){ parts.push({type:'text', value:text.slice(lastIndex)}); }
  parts.forEach(seg=>{
    if(seg.type==='text'){
      const t=seg.value.trim(); if(!t) return; const div=document.createElement('div'); div.className='chat-text'; div.textContent=t; wrap.appendChild(div);
    } else {
      const codeId='cb_'+Math.random().toString(36).slice(2);
      const block=document.createElement('div'); block.className='code-block-wrapper'; block.style.marginTop='4px';
      block.innerHTML=`<div style="display:flex; justify-content:space-between; align-items:center; background:#1e1e1e; padding:2px 6px; border:1px solid #333; border-bottom:none; font-size:10px; color:#bbb;">
          <span>${escapeHtml(seg.lang||'code')}</span>
          <div style='display:flex; gap:4px;'>
            <button title='Copy' style='font-size:10px;' onclick="navigator.clipboard.writeText(document.getElementById('${codeId}').textContent)">Copy</button>
            <button title='To Editor' style='font-size:10px;' onclick="editor.setValue(document.getElementById('${codeId}').textContent); setStatus('Code loaded to editor');">Editor</button>
            <button title='Auto-Apply Code' style='font-size:10px; background:#28a745; color:white; border:none; padding:2px 6px; border-radius:3px;' onclick="autoApplyCode('${codeId}','${seg.lang||''}')">Auto-Apply</button>
            <button title='Append to Report' style='font-size:10px;' onclick="appendCodeBlockToReport('${codeId}','${seg.lang||''}')">Report</button>
          </div>
        </div>
        <pre id='${codeId}' style="margin:0; padding:6px; background:#111; border:1px solid #333; overflow:auto; max-height:260px;">${escapeHtml(seg.value)}</pre>`;
      wrap.appendChild(block);
    }
  });
  box.appendChild(wrap); scrollChatBottom();
}
function clearChatHistory(){ const box=document.getElementById('chatHistory'); if(box) box.innerHTML=''; }
function appendCodeBlockToReport(codeId, lang){ try{ const el=document.getElementById(codeId); if(!el) return; const txt=el.textContent; const rep=document.getElementById('reportEditor'); rep.value += `\n\n\
\`\`\`${lang||''}\n${txt}\n\`\`\``; setStatus('Code appended to report'); }catch(e){} }
function autoApplyCode(codeId, lang){
  try{
    const el=document.getElementById(codeId);
    if(!el) return;
    const code=el.textContent;
    
    // Get current editor content for context
    const currentContent = editor.getValue();
    
    // Extract context from recent chat messages
    const chatHistory = document.getElementById('chatHistory');
    const lastMessages = Array.from(chatHistory.querySelectorAll('.msg')).slice(-3).map(msg => msg.textContent).join('\n');
    
    setStatus('Auto-applying code...');
    
    fetch('/api/vs_terminal/auto_apply_code', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: code,
        language: lang,
        context: lastMessages,
        target_file: '', // Could be enhanced to detect current file
        description: 'AI-generated code suggestion'
      })
    }).then(r=>r.json()).then(d=>{
      if(d.ok){
        let message = d.details;
        if(d.action === 'create_new_file'){
          message += `\n📁 File created successfully!`;
          // Optionally load the new file content into editor
          if(d.applied_code){
            editor.setValue(d.applied_code);
          }
        } else if(d.action === 'update_existing_file'){
          message += `\n✏️ File updated with backup created!`;
          if(d.applied_code){
            editor.setValue(d.applied_code);
          }
        } else if(d.action === 'append_to_file'){
          message += `\n➕ Code appended successfully!`;
        } else if(d.action === 'manual_review'){
          message += `\n⚠️ ${d.suggestion || 'Manual review recommended'}`;
          // Load to editor for manual application
          editor.setValue(code);
        }
        
        setStatus('✅ ' + message);
        
        // Show success notification in chat
        appendChat('system', `🤖 Auto-Apply Result: ${message}`);
        
        // Optionally refresh file list if available
        if(typeof refreshFileList === 'function'){
          setTimeout(refreshFileList, 500);
        }
        
      } else {
        setStatus('❌ Auto-apply failed: ' + (d.error || 'unknown error'));
        appendChat('system', `❌ Auto-apply failed: ${d.error || 'unknown error'}`);
      }
    }).catch(e=>{
      setStatus('❌ Auto-apply error: ' + e.toString());
      appendChat('system', `❌ Auto-apply error: ${e.toString()}`);
    });
  }catch(e){
    setStatus('❌ Auto-apply exception: ' + e.toString());
  }
}
function indicateActiveSession(){ const list=document.getElementById('chatSessionList'); if(!list) return; [...list.querySelectorAll('li')].forEach(li=>{ li.style.background = (li.dataset.sid===currentChatSession)?'#094771':'var(--panel-bg)'; }); }
function refreshChatSessions(){ fetch('/api/chat/sessions').then(r=>r.json()).then(d=>{ if(!d.ok){ return; } chatSessions=d.sessions||[]; const ul=document.getElementById('chatSessionList'); if(!ul) return; ul.innerHTML=''; chatSessions.forEach(s=>{ const li=document.createElement('li'); li.textContent=(s.title||'Session') + (s.count?` (${s.count})`:'' ); li.dataset.sid=s.id; li.style.display='flex'; li.style.alignItems='center'; li.style.justifyContent='space-between';
    const actions=document.createElement('span'); actions.style.fontSize='10px'; actions.style.display='flex'; actions.style.gap='4px'; actions.innerHTML=`<a href='#' title='Rename' onclick="event.stopPropagation(); renameChatSessionPrompt('${s.id}'); return false;">✎</a><a href='#' title='Delete' onclick="event.stopPropagation(); deleteChatSession('${s.id}'); return false;" style='color:#f66;'>✕</a>`; li.appendChild(actions); li.addEventListener('click',()=>loadChatSession(s.id)); ul.appendChild(li); }); indicateActiveSession(); }).catch(()=>{}); }
function createChatSession(cb){ const modelEl=document.getElementById('llmSelect'); const model=modelEl?modelEl.value:null; fetch('/api/chat/session',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({model})}).then(r=>r.json()).then(d=>{ if(d.ok){ currentChatSession=d.session.id; refreshChatSessions(); if(cb) cb(); } }).catch(()=>{}); }
function loadChatSession(id){ fetch('/api/chat/session/'+id).then(r=>r.json()).then(d=>{ if(!d.ok) return; currentChatSession=d.session.id; clearChatHistory(); (d.session.messages||[]).forEach(m=>renderChatMessage(m.role,m.content)); indicateActiveSession(); scrollChatBottom(true); }).catch(()=>{}); }
function deleteChatSession(id){ if(!confirm('Delete this chat session?')) return; fetch('/api/chat/session/'+id,{method:'DELETE'}).then(r=>r.json()).then(()=>{ if(currentChatSession===id) currentChatSession=null; refreshChatSessions(); if(!currentChatSession){ clearChatHistory(); } }).catch(()=>{}); }
function renameChatSessionPrompt(id){ const cur=chatSessions.find(s=>s.id===id); const title=prompt('New title',cur?cur.title:''); if(title){ fetch('/api/chat/session/'+id+'/rename',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title})}).then(()=>refreshChatSessions()).catch(()=>{}); } }
function ensureSession(runAfter){ if(currentChatSession){ runAfter(); return;} createChatSession(runAfter); }
function appendChat(role,text){ renderChatMessage(role,text); }
function sendChat(){ 
    const ta=document.getElementById('chatInput'); 
    const msg=ta.value.trim(); 
    if(!msg) return; 
    ta.value=''; 
    ensureSession(()=>{ 
        const firstMessageForRename = !chatSessions.find(s=>s.id===currentChatSession)|| (chatSessions.find(s=>s.id===currentChatSession).count===0);
        appendChat('user', msg);
        
        fetch('/api/chat/session/'+currentChatSession+'/message',{
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({message: msg})
        }).then(r=>r.json()).then(d=>{ 
            if(d.ok && d.reply){ 
                // Enhanced chat message rendering for agentic AI
                appendAgenticChat('ai', d.reply, d.download_url); 
                
                // rename after first user message for better title
                if(firstMessageForRename){ 
                    const base=msg.split('\n')[0].slice(0,60); 
                    fetch('/api/chat/session/'+currentChatSession+'/rename',{
                        method:'POST', 
                        headers:{'Content-Type':'application/json'}, 
                        body:JSON.stringify({title: base})
                    }).then(()=>refreshChatSessions()).catch(()=>{}); 
                } 
                refreshChatSessions(); 
            }
            else if(d.error){ 
                appendChat('ai','Error: '+d.error); 
            } else { 
                appendChat('ai','(no reply)'); 
            } 
        }).catch(()=>appendChat('ai','(network error)')); 
    }); 
}

// Enhanced chat message rendering for agentic AI features
function appendAgenticChat(role, text, downloadUrl) {
    const chatHistory = document.getElementById('chatHistory');
    if (!chatHistory) return;
    
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${role}`;
    
    // Convert markdown-style links to clickable links
    let processedText = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:#0e639c;text-decoration:underline;">$1</a>');
    
    // If there's a download URL, make sure it's clickable
    if (downloadUrl) {
        processedText = processedText.replace(/\[📥 Download Report\]\([^)]+\)/, `<a href="${downloadUrl}" target="_blank" style="color:#0e639c;text-decoration:underline;font-weight:bold;">📥 Download Report</a>`);
    }
    
    msgDiv.innerHTML = processedText.replace(/\n/g, '<br>');
    
    // Add special styling for agentic AI responses
    if (role === 'ai' && (text.includes('Report Generated') || text.includes('✅') || downloadUrl)) {
        msgDiv.style.border = '1px solid #0e639c';
        msgDiv.style.background = '#1a2632';
    }
    
    chatHistory.appendChild(msgDiv);
    scrollChatBottom();
}
// Fallback simple chat endpoint (unused once sessions active) kept for compatibility
function sendLegacyChat(msg){ fetch('/api/vs_terminal/chat',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message: msg})}).then(r=>r.json()).then(d=>{ if(d.reply) appendChat('ai',d.reply); }); }

// --- Workspace File Management ---
let selectedWorkspaceFile = null;
function refreshWorkspaceFiles(){
  fetch('/api/vs_terminal/workspace_files').then(r=>r.json()).then(d=>{
    const ul=document.getElementById('workspaceFilesList');
    if(!ul) return;
    ul.innerHTML='';
    
    if(d.ok && d.files){
      d.files.forEach(file=>{
        const li=document.createElement('li');
        li.style.display='flex'; 
        li.style.justifyContent='space-between'; 
        li.style.alignItems='center';
        li.style.cursor='pointer';
        
        const icon = _getFileIcon(file.extension);
        const sizeStr = _formatFileSize(file.size);
        const dateStr = new Date(file.modified).toLocaleDateString();
        
        li.innerHTML = `
          <span style="display:flex; align-items:center; gap:4px;">
            <i class="${icon}" style="color:#569cd6;"></i>
            <span title="${file.path}">${file.name}</span>
          </span>
          <span style="font-size:9px; color:#888;">${sizeStr}</span>
        `;
        
        li.onclick = () => {
          selectedWorkspaceFile = file;
          [...ul.querySelectorAll('li')].forEach(item => item.style.background = '');
          li.style.background = '#094771';
        };
        
        ul.appendChild(li);
      });
      
      if(d.files.length === 0){
        ul.innerHTML = '<li style="color:#888; font-style:italic;">No files in workspace</li>';
      }
    } else {
      ul.innerHTML = '<li style="color:#f66;">Error loading files</li>';
    }
  }).catch(()=>{
    const ul=document.getElementById('workspaceFilesList');
    if(ul) ul.innerHTML = '<li style="color:#f66;">Network error</li>';
  });
}

function loadSelectedWorkspaceFile(){
  if(!selectedWorkspaceFile){
    setStatus('No workspace file selected');
    return;
  }
  
  fetch('/api/vs_terminal/read_file', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({file_path: selectedWorkspaceFile.path})
  }).then(r=>r.json()).then(d=>{
    if(d.ok){
      editor.setValue(d.content);
      setStatus(`Loaded: ${selectedWorkspaceFile.name} (${d.size} chars)`);
    } else {
      setStatus(`Error loading file: ${d.error}`);
    }
  }).catch(e=>{
    setStatus(`Error loading file: ${e.toString()}`);
  });
}

function deleteSelectedWorkspaceFile(){
  if(!selectedWorkspaceFile){
    setStatus('No workspace file selected');
    return;
  }
  
  if(!confirm(`Delete ${selectedWorkspaceFile.name}?`)) return;
  
  // Note: We'd need to add a delete endpoint to the backend
  setStatus(`Delete not implemented yet for: ${selectedWorkspaceFile.name}`);
}

function _getFileIcon(extension){
  const iconMap = {
    '.py': 'fab fa-python',
    '.js': 'fab fa-js-square',
    '.html': 'fab fa-html5',
    '.css': 'fab fa-css3-alt',
    '.json': 'fas fa-file-code',
    '.txt': 'fas fa-file-alt',
    '.md': 'fab fa-markdown'
  };
  return iconMap[extension] || 'fas fa-file';
}

function _formatFileSize(bytes){
  if(bytes < 1024) return bytes + 'B';
  if(bytes < 1024*1024) return Math.round(bytes/1024) + 'KB';
  return Math.round(bytes/(1024*1024)) + 'MB';
}

// Mobile sidebar toggle functions
function toggleMobileSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.mobile-overlay');
  
  if (sidebar && overlay) {
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
  }
}

function closeMobileSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const chatPanel = document.querySelector('.right-panel');
  const overlay = document.querySelector('.mobile-overlay');
  
  if (sidebar) sidebar.classList.remove('mobile-open');
  if (chatPanel) chatPanel.classList.remove('mobile-open');
  if (overlay) overlay.classList.remove('active');
}

function toggleMobileChat() {
  const chatPanel = document.querySelector('.right-panel');
  const overlay = document.querySelector('.mobile-overlay');
  
  if (chatPanel && overlay) {
    chatPanel.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
  }
}

// Demo function to generate sample code for testing Auto-Apply
function generateDemoCode(){
  const demoCodeExamples = [
    {
      role: 'ai',
      content: `Here's a simple calculator function you can auto-apply:

\`\`\`python
def calculator(a, b, operation):
    """A simple calculator function with multiple operations."""
    if operation == 'add':
        return a + b
    elif operation == 'subtract':
        return a - b
    elif operation == 'multiply':
        return a * b
    elif operation == 'divide':
        if b != 0:
            return a / b
        else:
            return "Error: Division by zero"
    else:
        return "Error: Invalid operation"

# Test the calculator
print("Testing calculator:")
print(f"5 + 3 = {calculator(5, 3, 'add')}")
print(f"10 - 4 = {calculator(10, 4, 'subtract')}")
print(f"7 * 8 = {calculator(7, 8, 'multiply')}")
print(f"15 / 3 = {calculator(15, 3, 'divide')}")
\`\`\`

👆 Click the green **Auto-Apply** button above to automatically create a new file with this code!`
    },
    {
      role: 'ai', 
      content: `Here's a data analysis helper function:

\`\`\`python
import pandas as pd
import numpy as np

def analyze_data(data):
    """Analyze a dataset and return basic statistics."""
    if isinstance(data, list):
        data = pd.Series(data)
    
    analysis = {
        'count': len(data),
        'mean': np.mean(data),
        'median': np.median(data),
        'std': np.std(data),
        'min': np.min(data),
        'max': np.max(data)
    }
    
    return analysis

# Example usage
sample_data = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
results = analyze_data(sample_data)
print("Data Analysis Results:")
for key, value in results.items():
    print(f"{key}: {value:.2f}")
\`\`\`

Use **Auto-Apply** to save this as a new Python file in your workspace!`
    },
    {
      role: 'ai',
      content: `Here's a simple web scraper utility:

\`\`\`python
import requests
from datetime import datetime

def fetch_web_data(url, headers=None):
    """Fetch data from a web URL with error handling."""
    try:
        if headers is None:
            headers = {'User-Agent': 'Mozilla/5.0 (compatible; Data Fetcher)'}
        
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        
        return {
            'success': True,
            'data': response.text,
            'status_code': response.status_code,
            'timestamp': datetime.now().isoformat()
        }
    except Exception as e:
        return {
            'success': False,
            'error': str(e),
            'timestamp': datetime.now().isoformat()
        }

# Example usage
# result = fetch_web_data('https://httpbin.org/json')
# print(f"Fetch successful: {result['success']}")
\`\`\`

Try the **Auto-Apply** button to create this web scraper utility!`
    }
  ];
  
  // Select a random demo example
  const demo = demoCodeExamples[Math.floor(Math.random() * demoCodeExamples.length)];
  
  // Simulate AI response
  renderChatMessage(demo.role, demo.content);
  setStatus('Demo code generated! Try the Auto-Apply button on the code block above.');
}

window.addEventListener('load',()=>{ const saved=localStorage.getItem('vst_editorHeight'); if(saved){ editorWrapper.style.height=saved; setTimeout(()=>editor.refresh(),30); } // restore report draft
    const draft=localStorage.getItem('vst_report_draft'); if(draft && !document.getElementById('reportEditor').value.trim()){ document.getElementById('reportEditor').value=draft; }
    ensureChatVisible(); refreshReportList(); refreshChatSessions(); refreshWorkspaceFiles(); });
// Autosave report draft
setInterval(()=>{ const val=document.getElementById('reportEditor').value; localStorage.setItem('vst_report_draft', val); }, 5000);
window.addEventListener('resize',()=>{ ensureChatInputVisible(); });
// Detect manual scroll to disable autoscroll
document.addEventListener('DOMContentLoaded',()=>{
  if(typeof refreshModelList==='function') try{ refreshModelList(); }catch(e){}
  const h=document.getElementById('chatHistory');
    if(h){
        h.addEventListener('scroll',()=>{
            const atBottom = h.scrollTop + h.clientHeight >= h.scrollHeight - 10;
            if(!atBottom){ chatAutoScroll=false; }
            maybeShowJump();
        }, { passive:true });
    }
    // Initial scroll to bottom only once
    setTimeout(()=>{ scrollChatBottom(true); maybeShowJump(); }, 50);
});
// Populate LLM model list dynamically
fetch('/api/vs_terminal/models').then(r=>r.json()).then(d=>{
  const sel=document.getElementById('llmSelect');
  if(d.models && d.models.length){
      sel.innerHTML='';
      d.models.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m+(m===d.default?' (default)':''); sel.appendChild(opt); });
  }
  const statusDiv=document.getElementById('llmStatus');
  if(d.status){
      const parts=Object.values(d.status).map(s=>`${s.model||''}:${s.ready?'ready':'off'}`);
      statusDiv.textContent='Models: '+parts.join(', ');
  } else { statusDiv.textContent='Models loaded'; }
}).catch(()=>{ const statusDiv=document.getElementById('llmStatus'); if(statusDiv) statusDiv.textContent='Model list unavailable'; });
// --- Diagnostics & Config ---
function refreshDiagnostics(){
  fetch('/api/vs_terminal/diagnostics').then(r=>r.json()).then(d=>{
    if(!d.ok){ document.getElementById('diagPanel').textContent='Error: '+(d.error||'unknown'); return; }
    const diag=d.diagnostics;
    let txt=`Host: ${diag.host}\nPort: ${diag.port}\nBase URL: ${diag.base_url}\nDefault Model: ${diag.default_model}\nGen Timeout: ${diag.gen_timeout}s\nDefault Model Status: ${JSON.stringify(diag.default_model_status)}\nAvailable Models: ${(diag.available_models||[]).join(', ')||'(none)'}\nEnv Overrides: ${JSON.stringify(diag.env_overrides)}\nRecent Errors:\n`;
    if(diag.recent_errors && diag.recent_errors.length){
      diag.recent_errors.forEach(e=>{ txt+=` - ${e.stage}: ${e.error} (status=${e.status})\n`; });
    } else { txt+=' (none)'; }
    document.getElementById('diagPanel').textContent=txt;
  }).catch(e=>{ document.getElementById('diagPanel').textContent='Fetch error: '+e; });
}
function applyConfig(){
  const host=document.getElementById('cfgHost').value.trim()||null;
  const port=document.getElementById('cfgPort').value.trim()||null;
  const model=document.getElementById('cfgModel').value.trim()||null;
  const gen_timeout=document.getElementById('cfgGenTimeout').value.trim()||null;
  fetch('/api/vs_terminal/config',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({host, port, model, gen_timeout})})
    .then(r=>r.json()).then(d=>{ if(!d.ok){ alert('Config error: '+(d.error||'unknown')); return;} refreshDiagnostics(); if(d.changed && d.changed.model){ document.getElementById('modelIndicator').textContent=d.changed.model; }
      fetch('/api/vs_terminal/models').then(r=>r.json()).then(d2=>{ const sel=document.getElementById('llmSelect'); if(d2.models){ sel.innerHTML=''; d2.models.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m+(m===d2.default?' (default)':''); sel.appendChild(opt); }); } }).catch(()=>{});
    }).catch(e=>alert('Config request failed: '+e));
}
function warmModel(){
  const model=document.getElementById('llmSelect').value;
  const ws=document.getElementById('warmStatus');
  ws.textContent='Warm: starting...';
  fetch('/api/vs_terminal/warm',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({model, prompt:'Warmup ping', timeout:180})})
    .then(r=>r.json()).then(d=>{ if(d.ok){ ws.textContent='Warm: loaded ('+(d.chars||'')+' chars raw)'; } else { ws.textContent='Warm fail: '+(d.error||d.status||'unknown'); } refreshDiagnostics(); })
    .catch(e=>{ ws.textContent='Warm error: '+e; });
}
// AI Provider functions
function refreshAIProviders(){
  fetch('/api/ai/providers').then(r=>r.json()).then(d=>{
    const listDiv=document.getElementById('aiProvidersList');
    const sel=document.getElementById('cfgAIProvider');
    if(!listDiv||!sel) return; listDiv.innerHTML=''; sel.innerHTML='';
    (d.providers||[]).forEach(p=>{
      const row=document.createElement('div');
      row.style.display='flex'; row.style.alignItems='center'; row.style.gap='4px';
      row.style.background=p.selected?'#094771':'#2d2d2d'; row.style.padding='4px 6px'; row.style.borderRadius='4px';
      row.innerHTML=`<span style='flex:1;'>${p.label}</span><span style='font-size:10px; color:${p.configured?'#6f6':'#f66'};'>${p.configured?'set':'none'}</span>`;
      row.title = (p.notes||'') + (p.models_hint?`\nModels: ${p.models_hint}`:'');
      listDiv.appendChild(row);
      const opt=document.createElement('option'); opt.value=p.key; opt.textContent=p.label; sel.appendChild(opt);
    });
  }).catch(()=>{});
}
function saveAIProvider(){
  const provider=document.getElementById('cfgAIProvider').value; const api_key=document.getElementById('cfgAIKey').value.trim(); const model=document.getElementById('cfgAIModel').value.trim(); const base_url=document.getElementById('cfgAIBase').value.trim();
  document.getElementById('aiProvStatus').textContent='Saving...';
  fetch('/api/ai/providers/configure',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({provider, api_key, model, base_url})}).then(r=>r.json()).then(d=>{
    if(d.error){ document.getElementById('aiProvStatus').textContent='Error: '+d.error; return; }
    document.getElementById('aiProvStatus').textContent='Saved'; refreshAIProviders();
  }).catch(e=>{ document.getElementById('aiProvStatus').textContent='Error: '+e; });
}
function selectAIProvider(){
  const provider=document.getElementById('cfgAIProvider').value; const model=document.getElementById('cfgAIModel').value.trim();
  document.getElementById('aiProvStatus').textContent='Selecting...';
  fetch('/api/ai/providers/select',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({provider, model})}).then(r=>r.json()).then(d=>{
    document.getElementById('aiProvStatus').textContent=d.error?'Error: '+d.error:'Selected'; refreshAIProviders();
  }).catch(e=>{ document.getElementById('aiProvStatus').textContent='Error: '+e; });
}
// ================== Published Models ==================
let publishPanelEl=null; let currentPublishedSelection=null; let publishedModels=[]; let publishAllowedFunctions=[];
let publishedPage=1, publishedPages=1, publishedSearch='';
function openPublishPanel(){
  if(publishPanelEl){ publishPanelEl.remove(); publishPanelEl=null; return; }
  publishPanelEl=document.createElement('div');
  publishPanelEl.style.position='fixed'; publishPanelEl.style.top='50%'; publishPanelEl.style.left='50%'; publishPanelEl.style.transform='translate(-50%,-50%)'; publishPanelEl.style.background='#1e1e1e'; publishPanelEl.style.border='1px solid #444'; publishPanelEl.style.width='560px'; publishPanelEl.style.maxHeight='80%'; publishPanelEl.style.overflow='auto'; publishPanelEl.style.zIndex='9999'; publishPanelEl.style.padding='14px 16px'; publishPanelEl.style.borderRadius='8px';
  publishPanelEl.innerHTML=`<div style='display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;'>
    <h3 style='margin:0; font-size:15px;'>Publish Model</h3>
    <button class='secondary-btn' style='padding:4px 8px; font-size:11px;' onclick='closePublishPanel()'>Close</button>
  </div>
  <div style='display:flex; flex-direction:column; gap:8px;'>
    <input id='pubName' placeholder='Name (required)' style='font-size:12px;'>
    <select id='pubVisibility' style='font-size:12px;'>
      <option value='public'>public</option>
      <option value='restricted'>restricted</option>
      <option value='private'>private</option>
    </select>
    <div style='display:flex; flex-direction:column; gap:4px;'>
      <label style='font-size:11px; color:var(--muted); font-weight:600;'>Model Category</label>
      <select id='pubCategory' style='font-size:12px;'>
        <option value='Ultra Short-Term'>Ultra Short-Term</option>
        <option value='Short-Term'>Short-Term</option>
        <option value='Medium-Term'>Medium-Term</option>
        <option value='Long-Term'>Long-Term</option>
        <option value='High Risk'>High Risk</option>
        <option value='Medium Risk'>Medium Risk</option>
        <option value='Low Risk'>Low Risk</option>
        <option value='Fundamental Models'>Fundamental Models</option>
        <option value='Technical Models'>Technical Models</option>
        <option value='Quantitative' selected>Quantitative</option>
        <option value='Hybrid Models'>Hybrid Models</option>
        <option value='Risk Management Models'>Risk Management Models</option>
        <option value='Portfolio Optimization'>Portfolio Optimization</option>
      </select>
    </div>
    <textarea id='pubReadme' style='height:90px; font-size:12px;' placeholder='README markdown (optional)'></textarea>
    <div style='display:flex; gap:6px;'>
      <button class='secondary-btn' style='flex:1;' onclick='introspectCurrentCode()'>Detect Functions</button>
      <button class='secondary-btn' style='flex:1;' onclick='publishCurrentCode()'>Publish</button>
    </div>
    <div id='pubFunctionsBox' style='border:1px solid #333; padding:6px; border-radius:4px; font-size:11px; display:none;'>
      <div style='font-weight:600; margin-bottom:4px;'>Select Allowed Functions</div>
      <div id='pubFunctionsList' style='display:flex; flex-wrap:wrap; gap:6px;'></div>
    </div>
    <div id='pubStatus' style='font-size:11px; color:#999;'>Idle</div>
  </div>`;
  document.body.appendChild(publishPanelEl);
}
function closePublishPanel(){ if(publishPanelEl){ publishPanelEl.remove(); publishPanelEl=null; } }
// Added missing list refresher for published models to avoid ReferenceError
function refreshPublishedModels(forceSearch){
  const listEl=document.getElementById('publishedModelsList');
  if(!listEl){ return; }
  const search = forceSearch ? (document.getElementById('pubSearch')?document.getElementById('pubSearch').value.trim():'') : (document.getElementById('pubSearch')?document.getElementById('pubSearch').value.trim():'');
  const category = document.getElementById('pubCategoryFilter')?document.getElementById('pubCategoryFilter').value.trim():'';
  let page = publishedPage||1;
  let url = `/api/published_models?page=${page}&page_size=20`;
  if(search) url += '&search='+encodeURIComponent(search);
  if(category) url += '&category='+encodeURIComponent(category);
  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok){ listEl.innerHTML='<div style="padding:6px; color:#c66;">Load error</div>'; return; }
      publishedPages = d.pages || 1; publishedPage = d.page || 1;
      const arr = d.models||[];
      listEl.innerHTML='';
      if(!arr.length){ listEl.innerHTML='<div style="padding:6px; opacity:.6;">No models</div>'; return; }
      arr.forEach(m=>{
        const row=document.createElement('div');
        row.style.padding='4px 6px'; row.style.borderBottom='1px solid #2a2a2a'; row.style.cursor='pointer'; row.style.fontSize='11px';
        const runTxt = (m.run_count!=null)? m.run_count : 0;
        const subTxt = (m.subscriber_count!=null)? m.subscriber_count : 0;
        const auth = m.author || m.author_user_key || 'anon';
        row.innerHTML = `<div style='display:flex; justify-content:space-between; gap:6px;'>
            <span style='flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;'>${m.name}@${m.version}</span>
            <span style='color:#888;'>R:${runTxt}</span>
            <span style='color:#888;'>S:${subTxt}</span>
          </div>
          <div style='font-size:9px; color:#666; margin-top:2px; display:flex; justify-content:space-between; gap:4px;'>
            <span style='flex:1 1 auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;'>by ${auth}</span>
            <span>${m.category||''}</span>
          </div>`;
        row.onclick=()=>selectPublished(m.id);
        listEl.appendChild(row);
      });
    }).catch(()=>{ listEl.innerHTML='<div style="padding:6px; color:#c66;">Network error</div>'; });
}
function introspectCurrentCode(){
  const code=editor.getValue(); if(!code.trim()){ document.getElementById('pubStatus').textContent='No code'; return; }
  document.getElementById('pubStatus').textContent='Introspecting...';
  fetch('/api/published_models/dummy/introspect',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code})})
    .then(r=>r.json()).then(d=>{
      if(d.error){ document.getElementById('pubStatus').textContent='Error: '+d.error; return; }
      publishAllowedFunctions=d.functions||[];
      const box=document.getElementById('pubFunctionsBox'); const list=document.getElementById('pubFunctionsList');
      list.innerHTML=''; publishAllowedFunctions.forEach(fn=>{ const lbl=document.createElement('label'); lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='4px'; lbl.style.background='#262626'; lbl.style.padding='4px 6px'; lbl.style.borderRadius='4px'; lbl.innerHTML=`<input type='checkbox' value='${fn}' checked style='margin:0;'> <span>${fn}</span>`; list.appendChild(lbl); });
      box.style.display= publishAllowedFunctions.length? 'block':'none';
      document.getElementById('pubStatus').textContent= publishAllowedFunctions.length? 'Detected '+publishAllowedFunctions.length+' functions':'No public functions';
    }).catch(e=>{ document.getElementById('pubStatus').textContent='Introspect fail: '+e; });
}
function publishCurrentCode(){
  const name=document.getElementById('pubName').value.trim(); if(!name){ document.getElementById('pubStatus').textContent='Name required'; return; }
  const code=editor.getValue(); if(!code.trim()){ document.getElementById('pubStatus').textContent='Empty code'; return; }
  const vis=document.getElementById('pubVisibility').value;
  const category=document.getElementById('pubCategory').value;
  const readme=document.getElementById('pubReadme').value;
  const selectedFns=[...document.querySelectorAll('#pubFunctionsList input[type=checkbox]:checked')].map(i=>i.value);
  document.getElementById('pubStatus').textContent='Publishing...';
 
  fetch('/api/publish_model',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, code, visibility:vis, category, readme_md:readme, allowed_functions:selectedFns})})
    .then(r=>r.json()).then(d=>{ if(!d.ok){ document.getElementById('pubStatus').textContent='Publish error: '+(d.error||''); return;} document.getElementById('pubStatus').textContent='Published '+d.model.id; refreshPublishedModels(); })
    .catch(e=>{ document.getElementById('pubStatus').textContent='Publish fail: '+e; });
}
// Simple wrapper expected by toolbar button
function publishModel(){ openPublishPanel(); }
// Legacy buttons expect saveModel(false) and publishModel(); reintroduce wrappers.
function saveModel(dry){
  try{
    const code=editor.getValue();
    if(!code.trim()){ setStatus('Nothing to save'); return; }
    const name = prompt('Save As (filename, no extension)', localStorage.getItem('last_saved_model_name')||'model1');
    if(!name){ setStatus('Save canceled'); return; }
    setStatus('Saving '+name+' ...');
    fetch('/api/save_model',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, code})})
      .then(r=>r.json()).then(d=>{ if(!d.ok){ setStatus('Save error: '+(d.error||'')); return; } setStatus('Saved as '+name); localStorage.setItem('last_saved_model_name', name); refreshModelList && refreshModelList(); })
      .catch(e=> setStatus('Save fail: '+e));
  }catch(e){ setStatus('Save exception: '+e); }
}
function selectPublished(id){
    currentPublishedSelection=id;
    const details=document.getElementById('publishedModelDetails');
    if(details){ details.style.display='block'; details.textContent='Loading...'; }
    fetch('/api/published_models/'+id)
      .then(r=>r.json())
      .then(d=>{
        if(!d.ok){ if(details){ details.textContent='Load error'; } return; }
        const m=d.model; // include readme
        let allowed=[]; try{ allowed=JSON.parse(m.allowed_functions||'[]'); }catch(e){}
        publishAllowedFunctions=allowed;
        let fnSelect='';
        if(allowed.length){
            fnSelect = `<div style='margin-top:6px;'>Function: <select id='publishedFunctionSelect' style='font-size:11px;'>${allowed.map(a=>`<option value='${a}'>${a}</option>`).join('')}</select></div>`;
        } else {
            fnSelect = `<div style='margin-top:6px; color:#c66;'>No allowed functions</div>`;
        }
    details.innerHTML = `<div style='font-weight:600;'>${m.name}@${m.version}</div>
    <div>Visibility: ${m.visibility}</div>
    <div>Author: ${m.author||m.author_user_key||'?'} | Category: ${m.category||'n/a'}</div>
    <div>Runs: ${m.run_count||0} | Subs: ${(m.subscriber_count!=null)?m.subscriber_count:'-'}</div>
    <div>Last Change: ${m.last_change_at||'-'}<br><span style='color:#999;'>${(m.last_change_summary||'').replace(/[<>]/g,c=>({'<':'&lt;','>':'&gt;'}[c]))}</span></div>
    <div style='margin-top:4px; max-height:60px; overflow:auto;'>${(m.readme_md||'').replace(/[<>]/g,c=>({'<':'&lt;','>':'&gt;'}[c]))}</div>
    ${fnSelect}
    <div style='margin-top:6px; display:flex; flex-direction:column; gap:4px;'>
      <input id='publishedArgsInput' placeholder='Args JSON array (optional)' style='font-size:11px;'>
      <input id='publishedKwargsInput' placeholder='Kwargs JSON object (optional)' style='font-size:11px;'>
            <input id='publishedTimeoutInput' placeholder='Timeout seconds (default 10)' style='font-size:11px;'>
        </div>`;
    }).catch(()=>{ if(details){ details.textContent='Load failure'; } });
}
function requestEditSelected(){
  // Feature disabled; left as no-op to avoid errors
  setStatus('Edit request feature disabled');
}
function changePublishedPage(delta){ let np=publishedPage+delta; if(np<1) np=1; if(np>publishedPages) np=publishedPages; if(np!==publishedPage){ publishedPage=np; refreshPublishedModels(); } }
function loadEditRequests(){ if(!currentPublishedSelection){ setStatus('No selection'); return;} fetch(`/api/published_models/${currentPublishedSelection}/requests`).then(r=>r.json()).then(d=>{ const panel=document.getElementById('editRequestsPanel'); if(!panel) return; if(d.error){ panel.style.display='block'; panel.textContent='Error: '+d.error; return; } if(!d.requests || !d.requests.length){ panel.style.display='block'; panel.textContent='No requests'; return; } panel.style.display='block'; panel.innerHTML=''; d.requests.forEach(req=>{ const row=document.createElement('div'); row.style.borderBottom='1px solid #333'; row.style.padding='4px 0'; row.innerHTML=`<div><strong>${req.requester_user_key}</strong> <span style='color:${req.status==='pending'?'#fa3':'#999'};'>${req.status}</span></div><div style='white-space:pre-wrap;'>${(req.reason||'').slice(0,260)}</div>`; if(req.status==='pending'){ const actions=document.createElement('div'); actions.style.marginTop='4px'; actions.style.display='flex'; actions.style.gap='4px'; const approve=document.createElement('button'); approve.className='secondary-btn'; approve.style.fontSize='10px'; approve.textContent='Approve'; approve.onclick=()=>decideEditRequest(req.id,'approve'); const deny=document.createElement('button'); deny.className='secondary-btn'; deny.style.fontSize='10px'; deny.textContent='Deny'; deny.onclick=()=>decideEditRequest(req.id,'deny'); actions.appendChild(approve); actions.appendChild(deny); row.appendChild(actions);} panel.appendChild(row); }); }).catch(()=>{}); }
function decideEditRequest(rid, decision){ fetch(`/api/published_models/${currentPublishedSelection}/requests/${rid}/decision`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({decision})}).then(r=>r.json()).then(d=>{ if(d.ok){ loadEditRequests(); refreshPublishedModels(); setStatus('Decision: '+d.status); } else { setStatus('Decision error'); } }).catch(()=>{}); }
// modify runSelectedPublished to show timeout and capture errors already done sandbox side
function runSelectedPublished(){ if(!currentPublishedSelection){ setStatus('No published model selected'); return; } const fnSel=document.getElementById('publishedFunctionSelect'); const fn = fnSel?fnSel.value:null; if(!fn){ setStatus('No function selected'); return; } let args=[], kwargs={}; try{ const a=document.getElementById('publishedArgsInput').value.trim(); if(a){ args=JSON.parse(a); if(!Array.isArray(args)) throw new Error('Args must be array'); } }catch(e){ alert('Args JSON invalid: '+e); return;} try{ const k=document.getElementById('publishedKwargsInput').value.trim(); if(k){ kwargs=JSON.parse(k); if(typeof kwargs!=='object'||Array.isArray(kwargs)) throw new Error('Kwargs must be object'); } }catch(e){ alert('Kwargs JSON invalid: '+e); return;} let timeout=null; const t=document.getElementById('publishedTimeoutInput').value.trim(); if(t){ timeout=parseInt(t)||600; } else { timeout=600; } // Default 10 minutes for ML models setStatus('Running '+fn+' ...'); const outEl=document.getElementById('resultOutput'); outEl.textContent='Running '+fn+' ...'; 

// Create AbortController for frontend timeout
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), (timeout + 50) * 1000); // Server timeout + buffer

fetch('/api/published_models/'+currentPublishedSelection+'/run',{
  method:'POST', 
  headers:{'Content-Type':'application/json'}, 
  body:JSON.stringify({function:fn, args, kwargs, timeout}),
  signal: controller.signal
}).then(r=>r.json()).then(d=>{ 
  clearTimeout(timeoutId);
  const text = d.result || d.output || d.error || JSON.stringify(d); 
  lastOutput=text; 
  outEl.textContent=text; 
  setStatus(d.error?'Run error':'Run complete'); 
  ensureChatVisible(); 
}).catch(e=>{ 
  clearTimeout(timeoutId);
  if (e.name === 'AbortError') {
    outEl.textContent='Execution timed out after ' + timeout + ' seconds. ML models now have extended timeout. Try using async API for very long analyses.';
    setStatus('Execution timeout');
  } else {
    outEl.textContent='Error: '+e; 
    setStatus('Execution error'); 
  }
  ensureChatVisible(); 
}); }
// ---------------- Interactive Terminal Frontend ----------------
let terminalSessionId=null;
function ensureTerminalSession(){ if(terminalSessionId) return Promise.resolve(terminalSessionId); return fetch('/api/terminal/session',{method:'POST'}).then(r=>r.json()).then(d=>{ if(d.ok){ terminalSessionId=d.session_id; const win=document.getElementById('terminalWindow'); if(win){ win.innerHTML='<div class="line sys">Session '+terminalSessionId+' created</div>'; } return terminalSessionId; } else { throw new Error('terminal create failed'); } }); }
function appendTerminalLine(text, cls){ const win=document.getElementById('terminalWindow'); if(!win) return; const div=document.createElement('div'); div.className='line '+(cls||'out'); div.textContent=text; win.appendChild(div); win.scrollTop=win.scrollHeight; }
function terminalInputKey(e){ if(e.key==='Enter'){ if(e.shiftKey){ return; } e.preventDefault(); const inp=e.currentTarget; const line=inp.value; inp.value=''; ensureTerminalSession().then(()=>sendTerminalLine(line)); } }
function sendTerminalLine(line){ appendTerminalLine('>>> '+line, 'in'); fetch('/api/terminal/'+terminalSessionId+'/exec',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({line})}).then(r=>r.json()).then(d=>{ if(!d.ok){ appendTerminalLine('[error] '+(d.error||'fail'),'err'); return;} if(d.output){ d.output.split(/\n/).forEach(l=>{ if(l.length) appendTerminalLine(l,'out'); }); } if(d.stderr){ d.stderr.split(/\n/).forEach(l=>{ if(l.length) appendTerminalLine(l,'err'); }); } if(d.more){ appendTerminalLine('... (continue block)','sys'); } }).catch(err=> appendTerminalLine('[network] '+err,'err')); }
function resetTerminalSession(){ if(!terminalSessionId){ ensureTerminalSession().then(resetTerminalSession); return; } fetch('/api/terminal/'+terminalSessionId+'/reset',{method:'POST'}).then(r=>r.json()).then(d=>{ if(d.ok){ const win=document.getElementById('terminalWindow'); if(win){ win.innerHTML='<div class="line sys">Session reset</div>'; } } else { appendTerminalLine('[reset failed]','err'); } }).catch(()=> appendTerminalLine('[reset error]','err')); }
function refreshAuthorRequests(){
  const box = document.getElementById('authorRequests');
  if(!box){ return; }
  box.textContent='Loading...';
  // Strategy: list first N published models (author view) then fetch their requests; aggregate pending only
  fetch('/api/published_models?page=1&page_size=50').then(r=>r.json()).then(d=>{
    if(!d.ok){ box.textContent='Error'; return; }
    const models = d.models || [];
    if(!models.length){ box.textContent='(no models)'; return; }
    const pendingRows = [];
    let remaining = models.length;
    function done(){ remaining--; if(remaining===0){ box.innerHTML = pendingRows.length? pendingRows.join('') : '(none)'; }}
    models.forEach(m=>{
      fetch(`/api/published_models/${m.id}/requests`).then(r=>r.json()).then(dr=>{
        if(dr.requests){
          dr.requests.filter(x=>x.status==='pending').forEach(req=>{
            pendingRows.push(`<div style='border-bottom:1px solid #333; padding:4px 0;'>`+
              `<div><strong>${m.name}</strong> – <span style='color:#fa3;'>pending</span></div>`+
              `<div style='white-space:pre-wrap;'>${(req.reason||'').slice(0,160)}</div>`+
              `<div style='display:flex; gap:4px; margin-top:4px;'>`+
                `<button class='secondary-btn' style='font-size:10px; flex:1;' onclick="decideAuthReq('${m.id}','${req.id}','approve')">Approve</button>`+
                `<button class='secondary-btn' style='font-size:10px; flex:1;' onclick="decideAuthReq('${m.id}','${req.id}','deny')">Deny</button>`+
              `</div>`+
            `</div>`);
          });
        }
        done();
      }).catch(done);
    });
  }).catch(()=>{ box.textContent='Error'; });
}
function decideAuthReq(mid,rid,decision){
  fetch(`/api/published_models/${mid}/requests/${rid}/decision`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({decision})})
    .then(r=>r.json()).then(d=>{ refreshAuthorRequests(); if(d.ok){ setStatus('Decision: '+d.status); } else { setStatus('Decision error'); } }).catch(()=>{ setStatus('Decision error'); });
}
// Auto-load on startup (slight delay so layout is ready)
setTimeout(refreshAuthorRequests, 1500);
</script>
{% if is_admin %}
<div id="adminPayPanel">
  <header>
    <span>Payment Settings</span>
    <button class="close-btn" onclick="toggleAdminPay(false)">&times;</button>
  </header>
  <form id="adminPayForm" onsubmit="saveAdminPay(event)">
    <label>Key ID<input name="key_id" required placeholder="rzp_test_..."></label>
    <label>Key Secret<input name="key_secret" required placeholder="secret"></label>
    <label>Webhook Secret<input name="webhook_secret" placeholder="webhook secret"></label>
    <label>Currency<input name="currency" value="INR"></label>
    <label>Price Retail (paise)<input name="price_retail" type="number" min="0"></label>
    <label>Price Pro (paise)<input name="price_pro" type="number" min="0"></label>
    <label>Price Pro Plus (paise)<input name="price_pro_plus" type="number" min="0"></label>
    <div class="small-note">Secrets stored server-side; only last 4 chars shown when loading.</div>
    <div class="actions">
      <button type="submit" class="primary-btn" style="flex:1;">Save</button>
      <button type="button" class="secondary-btn" style="flex:1;" onclick="reloadAdminPay()">Reload</button>
    </div>
    <div id="adminPayStatus" class="small-note">Idle</div>
  </form>
</div>
<script>
if(document.querySelector('.activity-bar')){
  const ab=document.querySelector('.activity-bar');
  const planBtn=document.createElement('button');
  planBtn.title='Analyst Plan Status / Upgrade';
  planBtn.innerHTML='<i class="fa fa-layer-group"></i>';
  planBtn.onclick=()=>togglePlanPanel();
  ab.appendChild(planBtn);
  const btn=document.createElement('button');
  btn.title='Admin Payment Settings';
  btn.innerHTML='<i class="fa fa-credit-card"></i>';
  btn.onclick=()=>toggleAdminPay();
  ab.appendChild(btn);
}
function toggleAdminPay(open){ const p=document.getElementById('adminPayPanel'); if(!p) return; if(open===false){ p.style.display='none'; return;} p.style.display = (p.style.display==='flex')?'none':'flex'; if(p.style.display==='flex'){ reloadAdminPay(); } }
function reloadAdminPay(){ fetch('/api/admin/payment_settings').then(r=>r.json()).then(d=>{ if(!d.ok){ setAdminPayStatus('Load error'); return;} const f=document.getElementById('adminPayForm'); Object.entries(d.settings||{}).forEach(([k,v])=>{ if(f.elements[k]) f.elements[k].value = v==null?'':v; }); setAdminPayStatus('Loaded'); }).catch(()=> setAdminPayStatus('Network error')); }
function saveAdminPay(e){ e.preventDefault(); const f=e.target; const payload={}; ['key_id','key_secret','webhook_secret','currency','price_retail','price_pro','price_pro_plus'].forEach(k=> payload[k]=f.elements[k]?f.elements[k].value.trim():undefined); setAdminPayStatus('Saving...'); fetch('/api/admin/payment_settings',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).then(r=>r.json()).then(d=>{ if(d.ok){ setAdminPayStatus('Saved'); reloadAdminPay(); } else { setAdminPayStatus('Save error: '+(d.error||'')); } }).catch(()=> setAdminPayStatus('Save network error')); }
function setAdminPayStatus(t){ const el=document.getElementById('adminPayStatus'); if(el) el.textContent=t; }
</script>
{% endif %}
{% if is_admin %}
<div id="aiReportAgentModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);z-index:3000;align-items:center;justify-content:center;">
  <div style="background:#23272e;padding:32px 24px 24px 24px;border-radius:10px;max-width:480px;width:95vw;box-shadow:0 4px 24px #000a;position:relative;">
    <button onclick="closeAIReportAgent()" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:22px;cursor:pointer;">&times;</button>
    <h2 style="margin-top:0;font-size:20px;">AI Report Agent</h2>
    <form id="aiReportAgentForm" onsubmit="submitAIReportAgent(event)">
      <label style="font-size:13px;">Stock/Sector Name
        <input name="subject" required placeholder="e.g. Reliance Industries or IT Sector" style="width:100%;margin-bottom:10px;" />
      </label>
      <label style="font-size:13px;">Report Requirements
        <textarea name="requirements" required placeholder="Describe what you want in the report (e.g. financials, charts, SWOT, etc.)" style="width:100%;height:80px;margin-bottom:10px;"></textarea>
      </label>
      <label style="font-size:13px;">Output Format
        <select name="format" style="width:100%;margin-bottom:16px;">
          <option value="pdf">PDF</option>
          <option value="docx">DOCX</option>
        </select>
      </label>
      <button class="primary-btn" type="submit" style="width:100%;font-size:15px;">Generate Report</button>
      <div id="aiReportAgentStatus" style="margin-top:10px;font-size:12px;color:#8ec07c;"></div>
      <div id="aiReportAgentDownload" style="margin-top:10px;font-size:13px;"></div>
    </form>
  </div>
</div>
<script>
function openAIReportAgent(){
  document.getElementById('aiReportAgentModal').style.display='flex';
  document.getElementById('aiReportAgentStatus').textContent='';
  document.getElementById('aiReportAgentDownload').innerHTML='';
}
function closeAIReportAgent(){
  document.getElementById('aiReportAgentModal').style.display='none';
}
function submitAIReportAgent(e){
  e.preventDefault();
  const f = e.target;
  const subject = f.subject.value.trim();
  const requirements = f.requirements.value.trim();
  const format = f.format.value;
  if(!subject||!requirements) return;
  document.getElementById('aiReportAgentStatus').textContent='Generating report...';
  document.getElementById('aiReportAgentDownload').innerHTML='';
  fetch('/api/ai_report_agent',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({subject,requirements,format})
  }).then(r=>r.json()).then(d=>{
    if(d.ok && d.download_url){
      document.getElementById('aiReportAgentStatus').textContent='Report ready!';
      document.getElementById('aiReportAgentDownload').innerHTML='<a href="'+d.download_url+'" target="_blank" style="color:#0e639c;text-decoration:underline;">Download '+format.toUpperCase()+' Report</a>';
    }else{
      document.getElementById('aiReportAgentStatus').textContent='Error: '+(d.error||'Unknown error');
    }
  }).catch(e=>{
    document.getElementById('aiReportAgentStatus').textContent='Network error: '+e;
  });
}
</script>
{% endif %}
<div id="planPanel">
  <header>
    <span>Analyst Plan <span id="planBadge" class="badge-plan"></span></span>
    <button class="close-btn" onclick="togglePlanPanel(false)">&times;</button>
  </header>
  <div class="content">
    <div id="planUsageSection">
      <div style="font-weight:600; font-size:12px;">Current Usage</div>
      <div class="usage-grid" id="planUsageGrid"></div>
    </div>
    <div id="planLimitsNote" class="hint"></div>
    <div class="upgrade-actions" id="upgradeActions"></div>
    <div id="planStatusMsg" class="hint">Loading...</div>
  </div>
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
const PLAN_LABELS={small:'Small (Free)', pro:'Pro', pro_plus:'Pro Plus'};
let currentAnalystPlan=null; let currentPlanInfo=null; let upgradingPlan=null;
function togglePlanPanel(open){ const p=document.getElementById('planPanel'); if(!p) return; if(open===false){ p.style.display='none'; return;} p.style.display = (p.style.display==='flex')?'none':'flex'; if(p.style.display==='flex'){ loadPlanStatus(); }}
function loadPlanStatus(){ const msg=document.getElementById('planStatusMsg'); msg.textContent='Loading...'; fetch('/api/analyst/plan_status').then(r=>r.json()).then(d=>{ if(!d.ok){ msg.textContent='Not logged in as analyst'; return;} currentPlanInfo=d.plan_info; currentAnalystPlan=currentPlanInfo.plan; renderPlanInfo(); }).catch(()=>{ msg.textContent='Load error'; }); }
function renderPlanInfo(){ const info=currentPlanInfo; if(!info) return; const badge=document.getElementById('planBadge'); badge.textContent=PLAN_LABELS[info.plan]||info.plan; const grid=document.getElementById('planUsageGrid'); grid.innerHTML=''; const rows=[
  ['Runs Today', fmtUsage(info.daily_run_count, info.runs_per_day)],
  ['LLM Prompts', fmtUsage(info.daily_llm_prompt_count, info.llm_prompts_per_day)],
  ['LLM Tokens', fmtUsage(info.daily_llm_token_count, info.llm_tokens_per_day)],
  ['Publish Limit', fmtUsage(info.publish_limit===0?0: (info.publish_limit==null? '∞': null), info.publish_limit, true)]
]; rows.forEach(r=>{ const [label,val]=r; const l=document.createElement('div'); l.textContent=label; const v=document.createElement('div'); v.innerHTML=val.html; if(val.exceeded) v.classList.add('exceeded','limit-row'); grid.appendChild(l); grid.appendChild(v); });
  const note=document.getElementById('planLimitsNote'); note.textContent = info.expires_at? 'Plan renews: '+info.expires_at : (info.plan==='small'?'Upgrade to unlock higher limits':'');
  const up=document.getElementById('upgradeActions'); up.innerHTML=''; if(info.plan!=='pro'){ up.appendChild(makeUpgradeBtn('pro','Upgrade to Pro (₹ 999 / month)','fa-arrow-up')); } if(info.plan!=='pro_plus'){ up.appendChild(makeUpgradeBtn('pro_plus','Upgrade to Pro Plus (₹ 2499 / month)','fa-rocket')); }
  document.getElementById('planStatusMsg').textContent=''; }
function fmtUsage(used, limit, isPublish){ if(limit==null){ return {html:`<span>${used!=null?used:'-' } / ∞</span>`}; } if(isPublish){ // need active count from backend separately (not provided) -> show limit only
    return {html:`<span>${limit===0? 'Disabled':'Limit '+limit}</span>`}; }
  const exceeded = typeof used==='number' && typeof limit==='number' && used>=limit; return {html:`<span>${used} / ${limit}</span>`, exceeded}; }
function makeUpgradeBtn(plan,label,icon){ const b=document.createElement('button'); b.className='up-btn'; b.innerHTML=`<i class="fa ${icon}"></i> ${label}`; b.onclick=()=>beginUpgrade(plan); return b; }
function beginUpgrade(plan){ if(upgradingPlan){ return;} upgradingPlan=plan; document.getElementById('planStatusMsg').textContent='Creating order...'; fetch('/api/analyst/upgrade/create_order',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({plan})}).then(r=>r.json()).then(d=>{ if(!d.ok){ document.getElementById('planStatusMsg').textContent='Order error: '+(d.error||''); upgradingPlan=null; return;} launchRzpCheckout(d, plan); }).catch(e=>{ document.getElementById('planStatusMsg').textContent='Network error'; upgradingPlan=null; }); }
function launchRzpCheckout(orderResp, plan){ if(!orderResp.public_key){ document.getElementById('planStatusMsg').textContent='Missing public key'; upgradingPlan=null; return; } const options={
    key: orderResp.public_key,
    amount: orderResp.amount,
    currency: orderResp.currency,
    name: 'Analyst Plan Upgrade',
    description: PLAN_LABELS[plan]+' Subscription',
    order_id: orderResp.order.id,
    handler: function (response){ confirmUpgrade(plan, response.razorpay_order_id, response.razorpay_payment_id, response.razorpay_signature); },
    modal: { ondismiss: ()=>{ document.getElementById('planStatusMsg').textContent='Checkout dismissed'; upgradingPlan=null; } },
    theme: { color:'#0e639c'}
  }; try{ const rzp=new window.Razorpay(options); rzp.open(); document.getElementById('planStatusMsg').textContent='Awaiting payment...'; }catch(e){ document.getElementById('planStatusMsg').textContent='Checkout init failed'; upgradingPlan=null; }
}
function confirmUpgrade(plan, order_id, payment_id, signature){ document.getElementById('planStatusMsg').textContent='Verifying...'; fetch('/api/analyst/upgrade/confirm',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({plan, order_id, payment_id, signature})}).then(r=>r.json()).then(d=>{ if(!d.ok){ document.getElementById('planStatusMsg').textContent='Verification failed: '+(d.error||''); upgradingPlan=null; return;} document.getElementById('planStatusMsg').textContent='Upgraded to '+PLAN_LABELS[d.plan]; upgradingPlan=null; loadPlanStatus(); }).catch(()=>{ document.getElementById('planStatusMsg').textContent='Verify network error'; upgradingPlan=null; }); }
// Hook publish errors to offer upgrade suggestion
const origPublish=publishCurrentCode; publishCurrentCode=function(){ const beforeCount=(window.publishAllowedFunctions||[]).length; origPublish.apply(this, arguments); // After small delay inspect status for gating
  setTimeout(()=>{ const st=document.getElementById('pubStatus'); if(!st) return; const txt=st.textContent||''; if(/Publish limit|not included/.test(txt)){ togglePlanPanel(true); const msgEl=document.getElementById('planStatusMsg'); if(msgEl && msgEl.textContent===''){ msgEl.textContent='Publishing blocked by plan. Consider upgrade.'; } } }, 800);
};

// Tab-specific functions
function insertPrompt(text) {
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.value = text;
    chatInput.focus();
  }
}

function insertReportPrompt(text) {
  const reportChatInput = document.getElementById('reportChatInput');
  if (reportChatInput) {
    reportChatInput.value = text;
    reportChatInput.focus();
  }
}

// Report chat functionality
function sendReportChat() {
  const ta = document.getElementById('reportChatInput');
  const msg = ta.value.trim();
  if (!msg) return;
  ta.value = '';
  
  appendReportChat('user', msg);
  
  // Send to the same endpoint but with enhanced capabilities
  fetch('/api/chat/session/' + (currentChatSession || 'new') + '/message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: msg })
  }).then(r => r.json()).then(d => {
    if (d.ok && d.reply) {
      // Update current session if a new one was created
      if (d.session_id && !currentChatSession) {
        currentChatSession = d.session_id;
        // Refresh sessions list to show the new session
        if (typeof refreshChatSessions === 'function') {
          refreshChatSessions();
        }
      }
      appendAgenticReportChat('ai', d.reply, d.download_url);
    } else {
      appendReportChat('ai', 'Error: ' + (d.error || 'Unknown error'));
    }
  }).catch(() => {
    appendReportChat('ai', 'Network error. Please try again.');
  });
}

function appendReportChat(role, text) {
  const chatHistory = document.getElementById('reportChatHistory');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg ' + role;
  msgDiv.textContent = text;
  chatHistory.insertBefore(msgDiv, document.getElementById('reportChatBottomAnchor'));
  jumpToLatestReport();
}

function appendAgenticReportChat(role, text, downloadUrl) {
  const chatHistory = document.getElementById('reportChatHistory');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg ' + role;
  
  // Enhanced formatting for report responses
  if (downloadUrl) {
    msgDiv.innerHTML = text.replace(/\[📥 Download Report\]\(([^)]+)\)/g, 
      '<a href="$1" target="_blank" style="background:#0e639c;color:white;padding:6px 12px;border-radius:4px;text-decoration:none;display:inline-block;margin:8px 0;">📥 Download Report</a>');
  } else {
    msgDiv.textContent = text;
  }
  
  chatHistory.insertBefore(msgDiv, document.getElementById('reportChatBottomAnchor'));
  jumpToLatestReport();
}

function jumpToLatestReport() {
  const anchor = document.getElementById('reportChatBottomAnchor');
  if (anchor) {
    anchor.scrollIntoView({ behavior: 'smooth' });
  }
}

// Enter key handlers for both inputs
document.addEventListener('DOMContentLoaded', function() {
  const chatInput = document.getElementById('chatInput');
  const reportChatInput = document.getElementById('reportChatInput');
  
  if (chatInput) {
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChat();
      }
    });
  }
  
  if (reportChatInput) {
    reportChatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendReportChat();
      }
    });
  }
});
</script>
</body>
</html>
