{% extends 'layout.html' %}
{% block title %}Options Chain ML Analyzer{% endblock %}

{% block header %}
<div class="d-flex align-items-center justify-content-between">
  <div>
    <h2 class="mb-1">Options Chain ML Analyzer</h2>
    <p class="text-white-50 mb-0">Admin & Investor can analyze, refresh and save options trade ideas.</p>
  </div>
  <div>
    <a href="/investor_ml_models" class="btn btn-light btn-sm">View Saved ML Results</a>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <form id="optsForm" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Underlying</label>
        <select class="form-select" name="asset_key" id="asset_key">
          <option value="NSE_INDEX|Nifty 50" {{ 'selected' if default_asset=='NSE_INDEX|Nifty 50' }}>Nifty 50</option>
          <option value="NSE_INDEX|Bank Nifty">Bank Nifty</option>
          <option value="NSE_INDEX|Fin Nifty">Fin Nifty</option>
          <option value="NSE_INDEX|IT Nifty">IT Nifty</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Expiry Date</label>
        <input type="date" class="form-control" name="expiry_date" id="expiry_date" value="{{ default_expiry }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Days to Expiry</label>
        <input type="number" min="0" class="form-control" name="days_to_expiry" id="days_to_expiry" value="{{ default_days }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Selected Strike</label>
        <input type="number" class="form-control" name="selected_strike" id="selected_strike" value="22000" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Risk-free Rate</label>
        <input type="number" step="0.001" class="form-control" name="risk_free_rate" id="risk_free_rate" value="0.05" />
      </div>
      <div class="col-12 d-flex gap-2">
        <button type="button" id="btnRefresh" class="btn btn-primary">Refresh</button>
        <button type="button" id="btnSave" class="btn btn-success">Save Snapshot</button>
      </div>
    </form>
  </div>
</div>

<div id="resultSection" class="mt-4" style="display:none;">
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Summary</h5>
      <div id="summary"></div>
      <hr />
      <h5 class="card-title">Trade Recommendations</h5>
      <div class="table-responsive">
        <table class="table table-striped table-sm" id="recsTable">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Current Price</th>
              <th>Recommendation</th>
              <th>Confidence (%)</th>
              <th>Stop Loss</th>
              <th>Target</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function formData() {
  const fd = new FormData(document.getElementById('optsForm'));
  return fd;
}

async function post(url, fd) {
  const resp = await fetch(url, { method: 'POST', body: fd });
  return await resp.json();
}

function renderResults(data) {
  const res = data.result || {};
  document.getElementById('resultSection').style.display = '';
  const s = res.summary || {};
  document.getElementById('summary').innerHTML = `
    <div class="row g-3">
      <div class="col">Total Strikes: <strong>${s.total_strikes ?? 0}</strong></div>
      <div class="col">PCR: <strong>${(s.pcr_ratio||0).toFixed ? s.pcr_ratio.toFixed(2) : s.pcr_ratio}</strong></div>
      <div class="col">Avg IV: <strong>${(s.avg_iv||0).toFixed ? s.avg_iv.toFixed(2) : s.avg_iv}%</strong></div>
      <div class="col">Actionable Trades: <strong>${res.actionable_count || 0}</strong></div>
    </div>`;

  const tbody = document.querySelector('#recsTable tbody');
  tbody.innerHTML = '';
  (res.actionable_results || []).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r['Symbol']||''}</td>
      <td>${r['Current Price']||''}</td>
      <td>${r['Recommendation']||''}</td>
      <td>${r['Confidence (%)']||''}</td>
      <td>${r['Stop Loss']||''}</td>
      <td>${r['Target']||''}</td>`;
    tbody.appendChild(tr);
  });
}

async function refresh() {
  const fd = formData();
  const json = await post('/api/options_chain_ml/refresh', fd);
  if (!json.success) {
    toastr.error(json.error || 'Failed to refresh');
    return;
  }
  renderResults(json);
}

async function saveSnap() {
  const fd = formData();
  const json = await post('/api/options_chain_ml/save', fd);
  if (!json.success) {
    toastr.error(json.error || 'Failed to save');
    return;
  }
  toastr.success('Saved');
  renderResults(json);
}

document.getElementById('btnRefresh').addEventListener('click', refresh);

document.getElementById('btnSave').addEventListener('click', saveSnap);
</script>
{% endblock %}
