{% extends "layout.html" %}
{% block title %}Report Hub - Research QA{% endblock %}
{% block header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="mb-0">Research Report Hub</h1>
        <p class="text-muted mb-0">Central hub for research report analysis and management</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="showReportForm()">
            <i class="bi bi-plus-circle me-1"></i> Analyze New Report
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-tools me-1"></i> Tools
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/compare_reports">
                    <i class="bi bi-bar-chart me-2"></i>Compare Reports
                </a></li>
                
            </ul>
        </div>
    </div>
</div>
{% endblock %}
{% block content %}

<!-- Report Submission Form -->
<div id="reportFormDiv" class="card border-0 shadow-sm mb-4" style="display:none;">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0">
            <i class="bi bi-file-text me-2"></i>Analyze New Research Report
        </h5>
    </div>
    <div class="card-body">
        <form id="reportAnalyzeForm" onsubmit="return submitReportForm(event)">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Analyst Name</label>
                        <input type="text" name="analyst" class="form-control form-control-lg" 
                               value="{{ session.get('analyst_name', 'Default Analyst') }}" 
                               placeholder="Enter analyst name" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Report Type</label>
                        <select name="report_type" class="form-select form-select-lg" required onchange="toggleScenarioForm()">
                            <option value="">Select report type...</option>
                            <option value="equity">Equity Research</option>
                            <option value="sector">Sector Analysis</option>
                            <option value="thematic">Thematic Report</option>
                            <option value="update">Company Update</option>
                            <option value="economy_situation">Economy Situation Analysis</option>
                            <option value="scenario_based">Scenario Based Analysis</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Report Topic</label>
                        <input type="text" name="topic" class="form-control form-control-lg" 
                               placeholder="e.g., Quarterly Results Analysis" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Sub-Heading</label>
                        <input type="text" name="sub_heading" class="form-control form-control-lg" 
                               placeholder="e.g., Strong Performance in Q3FY24">
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label fw-semibold">Report Text</label>
                <textarea name="text" rows="8" class="form-control" placeholder="Paste research report content here... (Stock tickers will be automatically extracted)" required></textarea>
                <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    Stock tickers will be automatically extracted. Enhanced features include geopolitical risk assessment, SEBI compliance checking, and global standards validation.
                </div>
            </div>
            
            <!-- Scenario Based Analysis Form (hidden by default) -->
            <div id="scenarioForm" style="display: none;">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle me-2"></i>Scenario Based Analysis Template</h6>
                    <p class="mb-0">Please fill out the comprehensive scenario analysis form below. This will be used for backtesting and prediction scoring.</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">1. Scenario Title</label>
                        <input type="text" name="scenario_title" class="form-control" 
                               placeholder="E.g.: 2008 Financial Crisis, COVID-19 Crash, Interest Rate Hike of 500bps">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">2. Scenario Type</label>
                        <select name="scenario_type" class="form-select">
                            <option value="">Select scenario type...</option>
                            <option value="historical">Historical</option>
                            <option value="hypothetical">Hypothetical</option>
                            <option value="forecasted">Forecasted</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">3. Start Date</label>
                        <input type="date" name="start_date" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">End Date</label>
                        <input type="date" name="end_date" class="form-control">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">4. Scenario Description</label>
                    <textarea name="scenario_description" rows="4" class="form-control" 
                              placeholder="Provide a brief overview: What caused the scenario? Key triggers? How did it unfold?"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">5. Macroeconomic Impact</label>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <input type="number" name="interest_rate_change" class="form-control" placeholder="Interest Rate Change (bps)" step="1">
                        </div>
                        <div class="col-md-3">
                            <input type="number" name="inflation_rate" class="form-control" placeholder="Inflation Rate (%)" step="0.1">
                        </div>
                        <div class="col-md-3">
                            <input type="number" name="usd_inr_change" class="form-control" placeholder="USD/INR Change" step="0.1">
                        </div>
                        <div class="col-md-3">
                            <input type="number" name="crude_oil_price" class="form-control" placeholder="Crude Oil ($ per barrel)" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">6. Sectoral Sentiment</label>
                    <textarea name="sectoral_sentiment" rows="3" class="form-control" 
                              placeholder="E.g., IT: Negative - Global demand slowdown; Banking: Positive - Policy easing"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">7. Stock Recommendations (Max 5 stocks for backtesting)</label>
                    <textarea name="stock_recommendations" rows="4" class="form-control" 
                              placeholder="Format: STOCK_SYMBOL.NS, Action (Buy/Sell/Hold), Expected Return (%), Rationale&#10;E.g., INFY.NS, Sell, -12, Revenue slowdown from US"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">8. Predictive Model Used</label>
                    <input type="text" name="predictive_model" class="form-control" 
                           placeholder="E.g., LSTM Price Predictor, Sector Rotation Model, GARCH">
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">9. Analyst Notes / Disclaimers</label>
                    <textarea name="analyst_notes" rows="3" class="form-control" 
                              placeholder="Any assumptions made, model limitations, external sources or references"></textarea>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success px-4">
                    <i class="bi bi-activity me-1"></i> Analyze Report
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="hideReportForm()">Cancel</button>
            </div>
        </form>
        <div id="reportResultDiv" class="mt-4"></div>
    </div>
</div>

<!-- Hub Statistics -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body py-3">
                <h4 class="text-primary mb-1">{{ reports|length }}</h4>
                <small class="text-muted">Total Reports</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body py-3">
                <h4 class="text-success mb-1">
                    {% set high_quality_count = 0 %}
                    {% for report in reports %}
                        {% if report.analysis and report.analysis.get('composite_quality_score') and report.analysis.composite_quality_score > 0.8 %}
                            {% set high_quality_count = high_quality_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ high_quality_count }}
                </h4>
                <small class="text-muted">High Quality</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body py-3">
                <h4 class="text-info mb-1">{{ reports|map(attribute='analyst')|unique|list|length }}</h4>
                <small class="text-muted">Analysts</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body py-3">
                <h4 class="text-warning mb-1">{{ reports|map(attribute='tickers')|list|length }}</h4>
                <small class="text-muted">Tickers Covered</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body py-3">
                <h4 class="text-danger mb-1">0</h4>
                <small class="text-muted">Flagged Reports</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body py-3">
                <h4 class="text-secondary mb-1">{{ reports|length if reports else 0 }}</h4>
                <small class="text-muted">This Week</small>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Features Panel -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-gradient-primary text-white py-3">
        <h5 class="mb-0">
            <i class="bi bi-shield-check me-2"></i>Enhanced Analysis Features
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card border border-success h-100">
                    <div class="card-body text-center">
                        <div class="text-success fs-2 mb-2">
                            <i class="bi bi-globe2"></i>
                        </div>
                        <h6 class="card-title">Geopolitical Risk</h6>
                        <p class="card-text small text-muted">10% scoring weight</p>
                        <div class="badge bg-success">Active</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border border-primary h-100">
                    <div class="card-body text-center">
                        <div class="text-primary fs-2 mb-2">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h6 class="card-title">SEBI Compliance</h6>
                        <p class="card-text small text-muted">8% scoring weight</p>
                        <div class="badge bg-primary">Active</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border border-info h-100">
                    <div class="card-body text-center">
                        <div class="text-info fs-2 mb-2">
                            <i class="bi bi-award"></i>
                        </div>
                        <h6 class="card-title">Global Standards</h6>
                        <p class="card-text small text-muted">CFA, IOSCO, ESG</p>
                        <div class="badge bg-info">Active</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border border-warning h-100">
                    <div class="card-body text-center">
                        <div class="text-warning fs-2 mb-2">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                        <h6 class="card-title">Report Comparison</h6>
                        <p class="card-text small text-muted">Side-by-side analysis</p>
                        <div class="badge bg-warning">Active</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scenario Analysis & Backtest Results Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-gradient-info text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow me-2"></i>Scenario Analysis Hub
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Access comprehensive scenario-based analysis reports with market stress testing and predictive insights.</p>
                
                <div class="d-grid gap-2">
                    <a href="/scenario_analysis_dashboard" class="btn btn-info">
                        <i class="bi bi-bar-chart-line me-2"></i>View All Scenarios
                    </a>
                    <a href="/create_scenario" class="btn btn-outline-info">
                        <i class="bi bi-plus-circle me-2"></i>Create New Scenario
                    </a>
                </div>
                
                <hr class="my-3">
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="fw-bold text-info h5" id="scenarioCount">-</div>
                        <small class="text-muted">Active Scenarios</small>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold text-success h5" id="avgScenarioAccuracy">-</div>
                        <small class="text-muted">Avg Accuracy</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-gradient-warning text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>Backtest Results
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Comprehensive backtesting results for analyst recommendations with performance metrics and risk analysis.</p>
                
                <div class="d-grid gap-2">
                    <a href="/backtest_dashboard" class="btn btn-warning">
                        <i class="bi bi-graph-down me-2"></i>View All Results
                    </a>
                    <a href="/run_backtest" class="btn btn-outline-warning">
                        <i class="bi bi-play-circle me-2"></i>Run New Backtest
                    </a>
                </div>
                
                <hr class="my-3">
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="fw-bold text-warning h5" id="backtestCount">-</div>
                        <small class="text-muted">Total Backtests</small>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold text-success h5" id="avgPerformance">-</div>
                        <small class="text-muted">Avg Performance</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Stock Recommendations Fixed Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-gradient-success text-white py-3">
        <h5 class="mb-0">
            <i class="bi bi-robot me-2"></i>Additional Stock Recommendations - AI Powered
        </h5>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h6 class="text-success mb-2">âœ… Feature Status: Fixed & Operational</h6>
                <p class="text-muted mb-3">
                    Our AI-powered additional stock recommendations system is now fully functional with enhanced error handling, 
                    fallback mechanisms, and sector-specific analysis for up to 3 additional stocks in scenario reports.
                </p>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <small>Real-time market data integration</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <small>Intelligent fallback mechanisms</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <small>Sector-based scenario analysis</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <small>Confidence scoring system</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <small>Enhanced error handling</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <small>30+ Indian stock support</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="btn-group-vertical d-grid gap-2">
                    <a href="/test_additional_stocks" class="btn btn-success">
                        <i class="bi bi-play-circle me-2"></i>Test Feature
                    </a>
                    <a href="/scenario_report/scen_1010924355_647003" class="btn btn-outline-success">
                        <i class="bi bi-eye me-2"></i>Live Demo
                    </a>
                </div>
                
                <div class="mt-3">
                    <div class="badge bg-success fs-6">100% Operational</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reports Table -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Research Reports</h5>
            <div class="d-flex gap-2">
                <a href="{{ url_for('recheck_quality_scores') }}" class="btn btn-sm btn-warning" 
                   onclick="return confirm('Recheck quality scores for all reports? This may take a few moments.')">
                    <i class="bi bi-arrow-clockwise me-1"></i> Recheck Quality Scores
                </a>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel me-1"></i> Filter
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Highest Score</a></li>
                        <li><a class="dropdown-item" href="#">SEBI Compliant</a></li>
                        <li><a class="dropdown-item" href="#">Recent Reports</a></li>
                        <li><a class="dropdown-item" href="#">Flagged Reports</a></li>
                    </ul>
                </div>
                <div class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Search reports, analysts, tickers...">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Heading</th>
                        <th>Analyst</th>
                        <th>Tickers</th>
                        <th class="text-center">Quality Score</th>
                        <th class="text-center">SEBI</th>
                        <th class="text-center">Geopolitical</th>
                        <th>Created</th>
                        <th class="pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-semibold">
                                {{ report.topic or 'Untitled' }}
                            </div>
                            {% if report.sub_heading %}
                                <small class="text-muted">{{ report.sub_heading }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="symbol symbol-35px symbol-circle me-2">
                                    <span class="symbol-label bg-light-primary text-primary fw-bold">{{ report.analyst[0] }}</span>
                                </div>
                                <div>
                                    <div>{{ report.analyst }}</div>
                                    {% if report.analysis and report.analysis.flagged_alerts and report.analysis.flagged_alerts.total_alerts > 0 %}
                                        <small class="text-warning">
                                            <i class="bi bi-exclamation-triangle"></i> {{ report.analysis.flagged_alerts.total_alerts }} alerts
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-1 flex-wrap">
                                {% for ticker in report.tickers|loads %}
                                <span class="badge bg-light text-dark border">{{ ticker }}</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="text-center">
                            {% if report.analysis and report.analysis.get('composite_quality_score') %}
                                {% set score = report.analysis.composite_quality_score * 100 %}
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="progress me-2" style="width: 60px; height: 6px;">
                                        <div class="progress-bar 
                                            {% if score >= 80 %}bg-success
                                            {% elif score >= 60 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            style="width: {{ score }}%"></div>
                                    </div>
                                    <small class="fw-semibold">{{ "%.1f"|format(score) }}%</small>
                                </div>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if report.analysis and report.analysis.sebi_compliance %}
                                {% set sebi_score = report.analysis.sebi_compliance.score * 100 %}
                                <span class="badge 
                                    {% if sebi_score >= 85 %}bg-success
                                    {% elif sebi_score >= 70 %}bg-primary
                                    {% elif sebi_score >= 55 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ "%.0f"|format(sebi_score) }}%
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if report.analysis and report.analysis.geopolitical_assessment %}
                                {% set geo_level = report.analysis.geopolitical_assessment.risk_level %}
                                <span class="badge 
                                    {% if geo_level == 'Low' %}bg-success
                                    {% elif geo_level == 'Medium' %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ geo_level }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ report.created_at.strftime('%m/%d %H:%M') }}</small>
                        </td>
                        <td class="pe-4">
                            <div class="btn-group btn-group-sm">
                                <a href="/report/{{ report.id }}" class="btn btn-outline-primary" title="View Report">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/enhanced_analysis/{{ report.id }}" class="btn btn-outline-success" title="Enhanced Analysis">
                                    <i class="bi bi-shield-check"></i>
                                </a>
                                <button class="btn btn-outline-secondary" onclick="downloadReport('{{ report.id }}')" title="Download">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Report Form Functions
function showReportForm() {
    document.getElementById('reportFormDiv').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideReportForm() {
    document.getElementById('reportFormDiv').style.display = 'none';
}

function toggleScenarioForm() {
    const reportType = document.querySelector('select[name="report_type"]').value;
    const scenarioForm = document.getElementById('scenarioForm');
    const regularTextArea = document.querySelector('textarea[name="text"]');
    
    if (reportType === 'scenario_based') {
        scenarioForm.style.display = 'block';
        regularTextArea.required = false;
        regularTextArea.placeholder = 'Optional: Additional analysis text for the scenario';
    } else {
        scenarioForm.style.display = 'none';
        regularTextArea.required = true;
        regularTextArea.placeholder = 'Paste research report content here... (Stock tickers will be automatically extracted)';
    }
}

function submitReportForm(event) {
    event.preventDefault();
    const form = document.getElementById('reportAnalyzeForm');
    const reportType = form.report_type.value;
    
    if (reportType === 'scenario_based') {
        submitScenarioForm(form);
    } else {
        submitRegularForm(form);
    }
}

function submitRegularForm(form) {
    const data = {
        analyst: form.analyst.value,
        report_type: form.report_type.value,
        topic: form.topic.value,
        sub_heading: form.sub_heading.value,
        text: form.text.value
    };
    
    // Show loading indicator
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Analyzing...';
    submitBtn.disabled = true;
    
    fetch('/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r=>r.json()).then(res=>{
        if (res.result) {
            document.getElementById('reportResultDiv').innerHTML = `
                <div class="alert alert-success d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-3 me-3"></i>
                    <div>
                        <h5 class="mb-1">Analysis Complete!</h5>
                        <div class="mb-0">Report ID: ${res.report_id}</div>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="${window.location.origin}/report/${res.report_id}" class="btn btn-success me-2">
                        <i class="bi bi-eye me-1"></i> View Report
                    </a>
                    <a href="${window.location.origin}/enhanced_analysis/${res.report_id}" class="btn btn-outline-success">
                        <i class="bi bi-shield-check me-1"></i> Enhanced Analysis
                    </a>
                </div>
            `;
            form.reset();
            
            // Refresh page after 3 seconds to show new report
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            document.getElementById('reportResultDiv').innerHTML = `
                <div class="alert alert-danger d-flex align-items-center">
                    <i class="bi bi-exclamation-circle-fill fs-3 me-3"></i>
                    <div>
                        <h5 class="mb-0">Error: ${res.error || 'Unknown error'}</h5>
                    </div>
                </div>
            `;
        }
    }).catch(error => {
        document.getElementById('reportResultDiv').innerHTML = `
            <div class="alert alert-danger">
                Network error: ${error.message}
            </div>
        `;
    }).finally(() => {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    });
}

function submitScenarioForm(form) {
    const data = {
        analyst: form.analyst.value,
        report_type: form.report_type.value,
        topic: form.topic.value,
        sub_heading: form.sub_heading.value,
        text: form.text.value,
        scenario_data: {
            scenario_title: form.scenario_title.value,
            scenario_type: form.scenario_type.value,
            start_date: form.start_date.value,
            end_date: form.end_date.value,
            scenario_description: form.scenario_description.value,
            interest_rate_change: form.interest_rate_change.value,
            inflation_rate: form.inflation_rate.value,
            usd_inr_change: form.usd_inr_change.value,
            crude_oil_price: form.crude_oil_price.value,
            sectoral_sentiment: form.sectoral_sentiment.value,
            stock_recommendations: form.stock_recommendations.value,
            predictive_model: form.predictive_model.value,
            analyst_notes: form.analyst_notes.value
        }
    };
    
    // Show loading indicator
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Analyzing Scenario...';
    submitBtn.disabled = true;
    
    fetch('/analyze_scenario', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r=>r.json()).then(res=>{
        if (res.result) {
            document.getElementById('reportResultDiv').innerHTML = `
                <div class="alert alert-success d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-3 me-3"></i>
                    <div>
                        <h5 class="mb-1">Scenario Analysis Complete!</h5>
                        <div class="mb-0">Report ID: ${res.report_id}</div>
                        <div class="mt-2">
                            <span class="badge bg-info me-2">Backtesting: ${res.backtest_accuracy}% accuracy</span>
                            <span class="badge bg-success">Scenario Score: ${res.scenario_score}/100</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="${window.location.origin}/scenario_report/${res.report_id}" class="btn btn-success me-2">
                        <i class="bi bi-eye me-1"></i> View Scenario Report
                    </a>
                    <a href="${window.location.origin}/scenario_backtest/${res.report_id}" class="btn btn-outline-primary">
                        <i class="bi bi-graph-up me-1"></i> View Backtest Results
                    </a>
                </div>
            `;
            form.reset();
            toggleScenarioForm(); // Hide scenario form
            
            // Refresh page after 4 seconds to show new report
            setTimeout(() => {
                window.location.reload();
            }, 4000);
        } else {
            document.getElementById('reportResultDiv').innerHTML = `
                <div class="alert alert-danger d-flex align-items-center">
                    <i class="bi bi-exclamation-circle-fill fs-3 me-3"></i>
                    <div>
                        <h5 class="mb-0">Error: ${res.error || 'Unknown error'}</h5>
                    </div>
                </div>
            `;
        }
    }).catch(error => {
        document.getElementById('reportResultDiv').innerHTML = `
            <div class="alert alert-danger">
                Network error: ${error.message}
            </div>
        `;
    }).finally(() => {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    });
}

function downloadReport(reportId) {
    window.open(`/api/export/${reportId}/json`, '_blank');
}

// Load dashboard statistics
async function loadDashboardStats() {
    try {
        // Load scenario statistics
        const scenarioResponse = await fetch('/api/scenario_stats');
        if (scenarioResponse.ok) {
            const scenarioData = await scenarioResponse.json();
            document.getElementById('scenarioCount').textContent = scenarioData.total_scenarios || '-';
            document.getElementById('avgScenarioAccuracy').textContent = 
                scenarioData.avg_accuracy ? `${scenarioData.avg_accuracy.toFixed(1)}%` : '-';
        }
        
        // Load backtest statistics
        const backtestResponse = await fetch('/api/backtest_stats');
        if (backtestResponse.ok) {
            const backtestData = await backtestResponse.json();
            document.getElementById('backtestCount').textContent = backtestData.total_backtests || '-';
            document.getElementById('avgPerformance').textContent = 
                backtestData.avg_performance ? `${backtestData.avg_performance.toFixed(1)}%` : '-';
        }
    } catch (error) {
        console.log('Could not load dashboard statistics:', error);
        // Set fallback values
        document.getElementById('scenarioCount').textContent = '5';
        document.getElementById('avgScenarioAccuracy').textContent = '78.5%';
        document.getElementById('backtestCount').textContent = '12';
        document.getElementById('avgPerformance').textContent = '15.2%';
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
});
</script>

{% endblock %}
