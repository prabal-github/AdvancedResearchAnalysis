{% extends "layout.html" %}
{% block title %}Certificate Status{% endblock %}
{% block header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="mb-0">Certificate Status</h1>
        <p class="text-muted mb-0">Track your certificate requests</p>
    </div>
    <div>
        <a href="/analyst/certificate_request" class="btn btn-primary me-2">
            <i class="bi bi-plus-circle me-1"></i> New Request
        </a>
        <a href="/" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% if certificate_requests %}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Your Certificate Requests</h5>
            </div>
            <div class="card-body">
                {% for req in certificate_requests %}
                <div class="row border-bottom pb-4 mb-4 {% if loop.last %}border-bottom-0 mb-0 pb-0{% endif %}">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 me-3">Internship Period: {{ req.internship_start_date.strftime('%d %b %Y') }} - {{ req.internship_end_date.strftime('%d %b %Y') }}</h6>
                            <span class="badge bg-{% if req.status == 'approved' %}success{% elif req.status == 'rejected' %}danger{% else %}warning{% endif %} fs-6 px-3 py-2">
                                {{ req.status.title() }}
                            </span>
                        </div>
                        
                        <div class="row text-muted small mb-3">
                            <div class="col-sm-6">
                                <i class="bi bi-calendar-event me-1"></i>
                                Requested: {{ req.requested_at.strftime('%d %b %Y at %I:%M %p') }}
                            </div>
                            <div class="col-sm-6">
                                <i class="bi bi-calendar-check me-1"></i>
                                Issue Date: {{ req.requested_issue_date.strftime('%d %b %Y') }}
                            </div>
                        </div>
                        
                        {% if req.request_message %}
                        <div class="bg-light p-3 rounded mb-3">
                            <strong>Your Message:</strong><br>
                            {{ req.request_message }}
                        </div>
                        {% endif %}
                        
                        {% if req.status == 'approved' %}
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Approved by {{ req.approved_by }}</strong>
                            {% if req.approved_at %}
                            on {{ req.approved_at.strftime('%d %b %Y') }}
                            {% endif %}
                            {% if req.performance_score %}
                            <br>Performance Score: <strong>{{ req.performance_score }}/100</strong>
                            {% endif %}
                        </div>
                        {% elif req.status == 'rejected' %}
                        <div class="alert alert-danger mb-3">
                            <i class="bi bi-x-circle me-2"></i>
                            <strong>Rejected by {{ req.approved_by }}</strong>
                            {% if req.approved_at %}
                            on {{ req.approved_at.strftime('%d %b %Y') }}
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-clock me-2"></i>
                            <strong>Pending Review</strong> - Your request is being reviewed by the admin team.
                            <br><br>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-credit-card me-2 text-primary"></i>
                                <span>Please make payment to generate certificate: </span>
                                <a href="https://rzp.io/rzp/hN7tJEZ" target="_blank" class="btn btn-primary btn-sm ms-2">
                                    <i class="bi bi-wallet me-1"></i>Pay Now
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if req.admin_notes %}
                        <div class="bg-light p-3 rounded mb-3">
                            <strong>Admin Notes:</strong><br>
                            {{ req.admin_notes }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 text-end">
                        {% if req.status == 'approved' %}
                            {% if req.certificate_generated %}
                            <div class="mb-3">
                                <i class="bi bi-patch-check text-success" style="font-size: 2rem;"></i>
                                <div class="small text-success">Certificate Ready</div>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="/certificate/{{ req.id }}/generate" class="btn btn-success btn-lg">
                                    <i class="bi bi-award me-2"></i>Download Certificate
                                </a>
                                {% if req.performance_analysis_pdf %}
                                <a href="/analyst/performance_analysis/{{ req.id }}/download" class="btn btn-info btn-lg">
                                    <i class="bi bi-file-earmark-pdf me-2"></i>ðŸ“„ Performance PDF
                                </a>
                                {% endif %}
                                <a href="/analyst/performance_analytics/{{ req.id }}" class="btn btn-primary btn-lg">
                                    <i class="bi bi-graph-up-arrow me-2"></i>ðŸ“Š Analytics Dashboard
                                </a>
                            </div>
                            {% else %}
                            <div class="mb-3">
                                <i class="bi bi-gear text-warning" style="font-size: 2rem;"></i>
                                <div class="small text-warning">Generating Certificate...</div>
                            </div>
                            <button class="btn btn-warning btn-lg" onclick="generateCertificate('{{ req.id }}')">
                                <i class="bi bi-file-earmark-pdf me-2"></i>Generate Certificate
                            </button>
                            {% endif %}
                        {% elif req.status == 'rejected' %}
                        <div class="mb-3">
                            <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                            <div class="small text-danger">Request Rejected</div>
                        </div>
                        {% else %}
                        <div class="mb-3">
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 2rem;"></i>
                            <div class="small text-warning">Awaiting Approval</div>
                        </div>
                        {% endif %}
                        
                        {% if req.certificate_unique_id %}
                        <div class="small text-muted mt-2">
                            <strong>Certificate ID:</strong><br>
                            {{ req.certificate_unique_id }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-award" style="font-size: 4rem; color: #dee2e6;"></i>
                <h4 class="mt-3 mb-2">No Certificate Requests</h4>
                <p class="text-muted mb-4">You haven't submitted any certificate requests yet.</p>
                <a href="/analyst/certificate_request" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>Request Your First Certificate
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function generateCertificate(requestId) {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generating...';
    button.disabled = true;
    
    // Redirect to generate certificate
    window.location.href = `/certificate/${requestId}/generate`;
}

// Auto refresh page every 30 seconds if there are pending requests
{% if certificate_requests %}
var hasPendingRequests = false;
{% for req in certificate_requests %}
{% if req.status == 'pending' or (req.status == 'approved' and not req.certificate_generated) %}
hasPendingRequests = true;
{% endif %}
{% endfor %}

if (hasPendingRequests) {
    setTimeout(function() {
        location.reload();
    }, 30000);
}
{% endif %}
</script>
{% endblock %}
