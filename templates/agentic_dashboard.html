{% extends "layout.html" %}

{% block title %}AI Investment Assistant{% endblock %}

{% block extra_css %}
<style>
    .agentic-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .dashboard-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        text-align: center;
        color: white;
    }
    
    .dashboard-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ffd700, #ffed4a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-number {
        font-size: 2.2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .success-rate { color: #10b981; }
    .total-recommendations { color: #3b82f6; }
    .total-return { color: #8b5cf6; }
    .active-status { color: #f59e0b; }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        margin: 30px 0;
        flex-wrap: wrap;
    }
    
    .btn-agentic {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-agentic:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .btn-agentic.btn-success {
        background: linear-gradient(45deg, #10b981, #059669);
    }
    
    .btn-agentic.btn-warning {
        background: linear-gradient(45deg, #f59e0b, #d97706);
    }
    
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 30px;
    }
    
    .content-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }
    
    .recommendations-list, .alerts-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .recommendation-item, .alert-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .recommendation-item:hover, .alert-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .recommendation-ticker {
        font-size: 1.2rem;
        font-weight: bold;
        color: #1f2937;
    }
    
    .recommendation-type {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
        margin: 5px 0;
    }
    
    .recommendation-type.buy { background: #dcfce7; color: #166534; }
    .recommendation-type.sell { background: #fee2e2; color: #991b1b; }
    .recommendation-type.hold { background: #fef3c7; color: #92400e; }
    
    .confidence-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
        transition: width 0.5s ease;
    }
    
    .alert-severity {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .alert-severity.low { background: #dbeafe; color: #1e40af; }
    .alert-severity.medium { background: #fef3c7; color: #92400e; }
    .alert-severity.high { background: #fee2e2; color: #991b1b; }
    .alert-severity.critical { background: #fecaca; color: #7f1d1d; }
    
    .performance-chart {
        width: 100%;
        height: 200px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
    }
    
    .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-active { background: #10b981; }
    .status-inactive { background: #ef4444; }
    
    @media (max-width: 768px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="agentic-dashboard">
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>ü§ñ AI Investment Assistant</h1>
            <p>Your autonomous investment advisor powered by advanced AI</p>
            <p><span class="status-indicator {{ 'status-active' if agent_stats.is_active else 'status-inactive' }}"></span>
               Status: {{ 'Active' if agent_stats.is_active else 'Inactive' }}</p>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number success-rate">{{ "%.1f"|format(agent_stats.accuracy_rate * 100) }}%</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number total-recommendations">{{ agent_stats.total_recommendations or 0 }}</div>
                <div class="stat-label">Total Recommendations</div>
            </div>
            <div class="stat-card">
                <div class="stat-number total-return">{{ "%.2f"|format(agent_stats.total_return or 0) }}%</div>
                <div class="stat-label">Total Return</div>
            </div>
            <div class="stat-card">
                <div class="stat-number active-status">{{ active_alerts|length }}</div>
                <div class="stat-label">Active Alerts</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-agentic btn-success" onclick="triggerAnalysis()">
                üîç Run Analysis
            </button>
            <button class="btn-agentic" onclick="getRecommendations()">
                üí° Get Recommendations
            </button>
            <button class="btn-agentic btn-warning" onclick="triggerLearning()">
                üß† Learn from Outcomes
            </button>
            <a href="#" class="btn-agentic" onclick="openConfigModal()">
                ‚öôÔ∏è Configure Agent
            </a>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Recent Recommendations -->
            <div class="content-card">
                <h3>üìä Recent Recommendations</h3>
                <div class="recommendations-list" id="recommendations-list">
                    {% if recent_recommendations %}
                        {% for rec in recent_recommendations %}
                        <div class="recommendation-item">
                            <div class="recommendation-ticker">{{ rec.ticker }}</div>
                            <div class="recommendation-type {{ rec.recommendation_type.lower() }}">
                                {{ rec.recommendation_type }}
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: {{ rec.confidence_score * 100 }}%"></div>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                Confidence: {{ "%.1f"|format(rec.confidence_score * 100) }}% | 
                                Target: ‚Çπ{{ rec.target_price or 'N/A' }} | 
                                Risk: {{ rec.risk_level }}
                            </div>
                            <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                                {{ rec.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </div>
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button class="btn btn-sm btn-success" onclick="recordFeedback({{ rec.id }}, 'accepted')">
                                    ‚úÖ Accept
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="recordFeedback({{ rec.id }}, 'rejected')">
                                    ‚ùå Reject
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center">No recommendations yet. Click "Get Recommendations" to start.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Active Alerts -->
            <div class="content-card">
                <h3>üö® Active Alerts</h3>
                <div class="alerts-list" id="alerts-list">
                    {% if active_alerts %}
                        {% for alert in active_alerts %}
                        <div class="alert-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="margin: 0;">{{ alert.title }}</h4>
                                <span class="alert-severity {{ alert.priority.lower() }}">
                                    {{ alert.priority }}
                                </span>
                            </div>
                            <p style="margin: 10px 0; color: #555;">{{ alert.message }}</p>
                            {% if alert.ticker %}
                                <div style="font-weight: 500; color: #1f2937;">üìà {{ alert.ticker }}</div>
                            {% endif %}
                            {% if alert.suggested_action %}
                                <div style="background: #f0f9ff; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.9rem;">
                                    üí° Suggested: {{ alert.suggested_action }}
                                </div>
                            {% endif %}
                            <div style="font-size: 0.8rem; color: #999; margin-top: 10px;">
                                {{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center">No active alerts. Your AI assistant is monitoring the markets.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="content-card" style="margin-top: 30px;">
            <h3>üìà Performance Overview</h3>
            <div class="performance-chart" id="performance-chart">
                <div>Performance chart will be displayed here</div>
            </div>
            <div class="row">
                <div class="col-md-3 text-center">
                    <strong>{{ "%.2f"|format(performance_data.accuracy_rate * 100 or 0) }}%</strong><br>
                    <small>Accuracy Rate</small>
                </div>
                <div class="col-md-3 text-center">
                    <strong>{{ performance_data.total_recommendations or 0 }}</strong><br>
                    <small>Recommendations</small>
                </div>
                <div class="col-md-3 text-center">
                    <strong>{{ "%.2f"|format(performance_data.total_return or 0) }}%</strong><br>
                    <small>Total Return</small>
                </div>
                <div class="col-md-3 text-center">
                    <strong>Active</strong><br>
                    <small>Status</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">‚öôÔ∏è Agent Configuration</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Confidence Threshold</label>
                    <input type="range" class="form-control-range" id="confidenceThreshold" min="0.5" max="1" step="0.1" value="0.7">
                    <small class="form-text text-muted">Minimum confidence required for recommendations</small>
                </div>
                <div class="form-group">
                    <label>Risk Tolerance</label>
                    <input type="range" class="form-control-range" id="riskTolerance" min="0" max="1" step="0.1" value="0.5">
                    <small class="form-text text-muted">Your risk tolerance (0 = Conservative, 1 = Aggressive)</small>
                </div>
                <div class="form-group">
                    <label>Max Daily Recommendations</label>
                    <input type="number" class="form-control" id="maxRecommendations" value="5" min="1" max="20">
                </div>
                <div class="form-group">
                    <label>Preferred Sectors</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="tech" value="technology" checked>
                            <label class="form-check-label" for="tech">Technology</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="banking" value="banking" checked>
                            <label class="form-check-label" for="banking">Banking</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="pharma" value="pharmaceuticals">
                            <label class="form-check-label" for="pharma">Pharmaceuticals</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="auto" value="automotive">
                            <label class="form-check-label" for="auto">Automotive</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">Save Configuration</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// AI Assistant JavaScript Functions
function triggerAnalysis() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<div class="loading-spinner"></div> Analyzing...';
    button.disabled = true;
    
    fetch('/api/agentic/autonomous_analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Analysis completed successfully!', 'success');
            // Refresh the page to show new results
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification('Analysis failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function getRecommendations() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<div class="loading-spinner"></div> Getting...';
    button.disabled = true;
    
    fetch('/api/agentic/recommendations')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Generated ${data.count} recommendations!`, 'success');
            updateRecommendationsList(data.recommendations);
        } else {
            showNotification('Failed to get recommendations: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function triggerLearning() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<div class="loading-spinner"></div> Learning...';
    button.disabled = true;
    
    fetch('/api/agentic/learn', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Learning process completed!', 'success');
            showLearningResults(data.data);
        } else {
            showNotification('Learning failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function recordFeedback(recommendationId, feedback) {
    fetch('/api/agentic/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            recommendation_id: recommendationId,
            feedback: feedback
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Feedback recorded!', 'success');
            // Update the UI to reflect the feedback
            const recommendationElement = document.querySelector(`[data-rec-id="${recommendationId}"]`);
            if (recommendationElement) {
                recommendationElement.style.opacity = '0.6';
                recommendationElement.innerHTML += `<div class="feedback-recorded">‚úì ${feedback}</div>`;
            }
        } else {
            showNotification('Failed to record feedback: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
    });
}

function openConfigModal() {
    $('#configModal').modal('show');
}

function saveConfiguration() {
    const config = {
        confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
        risk_tolerance: parseFloat(document.getElementById('riskTolerance').value),
        max_recommendations_per_day: parseInt(document.getElementById('maxRecommendations').value),
        preferred_sectors: Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value)
    };
    
    fetch('/api/agentic/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ config: config })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Configuration updated successfully!', 'success');
            $('#configModal').modal('hide');
        } else {
            showNotification('Failed to update configuration: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
    });
}

function updateRecommendationsList(recommendations) {
    const listElement = document.getElementById('recommendations-list');
    if (recommendations.length === 0) {
        listElement.innerHTML = '<p class="text-center">No recommendations available.</p>';
        return;
    }
    
    listElement.innerHTML = recommendations.map(rec => `
        <div class="recommendation-item" data-rec-id="${rec.id}">
            <div class="recommendation-ticker">${rec.ticker}</div>
            <div class="recommendation-type ${rec.recommendation.toLowerCase()}">${rec.recommendation}</div>
            <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${rec.confidence * 100}%"></div>
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                Confidence: ${(rec.confidence * 100).toFixed(1)}% | 
                Target: ‚Çπ${rec.target_price || 'N/A'} | 
                Risk: ${rec.risk_level}
            </div>
            <div class="action-buttons" style="margin-top: 10px;">
                <button class="btn btn-sm btn-success" onclick="recordFeedback(${rec.id}, 'accepted')">
                    ‚úÖ Accept
                </button>
                <button class="btn btn-sm btn-danger" onclick="recordFeedback(${rec.id}, 'rejected')">
                    ‚ùå Reject
                </button>
            </div>
        </div>
    `).join('');
}

function showLearningResults(learningData) {
    const message = `
        <div>
            <h4>üß† Learning Summary</h4>
            <p><strong>Patterns Learned:</strong> ${learningData.patterns_learned}</p>
            <p><strong>Parameters Updated:</strong> ${learningData.parameters_updated.join(', ')}</p>
            <p><strong>Performance Improvement:</strong> ${(learningData.performance_improvement * 100).toFixed(2)}%</p>
        </div>
    `;
    
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Learning Results</h4>
                        <button type="button" class="close" onclick="this.closest('.modal').remove()">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">${message}</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showNotification(message, type = 'info') {
    // Create a toast notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Auto-refresh alerts every 30 seconds
setInterval(() => {
    fetch('/api/agentic/alerts')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.alerts.length > 0) {
            // Update alerts list if there are new alerts
            updateAlertsList(data.alerts);
        }
    })
    .catch(error => console.error('Error fetching alerts:', error));
}, 30000);

function updateAlertsList(alerts) {
    const listElement = document.getElementById('alerts-list');
    // Only update if we have new alerts to show
    if (alerts.length > 0) {
        // This would update the alerts list - implementation depends on your needs
        console.log('New alerts available:', alerts.length);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Agentic AI Dashboard loaded');
    
    // Load initial configuration into modal
    fetch('/api/agentic/config')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const config = data.config;
            if (config.confidence_threshold) {
                document.getElementById('confidenceThreshold').value = config.confidence_threshold;
            }
            if (config.risk_tolerance) {
                document.getElementById('riskTolerance').value = config.risk_tolerance;
            }
            if (config.max_recommendations_per_day) {
                document.getElementById('maxRecommendations').value = config.max_recommendations_per_day;
            }
        }
    })
    .catch(error => console.error('Error loading configuration:', error));
});
</script>
{% endblock %}
