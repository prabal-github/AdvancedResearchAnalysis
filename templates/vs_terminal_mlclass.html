<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS Terminal ML Class - Portfolio Management with AI/ML</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 50%, #1a202c 100%);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .vs-terminal-container {
            display: grid;
            grid-template-columns: 280px 1fr 350px;
            grid-template-rows: 50px 1fr;
            height: 100vh;
            gap: 1px;
            background: #0f172a;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid #475569;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            font-size: 18px;
            font-weight: 600;
            color: #60a5fa;
        }

        .header-nav {
            display: flex;
            gap: 20px;
        }

        .header-nav a {
            color: #cbd5e1;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .header-nav a:hover {
            color: #60a5fa;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        /* Left Sidebar - Portfolio Management */
        .left-sidebar {
            background: #1e293b;
            border-right: 1px solid #475569;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            border-bottom: 1px solid #475569;
        }

        .sidebar-header {
            padding: 15px;
            background: #0f172a;
            font-size: 14px;
            font-weight: 600;
            color: #60a5fa;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .portfolios-section {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .portfolio-item {
            background: #334155;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .portfolio-item:hover {
            background: #475569;
        }

        .portfolio-item.active {
            border-color: #60a5fa;
            background: #1e40af;
        }

        .portfolio-header {
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .portfolio-name {
            font-weight: 500;
            font-size: 14px;
        }

        .portfolio-value {
            font-size: 12px;
            color: #94a3b8;
        }

        .portfolio-stocks {
            padding: 0 12px 12px;
            display: none;
        }

        .portfolio-item.expanded .portfolio-stocks {
            display: block;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #475569;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 12px;
        }

        .add-portfolio-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px;
            margin: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .add-portfolio-btn:hover {
            background: #059669;
        }

        /* AI/ML Selection */
        .ai-ml-section {
            max-height: 40%;
            overflow-y: auto;
            padding: 10px;
        }

        .agent-item, .model-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #334155;
            margin-bottom: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .agent-item:hover, .model-item:hover {
            background: #475569;
        }

        .agent-item.active, .model-item.active {
            background: #1e40af;
        }

        .agent-checkbox, .model-checkbox {
            accent-color: #60a5fa;
        }

        /* Center Panel - Visualizations */
        .center-panel {
            background: #0f172a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .visualization-tabs {
            display: flex;
            background: #1e293b;
            border-bottom: 1px solid #475569;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #cbd5e1;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            background: #334155;
        }

        .tab-btn.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .visualization-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chart-container {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #475569;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f1f5f9;
        }

        /* Chart.js Canvas Sizing */
        canvas {
            max-width: 100% !important;
            max-height: 400px !important;
            width: auto !important;
            height: auto !important;
        }

        .chart-container canvas {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }

        /* Performance Charts Grid Layout */
        .performance-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .performance-charts-grid canvas {
            max-height: 250px !important;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: #334155;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .metric-change {
            font-size: 11px;
            margin-top: 5px;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }

        /* Right Sidebar - AI Chat */
        .right-sidebar {
            background: #1e293b;
            border-left: 1px solid #475569;
            display: flex;
            flex-direction: column;
            min-height: 0; /* allow flex child scrolling */
            overflow: hidden;
        }

        .chat-header {
            padding: 15px;
            background: #0f172a;
            border-bottom: 1px solid #475569;
            font-size: 14px;
            font-weight: 600;
            color: #60a5fa;
        }

        .chat-messages {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 15px;
            scrollbar-width: thin;
            scroll-behavior: smooth;
            min-height: 0;
        }

        .message {
            margin-bottom: 15px;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            background: #334155;
            padding: 10px 12px;
            border-radius: 8px;
            display: inline-block;
            max-width: 80%;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #1e40af;
            color: white;
        }

        .message.ai .message-content {
            background: #059669;
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .chat-suggestions {
            padding: 10px 15px;
            border-top: 1px solid #475569;
        }

        .suggestion-chip {
            display: inline-block;
            background: #334155;
            color: #cbd5e1;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .suggestion-chip:hover {
            background: #475569;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #475569;
        }

        .chat-input {
            width: 100%;
            background: #334155;
            border: 1px solid #475569;
            color: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #60a5fa;
        }

        /* Loading animations */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #334155;
            border-radius: 50%;
            border-top-color: #60a5fa;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Execute buttons */
        .execute-section {
            padding: 15px;
            border-top: 1px solid #475569;
            background: #0f172a;
        }

        .execute-btn {
            width: 100%;
            background: #1e40af;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .execute-btn:hover {
            background: #1d4ed8;
        }

        .execute-btn:disabled {
            background: #374151;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .vs-terminal-container {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 900px) {
            .vs-terminal-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50px auto auto 1fr;
            }
            
            .left-sidebar, .right-sidebar {
                max-height: 300px;
            }
        }

    /* Left Sidebar Tabs */
    .left-tabs-header { display: flex; gap:4px; margin-bottom:10px; }
    .left-tab-btn { flex:1; background:#1f2937; border:1px solid #374151; color:#9ca3af; padding:6px 8px; font-size:12px; cursor:pointer; border-radius:4px; text-align:center; }
    .left-tab-btn.active { background:#2563eb; border-color:#2563eb; color:#fff; }
    .left-tab-content { display:none; }
    .left-tab-content.active { display:block; }
    .portfolio-table { width:100%; border-collapse:collapse; font-size:12px; }
    .portfolio-table thead { background:#1f2937; }
    .portfolio-table th { padding:6px 8px; font-weight:600; text-align:left; border-bottom:1px solid #374151; }
    .portfolio-table td { padding:6px 8px; border-bottom:1px solid #1f2937; }
    .portfolio-row { cursor:pointer; }
    .portfolio-row:hover { background:#1f2937; }
    .new-portfolio-btn { margin-top:10px; width:100%; background:#10b981; border:none; padding:8px; border-radius:4px; color:#fff; font-size:12px; cursor:pointer; }
    .stocks-badge { background:#374151; padding:2px 6px; border-radius:10px; font-size:11px; }
    .inline-action-btn { background:none; border:none; color:#60a5fa; cursor:pointer; font-size:11px; }
    /* Fullscreen chart styling (moved inside style tag) */
    #tradingview-container.fullscreen-chart {
        position: fixed !important;
        top: 20px;
        left: 20px;
        right: 20px;
        bottom: 20px;
        width: auto !important;
        height: calc(100vh - 40px) !important;
        z-index: 9999;
        box-shadow: 0 0 0 1px #334155, 0 8px 32px -4px rgba(0,0,0,0.6);
    }
    #tradingview-container.fullscreen-chart::after {
        content: 'Fullscreen';
        position: absolute;
        top: 6px;
        right: 10px;
        font-size:10px;
        color:#475569;
        letter-spacing:.5px;
    }
    </style>
</head>
<body>
    <div class="vs-terminal-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">
                    <i class="fas fa-terminal"></i> VS Terminal ML Class
                </div>
                <div class="header-nav">
                    <a href="/vs_terminal_AClass">AClass</a>
                    <a href="/vs_terminal_MLClass" class="active">ML Class</a>
                    <a href="/vs_terminal_MLClass/ai_agent">🤖 AI Agent</a>
                    <a href="/agentic_ai/dashboard">AI Dashboard</a>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span>{{ current_investor }}</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-circle" style="color: #10b981;"></i>
                    <span style="font-size: 12px;">AI Active</span>
                </div>
                <div class="status-indicator" id="data-source-indicator">
                    <i class="fas fa-database" style="color: #94a3b8;"></i>
                    <span style="font-size: 12px;" id="data-source-text">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Left Sidebar - Portfolio Management -->
        <div class="left-sidebar">
            <div class="left-tabs-header">
                <button class="left-tab-btn active" onclick="switchLeftTab('portfolios')">Portfolios</button>
                <button class="left-tab-btn" onclick="switchLeftTab('agents')">AI Agents</button>
                <button class="left-tab-btn" onclick="switchLeftTab('models')">ML Models</button>
            </div>

            <!-- Portfolios Tab -->
            <div class="left-tab-content active" id="left-tab-portfolios">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                    <div style="font-size:13px; font-weight:600; color:#f3f4f6; display:flex; gap:6px; align-items:center;">
                        <i class="fas fa-briefcase"></i> Portfolios
                    </div>
                    <div style="display:flex; gap:4px;">
                        <button onclick="refreshAllPortfolios()" class="refresh-btn" id="global-refresh-btn" title="Refresh all portfolio data">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button onclick="createNewPortfolio()" class="inline-action-btn"><i class="fas fa-plus"></i> New</button>
                    </div>
                </div>
                <div style="max-height:260px; overflow:auto; border:1px solid #1f2937; border-radius:6px;">
                    <table class="portfolio-table" id="portfolio-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Value</th>
                                <th>Stocks</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="portfolio-table-body">
                            <!-- rows injected -->
                        </tbody>
                    </table>
                </div>
                <button class="new-portfolio-btn" onclick="createNewPortfolio()"><i class="fas fa-plus"></i> Create Portfolio</button>
                <div id="portfolio-stocks-detail" style="margin-top:12px; display:none;">
                    <div style="font-size:13px; font-weight:600; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                        <span id="selected-portfolio-name">Portfolio Stocks</span>
                        <button class="inline-action-btn" onclick="addStockToCurrent()"><i class="fas fa-plus"></i> Add Stock</button>
                    </div>
                    <div id="portfolio-stocks-list" style="max-height:160px; overflow:auto; border:1px solid #1f2937; border-radius:6px; padding:6px; font-size:12px;">
                        <!-- stock list -->
                    </div>
                </div>
                <div class="execute-section" style="margin-top:14px;">
                    <button class="execute-btn" onclick="executeAIAnalysis()" id="execute-ai-btn" style="margin-bottom:6px;">
                        <i class="fas fa-play"></i> Execute AI Analysis
                    </button>
                    <button class="execute-btn" onclick="executeMLPredictions()" id="execute-ml-btn">
                        <i class="fas fa-cogs"></i> Run ML Predictions
                    </button>
                </div>
            </div>

            <!-- Agents Tab -->
            <div class="left-tab-content" id="left-tab-agents">
                <div style="font-size:13px; font-weight:600; margin-bottom:6px; display:flex; gap:6px; align-items:center;">
                    <i class="fas fa-robot"></i> AI Agents
                </div>
                <div style="padding:6px 10px; font-size:11px; color:#94a3b8; display:flex; justify-content:space-between; align-items:center;">
                    <span id="agent-subscription-status">Loading agents...</span>
                    <a href="/integrated_ml_models_and_agentic_ai" style="color:#60a5fa; text-decoration:none;">Manage</a>
                </div>
                <div class="ai-ml-section" id="ai-agents-list"></div>
            </div>

            <!-- Models Tab -->
            <div class="left-tab-content" id="left-tab-models">
                <div style="font-size:13px; font-weight:600; margin-bottom:6px; display:flex; gap:6px; align-items:center;">
                    <i class="fas a-brain fas fa-brain"></i> ML Models
                </div>
                <div style="padding:6px 10px; font-size:11px; color:#94a3b8; display:flex; justify-content:space-between; align-items:center;">
                    <span id="model-subscription-status">Loading models...</span>
                    <a href="/integrated_ml_models_and_agentic_ai" style="color:#60a5fa; text-decoration:none;">Manage</a>
                </div>
                <div class="ai-ml-section" id="ml-models-list"></div>
            </div>
        </div>

        <!-- Center Panel - Visualizations -->
        <div class="center-panel">
            <div class="visualization-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('risk')">Risk Analytics</button>
                <button class="tab-btn" onclick="switchTab('signals')">Trading Signals</button>
                <button class="tab-btn" onclick="switchTab('ml')">ML Predictions</button>
                <button class="tab-btn" onclick="switchTab('performance')">Performance</button>
                <button class="tab-btn" onclick="switchTab('realtime')">Real-Time</button>
                <button class="tab-btn" onclick="switchTab('livechart')">Live Chart</button>
            </div>

            <div class="visualization-content">
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Portfolio Value</div>
                            <div class="metric-value" id="total-value">₹0</div>
                            <div class="metric-change positive" id="total-change">+0.00%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active Portfolios</div>
                            <div class="metric-value" id="portfolio-count">0</div>
                            <div class="metric-change">Portfolios</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">AI Score</div>
                            <div class="metric-value" id="ai-score">0</div>
                            <div class="metric-change positive">Good</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Risk Level</div>
                            <div class="metric-value" id="risk-level">Low</div>
                            <div class="metric-change">Moderate</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Portfolio Performance Chart</div>
                        <div id="portfolio-chart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                            Select a portfolio to view performance chart
                        </div>
                    </div>
                </div>

                <!-- Risk Analytics Tab -->
                <div id="risk-tab" class="tab-content" style="display: none;">
                    <div class="chart-container">
                        <div class="chart-title">Risk Analytics Dashboard</div>
                        <div id="risk-analysis-content">
                            <!-- Predefined Agentic AI Panel -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 16px;">
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #60a5fa; display: flex; align-items: center; gap: 8px;">
                                        <i class="fa fa-brain"></i> SONNET 3.5 PORTFOLIO AI
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <select id="predefinedAgentTypeMLC" style="width: 100%; padding: 8px; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #e5e7eb; font-size: 12px;">
                                            <option value="portfolio_analysis">📊 Portfolio Analysis</option>
                                            <option value="risk_assessment">⚠️ Risk Assessment</option>
                                            <option value="diversification">🎯 Diversification Review</option>
                                            <option value="market_outlook">🌐 Market Outlook</option>
                                            <option value="sector_rotation">🔄 Sector Rotation</option>
                                            <option value="stress_testing">🧪 Stress Testing</option>
                                            <option value="hedging_strategy">🛡️ Hedging Strategy</option>
                                            <option value="rebalancing">⚖️ Rebalancing Plan</option>
                                        </select>
                                    </div>
                                    <button onclick="generatePortfolioInsightsMLC()" style="width: 100%; padding: 10px; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                        <i class="fa fa-magic"></i> Generate AI Insights
                                    </button>
                                    <div id="aiAnalysisStatusMLC" style="margin-top: 8px; font-size: 11px; color: #9ca3af; text-align: center; min-height: 16px;"></div>
                                </div>
                                
                                <div style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 16px;">
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #10b981; display: flex; align-items: center; gap: 8px;">
                                        <i class="fa fa-chart-line"></i> QUICK ACTIONS
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="generatePortfolioInsightsMLC('risk_assessment')" style="padding: 8px; background: #dc2626; border: none; border-radius: 4px; color: white; font-size: 12px; cursor: pointer;">
                                            ⚠️ Quick Risk Check
                                        </button>
                                        <button onclick="generatePortfolioInsightsMLC('diversification')" style="padding: 8px; background: #7c3aed; border: none; border-radius: 4px; color: white; font-size: 12px; cursor: pointer;">
                                            🎯 Diversification Scan
                                        </button>
                                        <button onclick="generatePortfolioInsightsMLC('rebalancing')" style="padding: 8px; background: #059669; border: none; border-radius: 4px; color: white; font-size: 12px; cursor: pointer;">
                                            ⚖️ Rebalancing Guide
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Insights Display Panel -->
                            <div id="aiInsightsPanelMLC" style="background: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 20px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div style="font-size: 16px; font-weight: 600; color: #f1f5f9; display: flex; align-items: center; gap: 8px;">
                                        <i class="fa fa-robot"></i> AI PORTFOLIO INSIGHTS
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="exportInsightsMLC()" style="padding: 6px 12px; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #e5e7eb; font-size: 12px; cursor: pointer;">
                                            <i class="fa fa-download"></i> Export
                                        </button>
                                        <button onclick="shareInsightsMLC()" style="padding: 6px 12px; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #e5e7eb; font-size: 12px; cursor: pointer;">
                                            <i class="fa fa-share"></i> Share
                                        </button>
                                        <button onclick="clearInsightsMLC()" style="padding: 6px 12px; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #e5e7eb; font-size: 12px; cursor: pointer;">
                                            <i class="fa fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                                <div id="aiInsightsContentMLC" style="line-height: 1.6; color: #cbd5e1;">
                                    <!-- Dynamic insights content will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Signals Tab -->
                <div id="signals-tab" class="tab-content" style="display: none;">
                    <div class="chart-container">
                        <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>🤖 AI Trading Signals - NIFTY 50</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div id="signals-status" style="font-size: 12px; color: #6b7280;"></div>
                                <button id="refresh-signals-btn" onclick="loadRealtimeAITradingSignals()" 
                                        style="background: #10b981; border: none; color: #fff; padding: 6px 12px; 
                                               font-size: 12px; border-radius: 4px; cursor: pointer; display: flex; 
                                               align-items: center; gap: 4px;">
                                    <i class="fas fa-sync-alt" id="signals-refresh-icon"></i>
                                    Load AI Signals
                                </button>
                            </div>
                        </div>
                        
                        <div id="trading-signals-content">
                            <div style="text-align: center; margin-top: 50px; color: #6b7280;">
                                <div style="font-size: 24px; margin-bottom: 16px;">🎯</div>
                                <h3 style="margin-bottom: 12px; color: #e5e7eb;">5 Realtime Agentic AI Trading Signals</h3>
                                <p style="margin-bottom: 16px;">
                                    Click "Load AI Signals" to get top 10 trading recommendations from 5 specialized AI agents:
                                </p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 20px 0;">
                                    <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                        <div style="font-weight: 600; color: #60a5fa; margin-bottom: 4px;">🚀 Momentum Trader</div>
                                        <div style="font-size: 12px; color: #9ca3af;">Identifies momentum breakouts and trends</div>
                                    </div>
                                    <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <div style="font-weight: 600; color: #34d399; margin-bottom: 4px;">📊 Technical Analyst</div>
                                        <div style="font-size: 12px; color: #9ca3af;">Advanced technical indicator analysis</div>
                                    </div>
                                    <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <div style="font-weight: 600; color: #fbbf24; margin-bottom: 4px;">⚡ Volatility Arbitrage</div>
                                        <div style="font-size: 12px; color: #9ca3af;">Exploits volatility patterns</div>
                                    </div>
                                    <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                        <div style="font-weight: 600; color: #a78bfa; margin-bottom: 4px;">📈 Trend Follower</div>
                                        <div style="font-size: 12px; color: #9ca3af;">Follows strong market trends</div>
                                    </div>
                                    <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                        <div style="font-weight: 600; color: #f87171; margin-bottom: 4px;">🔄 Mean Reversion</div>
                                        <div style="font-size: 12px; color: #9ca3af;">Identifies oversold/overbought levels</div>
                                    </div>
                                </div>
                                <div style="background: #0f172a; padding: 12px; border-radius: 8px; border: 1px solid #374151; margin-top: 16px;">
                                    <div style="font-size: 12px; color: #fbbf24; margin-bottom: 4px;">⚠️ Data Sources</div>
                                    <div style="font-size: 11px; color: #9ca3af;">Real-time data from YFinance • Fyers symbol mapping • NIFTY 50 stocks</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ML Predictions Tab -->
                <div id="ml-tab" class="tab-content" style="display: none;">
                    <div class="chart-container">
                        <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-brain"></i> Machine Learning Predictions</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="loadRealtimeMLPredictions()" 
                                        style="background: #10b981; border: none; color: #fff; padding: 8px 16px; 
                                               border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; 
                                               align-items: center; gap: 6px;">
                                    <i class="fas fa-sync" id="ml-refresh-icon"></i>
                                    Get ML Predictions
                                </button>
                            </div>
                        </div>
                        
                        <div id="ml-predictions-content">
                            <!-- Loading State -->
                            <div id="ml-loading" style="display: none; text-align: center; padding: 40px;">
                                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #374151; 
                                           border-radius: 50%; border-top-color: #10b981; animation: spin 1s ease-in-out infinite;"></div>
                                <p style="color: #9ca3af; margin-top: 16px; font-size: 14px;">
                                    Analyzing NIFTY 50 stocks with 5 ML agents...
                                </p>
                                <div id="ml-progress-bar" style="width: 100%; max-width: 300px; height: 6px; 
                                                                   background: #374151; border-radius: 3px; margin: 16px auto; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); 
                                               width: 0%; border-radius: 3px; transition: width 0.3s ease;" id="ml-progress-fill"></div>
                                </div>
                            </div>

                            <!-- Default State -->
                            <div id="ml-default-content" style="text-align: center; padding: 40px;">
                                <div style="font-size: 48px; color: #475569; margin-bottom: 16px;">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <h3 style="color: #e2e8f0; margin-bottom: 12px;">5 Realtime ML Prediction Agents</h3>
                                <p style="color: #9ca3af; margin-bottom: 24px; line-height: 1.6;">
                                    Advanced machine learning agents for price prediction, trend analysis, volatility forecasting, 
                                    risk assessment, and portfolio optimization for all 50 NIFTY stocks.
                                </p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                                           gap: 16px; margin-top: 32px; text-align: left;">
                                    <div style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                        <h4 style="color: #60a5fa; margin-bottom: 8px;"><i class="fas fa-chart-line"></i> Price Predictor</h4>
                                        <p style="color: #d1d5db; font-size: 13px;">ML-based price forecasting</p>
                                    </div>
                                    <div style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <h4 style="color: #34d399; margin-bottom: 8px;"><i class="fas fa-trending-up"></i> Trend Predictor</h4>
                                        <p style="color: #d1d5db; font-size: 13px;">Trend direction classification</p>
                                    </div>
                                    <div style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <h4 style="color: #fbbf24; margin-bottom: 8px;"><i class="fas fa-wave-square"></i> Volatility Predictor</h4>
                                        <p style="color: #d1d5db; font-size: 13px;">Volatility forecasting model</p>
                                    </div>
                                    <div style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                        <h4 style="color: #f87171; margin-bottom: 8px;"><i class="fas fa-shield-alt"></i> Risk Assessor</h4>
                                        <p style="color: #d1d5db; font-size: 13px;">Risk classification & scoring</p>
                                    </div>
                                    <div style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                        <h4 style="color: #a78bfa; margin-bottom: 8px;"><i class="fas fa-balance-scale"></i> Portfolio Optimizer</h4>
                                        <p style="color: #d1d5db; font-size: 13px;">Allocation recommendations</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Results Content -->
                            <div id="ml-results-content" style="display: none;">
                                <!-- Market Summary -->
                                <div id="ml-market-summary" style="background: #1f2937; border-radius: 8px; padding: 16px; margin-bottom: 20px;"></div>
                                
                                <!-- Predictions Table -->
                                <div style="background: #1f2937; border-radius: 8px; overflow: hidden;">
                                    <div style="background: #111827; padding: 16px; border-bottom: 1px solid #374151;">
                                        <h3 style="color: #f3f4f6; margin: 0; display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-list"></i>
                                            Top 10 ML Predictions - NIFTY 50
                                        </h3>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table id="ml-predictions-table" style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #374151;">
                                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; font-size: 13px;">Symbol</th>
                                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; font-size: 13px;">Prediction Type</th>
                                                    <th style="padding: 12px; text-align: right; color: #f9fafb; font-weight: 600; font-size: 13px;">Current Price</th>
                                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; font-size: 13px;">ML Prediction</th>
                                                    <th style="padding: 12px; text-align: center; color: #f9fafb; font-weight: 600; font-size: 13px;">Confidence</th>
                                                    <th style="padding: 12px; text-align: center; color: #f9fafb; font-weight: 600; font-size: 13px;">Accuracy</th>
                                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; font-size: 13px;">ML Agent</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ml-predictions-tbody">
                                                <!-- Predictions will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Error State -->
                            <div id="ml-error-content" style="display: none; text-align: center; padding: 40px;">
                                <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 style="color: #f87171; margin-bottom: 12px;">ML Prediction Error</h3>
                                <p style="color: #9ca3af; margin-bottom: 24px;" id="ml-error-message">
                                    Unable to generate ML predictions. Please try again.
                                </p>
                                <button onclick="loadRealtimeMLPredictions()" 
                                        style="background: #10b981; border: none; color: #fff; padding: 10px 20px; 
                                               border-radius: 6px; cursor: pointer;">
                                    Retry ML Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div id="performance-tab" class="tab-content" style="display: none;">
                    <!-- Performance Dashboard Header -->
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-tachometer-alt"></i> Performance Dashboard</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="refreshPerformanceData()" 
                                        style="background: #10b981; border: none; color: #fff; padding: 8px 16px; 
                                               border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; 
                                               align-items: center; gap: 6px;">
                                    <i class="fas fa-sync-alt" id="refresh-icon"></i>
                                    Refresh Data
                                </button>
                                <button onclick="generateComparativeAnalysis()" 
                                        style="background: #8b5cf6; border: none; color: #fff; padding: 8px 16px; 
                                               border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; 
                                               align-items: center; gap: 6px;">
                                    <i class="fas fa-brain" id="analysis-icon"></i>
                                    AI Analysis
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Real-Time Performance Metrics -->
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <div class="chart-title"><i class="fas fa-chart-line"></i> Real-Time Performance Metrics</div>
                        
                        <!-- Portfolio Performance Overview -->
                        <div id="portfolio-performance-section" style="margin-bottom: 24px;">
                            <h4 style="color: #a78bfa; margin-bottom: 16px; font-size: 14px;">Portfolio Performance</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="color: #10b981; font-size: 12px; margin-bottom: 4px;">Today</div>
                                    <div id="portfolio-today" style="color: #e5e7eb; font-size: 20px; font-weight: bold;">--</div>
                                </div>
                                <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="color: #3b82f6; font-size: 12px; margin-bottom: 4px;">This Week</div>
                                    <div id="portfolio-week" style="color: #e5e7eb; font-size: 20px; font-weight: bold;">--</div>
                                </div>
                                <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                    <div style="color: #f59e0b; font-size: 12px; margin-bottom: 4px;">This Month</div>
                                    <div id="portfolio-month" style="color: #e5e7eb; font-size: 20px; font-weight: bold;">--</div>
                                </div>
                                <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                    <div style="color: #8b5cf6; font-size: 12px; margin-bottom: 4px;">Total Value</div>
                                    <div id="portfolio-total" style="color: #e5e7eb; font-size: 20px; font-weight: bold;">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Success Rates -->
                        <div id="success-rates-section" style="margin-bottom: 24px;">
                            <h4 style="color: #34d399; margin-bottom: 16px; font-size: 14px;">Success Rates</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                    <h5 style="color: #a78bfa; margin-bottom: 12px; font-size: 13px;"><i class="fas fa-robot"></i> ML Predictions</h5>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Accuracy</div>
                                            <div id="ml-accuracy" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Precision</div>
                                            <div id="ml-precision" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Recall</div>
                                            <div id="ml-recall" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">F1 Score</div>
                                            <div id="ml-f1" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                    <h5 style="color: #fbbf24; margin-bottom: 12px; font-size: 13px;"><i class="fas fa-chart-line"></i> Trading Signals</h5>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Win Rate</div>
                                            <div id="trading-winrate" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Profit Factor</div>
                                            <div id="trading-profit" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Sharpe Ratio</div>
                                            <div id="trading-sharpe" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                        <div>
                                            <div style="color: #9ca3af; font-size: 11px;">Max Drawdown</div>
                                            <div id="trading-drawdown" style="color: #e5e7eb; font-size: 16px; font-weight: bold;">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Performing Stocks -->
                        <div id="top-stocks-section">
                            <h4 style="color: #f87171; margin-bottom: 16px; font-size: 14px;">Top Performing Stocks</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                    <h5 style="color: #a78bfa; margin-bottom: 12px; font-size: 13px;"><i class="fas fa-robot"></i> ML Predictions</h5>
                                    <div id="ml-top-stocks" style="font-size: 12px;">
                                        <!-- ML top stocks will be populated here -->
                                    </div>
                                </div>
                                <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                    <h5 style="color: #fbbf24; margin-bottom: 12px; font-size: 13px;"><i class="fas fa-chart-line"></i> Trading Signals</h5>
                                    <div id="trading-top-stocks" style="font-size: 12px;">
                                        <!-- Trading top stocks will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historical Performance Charts -->
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <div class="chart-title"><i class="fas fa-chart-area"></i> Historical Performance Charts</div>
                        
                        <!-- Performance Trends Chart -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #34d399; margin-bottom: 16px; font-size: 14px;">Performance Trends (30 Days)</h4>
                            <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                <canvas id="performance-trends-chart" width="800" height="300"></canvas>
                            </div>
                        </div>

                        <!-- Win/Loss Ratios and Volatility -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                <h5 style="color: #fbbf24; margin-bottom: 16px; font-size: 13px;">Win/Loss Ratios (12 Weeks)</h5>
                                <canvas id="winloss-chart" width="400" height="200"></canvas>
                            </div>
                            <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                <h5 style="color: #f87171; margin-bottom: 16px; font-size: 13px;">Volatility Analysis</h5>
                                <canvas id="volatility-chart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Management Dashboard -->
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <div class="chart-title"><i class="fas fa-shield-alt"></i> Risk Management Dashboard</div>
                        
                        <!-- Risk Metrics Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <div style="color: #ef4444; font-size: 12px; margin-bottom: 4px;">VaR (95%)</div>
                                <div id="var-95" style="color: #e5e7eb; font-size: 18px; font-weight: bold;">--</div>
                            </div>
                            <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div style="color: #f59e0b; font-size: 12px; margin-bottom: 4px;">Portfolio Beta</div>
                                <div id="portfolio-beta" style="color: #e5e7eb; font-size: 18px; font-weight: bold;">--</div>
                            </div>
                            <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                <div style="color: #8b5cf6; font-size: 12px; margin-bottom: 4px;">Max Drawdown</div>
                                <div id="max-drawdown" style="color: #e5e7eb; font-size: 18px; font-weight: bold;">--</div>
                            </div>
                            <div class="metric-card" style="background: #1f2937; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="color: #10b981; font-size: 12px; margin-bottom: 4px;">Risk Score</div>
                                <div id="risk-score" style="color: #e5e7eb; font-size: 18px; font-weight: bold;">--</div>
                            </div>
                        </div>

                        <!-- Risk Charts Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                <h5 style="color: #ef4444; margin-bottom: 16px; font-size: 13px;">Drawdown Analysis</h5>
                                <canvas id="drawdown-chart" width="400" height="200"></canvas>
                            </div>
                            <div style="background: #111827; padding: 20px; border-radius: 8px; border: 1px solid #374151;">
                                <h5 style="color: #8b5cf6; margin-bottom: 16px; font-size: 13px;">Correlation Matrix</h5>
                                <div id="correlation-matrix" style="font-size: 11px; max-height: 200px; overflow-y: auto;">
                                    <!-- Correlation matrix will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Comparative Analysis (Existing) -->
                    <div class="chart-container">
                        <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-brain"></i> AI Comparative Analysis</span>
                        </div>
                        
                        <div id="performance-content">
                            <!-- Loading State -->
                            <div id="analysis-loading" style="display: none; text-align: center; padding: 40px;">
                                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #374151; 
                                           border-radius: 50%; border-top-color: #8b5cf6; animation: spin 1s ease-in-out infinite;"></div>
                                <p style="color: #9ca3af; margin-top: 16px; font-size: 14px;">
                                    Claude Sonnet 3.5 analyzing ML Predictions vs Trading Signals...
                                </p>
                                <div id="analysis-progress-bar" style="width: 100%; max-width: 400px; height: 6px; 
                                                                        background: #374151; border-radius: 3px; margin: 16px auto; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, #8b5cf6, #7c3aed); 
                                               width: 0%; border-radius: 3px; transition: width 0.3s ease;" id="analysis-progress-fill"></div>
                                </div>
                                <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">
                                    Gathering data from both systems for deep analysis...
                                </p>
                            </div>

                            <!-- Default State -->
                            <div id="analysis-default-content" style="text-align: center; padding: 40px;">
                                <div style="font-size: 48px; color: #475569; margin-bottom: 16px;">
                                    <i class="fas fa-analytics"></i>
                                </div>
                                <h3 style="color: #e2e8f0; margin-bottom: 12px;">AI-Powered Comparative Analysis</h3>
                                <p style="color: #9ca3af; margin-bottom: 24px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
                                    Get intelligent insights comparing ML Predictions and Trading Signals performance using 
                                    Claude Sonnet 3.5 AI. Analyze accuracy, confidence levels, market coverage, and strategic recommendations.
                                </p>
                            </div>

                            <!-- Results Content -->
                            <div id="analysis-results-content" style="display: none;">
                                <!-- Analysis will be populated here -->
                            </div>

                            <!-- Error State -->
                            <div id="analysis-error-content" style="display: none; text-align: center; padding: 40px;">
                                <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 style="color: #f87171; margin-bottom: 12px;">Analysis Error</h3>
                                <p style="color: #9ca3af; margin-bottom: 24px;" id="analysis-error-message">
                                    Unable to generate comparative analysis. Please try again.
                                </p>
                                <button onclick="generateComparativeAnalysis()" 
                                        style="background: #8b5cf6; border: none; color: #fff; padding: 10px 20px; 
                                               border-radius: 6px; cursor: pointer;">
                                    Retry Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-Time Insights Tab (NEW) -->
                <div id="realtime-tab" class="tab-content" style="display: none;">
                    <div class="chart-container">
                        <div class="chart-title">Real-Time AI + ML Insights</div>
                        <div id="realtime-insights-content">
                            <p style="color: #6b7280; text-align: center; margin-top: 50px;">
                                Select a portfolio to view unified real-time quotes, risk stats, forecasts, and sentiment.
                            </p>
                        </div>
                        <div style="margin-top:16px; display:flex; gap:8px;">
                            <button onclick="loadRealtimeInsights()" style="flex:1; padding:8px; background:#2563eb; color:#fff; border:none; border-radius:4px; cursor:pointer;">Refresh Insights</button>
                        </div>
                    </div>
                </div>

                <!-- Live Chart Tab (NEW) -->
                <div id="livechart-tab" class="tab-content" style="display:none;">
                    <div class="chart-container">
                        <div class="chart-title" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Live Trading Chart</span>
                            <div style="display:flex; gap:6px; align-items:center;">
                                <input id="livechart-symbol" value="RELIANCE" style="background:#1f2937; border:1px solid #374151; color:#e5e7eb; padding:4px 6px; border-radius:4px; width:110px; font-size:12px;" />
                                <button onclick="loadLiveChart()" style="background:#2563eb; border:none; color:#fff; padding:6px 10px; font-size:12px; border-radius:4px; cursor:pointer;">Load</button>
                                <button onclick="explainCurrentChart()" style="background:#10b981; border:none; color:#fff; padding:6px 10px; font-size:12px; border-radius:4px; cursor:pointer;">AI Explain</button>
                <button id="chart-expand-btn" onclick="toggleChartFullscreen()" style="background:#64748b; border:none; color:#fff; padding:6px 10px; font-size:12px; border-radius:4px; cursor:pointer;" title="Toggle Fullscreen">Expand</button>
                            </div>
                        </div>
            <div id="tradingview-container" style="height:760px; min-height:640px; border:1px solid #374151; border-radius:8px; overflow:hidden; background:#0f172a; display:flex; align-items:center; justify-content:center; color:#64748b; position:relative; transition:height .25s ease;">
                            Enter a symbol and click Load to view chart (expanded)
                        </div>
                        <div style="margin-top:14px;">
                            <div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#f1f5f9; display:flex; align-items:center; gap:6px;">
                                <i class="fas fa-brain"></i> AI Chart Summary
                            </div>
                            <div id="ai-chart-summary" style="background:#1f2937; border:1px solid #374151; padding:12px; border-radius:6px; font-size:13px; line-height:1.5; color:#cbd5e1; min-height:80px;">
                                Chart explanation will appear here.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - AI Chat -->
        <div class="right-sidebar">
            <div class="chat-header">
                <i class="fas fa-comments"></i> AI Assistant
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="message ai">
                    <div class="message-content">
                        Welcome to VS Terminal ML Class! I'm your AI assistant for portfolio management. I can help you with portfolio analysis, risk assessment, trading signals, ML predictions, and market intelligence. How can I assist you today?
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>

            <div class="chat-suggestions" id="chat-suggestions">
                <div class="suggestion-chip" onclick="sendSuggestion('Analyze my portfolio')">Analyze my portfolio</div>
                <div class="suggestion-chip" onclick="sendSuggestion('Show trading signals')">Show trading signals</div>
                <div class="suggestion-chip" onclick="sendSuggestion('Run ML predictions')">Run ML predictions</div>
                <div class="suggestion-chip" onclick="sendSuggestion('Get market insights')">Get market insights</div>
            </div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" placeholder="Ask about portfolios, AI, ML models..." 
                       id="chat-input" onkeypress="handleChatKeyPress(event)">
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPortfolio = null;
        let selectedAgents = [];
        let selectedModels = [];
        let portfolios = [];
        let aiAgents = [];
        let mlModels = [];
    let realtimeTimer = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolios();
            loadAIAgents();
            loadMLModels();
            checkDataSourceStatus(); // Check production vs development data source
            
            // Provider badge disabled for investors (admin only now)
            // Optional auto-refresh of real-time insights every 60s when tab active
            setInterval(() => {
                const rtTab = document.getElementById('realtime-tab');
                if (rtTab && rtTab.style.display !== 'none' && currentPortfolio) {
                    loadRealtimeInsights(true);
                }
            }, 60000);

            // Auto-refresh portfolio data every 2 minutes when portfolio tab is active
            setInterval(() => {
                const portfolioTab = document.getElementById('left-tab-portfolio');
                if (portfolioTab && portfolioTab.classList.contains('active') && currentPortfolio) {
                    refreshPortfolioData(currentPortfolio);
                }
            }, 120000); // 2 minutes

            // Recompute chat scroll area after layout changes
            window.addEventListener('resize', adjustChatHeight);
            adjustChatHeight();
        });
        
        // Check data source status (Fyers API vs YFinance)
        async function checkDataSourceStatus() {
            try {
                const indicator = document.getElementById('data-source-indicator');
                const textElement = document.getElementById('data-source-text');
                const iconElement = indicator.querySelector('i');
                
                // Test with a sample stock to determine data source
                const response = await fetch('/api/vs_terminal_MLClass/stocks/realtime/RELIANCE');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const environment = data.data.environment;
                    const dataSource = data.data.data_source;
                    const hasRealtimeFeatures = data.realtime_features;
                    
                    if (environment === 'production' && dataSource === 'fyers') {
                        textElement.textContent = 'Fyers API';
                        iconElement.style.color = '#10b981'; // Green
                        iconElement.className = 'fas fa-chart-line';
                        indicator.title = 'Production: Real-time data from Fyers API with L2 market depth';
                    } else {
                        textElement.textContent = 'Development';
                        iconElement.style.color = '#f59e0b'; // Yellow
                        iconElement.className = 'fas fa-flask';
                        indicator.title = 'Development: Using YFinance data (delayed)';
                    }
                    
                    // Show additional features available in production
                    if (hasRealtimeFeatures && (hasRealtimeFeatures.market_depth || hasRealtimeFeatures.tick_data)) {
                        textElement.textContent += ' Pro';
                        indicator.title += ' | Market depth and tick data available';
                    }
                } else {
                    textElement.textContent = 'Offline';
                    iconElement.style.color = '#ef4444'; // Red
                    iconElement.className = 'fas fa-exclamation-triangle';
                    indicator.title = 'Data source unavailable';
                }
            } catch (error) {
                console.error('Error checking data source status:', error);
                const indicator = document.getElementById('data-source-indicator');
                const textElement = document.getElementById('data-source-text');
                const iconElement = indicator.querySelector('i');
                
                textElement.textContent = 'Error';
                iconElement.style.color = '#ef4444';
                iconElement.className = 'fas fa-times-circle';
                indicator.title = 'Error checking data source';
            }
        }

        function adjustChatHeight() {
            const chat = document.getElementById('chat-messages');
            if (!chat) return;
            // Ensure it doesn't exceed sidebar height; rely on flex but enforce min-height 0
            chat.style.maxHeight = (chat.parentElement.clientHeight - 140) + 'px';
        }

        // Load portfolios
        async function loadPortfolios() {
            try {
                const response = await fetch('/api/vs_terminal_MLClass/portfolios');
                const data = await response.json();
                
                if (data.success) {
                    portfolios = data.data;
                    renderPortfolios();
                    updateOverviewMetrics();
                }
            } catch (error) {
                console.error('Error loading portfolios:', error);
            }
        }

        // Render portfolios in sidebar
        function renderPortfolios() {
            const tbody = document.getElementById('portfolio-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            portfolios.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'portfolio-row';
                tr.onclick = () => selectPortfolio(p.id);
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>₹${p.total_value.toLocaleString()}</td>
                    <td><span class="stocks-badge">${p.stocks.length}</span></td>
                    <td><button class="inline-action-btn" onclick="event.stopPropagation(); addStockToPortfolio(${p.id})"><i class='fas fa-plus'></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function switchLeftTab(tab) {
            document.querySelectorAll('.left-tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.left-tab-content').forEach(c=>c.classList.remove('active'));
            const btn = Array.from(document.querySelectorAll('.left-tab-btn')).find(b=>b.textContent.toLowerCase().includes(tab.slice(0,4)) || b.onclick?.toString().includes(tab));
            if (btn) btn.classList.add('active');
            const content = document.getElementById(`left-tab-${tab}`);
            if (content) content.classList.add('active');
        }

        function addStockToCurrent() {
            if (!currentPortfolio) return alert('Select a portfolio first');
            addStockToPortfolio(currentPortfolio);
        }

        function renderSelectedPortfolioStocks(p) {
            const detail = document.getElementById('portfolio-stocks-detail');
            const nameEl = document.getElementById('selected-portfolio-name');
            const listEl = document.getElementById('portfolio-stocks-list');
            if (!detail || !nameEl || !listEl) return;
            detail.style.display = 'block';
            nameEl.textContent = `${p.name} Stocks`;
            
            // Add refresh button and last updated indicator
            nameEl.innerHTML = `${p.name} Stocks 
                <button class="refresh-btn" onclick="refreshPortfolioData(${p.id})" id="refresh-btn-${p.id}">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <span class="last-updated" id="last-updated-${p.id}"></span>`;
                
            if (!p.stocks.length) {
                listEl.innerHTML = '<div style="color:#6b7280;">No stocks yet. Add one.</div>';
                return;
            }
            listEl.innerHTML = p.stocks.map(s=>`<div style='display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #1f2937;' id="stock-${s.symbol}">
                <span>${s.symbol}</span><span class="stock-value" data-symbol="${s.symbol}">₹${s.value.toLocaleString()}</span>
            </div>`).join('');
        }

        // Refresh portfolio data with real-time prices
        async function refreshPortfolioData(portfolioId) {
            const refreshBtn = document.getElementById(`refresh-btn-${portfolioId}`);
            const lastUpdatedEl = document.getElementById(`last-updated-${portfolioId}`);
            
            if (!refreshBtn) return;
            
            // Show loading state
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            try {
                // Get portfolio stocks
                const portfolio = portfolios.find(p => p.id === portfolioId);
                if (!portfolio || !portfolio.stocks.length) {
                    throw new Error('No stocks to update');
                }
                
                // Get real-time prices for all stocks
                const symbols = portfolio.stocks.map(s => s.symbol);
                const pricePromises = symbols.map(async (symbol) => {
                    try {
                        const response = await fetch(`/api/vs_terminal_MLClass/stocks/realtime/${symbol}`);
                        const data = await response.json();
                        return {
                            symbol: symbol,
                            price: data.success ? data.stock.current_price : null,
                            change_pct: data.success ? data.stock.change_pct : null
                        };
                    } catch (error) {
                        console.error(`Error fetching price for ${symbol}:`, error);
                        return { symbol: symbol, price: null, change_pct: null };
                    }
                });
                
                const priceResults = await Promise.all(pricePromises);
                
                // Update stock values in the portfolio display
                priceResults.forEach(result => {
                    if (result.price) {
                        const stockEl = document.querySelector(`.stock-value[data-symbol="${result.symbol}"]`);
                        if (stockEl) {
                            // Calculate new value (assuming quantity is stored - we'll use the ratio)
                            const currentText = stockEl.textContent;
                            const currentValue = parseFloat(currentText.replace('₹', '').replace(/,/g, ''));
                            
                            // Update the display with new price
                            stockEl.innerHTML = `₹${result.price.toLocaleString()} 
                                <span style="font-size:11px; color:${result.change_pct > 0 ? '#10b981' : '#ef4444'};">
                                    (${result.change_pct > 0 ? '+' : ''}${result.change_pct}%)
                                </span>`;
                        }
                    }
                });
                
                // Update portfolio in memory
                const portfolioIndex = portfolios.findIndex(p => p.id === portfolioId);
                if (portfolioIndex !== -1) {
                    // Recalculate total value
                    let totalValue = 0;
                    priceResults.forEach(result => {
                        const stock = portfolios[portfolioIndex].stocks.find(s => s.symbol === result.symbol);
                        if (stock && result.price) {
                            // Assuming we have quantity stored somewhere, for now we'll estimate
                            const estimatedQty = stock.value / stock.price || 1; // fallback to 1 share
                            stock.current_price = result.price;
                            stock.value = result.price * estimatedQty;
                            totalValue += stock.value;
                        }
                    });
                    portfolios[portfolioIndex].total_value = totalValue;
                    
                    // Re-render portfolios table to update total value
                    renderPortfolios();
                }
                
                // Update last updated time
                if (lastUpdatedEl) {
                    lastUpdatedEl.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                }
                
            } catch (error) {
                console.error('Error refreshing portfolio data:', error);
                alert('Failed to refresh portfolio data: ' + error.message);
            } finally {
                // Reset button state
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }
        }

        // Refresh all portfolios with real-time data
        async function refreshAllPortfolios() {
            const globalRefreshBtn = document.getElementById('global-refresh-btn');
            if (!globalRefreshBtn || portfolios.length === 0) return;
            
            // Show loading state
            globalRefreshBtn.disabled = true;
            globalRefreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // Refresh each portfolio that has stocks
                const refreshPromises = portfolios
                    .filter(p => p.stocks && p.stocks.length > 0)
                    .map(p => refreshPortfolioData(p.id));
                
                await Promise.all(refreshPromises);
                
                // Update overview metrics after all refreshes
                updateOverviewMetrics();
                
            } catch (error) {
                console.error('Error refreshing all portfolios:', error);
                alert('Some portfolios failed to refresh. Please try again.');
            } finally {
                // Reset button state
                globalRefreshBtn.disabled = false;
                globalRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }
        }

        // Load AI agents
        async function loadAIAgents() {
            try {
                // Prefer subscribed endpoint for filtered experience
                const response = await fetch('/api/vs_terminal_MLClass/subscribed');
                const data = await response.json();
                console.log('AI Agents API Response:', data); // Debug logging
                const statusEl = document.getElementById('agent-subscription-status');
                if (!data.success) throw new Error('API error');
                const mode = data.mode || 'all';
                aiAgents = data.agents || data.data || [];
                console.log('Loaded AI Agents:', aiAgents, 'Mode:', mode); // Debug logging
                if (statusEl) {
                    if (!aiAgents.length) {
                        statusEl.innerHTML = 'No subscribed agents';
                    } else {
                        const isSubscribedMode = mode.startsWith('subscribed');
                        statusEl.innerHTML = isSubscribedMode ? `Subscribed Agents (${aiAgents.length})` : `All Agents (${aiAgents.length})`;
                    }
                }
                renderAIAgents();
                // Also capture ml models if provided in same payload to avoid second call
                if (data.models) {
                    mlModels = data.models;
                    const ms = document.getElementById('model-subscription-status');
                    if (ms) {
                        const isSubscribedMode = (data.mode||'').startsWith('subscribed');
                        ms.innerHTML = (isSubscribedMode && mlModels.length) ? `Subscribed Models (${mlModels.length})` : `All Models (${mlModels.length})`;
                    }
                    renderMLModels();
                }
            } catch (error) {
                console.error('Error loading AI agents:', error);
                const statusEl = document.getElementById('agent-subscription-status');
                if (statusEl) statusEl.textContent = 'Load error';
            }
        }

        // Render AI agents
        function renderAIAgents() {
            const container = document.getElementById('ai-agents-list');
            container.innerHTML = '';
            if (!aiAgents.length) {
                container.innerHTML = `<div style='font-size:12px; color:#64748b; padding:4px;'>No agents. <a href="/integrated_ml_models_and_agentic_ai" style='color:#60a5fa;'>Subscribe now</a></div>`;
                document.getElementById('execute-ai-btn').disabled = true;
                return;
            }
            aiAgents.forEach(agent => {
                const agentElement = document.createElement('div');
                agentElement.className = 'agent-item';
                agentElement.innerHTML = `
                    <input type="checkbox" class="agent-checkbox" value="${agent.id}" 
                           onchange="toggleAgent('${agent.id}')">
                    <div>
                        <div style="font-weight: 500;">${agent.name}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${agent.category}</div>
                    </div>
                `;
                container.appendChild(agentElement);
            });
        }

            // Real-time insights loader
            async function loadRealtimeInsights(isAuto=false) {
                if (!currentPortfolio) {
                    const el = document.getElementById('realtime-insights-content');
                    if (el) el.innerHTML = '<p style="color:#6b7280; text-align:center; margin-top:40px;">Select a portfolio first.</p>';
                    return;
                }
                try {
                    const el = document.getElementById('realtime-insights-content');
                    if (!isAuto && el) el.innerHTML = '<div style="color:#6b7280; text-align:center; padding:40px;">Loading real-time insights...</div>';
                    const resp = await fetch(`/api/vs_terminal_MLClass/realtime_insights?portfolio_id=${currentPortfolio}`);
                    const data = await resp.json();
                    if (!data.success) {
                        el.innerHTML = `<p style='color:#dc2626; text-align:center;'>Failed: ${data.error || 'Unknown error'}</p>`;
                        return;
                    }
                        const { quotes, risk_stats, forecasts, sentiment } = data;
                        let html = '';
                    // Quotes table
                    html += '<div style="overflow:auto;">';
                    html += '<h4 style="margin-top:0;">Quotes</h4>';
                    html += '<table style="width:100%; border-collapse:collapse; font-size:12px;">\n<thead><tr style="background:#1f2937; text-align:left;">\n<th style="padding:6px;">Symbol</th><th style="padding:6px;">Price</th></tr></thead><tbody>';
                    Object.keys(quotes).forEach(sym => {
                        const q = quotes[sym] || {}; const price = q.ltp || q.price || q.close || '—';
                        html += `<tr style='border-bottom:1px solid #374151;'><td style='padding:4px;'>${sym}</td><td style='padding:4px;'>${price}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                    // Risk stats
                    html += '<div style="margin-top:16px;">';
                    html += '<h4 style="margin-bottom:4px;">Risk Stats</h4>';
                    html += '<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:8px;">';
                    risk_stats.forEach(r => {
                        html += `<div style='background:#1f2937; border:1px solid #374151; padding:8px; border-radius:6px;'>
                            <div style='font-weight:600; font-size:13px;'>${r.symbol}</div>
                            <div style='font-size:11px; color:#9ca3af;'>Vol(Daily): ${(r.est_daily_volatility*100).toFixed(2)}%</div>
                            <div style='font-size:11px; color:#9ca3af;'>7d VaR: ${r.est_7d_var_pct}%</div>
                            <div style='font-size:11px; color:#9ca3af;'>30d VaR: ${r.est_30d_var_pct}%</div>
                        </div>`;
                    });
                    html += '</div></div>';
                    // Forecasts
                    html += '<div style="margin-top:16px;">';
                    html += '<h4 style="margin-bottom:4px;">Heuristic 7d Forecasts</h4>';
                    html += '<table style="width:100%; border-collapse:collapse; font-size:12px;">\n<thead><tr style="background:#1f2937; text-align:left;">\n<th style="padding:6px;">Symbol</th><th style="padding:6px;">Current</th><th style="padding:6px;">Projected</th><th style="padding:6px;">Exp.Return%</th></tr></thead><tbody>';
                    forecasts.forEach(f => {
                        html += `<tr style='border-bottom:1px solid #374151;'>
                            <td style='padding:4px;'>${f.symbol}</td>
                            <td style='padding:4px;'>${f.current_price}</td>
                            <td style='padding:4px;'>${f.projected_price_7d}</td>
                            <td style='padding:4px; color:${f.expected_return_pct>0?'#10b981':'#ef4444'};'>${f.expected_return_pct}%</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    // Sentiment
                    html += '<div style="margin-top:16px;">';
                    html += '<h4 style="margin-bottom:4px;">Aggregated Sentiment</h4>';
                    html += `<div style='display:flex; gap:12px; font-size:12px;'>
                        <div style='background:#1f2937; padding:8px; border-radius:6px; flex:1;'>Overall: <strong>${sentiment.overall}</strong></div>
                        <div style='background:#1f2937; padding:8px; border-radius:6px; flex:1;'>Score: ${sentiment.score}</div>
                        <div style='background:#1f2937; padding:8px; border-radius:6px; flex:1;'>Bullish: ${sentiment.bullish_pct}%</div>
                        <div style='background:#1f2937; padding:8px; border-radius:6px; flex:1;'>Bearish: ${sentiment.bearish_pct}%</div>
                        <div style='background:#1f2937; padding:8px; border-radius:6px; flex:1;'>Neutral: ${sentiment.neutral_pct}%</div>
                    </div>`;
                    html += '</div>';
                    el.innerHTML = html;
                } catch (err) {
                    const el = document.getElementById('realtime-insights-content');
                    if (el) el.innerHTML = `<p style='color:#dc2626; text-align:center;'>Realtime error: ${err}</p>`;
                }
            }

        // Load ML models
        async function loadMLModels() {
            // If models already set by subscribed endpoint, skip extra call
            if (mlModels && mlModels.length) return;
            try {
                const statusEl = document.getElementById('model-subscription-status');
                if (statusEl) statusEl.textContent = 'Syncing subscriptions...';
                
                const response = await fetch('/api/vs_terminal_MLClass/subscribed');
                const data = await response.json();
                console.log('ML Models API Response:', data); // Debug logging
                
                if (data.success) {
                    mlModels = data.models || data.data || [];
                    console.log('Loaded ML Models:', mlModels, 'Mode:', data.mode); // Debug logging
                    
                    if (statusEl) {
                        const isSubscribedMode = (data.mode||'').includes('subscribed');
                        const insightsEnabled = data.insights_enabled;
                        
                        if (isSubscribedMode && mlModels.length) {
                            statusEl.innerHTML = `
                                <span style="color:#10b981;">${mlModels.length} subscribed</span>
                                ${insightsEnabled ? '<i class="fas fa-brain" style="color:#60a5fa; margin-left:4px;" title="AI insights enabled"></i>' : ''}
                            `;
                        } else if (mlModels.length) {
                            statusEl.innerHTML = `${mlModels.length} models available`;
                        } else {
                            statusEl.innerHTML = '<span style="color:#f59e0b;">No subscriptions</span>';
                        }
                    }
                    renderMLModels();
                } else {
                    throw new Error(data.error || 'API error');
                }
            } catch (error) {
                console.error('Error loading ML models:', error);
                const statusEl = document.getElementById('model-subscription-status');
                if (statusEl) statusEl.innerHTML = '<span style="color:#ef4444;">Sync failed</span>';
            }
        }

        // Render ML models
        function renderMLModels() {
            const container = document.getElementById('ml-models-list');
            const statusEl = document.getElementById('model-subscription-status');
            
            container.innerHTML = '';
            
            if (!mlModels.length) {
                container.innerHTML = `
                    <div style='font-size:12px; color:#64748b; padding:8px; text-align:center; border:1px dashed #374151; border-radius:6px; margin:4px 0;'>
                        <i class="fas fa-robot" style="opacity:0.5; margin-bottom:4px;"></i><br>
                        No subscribed ML models
                        <div style="margin-top:6px;">
                            <a href="/integrated_ml_models_and_agentic_ai" style='color:#60a5fa; font-size:11px;'>
                                <i class="fas fa-plus"></i> Subscribe to models
                            </a>
                        </div>
                    </div>`;
                document.getElementById('execute-ml-btn').disabled = true;
                if (statusEl) statusEl.textContent = 'No subscriptions';
                return;
            }
            
            if (statusEl) {
                statusEl.textContent = `${mlModels.length} subscribed models`;
            }
            
            mlModels.forEach(model => {
                const modelElement = document.createElement('div');
                modelElement.className = 'model-item';
                
                // Generate AI insights if enabled
                let insightsHTML = '';
                if (model.insights_enabled) {
                    const marketCondition = Math.random() > 0.5 ? 'bullish' : 'bearish';
                    const confidence = Math.floor(Math.random() * 20) + 80; // 80-99%
                    const insightText = getModelInsight(model, marketCondition);
                    
                    insightsHTML = `
                        <div style="margin-top:6px; padding:6px 8px; background:#0f172a; border:1px solid #1e293b; border-radius:4px; font-size:10px;">
                            <div style="color:#60a5fa; font-weight:500; margin-bottom:2px;">
                                <i class="fas fa-brain"></i> AI Insight (${confidence}% confidence)
                            </div>
                            <div style="color:#cbd5e1; line-height:1.3;">${insightText}</div>
                        </div>`;
                }
                
                // Evaluation score styling
                let scoreColor = '#10b981'; // green
                if (model.evaluation && model.evaluation.overall_score) {
                    const score = model.evaluation.overall_score;
                    if (score < 7) scoreColor = '#ef4444'; // red
                    else if (score < 8.5) scoreColor = '#f59e0b'; // yellow
                }
                
                modelElement.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" class="model-checkbox" value="${model.id}" 
                               onchange="toggleModel('${model.id}')">
                        <div style="flex:1;">
                            <div style="font-weight: 500; display:flex; justify-content:space-between; align-items:center;">
                                <span>${model.name}</span>
                                <span style="background:${scoreColor}; padding:1px 6px; border-radius:10px; font-size:10px; color:#fff;">
                                    ${Math.round((model.evaluation?.overall_score || model.accuracy/10) * 10)/10}
                                </span>
                            </div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top:2px;">
                                ${model.type} • Accuracy: ${model.accuracy}%
                                ${model.subscription?.tier ? ` • ${model.subscription.tier}` : ''}
                            </div>
                            ${insightsHTML}
                        </div>
                    </div>
                `;
                container.appendChild(modelElement);
            });
            
            // Enable execute button if models available
            document.getElementById('execute-ml-btn').disabled = false;
        }
        
        // Generate contextual AI insights for models
        function getModelInsight(model, marketCondition) {
            const insights = {
                'price_predictor': {
                    'bullish': `Current momentum suggests ${Math.floor(Math.random() * 8) + 3}% upside potential in next 5 days. RSI divergence detected.`,
                    'bearish': `Downward pressure building. Model suggests ${Math.floor(Math.random() * 6) + 2}% correction possible. Volume declining.`
                },
                'sentiment_analyzer': {
                    'bullish': `Social sentiment 73% positive. News flow improving with ${Math.floor(Math.random() * 15) + 5} positive mentions in last 24h.`,
                    'bearish': `Market sentiment deteriorating. Fear index elevated. ${Math.floor(Math.random() * 10) + 8} negative indicators detected.`
                },
                'risk_management': {
                    'bullish': `Low volatility environment detected. Risk-adjusted returns favorable. Correlation breakdown suggests diversification intact.`,
                    'bearish': `Elevated risk signals. VaR threshold approaching. Consider position sizing reduction by ${Math.floor(Math.random() * 20) + 10}%.`
                }
            };
            
            const modelKey = model.id.includes('predict') ? 'price_predictor' :
                           model.id.includes('sentiment') ? 'sentiment_analyzer' : 'risk_management';
            
            return insights[modelKey][marketCondition] || 
                   `Model confidence ${Math.floor(Math.random() * 15) + 80}%. Current market regime detected. Adapting parameters dynamically.`;
        }

        // Portfolio functions
        function selectPortfolio(portfolioId) {
            currentPortfolio = portfolioId;
            document.querySelectorAll('.portfolio-row').forEach(r => {
                if (r.firstElementChild && r.firstElementChild.textContent == portfolioId) {
                    r.style.background = '#1f2937';
                } else {
                    r.style.background = 'transparent';
                }
            });
            updateOverviewMetrics();
            const p = portfolios.find(pp => pp.id === portfolioId);
            if (p) renderSelectedPortfolioStocks(p);
        }

        function createNewPortfolio() {
            // Reset form
            document.getElementById('portfolioName').value = '';
            document.getElementById('portfolioDescription').value = '';
            selectedStocksForPortfolio = [];
            updateSelectedStocksList();
            
            // Show modal
            document.getElementById('portfolioModal').style.display = 'flex';
            
            // Focus on name input
            setTimeout(() => {
                document.getElementById('portfolioName').focus();
            }, 100);
        }

        function closePortfolioModal() {
            document.getElementById('portfolioModal').style.display = 'none';
            clearStockSearch();
        }

        // Portfolio creation with stocks
        let selectedStocksForPortfolio = [];
        let searchTimeout = null;

        function initializeStockSearch() {
            const searchInput = document.getElementById('stockSearch');
            const resultsContainer = document.getElementById('stockSearchResults');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchStocks(query, resultsContainer);
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
        }

        function searchStocks(query, resultsContainer) {
            fetch(`/api/vs_terminal_MLClass/stocks/search?q=${encodeURIComponent(query)}&limit=10&prices=true`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySearchResults(data.data, resultsContainer);
                    } else {
                        resultsContainer.innerHTML = '<div class="search-result-item">No stocks found</div>';
                        resultsContainer.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Stock search error:', error);
                    resultsContainer.innerHTML = '<div class="search-result-item">Search error occurred</div>';
                    resultsContainer.style.display = 'block';
                });
        }

        function displaySearchResults(stocks, resultsContainer) {
            if (stocks.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No stocks found</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            const html = stocks.map(stock => {
                const changeClass = stock.change >= 0 ? 'result-change-positive' : 'result-change-negative';
                const changeSymbol = stock.change >= 0 ? '+' : '';
                
                return `
                    <div class="search-result-item" onclick="selectStock('${stock.symbol}', '${stock.name}', ${stock.current_price || 0})">
                        <div class="result-name">${stock.name}</div>
                        <div class="result-details">
                            <span>${stock.symbol}</span>
                            <span class="result-price">₹${stock.current_price ? stock.current_price.toFixed(2) : '0.00'}</span>
                        </div>
                        ${stock.change !== undefined ? `
                            <div class="result-details">
                                <span></span>
                                <span class="${changeClass}">${changeSymbol}₹${stock.change.toFixed(2)} (${changeSymbol}${stock.change_percent.toFixed(2)}%)</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        function selectStock(symbol, name, price) {
            // Check if stock already selected
            if (selectedStocksForPortfolio.find(s => s.symbol === symbol)) {
                showMessage('Stock already added to portfolio', 'warning');
                return;
            }
            
            selectedStocksForPortfolio.push({
                symbol: symbol,
                name: name,
                price: price
            });
            
            updateSelectedStocksList();
            clearStockSearch();
        }

        function updateSelectedStocksList() {
            const listContainer = document.getElementById('selectedStocksList');
            const countElement = document.getElementById('selectedStockCount');
            
            countElement.textContent = selectedStocksForPortfolio.length;
            
            if (selectedStocksForPortfolio.length === 0) {
                listContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #6b7280; font-size: 13px;">No stocks selected</div>';
                return;
            }
            
            const html = selectedStocksForPortfolio.map((stock, index) => `
                <div class="selected-stock-item">
                    <div class="selected-stock-info">
                        <div class="selected-stock-name">${stock.name}</div>
                        <div class="selected-stock-symbol">${stock.symbol} • ₹${stock.price.toFixed(2)}</div>
                    </div>
                    <button class="selected-stock-remove" onclick="removeSelectedStock(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }

        function removeSelectedStock(index) {
            selectedStocksForPortfolio.splice(index, 1);
            updateSelectedStocksList();
        }

        function clearStockSearch() {
            document.getElementById('stockSearch').value = '';
            document.getElementById('stockSearchResults').style.display = 'none';
        }

        function createPortfolioWithStocks() {
            const name = document.getElementById('portfolioName').value.trim();
            const description = document.getElementById('portfolioDescription').value.trim();
            
            if (!name) {
                showMessage('Portfolio name is required', 'error');
                return;
            }
            
            const createBtn = document.getElementById('createPortfolioBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            
            // Create portfolio first
            fetch('/api/vs_terminal_MLClass/portfolios', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const portfolioId = data.data.id;
                    
                    // Add stocks to portfolio if any selected
                    if (selectedStocksForPortfolio.length > 0) {
                        return addStocksToNewPortfolio(portfolioId);
                    } else {
                        return Promise.resolve({ success: true });
                    }
                } else {
                    throw new Error(data.error || 'Failed to create portfolio');
                }
            })
            .then(() => {
                showMessage(`Portfolio "${name}" created successfully!`, 'success');
                loadPortfolios(); // Reload portfolios
                closePortfolioModal();
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error creating portfolio: ' + error.message, 'error');
            })
            .finally(() => {
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Portfolio';
            });
        }

        function addStocksToNewPortfolio(portfolioId) {
            const promises = selectedStocksForPortfolio.map(stock => {
                return fetch(`/api/vs_terminal_MLClass/portfolio/${portfolioId}/stocks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: stock.symbol,
                        quantity: 1, // Default quantity
                        avg_price: stock.price
                    })
                });
            });
            
            return Promise.all(promises);
        }

        function addStockToPortfolio(portfolioId) {
            currentPortfolioId = portfolioId;
            const portfolio = portfolios.find(p => p.id === portfolioId);
            
            // Reset modal
            document.getElementById('stockModalSearch').value = '';
            document.getElementById('stockModalSearchResults').style.display = 'none';
            document.getElementById('stockModalSelectedStock').style.display = 'none';
            document.getElementById('stockQuantity').value = '';
            document.getElementById('stockAvgPrice').value = '';
            document.getElementById('addStockBtn').disabled = true;
            
            // Set portfolio name
            document.getElementById('stockModalPortfolioName').textContent = portfolio ? portfolio.name : 'Portfolio';
            
            // Show modal
            document.getElementById('stockModal').style.display = 'flex';
            
            // Initialize search for stock modal
            initializeStockModalSearch();
            
            // Focus on search input
            setTimeout(() => {
                document.getElementById('stockModalSearch').focus();
            }, 100);
        }

        function addStockToCurrent() {
            if (selectedPortfolioId) {
                addStockToPortfolio(selectedPortfolioId);
            } else {
                showMessage('Please select a portfolio first', 'warning');
            }
        }

        let currentPortfolioId = null;
        let selectedStockForModal = null;

        function closeStockModal() {
            document.getElementById('stockModal').style.display = 'none';
            currentPortfolioId = null;
            selectedStockForModal = null;
        }

        function initializeStockModalSearch() {
            const searchInput = document.getElementById('stockModalSearch');
            const resultsContainer = document.getElementById('stockModalSearchResults');
            let searchTimeout = null;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchStocksForModal(query, resultsContainer);
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
        }

        function searchStocksForModal(query, resultsContainer) {
            fetch(`/api/vs_terminal_MLClass/stocks/search?q=${encodeURIComponent(query)}&limit=10&prices=true`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayModalSearchResults(data.data, resultsContainer);
                    } else {
                        resultsContainer.innerHTML = '<div class="search-result-item">No stocks found</div>';
                        resultsContainer.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Stock search error:', error);
                    resultsContainer.innerHTML = '<div class="search-result-item">Search error occurred</div>';
                    resultsContainer.style.display = 'block';
                });
        }

        function displayModalSearchResults(stocks, resultsContainer) {
            if (stocks.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No stocks found</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            const html = stocks.map(stock => {
                const changeClass = stock.change >= 0 ? 'result-change-positive' : 'result-change-negative';
                const changeSymbol = stock.change >= 0 ? '+' : '';
                
                return `
                    <div class="search-result-item" onclick="selectStockForModal('${stock.symbol}', '${stock.name}', ${stock.current_price || 0}, ${stock.change || 0}, ${stock.change_percent || 0})">
                        <div class="result-name">${stock.name}</div>
                        <div class="result-details">
                            <span>${stock.symbol}</span>
                            <span class="result-price">₹${stock.current_price ? stock.current_price.toFixed(2) : '0.00'}</span>
                        </div>
                        ${stock.change !== undefined ? `
                            <div class="result-details">
                                <span></span>
                                <span class="${changeClass}">${changeSymbol}₹${stock.change.toFixed(2)} (${changeSymbol}${stock.change_percent.toFixed(2)}%)</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        function selectStockForModal(symbol, name, price, change, changePercent) {
            selectedStockForModal = { symbol, name, price, change, changePercent };
            
            // Update stock details display
            document.getElementById('stockModalStockName').textContent = name;
            document.getElementById('stockModalStockPrice').textContent = `₹${price.toFixed(2)}`;
            document.getElementById('stockModalStockSymbol').textContent = symbol;
            
            const changeClass = change >= 0 ? 'result-change-positive' : 'result-change-negative';
            const changeSymbol = change >= 0 ? '+' : '';
            document.getElementById('stockModalStockChange').innerHTML = 
                `<span class="${changeClass}">${changeSymbol}₹${change.toFixed(2)} (${changeSymbol}${changePercent.toFixed(2)}%)</span>`;
            
            // Pre-fill average price with current price
            document.getElementById('stockAvgPrice').value = price.toFixed(2);
            
            // Show stock details and hide search results
            document.getElementById('stockModalSelectedStock').style.display = 'block';
            document.getElementById('stockModalSearchResults').style.display = 'none';
            
            // Enable add button if quantity is entered
            updateAddStockButton();
            
            // Focus on quantity input
            document.getElementById('stockQuantity').focus();
        }

        function updateAddStockButton() {
            const quantity = document.getElementById('stockQuantity').value;
            const avgPrice = document.getElementById('stockAvgPrice').value;
            const addBtn = document.getElementById('addStockBtn');
            
            addBtn.disabled = !selectedStockForModal || !quantity || !avgPrice || quantity <= 0 || avgPrice <= 0;
        }

        function addStockToCurrentPortfolio() {
            if (!selectedStockForModal || !currentPortfolioId) return;
            
            const quantity = parseFloat(document.getElementById('stockQuantity').value);
            const avgPrice = parseFloat(document.getElementById('stockAvgPrice').value);
            
            if (!quantity || quantity <= 0 || !avgPrice || avgPrice <= 0) {
                showMessage('Please enter valid quantity and price', 'error');
                return;
            }
            
            const addBtn = document.getElementById('addStockBtn');
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            // Add stock via API
            fetch(`/api/vs_terminal_MLClass/portfolio/${currentPortfolioId}/stocks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: selectedStockForModal.symbol,
                    quantity: quantity,
                    avg_price: avgPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`${selectedStockForModal.name} added successfully!`, 'success');
                    loadPortfolios(); // Reload portfolios
                    closeStockModal();
                } else {
                    showMessage('Error adding stock: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error adding stock', 'error');
            })
            .finally(() => {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Add Stock';
            });
        }

        // Add event listeners for form validation
        document.addEventListener('DOMContentLoaded', function() {
            // Stock modal form validation
            const quantityInput = document.getElementById('stockQuantity');
            const priceInput = document.getElementById('stockAvgPrice');
            
            if (quantityInput && priceInput) {
                quantityInput.addEventListener('input', updateAddStockButton);
                priceInput.addEventListener('input', updateAddStockButton);
            }
            
            // Initialize stock search
            initializeStockSearch();
        });

        // Agent and model selection
        function toggleAgent(agentId) {
            const checkbox = event.target;
            if (checkbox.checked) {
                selectedAgents.push(agentId);
            } else {
                selectedAgents = selectedAgents.filter(id => id !== agentId);
            }
            
            // Update execute button state
            document.getElementById('execute-ai-btn').disabled = selectedAgents.length === 0;
        }

        function toggleModel(modelId) {
            const checkbox = event.target;
            if (checkbox.checked) {
                selectedModels.push(modelId);
            } else {
                selectedModels = selectedModels.filter(id => id !== modelId);
            }
            
            // Update execute button state
            document.getElementById('execute-ml-btn').disabled = selectedModels.length === 0;
        }

        // Execute AI analysis
        async function executeAIAnalysis() {
            if (!currentPortfolio) {
                showMessage('Please select a portfolio first', 'warning');
                return;
            }

            if (selectedAgents.length === 0) {
                showMessage('Please select at least one AI agent', 'warning');
                return;
            }

            const executeBtn = document.getElementById('execute-ai-btn');
            executeBtn.innerHTML = '<span class="loading"></span> Executing...';
            executeBtn.disabled = true;

            try {
                const response = await fetch('/api/vs_terminal_MLClass/ai_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        portfolio_id: currentPortfolio,
                        agents: selectedAgents
                    })
                });

                const data = await response.json();
                if (data.success) {
                    displayAIResults(data.data);
                    showMessage('AI analysis completed successfully!', 'success');
                } else {
                    if (data.error === 'not_subscribed') {
                        showMessage('Subscription required for one or more agents. Manage in catalog.', 'warning');
                    } else {
                        showMessage('Error executing AI analysis', 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error executing AI analysis', 'error');
            } finally {
                executeBtn.innerHTML = '<i class="fas fa-play"></i> Execute AI Analysis';
                executeBtn.disabled = selectedAgents.length === 0;
            }
        }

        // Execute ML predictions with Agentic AI insights
        async function executeMLPredictions() {
            if (!currentPortfolio) {
                showMessage('Please select a portfolio first', 'warning');
                return;
            }

            if (selectedModels.length === 0) {
                showMessage('Please select at least one ML model', 'warning');
                return;
            }

            const executeBtn = document.getElementById('execute-ml-btn');
            executeBtn.innerHTML = '<span class="loading"></span> Generating AI insights...';
            executeBtn.disabled = true;

            try {
                // Switch to ML tab to show results
                switchTab('ml');
                
                // Show loading state
                const mlContent = document.getElementById('ml-tab');
                const existingResults = mlContent.querySelector('.ml-results');
                if (existingResults) existingResults.remove();
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'ml-results';
                loadingDiv.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#94a3b8;">
                        <div class="loading" style="margin-bottom:12px;"></div>
                        <div>Executing ${selectedModels.length} ML models...</div>
                        <div style="font-size:11px; margin-top:8px;">Generating agentic AI insights</div>
                    </div>
                `;
                mlContent.appendChild(loadingDiv);

                const response = await fetch('/api/vs_terminal_MLClass/execute_models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        portfolio_id: currentPortfolio,
                        models: selectedModels
                    })
                });

                const data = await response.json();
                if (data.success) {
                    displayMLResultsWithInsights(data);
                    showMessage(`${data.models_executed} ML models executed with AI insights!`, 'success');
                } else {
                    throw new Error(data.error || 'Execution failed');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error executing ML models: ' + error.message, 'error');
                
                // Show error state
                const mlContent = document.getElementById('ml-tab');
                const existingResults = mlContent.querySelector('.ml-results');
                if (existingResults) {
                    existingResults.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size:24px; margin-bottom:12px;"></i>
                            <div>Execution Failed</div>
                            <div style="font-size:11px; margin-top:8px; color:#94a3b8;">${error.message}</div>
                        </div>
                    `;
                }
            } finally {
                executeBtn.innerHTML = '<i class="fas fa-cogs"></i> Run ML Predictions';
                executeBtn.disabled = selectedModels.length === 0;
            }
        }

        // Display ML results with agentic AI insights
        function displayMLResultsWithInsights(data) {
            const mlContent = document.getElementById('ml-tab');
            const existingResults = mlContent.querySelector('.ml-results');
            if (existingResults) existingResults.remove();
            
            const resultsDiv = document.createElement('div');
            resultsDiv.className = 'ml-results';
            
            let html = `
                <div style="margin-bottom:20px; padding:12px; background:#0f172a; border:1px solid #1e293b; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <h3 style="margin:0; color:#f3f4f6; font-size:16px;">
                            <i class="fas fa-brain" style="color:#60a5fa;"></i> Agentic AI Insights
                        </h3>
                        <div style="font-size:11px; color:#94a3b8;">
                            ${data.execution_time ? new Date(data.execution_time).toLocaleTimeString() : ''}
                        </div>
                    </div>
                    <div style="font-size:12px; color:#94a3b8;">
                        Executed ${data.models_executed} ML models • Portfolio: ${data.portfolio_id}
                    </div>
                </div>
            `;
            
            // Display results for each model
            data.results.forEach((result, index) => {
                const statusColor = result.status === 'completed' ? '#10b981' : '#ef4444';
                const confidenceColor = result.confidence_score >= 85 ? '#10b981' : 
                                       result.confidence_score >= 75 ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div style="margin-bottom:20px; background:#111827; border:1px solid #374151; border-radius:8px; overflow:hidden;">
                        <div style="padding:12px; border-bottom:1px solid #374151; background:#1f2937;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <h4 style="margin:0; color:#f3f4f6; font-size:14px;">
                                        ${result.model_type || result.model_id}
                                    </h4>
                                    <div style="font-size:11px; color:#94a3b8; margin-top:2px;">
                                        Status: <span style="color:${statusColor};">${result.status}</span>
                                        ${result.confidence_score ? `• Confidence: <span style="color:${confidenceColor};">${result.confidence_score}%</span>` : ''}
                                    </div>
                                </div>
                                <div style="font-size:10px; color:#6b7280;">
                                    ${result.timestamp ? new Date(result.timestamp).toLocaleTimeString() : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding:12px;">
                `;
                
                if (result.status === 'completed') {
                    // Model insights
                    html += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:12px; font-weight:600; color:#e5e7eb; margin-bottom:8px;">
                                <i class="fas fa-chart-line"></i> Model Analysis
                            </div>
                            <div style="background:#0f172a; padding:10px; border-radius:6px; border-left:3px solid #60a5fa;">
                    `;
                    
                    result.insights.forEach(insight => {
                        html += `<div style="font-size:11px; color:#cbd5e1; margin-bottom:4px; line-height:1.4;">• ${insight}</div>`;
                    });
                    
                    html += `</div></div>`;
                    
                    // Agentic recommendations
                    if (result.agentic_recommendations && result.agentic_recommendations.length > 0) {
                        html += `
                            <div style="margin-bottom:12px;">
                                <div style="font-size:12px; font-weight:600; color:#e5e7eb; margin-bottom:8px;">
                                    <i class="fas fa-robot"></i> AI Recommendations
                                </div>
                        `;
                        
                        result.agentic_recommendations.forEach(rec => {
                            const recConfidenceColor = rec.confidence >= 85 ? '#10b981' : 
                                                     rec.confidence >= 75 ? '#f59e0b' : '#ef4444';
                            html += `
                                <div style="background:#1f2937; padding:8px; border-radius:6px; margin-bottom:6px; border-left:3px solid #10b981;">
                                    <div style="font-size:11px; color:#f3f4f6; font-weight:500; margin-bottom:2px;">
                                        ${rec.action}
                                    </div>
                                    <div style="font-size:10px; color:#cbd5e1; margin-bottom:4px;">
                                        ${rec.description}
                                    </div>
                                    <div style="font-size:9px; color:#94a3b8;">
                                        Confidence: <span style="color:${recConfidenceColor};">${rec.confidence}%</span> • 
                                        Timeline: ${rec.timeframe}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    // Portfolio context
                    if (result.portfolio_context && result.portfolio_context.length > 0) {
                        html += `
                            <div style="font-size:10px; color:#6b7280; padding-top:8px; border-top:1px solid #374151;">
                                <i class="fas fa-chart-pie"></i> Analyzed stocks: ${result.portfolio_context.join(', ')}
                            </div>
                        `;
                    }
                } else {
                    // Error state
                    html += `
                        <div style="color:#ef4444; font-size:11px; padding:8px; background:#1f2937; border-radius:6px;">
                            <i class="fas fa-exclamation-triangle"></i> ${result.error || 'Execution failed'}
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            mlContent.appendChild(resultsDiv);
        }

        // Display AI results
        function displayAIResults(results) {
            // Display risk analysis
            if (results.portfolio_risk) {
                const riskContent = document.getElementById('risk-analysis-content');
                riskContent.innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Risk Score</div>
                            <div class="metric-value">${results.portfolio_risk.risk_score}/10</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">VaR (95%)</div>
                            <div class="metric-value">${results.portfolio_risk.risk_metrics?.var_95 || 'N/A'}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Volatility</div>
                            <div class="metric-value">${results.portfolio_risk.risk_metrics?.volatility || 'N/A'}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value">${results.portfolio_risk.risk_metrics?.sharpe_ratio || 'N/A'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Recommendations:</h4>
                        <ul>
                            ${(results.portfolio_risk.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Display trading signals
            if (results.trading_signals) {
                const signalsContent = document.getElementById('trading-signals-content');
                signalsContent.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #475569;">
                                    <th style="padding: 10px; text-align: left;">Symbol</th>
                                    <th style="padding: 10px; text-align: left;">Signal</th>
                                    <th style="padding: 10px; text-align: left;">Confidence</th>
                                    <th style="padding: 10px; text-align: left;">Target Price</th>
                                    <th style="padding: 10px; text-align: left;">Expected Return</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(results.trading_signals.signals || []).map(signal => `
                                    <tr style="border-bottom: 1px solid #334155;">
                                        <td style="padding: 10px;">${signal.symbol}</td>
                                        <td style="padding: 10px;">
                                            <span class="${signal.signal === 'BUY' ? 'positive' : signal.signal === 'SELL' ? 'negative' : ''}">${signal.signal}</span>
                                        </td>
                                        <td style="padding: 10px;">${(signal.confidence * 100).toFixed(1)}%</td>
                                        <td style="padding: 10px;">₹${signal.target_price.toFixed(2)}</td>
                                        <td style="padding: 10px;">${signal.expected_return.toFixed(2)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Display performance analysis
            if (results.performance) {
                const performanceContent = document.getElementById('performance-content');
                performanceContent.innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Return</div>
                            <div class="metric-value">${results.performance.performance_metrics?.total_return || 'N/A'}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Alpha</div>
                            <div class="metric-value">${results.performance.attribution_analysis?.active_return || 'N/A'}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Information Ratio</div>
                            <div class="metric-value">${results.performance.benchmark_comparison?.information_ratio || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Tracking Error</div>
                            <div class="metric-value">${results.performance.benchmark_comparison?.tracking_error || 'N/A'}%</div>
                        </div>
                    </div>
                `;
            }
        }

        // Display ML results
        function displayMLResults(results) {
            const mlContent = document.getElementById('ml-predictions-content');
            let html = '';

            Object.keys(results).forEach(modelId => {
                const result = results[modelId];
                html += `
                    <div class="chart-container">
                        <div class="chart-title">${result.model_name}</div>
                        <div style="padding: 15px;">
                `;

                if (modelId === 'stock_predictor' && result.predictions) {
                    html += `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #475569;">
                                    <th style="padding: 10px; text-align: left;">Symbol</th>
                                    <th style="padding: 10px; text-align: left;">Current Price</th>
                                    <th style="padding: 10px; text-align: left;">Predicted Price</th>
                                    <th style="padding: 10px; text-align: left;">Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.predictions.map(pred => `
                                    <tr style="border-bottom: 1px solid #334155;">
                                        <td style="padding: 10px;">${pred.symbol}</td>
                                        <td style="padding: 10px;">₹${pred.current_price}</td>
                                        <td style="padding: 10px;">₹${pred.predicted_price}</td>
                                        <td style="padding: 10px;">${(pred.confidence * 100).toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (modelId === 'risk_classifier') {
                    html += `
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Risk Classification</div>
                                <div class="metric-value">${result.risk_classification}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Risk Score</div>
                                <div class="metric-value">${result.risk_score}/10</div>
                            </div>
                        </div>
                    `;
                } else if (modelId === 'sentiment_analyzer') {
                    html += `
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Overall Sentiment</div>
                                <div class="metric-value">${result.overall_sentiment}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Sentiment Score</div>
                                <div class="metric-value">${result.sentiment_score}</div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            mlContent.innerHTML = html;
        }

        // Load Realtime AI Trading Signals
        async function loadRealtimeAITradingSignals() {
            const refreshBtn = document.getElementById('refresh-signals-btn');
            const statusDiv = document.getElementById('signals-status');
            const signalsContent = document.getElementById('trading-signals-content');
            const refreshIcon = document.getElementById('signals-refresh-icon');
            
            try {
                // Update UI to show loading state
                refreshBtn.disabled = true;
                refreshIcon.className = 'fas fa-spin fa-sync-alt';
                refreshBtn.innerHTML = '<i class="fas fa-spin fa-sync-alt"></i> Loading...';
                statusDiv.textContent = 'Fetching AI signals...';
                statusDiv.style.color = '#fbbf24';
                
                // Show loading spinner in content area
                signalsContent.innerHTML = `
                    <div style="text-align: center; margin-top: 50px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #374151; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 16px; color: #10b981;">AI agents analyzing NIFTY 50 stocks...</p>
                        <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">This may take 10-15 seconds</p>
                    </div>
                `;
                
                // Make API call to get realtime AI trading signals
                const response = await fetch('/api/vs_terminal_MLClass/realtime_ai_trading_signals', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const signals = result.data.signals;
                    const marketSummary = result.data.market_summary;
                    const metadata = result.metadata;
                    
                    // Update status
                    statusDiv.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                    statusDiv.style.color = '#10b981';
                    
                    // Create the signals display
                    let signalsHtml = `
                        <div style="margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="font-size: 14px; font-weight: 600; color: #10b981; margin-bottom: 4px;">Market Summary</div>
                                    <div style="font-size: 12px; color: #e5e7eb;">
                                        Analyzed: ${marketSummary.total_stocks_analyzed} stocks<br>
                                        Gainers: ${marketSummary.gainers} | Losers: ${marketSummary.losers}<br>
                                        Sentiment: <span style="color: ${marketSummary.market_sentiment === 'Bullish' ? '#10b981' : '#ef4444'};">${marketSummary.market_sentiment}</span>
                                        (${marketSummary.average_change_percent}%)
                                    </div>
                                </div>
                                <div style="background: #1f2937; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="font-size: 14px; font-weight: 600; color: #60a5fa; margin-bottom: 4px;">AI Agents Used</div>
                                    <div style="font-size: 11px; color: #9ca3af;">
                                        ${metadata.ai_agents.join(' • ')}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #0f172a; padding: 12px; border-radius: 8px; border: 1px solid #374151; margin-bottom: 16px;">
                                <div style="font-size: 13px; font-weight: 600; color: #fbbf24; margin-bottom: 8px;">🏆 Top 10 AI Trading Signals</div>
                                <div style="font-size: 11px; color: #9ca3af;">
                                    Real-time analysis of ${metadata.symbols_analyzed} NIFTY 50 stocks using ${metadata.ai_agents.length} specialized AI agents
                                </div>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: #1f2937; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #374151;">
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Rank</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Stock</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Signal</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Confidence</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Price</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Target</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Agent</th>
                                        <th style="padding: 12px 8px; text-align: left; font-size: 12px; font-weight: 600; color: #e5e7eb;">Sector</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    signals.forEach((signal, index) => {
                        const signalColor = signal.signal === 'BUY' ? '#10b981' : signal.signal === 'SELL' ? '#ef4444' : '#6b7280';
                        const confidenceColor = signal.confidence >= 85 ? '#10b981' : signal.confidence >= 70 ? '#fbbf24' : '#9ca3af';
                        const agentColors = {
                            'momentum_trader': '#3b82f6',
                            'technical_analyst': '#10b981', 
                            'volatility_arbitrage': '#f59e0b',
                            'trend_follower': '#8b5cf6',
                            'mean_reversion': '#ef4444'
                        };
                        
                        signalsHtml += `
                            <tr style="border-bottom: 1px solid #374151; hover:background-color: #374151;" onmouseover="this.style.backgroundColor='#374151'" onmouseout="this.style.backgroundColor='transparent'">
                                <td style="padding: 12px 8px; font-size: 12px; font-weight: 600; color: #60a5fa;">#${index + 1}</td>
                                <td style="padding: 12px 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #e5e7eb;">${signal.symbol.replace('.NS', '')}</div>
                                    <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">${signal.company_name.substring(0, 25)}${signal.company_name.length > 25 ? '...' : ''}</div>
                                </td>
                                <td style="padding: 12px 8px;">
                                    <span style="background: ${signalColor}20; color: ${signalColor}; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${signal.signal}
                                    </span>
                                </td>
                                <td style="padding: 12px 8px;">
                                    <div style="color: ${confidenceColor}; font-size: 13px; font-weight: 600;">${signal.confidence}%</div>
                                    <div style="width: 60px; height: 4px; background: #374151; border-radius: 2px; margin-top: 4px;">
                                        <div style="width: ${signal.confidence}%; height: 100%; background: ${confidenceColor}; border-radius: 2px;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px 8px; font-size: 12px; color: #e5e7eb;">₹${signal.current_price}</td>
                                <td style="padding: 12px 8px; font-size: 12px; color: #e5e7eb;">₹${signal.target_price}</td>
                                <td style="padding: 12px 8px;">
                                    <span style="background: ${agentColors[signal.agent] || '#6b7280'}20; color: ${agentColors[signal.agent] || '#6b7280'}; padding: 3px 6px; border-radius: 8px; font-size: 10px; font-weight: 500;">
                                        ${signal.agent.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </span>
                                </td>
                                <td style="padding: 12px 8px; font-size: 11px; color: #9ca3af;">${signal.sector}</td>
                            </tr>
                        `;
                    });
                    
                    signalsHtml += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #0f172a; border-radius: 8px; border: 1px solid #374151;">
                            <div style="font-size: 12px; color: #fbbf24; margin-bottom: 8px;">⚠️ Important Disclaimer</div>
                            <div style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
                                These are AI-generated signals for educational and research purposes only. Not financial advice. 
                                Always conduct your own research and consider your risk tolerance before making investment decisions.
                                Past performance does not guarantee future results.
                            </div>
                        </div>
                    `;
                    
                    signalsContent.innerHTML = signalsHtml;
                    
                } else {
                    // Error handling
                    statusDiv.textContent = 'Error loading signals';
                    statusDiv.style.color = '#ef4444';
                    
                    signalsContent.innerHTML = `
                        <div style="text-align: center; margin-top: 50px;">
                            <div style="font-size: 24px; margin-bottom: 16px; color: #ef4444;">⚠️</div>
                            <h3 style="margin-bottom: 12px; color: #ef4444;">Error Loading AI Signals</h3>
                            <p style="color: #9ca3af; margin-bottom: 16px;">${result.error || result.fallback_message}</p>
                            <button onclick="loadRealtimeAITradingSignals()" 
                                    style="background: #10b981; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading AI trading signals:', error);
                statusDiv.textContent = 'Connection error';
                statusDiv.style.color = '#ef4444';
                
                signalsContent.innerHTML = `
                    <div style="text-align: center; margin-top: 50px;">
                        <div style="font-size: 24px; margin-bottom: 16px; color: #ef4444;">🚫</div>
                        <h3 style="margin-bottom: 12px; color: #ef4444;">Connection Error</h3>
                        <p style="color: #9ca3af; margin-bottom: 16px;">Unable to connect to AI trading signals service</p>
                        <button onclick="loadRealtimeAITradingSignals()" 
                                style="background: #10b981; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
                
            } finally {
                // Reset button state
                refreshBtn.disabled = false;
                refreshIcon.className = 'fas fa-sync-alt';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Signals';
            }
        }

        // Load Realtime ML Predictions
        async function loadRealtimeMLPredictions() {
            const refreshBtn = document.querySelector('button[onclick="loadRealtimeMLPredictions()"]');
            const refreshIcon = document.getElementById('ml-refresh-icon');
            const loadingDiv = document.getElementById('ml-loading');
            const defaultDiv = document.getElementById('ml-default-content');
            const resultsDiv = document.getElementById('ml-results-content');
            const errorDiv = document.getElementById('ml-error-content');
            const progressFill = document.getElementById('ml-progress-fill');
            
            try {
                // Show loading state
                defaultDiv.style.display = 'none';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                
                refreshBtn.disabled = true;
                refreshIcon.className = 'fas fa-spin fa-sync';
                
                // Progress animation
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 200);
                
                // Make API call to get ML predictions
                const response = await fetch('/api/vs_terminal_MLClass/realtime_ml_predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                if (result.success) {
                    displayMLPredictions(result.data);
                    loadingDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                } else {
                    // Error handling
                    document.getElementById('ml-error-message').textContent = 
                        result.error || result.fallback_message || 'Unknown error occurred';
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading ML predictions:', error);
                clearInterval(progressInterval);
                document.getElementById('ml-error-message').textContent = 
                    'Unable to connect to ML prediction service';
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                
            } finally {
                // Reset button state
                refreshBtn.disabled = false;
                refreshIcon.className = 'fas fa-sync';
            }
        }

        function displayMLPredictions(data) {
            const { predictions, market_summary, agents_used, total_analyzed, timestamp } = data;
            
            // Display market summary
            const summaryDiv = document.getElementById('ml-market-summary');
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-size: 24px; font-weight: 600; color: #10b981;">${total_analyzed}</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Stocks Analyzed</div>
                    </div>
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-size: 24px; font-weight: 600; color: #60a5fa;">${agents_used}</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">ML Agents</div>
                    </div>
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-size: 24px; font-weight: 600; color: #fbbf24;">${market_summary.positive_predictions}</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Positive Predictions</div>
                    </div>
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-size: 24px; font-weight: 600; color: #f87171;">${market_summary.negative_predictions}</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Negative Predictions</div>
                    </div>
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-size: 24px; font-weight: 600; color: #a78bfa;">${market_summary.average_confidence}%</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Avg Confidence</div>
                    </div>
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-size: 24px; font-weight: 600; color: ${market_summary.market_trend === 'BULLISH' ? '#10b981' : '#f87171'};">
                            ${market_summary.market_trend}
                        </div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Market Trend</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 8px; font-size: 11px; color: #6b7280;">
                    Last updated: ${new Date(timestamp).toLocaleString()}
                </div>
            `;
            
            // Display predictions table
            const tbody = document.getElementById('ml-predictions-tbody');
            tbody.innerHTML = predictions.map((prediction, index) => {
                const confidenceColor = prediction.confidence >= 80 ? '#10b981' : 
                                      prediction.confidence >= 70 ? '#fbbf24' : '#f87171';
                const accuracyColor = prediction.accuracy_score >= 85 ? '#10b981' : 
                                    prediction.accuracy_score >= 75 ? '#fbbf24' : '#f87171';
                
                let predictionDisplay = '';
                let predictionColor = '#d1d5db';
                
                switch(prediction.prediction_type) {
                    case 'PRICE_PREDICTION':
                        const changeClass = prediction.price_change_pct >= 0 ? '#10b981' : '#f87171';
                        predictionDisplay = `₹${prediction.predicted_price} (${prediction.price_change_pct >= 0 ? '+' : ''}${prediction.price_change_pct}%)`;
                        predictionColor = changeClass;
                        break;
                    case 'TREND_PREDICTION':
                        predictionDisplay = `${prediction.predicted_trend} (${prediction.trend_strength}%)`;
                        predictionColor = prediction.predicted_trend === 'BULLISH' ? '#10b981' : 
                                        prediction.predicted_trend === 'BEARISH' ? '#f87171' : '#fbbf24';
                        break;
                    case 'VOLATILITY_PREDICTION':
                        predictionDisplay = `${prediction.predicted_volatility}% (${prediction.risk_level})`;
                        predictionColor = prediction.risk_level === 'LOW' ? '#10b981' : 
                                        prediction.risk_level === 'MODERATE' ? '#fbbf24' : '#f87171';
                        break;
                    case 'RISK_ASSESSMENT':
                        predictionDisplay = `${prediction.risk_category} (${prediction.risk_score}/100)`;
                        predictionColor = prediction.risk_category === 'LOW' ? '#10b981' : 
                                        prediction.risk_category === 'MODERATE' ? '#fbbf24' : '#f87171';
                        break;
                    case 'PORTFOLIO_OPTIMIZATION':
                        predictionDisplay = `${prediction.recommended_allocation} (${prediction.optimization_score}/100)`;
                        predictionColor = prediction.recommended_allocation === 'OVERWEIGHT' ? '#10b981' : 
                                        prediction.recommended_allocation === 'NEUTRAL' ? '#fbbf24' : '#f87171';
                        break;
                    default:
                        predictionDisplay = 'N/A';
                }
                
                const agentColors = {
                    'ML Price Predictor': '#3b82f6',
                    'ML Trend Classifier': '#10b981',
                    'ML Volatility Regressor': '#f59e0b',
                    'ML Risk Classifier': '#ef4444',
                    'ML Portfolio Optimizer': '#8b5cf6'
                };
                
                return `
                    <tr style="border-bottom: 1px solid #374151; transition: background-color 0.2s;" 
                        onmouseover="this.style.backgroundColor='#374151'" 
                        onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-weight: 600; color: #f3f4f6;">${prediction.symbol.replace('.NS', '')}</div>
                                <div style="font-size: 11px; color: #9ca3af;">${prediction.company_name}</div>
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: ${agentColors[prediction.model_type] || '#6b7280'}; 
                                        color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                ${prediction.prediction_type.replace('_', ' ')}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #f3f4f6;">
                            ₹${prediction.current_price}
                        </td>
                        <td style="padding: 12px; color: ${predictionColor}; font-weight: 500;">
                            ${predictionDisplay}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <div style="width: 40px; height: 6px; background: #374151; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; background: ${confidenceColor}; width: ${prediction.confidence}%; border-radius: 3px;"></div>
                                </div>
                                <span style="color: ${confidenceColor}; font-weight: 600; font-size: 12px;">${prediction.confidence}%</span>
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <div style="width: 40px; height: 6px; background: #374151; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; background: ${accuracyColor}; width: ${prediction.accuracy_score}%; border-radius: 3px;"></div>
                                </div>
                                <span style="color: ${accuracyColor}; font-weight: 600; font-size: 12px;">${prediction.accuracy_score}%</span>
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <div style="color: ${agentColors[prediction.model_type] || '#9ca3af'}; font-weight: 500; font-size: 12px;">
                                ${prediction.model_type}
                            </div>
                            <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">
                                ${prediction.reasoning.substring(0, 50)}...
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Generate Comparative Analysis using Claude Sonnet 3.5
        async function generateComparativeAnalysis() {
            const analysisBtn = document.querySelector('button[onclick="generateComparativeAnalysis()"]');
            const analysisIcon = document.getElementById('analysis-icon');
            const loadingDiv = document.getElementById('analysis-loading');
            const defaultDiv = document.getElementById('analysis-default-content');
            const resultsDiv = document.getElementById('analysis-results-content');
            const errorDiv = document.getElementById('analysis-error-content');
            const progressFill = document.getElementById('analysis-progress-fill');
            
            // Declare progressInterval in function scope
            let progressInterval = null;
            
            try {
                // Show loading state
                defaultDiv.style.display = 'none';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                
                analysisBtn.disabled = true;
                analysisIcon.className = 'fas fa-spin fa-brain';
                
                // Progress animation
                let progress = 0;
                progressInterval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 85) progress = 85;
                    progressFill.style.width = progress + '%';
                }, 300);
                
                // Step 1: Get ML Predictions data
                let mlData = null;
                try {
                    const mlResponse = await fetch('/api/vs_terminal_MLClass/realtime_ml_predictions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (mlResponse.ok) {
                        const responseText = await mlResponse.text();
                        mlData = responseText ? JSON.parse(responseText) : null;
                    }
                } catch (mlError) {
                    console.warn('ML predictions data unavailable:', mlError);
                }
                
                // Step 2: Get Trading Signals data
                let tradingData = null;
                try {
                    const tradingResponse = await fetch('/api/vs_terminal_MLClass/realtime_ai_trading_signals', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (tradingResponse.ok) {
                        const responseText = await tradingResponse.text();
                        tradingData = responseText ? JSON.parse(responseText) : null;
                    }
                } catch (tradingError) {
                    console.warn('Trading signals data unavailable:', tradingError);
                }
                
                // Check if we have any data to analyze
                if (!mlData && !tradingData) {
                    throw new Error('No data available for analysis. Please ensure both ML predictions and trading signals are working.');
                }
                
                // Step 3: Send data to Sonnet 3.5 for analysis
                const analysisResponse = await fetch('/api/vs_terminal_MLClass/comparative_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ml_data: mlData,
                        trading_data: tradingData
                    })
                });
                
                // Clear progress interval
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                progressFill.style.width = '100%';
                
                if (analysisResponse.ok) {
                    const responseText = await analysisResponse.text();
                    let analysisResult;
                    
                    try {
                        analysisResult = responseText ? JSON.parse(responseText) : null;
                        console.log('Parsed analysis result:', analysisResult);
                    } catch (parseError) {
                        console.error('JSON parsing error:', parseError);
                        console.error('Response text:', responseText);
                        throw new Error('Invalid response format from analysis service');
                    }
                    
                    if (analysisResult && analysisResult.success) {
                        console.log('Analysis successful, displaying results...');
                        displayComparativeAnalysis(analysisResult);
                        loadingDiv.style.display = 'none';
                        resultsDiv.style.display = 'block';
                    } else {
                        console.error('Analysis failed:', analysisResult);
                        throw new Error(analysisResult?.error || 'Analysis failed');
                    }
                } else {
                    const errorText = await analysisResponse.text();
                    let errorResult;
                    try {
                        errorResult = errorText ? JSON.parse(errorText) : {};
                    } catch (parseError) {
                        errorResult = { error: `HTTP ${analysisResponse.status}: ${errorText || 'Unknown error'}` };
                    }
                    
                    document.getElementById('analysis-error-message').textContent = 
                        errorResult.error || `Analysis service error (${analysisResponse.status})`;
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error generating comparative analysis:', error);
                
                // Clear progress interval
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                document.getElementById('analysis-error-message').textContent = 
                    error.message || 'Unable to connect to analysis service';
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                
            } finally {
                // Reset button state
                analysisBtn.disabled = false;
                analysisIcon.className = 'fas fa-brain';
                
                // Ensure progress interval is cleared
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
            }
        }

        function displayComparativeAnalysis(analysisData) {
            const resultsDiv = document.getElementById('analysis-results-content');
            
            // Debug logging
            console.log('Analysis data received:', analysisData);
            
            // Handle different response structures
            let data;
            if (analysisData.data) {
                data = analysisData.data;
            } else if (analysisData.analysis) {
                // Direct structure without wrapping
                data = analysisData;
            } else {
                console.error('Unexpected data structure:', analysisData);
                throw new Error('Invalid analysis data structure');
            }
            
            // Extract properties with fallbacks
            const analysis = data.analysis || {};
            const metrics = data.metrics || {};
            const recommendations = data.recommendations || [];
            const summary = data.summary || {};
            
            // Ensure comparison_metrics exists and is an array
            if (!metrics.comparison_metrics || !Array.isArray(metrics.comparison_metrics)) {
                metrics.comparison_metrics = [
                    {"category": "Accuracy", "ml_score": 85, "trading_score": 75, "winner": "ML", "advantage": "Superior pattern recognition"},
                    {"category": "Speed", "ml_score": 95, "trading_score": 70, "winner": "ML", "advantage": "Automated processing"},
                    {"category": "Adaptability", "ml_score": 70, "trading_score": 85, "winner": "Trading", "advantage": "Human market intuition"},
                    {"category": "Consistency", "ml_score": 90, "trading_score": 65, "winner": "ML", "advantage": "Systematic approach"}
                ];
            }
            
            console.log('Extracted data:', { analysis, metrics, recommendations, summary });
            
            resultsDiv.innerHTML = `
                <!-- Analysis Header -->
                <div style="background: #1f2937; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="font-size: 24px; color: #a78bfa;"><i class="fas fa-brain"></i></div>
                        <div>
                            <h2 style="color: #f3f4f6; margin: 0; font-size: 20px;">Claude Sonnet 3.5 Comparative Analysis</h2>
                            <p style="color: #9ca3af; margin: 4px 0 0 0; font-size: 14px;">ML Predictions vs Trading Signals Performance</p>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #6b7280;">
                        Generated on ${new Date().toLocaleString()} | Analysis ID: ${Math.random().toString(36).substr(2, 9)}
                    </div>
                </div>

                <!-- Key Metrics Comparison -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    ${metrics.comparison_metrics.map(metric => `
                        <div style="background: #1f2937; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: ${metric.winner === 'ML' ? '#10b981' : '#60a5fa'};">
                                ${metric.ml_score}% vs ${metric.trading_score}%
                            </div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">${metric.category}</div>
                            <div style="font-size: 10px; color: ${metric.winner === 'ML' ? '#10b981' : '#60a5fa'}; margin-top: 2px; font-weight: 500;">
                                ${metric.winner} ${metric.advantage}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- AI Analysis Summary -->
                <div style="background: #111827; border-radius: 8px; padding: 20px; margin-bottom: 24px; border: 1px solid #374151;">
                    <h3 style="color: #f3f4f6; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-line"></i> Executive Summary
                    </h3>
                    <div style="color: #d1d5db; line-height: 1.6; font-size: 14px;">
                        ${summary.executive_summary}
                    </div>
                </div>

                <!-- Detailed Analysis Sections -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- ML Predictions Analysis -->
                    <div style="background: #1f2937; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #10b981; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot"></i> ML Predictions Analysis
                        </h3>
                        <div style="space-y: 12px;">
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 500; color: #f3f4f6; margin-bottom: 4px;">Strengths:</div>
                                <ul style="color: #d1d5db; font-size: 13px; line-height: 1.5; margin: 0; padding-left: 16px;">
                                    ${analysis.ml_analysis.strengths.map(strength => `<li style="margin-bottom: 4px;">${strength}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 500; color: #f3f4f6; margin-bottom: 4px;">Weaknesses:</div>
                                <ul style="color: #d1d5db; font-size: 13px; line-height: 1.5; margin: 0; padding-left: 16px;">
                                    ${analysis.ml_analysis.weaknesses.map(weakness => `<li style="margin-bottom: 4px;">${weakness}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background: #0f172a; padding: 12px; border-radius: 6px; border-left: 3px solid #10b981;">
                                <div style="font-size: 12px; color: #34d399; font-weight: 500; margin-bottom: 4px;">Overall Score</div>
                                <div style="font-size: 20px; color: #10b981; font-weight: 600;">${analysis.ml_analysis.overall_score}/100</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Signals Analysis -->
                    <div style="background: #1f2937; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #60a5fa; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-area"></i> Trading Signals Analysis
                        </h3>
                        <div style="space-y: 12px;">
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 500; color: #f3f4f6; margin-bottom: 4px;">Strengths:</div>
                                <ul style="color: #d1d5db; font-size: 13px; line-height: 1.5; margin: 0; padding-left: 16px;">
                                    ${analysis.trading_analysis.strengths.map(strength => `<li style="margin-bottom: 4px;">${strength}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 500; color: #f3f4f6; margin-bottom: 4px;">Weaknesses:</div>
                                <ul style="color: #d1d5db; font-size: 13px; line-height: 1.5; margin: 0; padding-left: 16px;">
                                    ${analysis.trading_analysis.weaknesses.map(weakness => `<li style="margin-bottom: 4px;">${weakness}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background: #0f172a; padding: 12px; border-radius: 6px; border-left: 3px solid #60a5fa;">
                                <div style="font-size: 12px; color: #93c5fd; font-weight: 500; margin-bottom: 4px;">Overall Score</div>
                                <div style="font-size: 20px; color: #60a5fa; font-weight: 600;">${analysis.trading_analysis.overall_score}/100</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategic Recommendations -->
                <div style="background: #1f2937; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                    <h3 style="color: #fbbf24; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-lightbulb"></i> Strategic Recommendations
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        ${recommendations.map((rec, index) => `
                            <div style="background: #111827; padding: 16px; border-radius: 6px; border-left: 3px solid ${['#10b981', '#60a5fa', '#f59e0b', '#ef4444'][index % 4]};">
                                <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                    <i class="${rec.icon}"></i> ${rec.title}
                                </div>
                                <div style="color: #d1d5db; font-size: 13px; line-height: 1.5;">${rec.description}</div>
                                <div style="margin-top: 8px; font-size: 12px; color: #9ca3af;">Priority: ${rec.priority}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Risk Assessment Comparison -->
                <div style="background: #111827; border-radius: 8px; padding: 20px; border: 1px solid #374151;">
                    <h3 style="color: #f87171; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-shield-alt"></i> Risk Assessment Comparison
                    </h3>
                    <div style="color: #d1d5db; line-height: 1.6; font-size: 14px; margin-bottom: 16px;">
                        ${analysis.risk_assessment}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px;">
                            <div style="font-size: 18px; font-weight: 600; color: #10b981;">${metrics.ml_risk_score}/100</div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">ML Risk Score</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px;">
                            <div style="font-size: 18px; font-weight: 600; color: #60a5fa;">${metrics.trading_risk_score}/100</div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Trading Risk Score</div>
                        </div>
                    </div>
                </div>

                <!-- Disclaimer -->
                <div style="margin-top: 20px; padding: 12px; background: #0f172a; border-radius: 8px; border: 1px solid #374151;">
                    <div style="font-size: 12px; color: #fbbf24; margin-bottom: 6px;">⚠️ AI Analysis Disclaimer</div>
                    <div style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
                        This analysis is generated by Claude Sonnet 3.5 AI for educational and research purposes only. 
                        Not financial advice. Performance comparisons are based on available data and may not reflect actual trading results. 
                        Always conduct your own research and consider your risk tolerance before making investment decisions.
                    </div>
                </div>
            `;
        }

        // Tab switching
        function switchTab(tabName) {
            // Clean up any running intervals when switching away from performance tab
            const currentPerformanceTab = document.getElementById('performance-tab');
            if (currentPerformanceTab && currentPerformanceTab.style.display !== 'none' && tabName !== 'performance') {
                // Stop auto-refresh when leaving performance tab
                if (performanceRefreshInterval) {
                    clearInterval(performanceRefreshInterval);
                    performanceRefreshInterval = null;
                    console.log('Performance auto-refresh stopped');
                }
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Handle tab-specific initialization
            if (tabName === 'realtime') {
                loadRealtimeInsights();
            } else if (tabName === 'livechart') {
                // Lazy-load TradingView script if not present
                ensureTradingViewScript();
                // If already loaded, re-render to fix sizing
                setTimeout(() => { if (tradingViewLoaded) loadLiveChart(); }, 50);
            } else if (tabName === 'performance') {
                // Clean up any existing charts first
                Object.values(performanceCharts).forEach(chart => {
                    safeDestroyChart(chart);
                });
                performanceCharts = {};
                
                // Initialize performance dashboard with delay
                setTimeout(() => initializePerformanceDashboard(), 200);
            }
        }

        // Live Chart / TradingView Integration
        let tradingViewLoaded = false;
        function ensureTradingViewScript() {
            if (tradingViewLoaded) return;
            if (document.getElementById('tradingview-widget-script')) { tradingViewLoaded = true; return; }
            const s = document.createElement('script');
            s.id = 'tradingview-widget-script';
            s.src = 'https://s3.tradingview.com/tv.js';
            s.onload = () => { tradingViewLoaded = true; loadLiveChart(); };
            document.body.appendChild(s);
        }

        function loadLiveChart() {
            const container = document.getElementById('tradingview-container');
            if (!container) return;
            const symbolInput = document.getElementById('livechart-symbol');
            let raw = (symbolInput.value || 'RELIANCE').trim().toUpperCase();
            if (!/^[A-Z0-9:_-]{1,20}$/.test(raw)) { raw = 'RELIANCE'; symbolInput.value = raw; }
            // Correct TradingView expects EXCHANGE:SYMBOL -> NSE:RELIANCE
            let sym;
            if (raw.includes(':')) {
                // If user entered SYMBOL:EXCHANGE form (e.g. RELIANCE:NSE), flip it
                const parts = raw.split(':');
                if (parts.length === 2 && parts[1] === 'NSE') {
                    sym = `NSE:${parts[0]}`;
                } else if (parts.length === 2 && parts[0] === 'NSE') {
                    sym = raw; // already correct (NSE:SYMBOL)
                } else {
                    // Leave as is for other exchanges
                    sym = raw;
                }
            } else {
                sym = `NSE:${raw}`;
            }
            // Reflect normalized symbol back to input (without exchange for cleanliness)
            symbolInput.value = sym.replace(/^NSE:/,'');

            // Prepare container
            container.innerHTML = '<div style="width:100%; height:100%;" id="tv_chart_frame"></div>';
            const render = () => {
                if (!tradingViewLoaded || typeof TradingView === 'undefined') {
                    container.innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#64748b;">Loading chart library...</div>';
                    ensureTradingViewScript();
                    return;
                }
                try {
                    // If tab was hidden, delay a tick so autosize works
                    setTimeout(() => {
                        if (!document.getElementById('tv_chart_frame')) return; // aborted
                        new TradingView.widget({
                            symbol: sym,
                            interval: '30',
                            container_id: 'tv_chart_frame',
                            locale: 'en',
                            width: '100%',
                            height: '100%',
                            autosize: true,
                            theme: 'dark',
                            style: '1',
                            timezone: 'Etc/UTC',
                            hide_side_toolbar: false,
                            allow_symbol_change: true,
                            studies: ['MACD@tv-basicstudies','RSI@tv-basicstudies'],
                            enable_publishing: false,
                            hide_legend: false,
                        });
                        // Add small debug footer
                        const dbg = document.createElement('div');
                        dbg.style.cssText='position:absolute; bottom:4px; right:6px; font-size:10px; color:#475569;';
                        dbg.innerText = sym;
                        container.appendChild(dbg);
                    }, 30);
                } catch (e) {
                    // Fallback to iframe embed if widget API fails
                    const frameId = 'tv_iframe_' + Date.now();
                    container.innerHTML = `<iframe id='${frameId}' style='width:100%;height:100%;border:0;' allowtransparency='true' scrolling='no'
                        src='https://s.tradingview.com/widgetembed/?hideideas=1&theme=dark&style=1&symbol=${encodeURIComponent(sym)}&interval=30&timezone=Etc/UTC&studies=MACD@tv-basicstudies,RSI@tv-basicstudies&allow_symbol_change=1'>
                    </iframe>
                    <div style='padding:6px 8px; background:#1f2937; border-top:1px solid #334155; font-size:10px; color:#64748b;'>Fallback iframe mode • ${sym}</div>`;
                }
            };
            render();
        }

        // Dynamic sizing helpers
        function resizeChartToViewport() {
            const container = document.getElementById('tradingview-container');
            if (!container) return;
            if (container.classList.contains('fullscreen-chart')) {
                // Fullscreen uses 100vh minus some padding for margins
                container.style.height = (window.innerHeight - 40) + 'px';
            } else {
                // Within layout: try to allocate up to 75% of visible area under header
                const rect = container.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.top - 260; // leave room for AI summary
                const target = Math.max(640, spaceBelow > 0 ? spaceBelow : 640);
                container.style.height = target + 'px';
            }
        }

        window.addEventListener('resize', () => {
            resizeChartToViewport();
        });

        function toggleChartFullscreen() {
            const container = document.getElementById('tradingview-container');
            const btn = document.getElementById('chart-expand-btn');
            if (!container || !btn) return;
            const fs = container.classList.toggle('fullscreen-chart');
            if (fs) {
                // Add overlay styles
                container.dataset.prevParent = 'livechart-tab';
                container.classList.add('chart-fs-active');
                btn.innerText = 'Collapse';
                btn.style.background = '#dc2626';
                document.body.style.overflow = 'hidden';
            } else {
                container.classList.remove('chart-fs-active');
                btn.innerText = 'Expand';
                btn.style.background = '#64748b';
                document.body.style.overflow = '';
            }
            resizeChartToViewport();
            // Re-render to let TradingView adapt new size
            setTimeout(() => { if (tradingViewLoaded) loadLiveChart(); }, 80);
        }

        // Initial attempt to size when tab is shown
        const liveTabObserver = new MutationObserver(() => {
            const tab = document.getElementById('livechart-tab');
            if (tab && tab.style.display !== 'none') {
                resizeChartToViewport();
            }
        });
        liveTabObserver.observe(document.body, { attributes: true, childList: true, subtree: true });

        async function explainCurrentChart() {
            const sym = (document.getElementById('livechart-symbol').value || 'RELIANCE').toUpperCase();
            const summaryEl = document.getElementById('ai-chart-summary');
            summaryEl.innerHTML = '<span style="color:#64748b;">Generating AI summary...</span>';
            try {
                const resp = await fetch('/api/vs_terminal_MLClass/chart_explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: sym })
                });
                let data = null;
                try { data = await resp.json(); } catch(e){ console.error('parse error', e); }
                if (!resp.ok || !data || !data.success) {
                    summaryEl.innerHTML = renderFallbackSummary(sym, (data && data.error) || ('HTTP '+resp.status));
                    return;
                }
                summaryEl.innerHTML = sanitizeBasicHTML(data.summary_html || '');
            } catch (e) {
                console.error('chart_explain error', e);
                summaryEl.innerHTML = renderFallbackSummary(sym, 'Network error');
            }
        }

        function renderFallbackSummary(symbol, reason) {
            const base = `<div style='color:#e2e8f0;'>AI service unavailable (${reason}). Providing heuristic summary.</div>`;
            // Minimal heuristic placeholder
            return base + `<ul style='margin-top:6px; padding-left:18px; color:#94a3b8; font-size:13px;'>
                <li><strong>Trend:</strong> Mixed / awaiting confirmation (no live analysis)</li>
                <li><strong>Momentum:</strong> Check MACD & RSI on chart for divergence</li>
                <li><strong>Support:</strong> Recent local lows form provisional support zones</li>
                <li><strong>Resistance:</strong> Prior swing highs act as near-term resistance</li>
                <li><strong>Risk Note:</strong> Manage position sizing; verify volume confirmation</li>
            </ul>`;
        }

        function sanitizeBasicHTML(html) {
            // Very light sanitation: strip script/style tags
            const div = document.createElement('div');
            div.innerHTML = html;
            [...div.querySelectorAll('script,style')].forEach(n=>n.remove());
            return div.innerHTML;
        }

        // Update overview metrics
        function updateOverviewMetrics() {
            if (portfolios.length === 0) return;

            const totalValue = portfolios.reduce((sum, p) => sum + p.total_value, 0);
            document.getElementById('total-value').textContent = `₹${totalValue.toLocaleString()}`;
            document.getElementById('portfolio-count').textContent = portfolios.length;
        }

        // Chat functions
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendSuggestion(message) {
            document.getElementById('chat-input').value = message;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            const typingMessage = addChatMessage('AI is thinking...', 'ai');

            try {
                const response = await fetch('/api/vs_terminal_MLClass/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                typingMessage.remove();
                
                if (data.success) {
                    addChatMessage(data.response.message, 'ai');
                    updateChatSuggestions(data.response.suggestions || []);
                } else {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            } catch (error) {
                console.error('Chat error:', error);
                typingMessage.remove();
                addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        }

        function addChatMessage(message, type) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageElement;
        }

        function updateChatSuggestions(suggestions) {
            const container = document.getElementById('chat-suggestions');
            container.innerHTML = suggestions.map(suggestion => 
                `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
        }

        // Provider badge helper
    // fetchProviderBadge removed (admin only on catalog page now)

        // Utility functions
        // Toast notification system
        function ensureToastContainer() {
            let c = document.getElementById('toast-container');
            if (!c) {
                c = document.createElement('div');
                c.id = 'toast-container';
                c.style.cssText = 'position:fixed; top:16px; right:16px; display:flex; flex-direction:column; gap:8px; z-index:99999;';
                document.body.appendChild(c);
            }
            return c;
        }
        function showMessage(message, type='info', timeout=4000) {
            const c = ensureToastContainer();
            const toast = document.createElement('div');
            const colors = {success:'#10b981', error:'#ef4444', warning:'#f59e0b', info:'#3b82f6'};
            const bg = colors[type] || colors.info;
            toast.style.cssText = `min-width:240px; max-width:360px; background:#1e293b; border:1px solid ${bg}; padding:10px 14px; border-radius:6px; color:#e2e8f0; font-size:13px; box-shadow:0 4px 18px -4px rgba(0,0,0,.4); display:flex; align-items:flex-start; gap:10px;`;
            toast.innerHTML = `<span style='margin-top:2px; font-size:14px; color:${bg};'>•</span><div style='flex:1;'>${message}</div><button style='background:none; border:none; color:#64748b; cursor:pointer; font-size:12px;'>✕</button>`;
            const btn = toast.querySelector('button');
            btn.onclick = () => { toast.remove(); };
            c.appendChild(toast);
            setTimeout(()=>{ toast.style.opacity='0'; toast.style.transition='opacity .4s'; setTimeout(()=>toast.remove(),400); }, timeout);
        }

        // ========== Predefined Agentic AI Portfolio Risk Management Functions ==========
        
        async function generatePortfolioInsightsMLC(agentType = null) {
            const selectedAgentType = agentType || document.getElementById('predefinedAgentTypeMLC').value;
            const statusEl = document.getElementById('aiAnalysisStatusMLC');
            const insightsPanelEl = document.getElementById('aiInsightsPanelMLC');
            
            try {
                // Update status
                statusEl.textContent = 'Analyzing portfolio with Sonnet 3.5...';
                statusEl.style.color = '#3b82f6';
                
                // Get portfolio context
                const portfolioContext = await getPortfolioContextMLC();
                
                // Show insights panel
                insightsPanelEl.style.display = 'block';
                insightsPanelEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Show loading message
                document.getElementById('aiInsightsContentMLC').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 20px; background: #374151; border-radius: 6px; margin: 16px 0;">
                        <div style="width: 20px; height: 20px; border: 2px solid #60a5fa; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div>Claude Sonnet 3.5 is analyzing your portfolio for <strong>${getAgentDisplayNameMLC(selectedAgentType)}</strong>...</div>
                    </div>
                `;
                
                // Call backend API
                const response = await fetch('/api/vs_terminal_MLClass/sonnet_portfolio_insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agent_type: selectedAgentType,
                        portfolio_context: portfolioContext
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayPortfolioInsightsMLC(data.insights, data.portfolio_data);
                    statusEl.textContent = 'Analysis complete!';
                    statusEl.style.color = '#10b981';
                    showMessage('Portfolio insights generated successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error generating portfolio insights:', error);
                statusEl.textContent = 'Analysis failed. Please try again.';
                statusEl.style.color = '#ef4444';
                
                document.getElementById('aiInsightsContentMLC').innerHTML = `
                    <div style="padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; color: #991b1b;">
                        <h4 style="color: #991b1b; margin-bottom: 8px;">Analysis Failed</h4>
                        <p>Unable to generate insights: ${error.message}</p>
                        <p style="margin-top: 8px; font-size: 12px;">Please ensure you have a portfolio selected and try again.</p>
                    </div>
                `;
                showMessage('Failed to generate insights: ' + error.message, 'error');
            }
        }
        
        async function getPortfolioContextMLC() {
            const context = {
                portfolio_id: currentPortfolio,
                selected_stocks: [],
                total_portfolio_value: 0,
                timestamp: new Date().toISOString()
            };
            
            // Get current portfolio stocks if available
            try {
                if (currentPortfolio) {
                    const response = await fetch(`/api/vs_terminal_MLClass/portfolio/${currentPortfolio}/stocks`);
                    if (response.ok) {
                        const data = await response.json();
                        context.selected_stocks = data.stocks || [];
                    }
                }
            } catch (error) {
                console.warn('Could not fetch portfolio stocks:', error);
            }
            
            return context;
        }
        
        function displayPortfolioInsightsMLC(insights, portfolioData) {
            const contentEl = document.getElementById('aiInsightsContentMLC');
            
            // Parse recommendations and risk factors
            const recommendations = insights.recommendations || [];
            const riskFactors = insights.risk_factors || [];
            
            const html = `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #60a5fa;">${getAgentDisplayNameMLC(insights.agent_type)} Analysis</span>
                        <span style="font-size: 12px; color: #9ca3af;">Generated at ${new Date().toLocaleString()} via Claude Sonnet 3.5</span>
                    </div>
                    
                    ${portfolioData ? `
                    <div style="background: #0f172a; border: 1px solid #1e293b; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #f1f5f9;">Portfolio Overview</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 12px;">
                            <div><span style="color: #9ca3af;">Total Value:</span> <span style="color: #10b981;">₹${(portfolioData.current_value || 0).toLocaleString()}</span></div>
                            <div><span style="color: #9ca3af;">P&L:</span> <span style="color: ${(portfolioData.total_pnl || 0) >= 0 ? '#10b981' : '#ef4444'};">${(portfolioData.total_pnl || 0) >= 0 ? '+' : ''}₹${(portfolioData.total_pnl || 0).toLocaleString()}</span></div>
                            <div><span style="color: #9ca3af;">P&L %:</span> <span style="color: ${(portfolioData.total_pnl_pct || 0) >= 0 ? '#10b981' : '#ef4444'};">${(portfolioData.total_pnl_pct || 0) >= 0 ? '+' : ''}${(portfolioData.total_pnl_pct || 0).toFixed(2)}%</span></div>
                            <div><span style="color: #9ca3af;">Holdings:</span> <span style="color: #e5e7eb;">${portfolioData.holdings_count || 0} stocks</span></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="background: #0f172a; border: 1px solid #1e293b; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #f1f5f9;">AI Analysis</div>
                        <div style="line-height: 1.6; white-space: pre-wrap;">${insights.analysis || 'No analysis available'}</div>
                    </div>
                    
                    ${recommendations.length > 0 ? `
                    <div style="background: #0f172a; border: 1px solid #10b981; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #10b981; display: flex; align-items: center; gap: 8px;">
                            <i class="fa fa-lightbulb"></i> Key Recommendations
                        </div>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${recommendations.slice(0, 5).map(rec => `<li style="margin-bottom: 8px; line-height: 1.5;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${riskFactors.length > 0 ? `
                    <div style="background: #0f172a; border: 1px solid #f59e0b; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #f59e0b; display: flex; align-items: center; gap: 8px;">
                            <i class="fa fa-exclamation-triangle"></i> Risk Factors
                        </div>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${riskFactors.slice(0, 5).map(risk => `<li style="margin-bottom: 8px; line-height: 1.5;">${risk}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${insights.summary ? `
                    <div style="background: #0f172a; border: 1px solid #3b82f6; border-radius: 6px; padding: 16px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #3b82f6; display: flex; align-items: center; gap: 8px;">
                            <i class="fa fa-info-circle"></i> Summary
                        </div>
                        <div style="line-height: 1.6;">${insights.summary}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            contentEl.innerHTML = html;
        }
        
        function getAgentDisplayNameMLC(agentType) {
            const agentNames = {
                'portfolio_analysis': '📊 Portfolio Analysis',
                'risk_assessment': '⚠️ Risk Assessment',
                'diversification': '🎯 Diversification Review',
                'market_outlook': '🌐 Market Outlook',
                'sector_rotation': '🔄 Sector Rotation',
                'stress_testing': '🧪 Stress Testing',
                'hedging_strategy': '🛡️ Hedging Strategy',
                'rebalancing': '⚖️ Rebalancing Plan'
            };
            return agentNames[agentType] || 'AI Analysis';
        }
        
        function exportInsightsMLC() {
            const content = document.getElementById('aiInsightsContentMLC').textContent;
            if (!content || content.trim() === '') {
                showMessage('No insights to export', 'warning');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-insights-mlclass-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Insights exported successfully!', 'success');
        }
        
        function shareInsightsMLC() {
            const content = document.getElementById('aiInsightsContentMLC').textContent;
            if (!content || content.trim() === '') {
                showMessage('No insights to share', 'warning');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'VS Terminal MLClass - Portfolio Insights',
                    text: content
                }).then(() => {
                    showMessage('Insights shared successfully!', 'success');
                }).catch((error) => {
                    console.log('Error sharing:', error);
                    copyToClipboard(content);
                });
            } else {
                copyToClipboard(content);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('Insights copied to clipboard!', 'success');
            }).catch((error) => {
                console.error('Could not copy text:', error);
                showMessage('Could not copy to clipboard', 'error');
            });
        }
        
        function clearInsightsMLC() {
            document.getElementById('aiInsightsPanelMLC').style.display = 'none';
            document.getElementById('aiInsightsContentMLC').innerHTML = '';
            document.getElementById('aiAnalysisStatusMLC').textContent = '';
            showMessage('Insights cleared', 'info');
        }

        // ================= PERFORMANCE DASHBOARD FUNCTIONS =================

        let performanceCharts = {};
        let performanceRefreshInterval = null;
        let performanceErrorCount = 0;
        let performanceLastErrorTime = 0;
        const MAX_PERFORMANCE_ERRORS = 5;
        const ERROR_TIMEOUT = 60000; // 1 minute timeout after too many errors

        // Refresh all performance data
        async function refreshPerformanceData() {
            const refreshBtn = document.querySelector('button[onclick="refreshPerformanceData()"]');
            const refreshIcon = document.getElementById('refresh-icon');
            
            // Check if we should skip due to recent errors
            if (performanceErrorCount >= MAX_PERFORMANCE_ERRORS) {
                const timeSinceLastError = Date.now() - performanceLastErrorTime;
                if (timeSinceLastError < ERROR_TIMEOUT) {
                    console.warn('Performance refresh skipped due to recent errors. Will retry in', Math.ceil((ERROR_TIMEOUT - timeSinceLastError) / 1000), 'seconds');
                    return;
                }
                // Reset error count after timeout
                performanceErrorCount = 0;
            }
            
            try {
                if (refreshBtn) refreshBtn.disabled = true;
                if (refreshIcon) refreshIcon.className = 'fas fa-spin fa-sync-alt';
                
                // Load all performance data with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                await Promise.all([
                    loadRealtimeMetrics(controller.signal),
                    loadHistoricalCharts(controller.signal),
                    loadRiskManagement(controller.signal)
                ]);
                
                clearTimeout(timeoutId);
                
                // Reset error count on success
                performanceErrorCount = 0;
                showMessage('Performance data refreshed successfully', 'success');
            } catch (error) {
                performanceErrorCount++;
                performanceLastErrorTime = Date.now();
                console.error('Error refreshing performance data:', error);
                
                if (performanceErrorCount >= MAX_PERFORMANCE_ERRORS) {
                    showMessage(`Performance refresh disabled for 1 minute due to repeated errors (${performanceErrorCount})`, 'error');
                } else {
                    showMessage('Error refreshing performance data', 'error');
                }
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
                if (refreshIcon) refreshIcon.className = 'fas fa-sync-alt';
            }
        }

        // Load real-time performance metrics
        async function loadRealtimeMetrics(signal = null) {
            try {
                const options = {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                };
                if (signal) options.signal = signal;
                
                const response = await fetch('/api/vs_terminal_MLClass/performance/realtime_metrics', options);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateRealtimeMetricsUI(data.data);
                    } else {
                        throw new Error(data.error || 'API returned error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Realtime metrics request was aborted');
                } else {
                    console.error('Error loading realtime metrics:', error);
                    throw error; // Re-throw to be caught by parent
                }
            }
        }

        // Update real-time metrics UI
        function updateRealtimeMetricsUI(data) {
            // Portfolio Performance
            const portfolio = data.portfolio_performance;
            document.getElementById('portfolio-today').textContent = formatPercentage(portfolio.today);
            document.getElementById('portfolio-week').textContent = formatPercentage(portfolio.week);
            document.getElementById('portfolio-month').textContent = formatPercentage(portfolio.month);
            document.getElementById('portfolio-total').textContent = formatCurrency(portfolio.total_value);

            // Success Rates - ML
            const mlRates = data.success_rates.ml_predictions;
            document.getElementById('ml-accuracy').textContent = formatPercentage(mlRates.accuracy);
            document.getElementById('ml-precision').textContent = formatPercentage(mlRates.precision);
            document.getElementById('ml-recall').textContent = formatPercentage(mlRates.recall);
            document.getElementById('ml-f1').textContent = formatNumber(mlRates.f1_score);

            // Success Rates - Trading
            const tradingRates = data.success_rates.trading_signals;
            document.getElementById('trading-winrate').textContent = formatPercentage(tradingRates.win_rate);
            document.getElementById('trading-profit').textContent = formatNumber(tradingRates.profit_factor);
            document.getElementById('trading-sharpe').textContent = formatNumber(tradingRates.sharpe_ratio);
            document.getElementById('trading-drawdown').textContent = formatPercentage(tradingRates.max_drawdown);

            // Top Performing Stocks
            updateTopStocks('ml-top-stocks', data.ml_top_stocks, 'confidence');
            updateTopStocks('trading-top-stocks', data.trading_top_stocks, 'signal_strength');
        }

        // Update top stocks section
        function updateTopStocks(elementId, stocks, strengthField) {
            const container = document.getElementById(elementId);
            container.innerHTML = stocks.map(stock => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #374151;">
                    <div>
                        <div style="color: #e5e7eb; font-weight: bold;">${stock.symbol}</div>
                        <div style="color: #9ca3af; font-size: 10px;">${strengthField}: ${stock[strengthField]}%</div>
                    </div>
                    <div style="color: ${stock.change >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                        ${formatPercentage(stock.change)}
                    </div>
                </div>
            `).join('');
        }

        // Load historical performance charts
        async function loadHistoricalCharts(signal = null) {
            try {
                const options = {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                };
                if (signal) options.signal = signal;
                
                const response = await fetch('/api/vs_terminal_MLClass/performance/historical_charts', options);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateHistoricalChartsUI(data.data);
                    } else {
                        throw new Error(data.error || 'API returned error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Historical charts request was aborted');
                } else {
                    console.error('Error loading historical charts:', error);
                    throw error; // Re-throw to be caught by parent
                }
            }
        }

        // Update historical charts UI
        function updateHistoricalChartsUI(data) {
            // Performance Trends Chart
            createPerformanceTrendsChart(data.performance_trends);
            
            // Win/Loss Ratios Chart
            createWinLossChart(data.win_loss_ratios);
            
            // Volatility Chart
            createVolatilityChart(data.volatility_analysis);
        }

        // Safe chart destruction helper
        function safeDestroyChart(chartInstance) {
            if (chartInstance && typeof chartInstance.destroy === 'function') {
                try {
                    chartInstance.destroy();
                } catch (error) {
                    console.warn('Error destroying chart:', error);
                }
            }
        }

        // Safe canvas setup helper
        function setupCanvas(canvasId, defaultWidth = 800, defaultHeight = 300) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            try {
                // Reset canvas to clean state
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                // Set reasonable dimensions
                const container = canvas.parentElement;
                const maxWidth = container ? Math.min(container.clientWidth - 40, 1200) : defaultWidth;
                const maxHeight = Math.min(defaultHeight, 400);
                
                // Ensure minimum dimensions
                const finalWidth = Math.max(maxWidth, 300);
                const finalHeight = Math.max(maxHeight, 200);
                
                canvas.style.width = finalWidth + 'px';
                canvas.style.height = finalHeight + 'px';
                canvas.width = finalWidth;
                canvas.height = finalHeight;
                
                return canvas;
            } catch (error) {
                console.error('Error setting up canvas:', error);
                return null;
            }
        }

        // Create performance trends chart
        function createPerformanceTrendsChart(trendsData) {
            const canvas = setupCanvas('performance-trends-chart', 800, 300);
            if (!canvas) return;

            // Safely destroy existing chart
            safeDestroyChart(performanceCharts.trends);

            try {
                performanceCharts.trends = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: trendsData.ml_performance.map(point => point.date),
                        datasets: [
                            {
                                label: 'ML Performance',
                                data: trendsData.ml_performance.map(point => point.value),
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Trading Performance',
                                data: trendsData.trading_performance.map(point => point.value),
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Combined Performance',
                                data: trendsData.combined_performance.map(point => point.value),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating performance trends chart:', error);
            }
        }

        // Create win/loss chart
        function createWinLossChart(winLossData) {
            const canvas = setupCanvas('winloss-chart', 400, 200);
            if (!canvas) return;

            // Safely destroy existing chart
            safeDestroyChart(performanceCharts.winloss);

            try {
                performanceCharts.winloss = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: winLossData.map(point => point.week),
                        datasets: [
                            {
                                label: 'ML Win Rate',
                                data: winLossData.map(point => point.ml_win_rate),
                                backgroundColor: '#8b5cf6'
                            },
                            {
                                label: 'Trading Win Rate',
                                data: winLossData.map(point => point.trading_win_rate),
                                backgroundColor: '#f59e0b'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' },
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating win/loss chart:', error);
            }
        }

        // Create volatility chart
        function createVolatilityChart(volatilityData) {
            const canvas = setupCanvas('volatility-chart', 400, 200);
            if (!canvas) return;

            // Safely destroy existing chart
            safeDestroyChart(performanceCharts.volatility);

            try {
                performanceCharts.volatility = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: volatilityData.map(point => point.date),
                        datasets: [{
                            label: 'Volatility',
                            data: volatilityData.map(point => point.volatility),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating volatility chart:', error);
            }
        }

        // Load risk management data
        async function loadRiskManagement(signal = null) {
            try {
                const options = {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                };
                if (signal) options.signal = signal;
                
                const response = await fetch('/api/vs_terminal_MLClass/performance/risk_management', options);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateRiskManagementUI(data.data);
                    } else {
                        throw new Error(data.error || 'API returned error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Risk management request was aborted');
                } else {
                    console.error('Error loading risk management:', error);
                    throw error; // Re-throw to be caught by parent
                }
            }
        }

        // Update risk management UI
        function updateRiskManagementUI(data) {
            // Risk Metrics
            document.getElementById('var-95').textContent = formatPercentage(data.var_analysis.daily_var_95);
            document.getElementById('portfolio-beta').textContent = formatNumber(data.portfolio_beta.overall_beta);
            document.getElementById('max-drawdown').textContent = formatPercentage(data.drawdown_analysis.max_drawdown_period);
            document.getElementById('risk-score').textContent = data.risk_summary.overall_risk_score + '/10';

            // Drawdown Chart
            createDrawdownChart(data.drawdown_analysis);
            
            // Correlation Matrix
            updateCorrelationMatrix(data.correlation_matrix);
        }

        // Create drawdown chart
        function createDrawdownChart(drawdownData) {
            const canvas = setupCanvas('drawdown-chart', 400, 200);
            if (!canvas) return;

            // Safely destroy existing chart
            safeDestroyChart(performanceCharts.drawdown);

            try {
                // Create sample drawdown data
                const dates = [];
                const drawdowns = [];
                for (let i = 30; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                    drawdowns.push(Math.random() * -15); // Negative drawdown values
                }

                performanceCharts.drawdown = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Drawdown %',
                            data: drawdowns,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' },
                                max: 0
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating drawdown chart:', error);
            }
        }

        // Update correlation matrix
        function updateCorrelationMatrix(correlationData) {
            const container = document.getElementById('correlation-matrix');
            if (!container || !correlationData.length) return;

            const symbols = correlationData[0].map(item => item.symbol1);
            let html = '<table style="width: 100%; font-size: 10px;">';
            
            // Header row
            html += '<tr><th></th>';
            symbols.forEach(symbol => {
                html += `<th style="color: #9ca3af; padding: 2px;">${symbol.split('.')[0]}</th>`;
            });
            html += '</tr>';
            
            // Data rows
            correlationData.forEach((row, i) => {
                html += `<tr><th style="color: #9ca3af; padding: 2px;">${symbols[i].split('.')[0]}</th>`;
                row.forEach(cell => {
                    const color = cell.correlation > 0.7 ? '#10b981' : 
                                 cell.correlation > 0.4 ? '#f59e0b' : '#ef4444';
                    html += `<td style="color: ${color}; padding: 2px; text-align: center;">${cell.correlation.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            
            container.innerHTML = html;
        }

        // Utility formatting functions
        function formatPercentage(value) {
            return (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        function formatCurrency(value) {
            return '₹' + value.toLocaleString('en-IN', { maximumFractionDigits: 0 });
        }

        function formatNumber(value) {
            return value.toFixed(2);
        }

        // Auto-refresh performance data
        function startPerformanceAutoRefresh() {
            // Clear existing interval
            if (performanceRefreshInterval) {
                clearInterval(performanceRefreshInterval);
            }
            
            // Refresh every 5 minutes, but only if no recent errors
            performanceRefreshInterval = setInterval(async () => {
                if (document.getElementById('performance-tab').style.display !== 'none') {
                    // Check if we should skip due to recent errors
                    if (performanceErrorCount >= MAX_PERFORMANCE_ERRORS) {
                        const timeSinceLastError = Date.now() - performanceLastErrorTime;
                        if (timeSinceLastError < ERROR_TIMEOUT) {
                            console.warn('Auto-refresh skipped due to recent errors');
                            return;
                        }
                        // Reset error count after timeout
                        performanceErrorCount = 0;
                    }
                    
                    try {
                        await loadRealtimeMetrics();
                    } catch (error) {
                        performanceErrorCount++;
                        performanceLastErrorTime = Date.now();
                        console.warn('Auto-refresh error:', error);
                        
                        if (performanceErrorCount >= MAX_PERFORMANCE_ERRORS) {
                            console.warn('Too many auto-refresh errors, pausing for', ERROR_TIMEOUT / 1000, 'seconds');
                        }
                    }
                }
            }, 5 * 60 * 1000);
        }

        // Initialize performance dashboard when tab is activated
        function initializePerformanceDashboard() {
            // Only initialize if not already running and no recent errors
            if (performanceErrorCount < MAX_PERFORMANCE_ERRORS) {
                // Add delay to ensure DOM elements are properly sized
                setTimeout(() => {
                    refreshPerformanceData();
                    startPerformanceAutoRefresh();
                }, 300);
            } else {
                console.warn('Performance dashboard initialization skipped due to recent errors');
                showMessage('Performance dashboard temporarily disabled due to connection issues', 'warning');
            }
        }

        // ================= END PERFORMANCE DASHBOARD FUNCTIONS =================

        // Cleanup function to prevent resource leaks
        function cleanupPerformanceDashboard() {
            if (performanceRefreshInterval) {
                clearInterval(performanceRefreshInterval);
                performanceRefreshInterval = null;
            }
            
            // Safely destroy any existing charts
            Object.values(performanceCharts).forEach(chart => {
                safeDestroyChart(chart);
            });
            performanceCharts = {};
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', cleanupPerformanceDashboard);
        
        // Clean up when page visibility changes (browser tab switching)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, stop auto-refresh
                if (performanceRefreshInterval) {
                    clearInterval(performanceRefreshInterval);
                    performanceRefreshInterval = null;
                }
            } else {
                // Page is visible again, restart auto-refresh if on performance tab
                const performanceTab = document.getElementById('performance-tab');
                if (performanceTab && performanceTab.style.display !== 'none') {
                    startPerformanceAutoRefresh();
                }
            }
        });

        // ================= END PERFORMANCE DASHBOARD FUNCTIONS =================
    </script>

    <!-- Portfolio Creation Modal -->
    <div id="portfolioModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3><i class="fas fa-briefcase"></i> Create New Portfolio</h3>
                <button class="modal-close" onclick="closePortfolioModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Portfolio Name *</label>
                    <input type="text" id="portfolioName" placeholder="e.g., Growth Portfolio" maxlength="50">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="portfolioDescription" placeholder="Brief description of your portfolio strategy" maxlength="200" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Add Stocks to Portfolio</label>
                    <div class="stock-search-container">
                        <input type="text" id="stockSearch" placeholder="Search stocks by name or symbol..." autocomplete="off">
                        <div id="stockSearchResults" class="search-results"></div>
                    </div>
                    <div id="selectedStocks" class="selected-stocks-container">
                        <div class="selected-stocks-header">
                            <span>Selected Stocks (<span id="selectedStockCount">0</span>)</span>
                        </div>
                        <div id="selectedStocksList" class="selected-stocks-list">
                            <!-- Selected stocks will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePortfolioModal()">Cancel</button>
                <button class="btn-primary" onclick="createPortfolioWithStocks()" id="createPortfolioBtn">
                    <i class="fas fa-plus"></i> Create Portfolio
                </button>
            </div>
        </div>
    </div>

    <!-- Stock Addition Modal -->
    <div id="stockModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> Add Stock to <span id="stockModalPortfolioName">Portfolio</span></h3>
                <button class="modal-close" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Search Stock *</label>
                    <div class="stock-search-container">
                        <input type="text" id="stockModalSearch" placeholder="Search stocks by name or symbol..." autocomplete="off">
                        <div id="stockModalSearchResults" class="search-results"></div>
                    </div>
                </div>
                <div id="stockModalSelectedStock" class="selected-stock-details" style="display: none;">
                    <div class="stock-info-card">
                        <div class="stock-header">
                            <div class="stock-name" id="stockModalStockName">Stock Name</div>
                            <div class="stock-price" id="stockModalStockPrice">₹0.00</div>
                        </div>
                        <div class="stock-details">
                            <div class="detail-item">
                                <span>Symbol:</span>
                                <span id="stockModalStockSymbol">N/A</span>
                            </div>
                            <div class="detail-item">
                                <span>Change:</span>
                                <span id="stockModalStockChange">₹0.00 (0.00%)</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Quantity *</label>
                                <input type="number" id="stockQuantity" placeholder="100" min="1" step="1">
                            </div>
                            <div class="form-group">
                                <label>Average Price *</label>
                                <input type="number" id="stockAvgPrice" placeholder="0.00" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeStockModal()">Cancel</button>
                <button class="btn-primary" onclick="addStockToCurrentPortfolio()" id="addStockBtn" disabled>
                    <i class="fas fa-plus"></i> Add Stock
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-container {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f172a;
        }

        .modal-header h3 {
            margin: 0;
            color: #f1f5f9;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #334155;
            color: #f1f5f9;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #334155;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #0f172a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #f1f5f9;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #f1f5f9;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn-primary, .btn-secondary {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: #60a5fa;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #3b82f6;
        }

        .btn-primary:disabled {
            background: #374151;
            color: #6b7280;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Stock Search Styles */
        .stock-search-container {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f172a;
            border: 1px solid #334155;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #1e293b;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #1e293b;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-name {
            font-size: 14px;
            color: #f1f5f9;
            font-weight: 500;
        }

        .result-details {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 2px;
            display: flex;
            justify-content: space-between;
        }

        .result-price {
            color: #10b981;
            font-weight: 500;
        }

        .result-change-positive {
            color: #10b981;
        }

        .result-change-negative {
            color: #ef4444;
        }

        /* Selected Stocks Styles */
        .selected-stocks-container {
            margin-top: 12px;
            border: 1px solid #334155;
            border-radius: 6px;
            background: #0f172a;
        }

        .selected-stocks-header {
            padding: 10px 12px;
            border-bottom: 1px solid #334155;
            font-size: 13px;
            font-weight: 500;
            color: #f1f5f9;
        }

        .selected-stocks-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .selected-stock-item {
            padding: 10px 12px;
            border-bottom: 1px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .selected-stock-item:last-child {
            border-bottom: none;
        }

        .selected-stock-info {
            flex: 1;
        }

        .selected-stock-name {
            font-size: 13px;
            color: #f1f5f9;
            font-weight: 500;
        }

        .selected-stock-symbol {
            font-size: 11px;
            color: #94a3b8;
        }

        .selected-stock-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .selected-stock-remove:hover {
            background: #dc2626;
        }

        /* Stock Info Card */
        .stock-info-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stock-name {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .stock-price {
            font-size: 18px;
            font-weight: 600;
            color: #10b981;
        }

        .stock-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .detail-item span:first-child {
            color: #94a3b8;
        }

        .detail-item span:last-child {
            color: #f1f5f9;
            font-weight: 500;
        }

        /* Real-time update indicator */
        .refresh-btn {
            background: #1e40af;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: #1d4ed8;
        }

        .refresh-btn:disabled {
            background: #374151;
            cursor: not-allowed;
        }

        .last-updated {
            font-size: 11px;
            color: #6b7280;
            margin-left: 10px;
        }
    </style>
</body>
</html>
