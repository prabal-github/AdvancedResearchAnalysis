<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Research Assistant - Intelligent Investment Insights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        :root {
            /* PredictRAM Brand Palette */
            --brand-primary: #272BAB; /* Deep Indigo */
            --brand-accent: #9B82E1; /* Soft Lavender */
            --brand-secondary: #5F5B00; /* Olive Accent */
            --brand-neutral-dark: #2C3300; /* Earthy Neutral */
            --brand-neutral-light: #f5f7ff;

            /* Derived Gradients */
            --primary-gradient: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-accent) 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);

            /* Surfaces & Effects */
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.22);
            --text-primary: #1c2240;
            --text-secondary: #5b6280;
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 24px 48px -12px rgba(0, 0, 0, 0.18);
            --focus-ring: 0 0 0 3px rgba(39,43,171,0.35);
        }

        body {
            background:
                radial-gradient(circle at 20% 20%, rgba(155,130,225,0.25), transparent 60%),
                radial-gradient(circle at 80% 70%, rgba(39,43,171,0.25), transparent 55%),
                var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--glass-border);
        }

        /* Header Styles */
        .ai-header {
            background:
                linear-gradient(135deg, rgba(39,43,171,0.92) 0%, rgba(155,130,225,0.92) 65%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="%23272BAB"/><stop offset="1" stop-color="%239B82E1"/></linearGradient></defs><circle cx="650" cy="80" r="120" fill="url(%23g)" fill-opacity="0.18"/><circle cx="150" cy="520" r="180" fill="url(%23g)" fill-opacity="0.12"/></svg>') center/cover no-repeat;
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .ai-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .ai-header .title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .ai-header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }

        .ai-status {
            display: inline-flex;
            align-items: center;
            background: var(--glass-bg);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid var(--glass-border);
            margin-top: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        /* Chat Interface */
        .chat-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .query-input-area {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .query-input {
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 16px;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .query-input:focus {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .submit-btn {
            background: var(--primary-gradient);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .submit-btn:hover::before {
            left: 100%;
        }

        /* Response Area */
        .response-area {
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .response-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .response-icon {
            width: 40px;
            height: 40px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
        }

        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-primary);
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Sidebar Cards */
        .insight-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .card-header-custom {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .card-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 16px;
        }

        .card-icon.stats { background: var(--primary-gradient); }
        .card-icon.trending { background: var(--secondary-gradient); }
        .card-icon.insights { background: var(--success-gradient); }
        .card-icon.queries { background: var(--warning-gradient); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a202c;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Trending Topics */
        .trending-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .trending-item:last-child {
            border-bottom: none;
        }

        .trend-icon {
            color: #10b981;
            margin-right: 10px;
            font-size: 14px;
        }

        .trend-topic {
            flex: 1;
            font-weight: 500;
        }

        .trend-count {
            background: #e6fffa;
            color: #047857;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Query History */
        .query-history-item {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.2s ease;
        }

        .query-history-item:hover {
            background: #e2e8f0;
            transform: translateX(5px);
        }

        .query-text {
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .query-meta {
            display: flex;
            justify-content: between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Insights List */
        .insight-item {
            display: flex;
            align-items: start;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-bullet {
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            margin: 8px 12px 0 0;
            flex-shrink: 0;
        }

        .insight-text {
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }
            
            .ai-header {
                padding: 25px;
            }
            
            .ai-header .title {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .query-input {
                background: #2d3748;
                color: white;
                border-color: #4a5568;
            }
            
            .response-area {
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                color: white;
            }
        }

        /* New Enhanced Styles for Claude Integration */
        .ai-response-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .research-reports-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .research-reports-section h6 {
            color: #2d3748;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .report-insight-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .report-insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .report-excerpt {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #4a5568;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Enhanced button styles */
        .btn-outline-primary {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            transition: all 0.3s;
        }

        .btn-outline-primary:hover {
            background-color: var(--brand-primary);
            border-color: var(--brand-primary);
            transform: translateY(-1px);
        }

        /* Live Stock Data Styles */
        .live-stocks-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .live-stock-item {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .live-stock-item:last-child {
            border-bottom: none;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .stock-ticker {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .stock-change {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .stock-change.positive {
            color: #22c55e;
            background-color: #dcfce7;
        }

        .stock-change.negative {
            color: #ef4444;
            background-color: #fee2e2;
        }

        .stock-change.neutral {
            color: #64748b;
            background-color: #f1f5f9;
        }

        .stock-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .stock-price {
            font-weight: 600;
            color: #1e40af;
        }

        .stock-volume {
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Enhanced Header -->
        <div class="ai-header animate__animated animate__fadeInDown">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="title">
                        <i class="fas fa-brain me-3"></i>AI Research Assistant
                    </h1>
                    <p class="subtitle">
                        Get instant, intelligent insights from our comprehensive investment research database.
                        Ask complex questions, receive detailed analysis, and make informed investment decisions.
                    </p>
                    <div class="ai-status">
                        <div class="status-dot"></div>
                        <span>AI Engine Online • Response Time: {{ enhanced_stats.avg_response_time|default(2.3) }}s</span>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('investor_dashboard') }}" class="btn btn-warning">
                            <i class="fas fa-tachometer-alt me-2"></i>Investor Dashboard
                        </a>
                    </div>
                </div>
                <div class="col-lg-4 text-center">
                        <div class="d-flex flex-column align-items-center gap-2">
                            <!-- PredictRAM Logo -->
                            <img src="{{ url_for('static', filename='images/image.png') }}" alt="PredictRAM Logo" style="height:72px; width:auto; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.35)); border-radius:12px; background:rgba(255,255,255,0.08); padding:6px;" onerror="this.style.display='none'">
                            <div class="text-center small" style="letter-spacing:1px; font-weight:600; opacity:0.9;">PREDICTRAM RESEARCH</div>
                            <div class="mt-1 text-center">
                                <small style="opacity:0.8;">Satisfaction Score</small>
                                <div style="font-size:1.5rem; font-weight:700;">{{ enhanced_stats.satisfaction_score|default(4.2) }}/5.0</div>
                            </div>
                        </div>
                </div>
            </div>
        </div>

        <!-- SEBI Compliance & AI Disclaimer Section -->
        <div class="sebi-disclaimer-section animate__animated animate__fadeInUp" style="margin-top: 20px;">
            <div class="alert alert-warning border-0 shadow-sm" style="background: linear-gradient(135deg, #fff3cd 0%, #fefefe 100%); border-left: 4px solid #ff6b35 !important;">
                <div class="d-flex align-items-start">
                    <div class="me-3" style="margin-top: 2px;">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 1.2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-2" style="color: #b8560a; font-weight: 600;">
                            <i class="fas fa-robot me-2"></i>AI-Generated Content & SEBI Compliance Disclaimer
                        </h6>
                        <div style="font-size: 0.9rem; line-height: 1.5;">
                            <p class="mb-2" style="color: #856404;">
                                <strong>⚠️ AI-Generated Information:</strong> All research, analysis, and recommendations provided by this AI Research Assistant are generated using artificial intelligence and machine learning algorithms. This content is not authored by SEBI-registered research analysts.
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-2" style="color: #856404;">
                                        <li><i class="fas fa-shield-alt me-2 text-primary"></i><strong>Not Investment Advice:</strong> This is for informational purposes only</li>
                                        <li><i class="fas fa-chart-line me-2 text-info"></i><strong>Market Risk:</strong> All investments are subject to market risks</li>
                                        <li><i class="fas fa-user-tie me-2 text-success"></i><strong>Consult Advisor:</strong> Please consult your financial advisor before investing</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-2" style="color: #856404;">
                                        <li><i class="fas fa-gavel me-2 text-warning"></i><strong>SEBI Compliance:</strong> As per SEBI guidelines on AI-generated content</li>
                                        <li><i class="fas fa-database me-2 text-secondary"></i><strong>Data Accuracy:</strong> Information is provided as-is without warranty</li>
                                        <li><i class="fas fa-clock me-2 text-info"></i><strong>Real-time Disclaimer:</strong> Market data may have delays</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-2 p-2 rounded" style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);">
                                <small style="color: #b8560a;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Regulatory Note:</strong> This platform provides AI-assisted research tools. Users are advised to conduct their own due diligence and seek professional advice before making investment decisions. PredictRAM Research disclaims any liability for investment decisions based on AI-generated content.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Chat Interface -->
            <div class="col-lg-8">
                <div class="chat-container animate__animated animate__fadeInLeft">
                    <!-- Query Input Section -->
                    <div class="query-input-area">
                        <h5 class="mb-3">
                            <i class="fas fa-comments me-2"></i>Ask Your Investment Question
                        </h5>
                        <form id="enhancedAiQueryForm">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <textarea 
                                        class="form-control query-input" 
                                        id="queryInput" 
                                        rows="4" 
                                        placeholder="Ask detailed questions about stocks, sectors, market analysis, investment strategies...

Examples:
• What's the technical and fundamental outlook for RELIANCE.NS?
• How is the banking sector performing compared to technology?
• Should I consider ESG investments in the current market?
• What are the risks and opportunities in the Indian IT sector?"></textarea>
                                </div>
                            </div>
                            <!-- Multi-report selection -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Add analysts' reports to ground the answer (multi-select)</label>
                                <select id="reportPicker" class="form-select select2" multiple data-placeholder="Search and select reports by analyst, ticker, or score"></select>
                                <div class="form-text">Tip: Higher quality scores generally indicate better research rigor.</div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" value="1" id="useSelectedOnly" checked>
                                    <label class="form-check-label" for="useSelectedOnly">Prioritize selected reports</label>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <span id="queryHint">Pro tip: Be specific for better insights</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="clearQuery()">
                                        <i class="fas fa-eraser me-1"></i>Clear
                                    </button>
                                    <button type="submit" class="btn submit-btn" id="submitBtn">
                                        <i class="fas fa-paper-plane me-2"></i>Analyze Query
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Enhanced Response Area -->
                    <div class="response-area" id="responseArea">
                        <div class="response-header">
                            <div class="response-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">AI Analysis Complete</h6>
                                <small class="text-muted">Generated in <span id="responseTime">0.0</span>s</small>
                            </div>
                        </div>

                        <!-- Analysis Metrics -->
                        <div class="analysis-metrics" id="analysisMetrics">
                            <!-- Dynamically populated -->
                        </div>

                        <!-- AI Response -->
                        <div id="aiResponse" class="mb-4">
                            <!-- AI response content -->
                        </div>

                        <!-- Insights and Recommendations -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                                <div id="keyInsights">
                                    <!-- Insights list -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-arrow-right me-2"></i>Recommendations</h6>
                                <div id="recommendations">
                                    <!-- Recommendations list -->
                                </div>
                            </div>
                        </div>

                        <!-- Follow-up Questions -->
                        <div class="mt-4">
                            <h6><i class="fas fa-question-circle me-2"></i>Follow-up Questions</h6>
                            <div id="followUpQuestions" class="d-flex flex-wrap gap-2">
                                <!-- Follow-up question buttons -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query History -->
                <div class="insight-card animate__animated animate__fadeInUp">
                    <div class="card-header-custom">
                        <div class="card-icon queries">
                            <i class="fas fa-history"></i>
                        </div>
                        <h6 class="mb-0">Recent Query History</h6>
                    </div>
                    <div id="queryHistory">
                        {% for query in recent_queries[:5] %}
                        <div class="query-history-item">
                            <div class="query-text">{{ query.query_text[:120] }}{% if query.query_text|length > 120 %}...{% endif %}</div>
                            <div class="query-meta">
                                <span>
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ query.created_at.strftime('%m/%d %H:%M') if query.created_at else 'Recently' }}
                                </span>
                                <span>
                                    <i class="fas fa-chart-bar me-1"></i>
                                    {{ "%.0f"|format(query.confidence_score * 100) if query.confidence_score else '85' }}% confidence
                                </span>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <p>Start asking questions to build your query history!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Enhanced Sidebar -->
            <div class="col-lg-4">
                <!-- Enhanced Knowledge Base Stats with .NS Stocks -->
                <div class="insight-card animate__animated animate__fadeInRight">
                    <div class="card-header-custom">
                        <div class="card-icon stats">
                            <i class="fas fa-database"></i>
                        </div>
                        <h6 class="mb-0">Knowledge Base Stats</h6>
                        <small class="text-muted">Updated: {{ enhanced_stats.market_data_timestamp|default('Real-time') }}</small>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number">{{ enhanced_stats.total_reports|default(127) }}</span>
                            <div class="stat-label">Research Reports</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ enhanced_stats.ns_stocks_covered|default(25) }}</span>
                            <div class="stat-label">.NS Stocks Covered</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ enhanced_stats.answer_accuracy|default(85.4) }}%</span>
                            <div class="stat-label">Answer Accuracy</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ enhanced_stats.reports_with_ns_stocks|default(45) }}</span>
                            <div class="stat-label">NSE Reports</div>
                        </div>
                    </div>
                    
                    <!-- Live .NS Stock Data -->
                    {% if enhanced_stats.live_market_data %}
                    <div class="mt-3">
                        <h6 class="mb-2"><i class="fas fa-chart-line me-1"></i>Live .NS Stock Data</h6>
                        <div class="live-stocks-container">
                            {% for ticker, data in enhanced_stats.live_market_data.items() %}
                            <div class="live-stock-item">
                                <div class="stock-header">
                                    <span class="stock-ticker">{{ ticker }}</span>
                                    <span class="stock-change {% if data.change > 0 %}positive{% elif data.change < 0 %}negative{% else %}neutral{% endif %}">
                                        {{ "+" if data.change > 0 else "" }}{{ data.change }}%
                                    </span>
                                </div>
                                <div class="stock-details">
                                    <span class="stock-price">₹{{ data.price }}</span>
                                    <span class="stock-volume">Vol: {{ data.volume }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Trending Topics -->
                <div class="insight-card animate__animated animate__fadeInRight animate__delay-1s">
                    <div class="card-header-custom">
                        <div class="card-icon trending">
                            <i class="fas fa-fire"></i>
                        </div>
                        <h6 class="mb-0">Trending Topics</h6>
                    </div>
                    {% for topic in trending_topics %}
                    <div class="trending-item">
                        <i class="fas fa-arrow-{{ 'up' if topic.trend == 'up' else 'right' }} trend-icon"></i>
                        <span class="trend-topic">{{ topic.topic }}</span>
                        <span class="trend-count">{{ topic.count }}</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-chart-line mb-2"></i>
                        <p class="mb-0">Trending topics will appear here</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Personal Insights -->
                <div class="insight-card animate__animated animate__fadeInRight animate__delay-2s">
                    <div class="card-header-custom">
                        <div class="card-icon insights">
                            <i class="fas fa-user-chart"></i>
                        </div>
                        <h6 class="mb-0">Your Investment Insights</h6>
                    </div>
                    <div>
                        <div class="mb-3">
                            <small class="text-muted">Sectors of Interest</small>
                            <div class="mt-1">
                                {% for sector in investor_insights.sectors_of_interest %}
                                <span class="badge bg-primary me-1">{{ sector }}</span>
                                {% else %}
                                <span class="badge bg-primary me-1">Technology</span>
                                <span class="badge bg-primary me-1">Banking</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Top Stocks</small>
                            <div class="mt-1">
                                {% for stock in investor_insights.interests %}
                                <span class="badge bg-success me-1">{{ stock }}</span>
                                {% else %}
                                <span class="badge bg-success me-1">RELIANCE.NS</span>
                                <span class="badge bg-success me-1">TCS.NS</span>
                                {% endfor %}
                            </div>
                        </div>

                        <div>
                            <small class="text-muted">Personalized Recommendations</small>
                            {% for recommendation in investor_insights.recommendations %}
                            <div class="insight-item">
                                <div class="insight-bullet"></div>
                                <div class="insight-text">{{ recommendation }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        // Enhanced AI Query Processing
        let currentQueryId = null;
        let queryHistory = [];

        // Form submission handler
        document.getElementById('enhancedAiQueryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            processEnhancedQuery();
        });

        // Query input enhancements
        const queryInput = document.getElementById('queryInput');
        const queryHint = document.getElementById('queryHint');
        
        queryInput.addEventListener('input', function() {
            const text = this.value.toLowerCase();
            let hint = "Pro tip: Be specific for better insights";
            
            if (text.includes('stock') || text.match(/[A-Z]{2,6}\.NS/i)) {
                hint = "Great! Stock-specific questions get detailed analysis";
            } else if (text.includes('sector') || text.includes('industry')) {
                hint = "Sector analysis provides comprehensive market insights";
            } else if (text.includes('buy') || text.includes('sell') || text.includes('invest')) {
                hint = "Investment questions include risk and opportunity analysis";
            }
            
            queryHint.textContent = hint;
        });

    // Enhanced query processing
        async function processEnhancedQuery() {
            const query = queryInput.value.trim();
            if (!query) {
                alert('Please enter your investment question');
                return;
            }

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading-spinner"></div>Analyzing...';
            submitBtn.disabled = true;

            try {
                const selectedIds = (typeof $ !== 'undefined' && $.fn.select2) ? ($('#reportPicker').val() || []) : [];
                const useSelectedOnly = document.getElementById('useSelectedOnly') ? document.getElementById('useSelectedOnly').checked : true;
                const response = await fetch('/api/enhanced_ai_query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        investor_id: '{{ investor_id|default("demo_investor") }}',
                        selected_report_ids: selectedIds,
                        use_selected_only: useSelectedOnly
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayEnhancedResponse(data);
                    addToQueryHistory(query, data);
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Error processing query:', error);
                showErrorMessage(error.message);
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Populate report picker options on load
        (async function loadReportCatalog(){
            try {
                const res = await fetch('/api/ai/reports_catalog?limit=50');
                if (!res.ok) return;
                const payload = await res.json();
                if (payload.success && Array.isArray(payload.reports)) {
                    const picker = document.getElementById('reportPicker');
                    payload.reports.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.id;
                        const t = Array.isArray(r.tickers) ? r.tickers.join(', ') : (r.tickers || '');
                        opt.textContent = `${r.title || r.id} — ${r.analyst || 'Unknown'} • ${t} • QS: ${r.quality_score ?? 'NA'}`;
                        picker.appendChild(opt);
                    });
                    if (typeof $ !== 'undefined' && $.fn.select2) {
                        $('#reportPicker').select2({ width: '100%' });
                    }
                }
            } catch (e) { /* ignore */ }
        })();

        // Display enhanced response
        function displayEnhancedResponse(data) {
            const responseArea = document.getElementById('responseArea');
            const responseTime = document.getElementById('responseTime');
            const analysisMetrics = document.getElementById('analysisMetrics');
            const aiResponse = document.getElementById('aiResponse');
            const keyInsights = document.getElementById('keyInsights');
            const recommendations = document.getElementById('recommendations');
            const followUpQuestions = document.getElementById('followUpQuestions');

            // Show response area
            responseArea.style.display = 'block';
            responseArea.scrollIntoView({ behavior: 'smooth' });

            // Update response time
            responseTime.textContent = data.analysis.response_time.toFixed(1);

            // Create enhanced analysis metrics
            analysisMetrics.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${Math.round(data.analysis.confidence_level * 100)}%</div>
                    <div class="metric-label">Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${Math.round(data.analysis.coverage_score * 100)}%</div>
                    <div class="metric-label">Coverage</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.analysis.identified_tickers.length}</div>
                    <div class="metric-label">Stocks</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.analysis.research_reports_found || 0}</div>
                    <div class="metric-label">Reports</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${data.analysis.market_data_available ? '✓' : '✗'}</div>
                    <div class="metric-label">Live Data</div>
                </div>
            `;

            // Display AI response with enhanced formatting
            let responseContent = `
                <div class="ai-response-header">
                    <i class="fas fa-robot text-primary me-2"></i>
                    <strong>Claude-Enhanced Analysis</strong>
                    <span class="badge bg-primary ms-2">${data.analysis.query_type.replace('_', ' ').toUpperCase()}</span>
                </div>
                <div class="ai-response-content">
                    ${formatAIResponse(data.ai_response)}
                </div>
            `;

            // Add research report insights if available
            if (data.report_insights && data.report_insights.length > 0) {
                responseContent += `
                    <div class="research-reports-section mt-4">
                        <h6><i class="fas fa-file-alt text-info me-2"></i>Related Research Reports</h6>
                        ${data.report_insights.map(report => `
                            <div class="report-insight-card">
                                <div class="d-flex justify-content-between">
                                    <span><strong>By ${report.analyst}</strong> (${report.created_at})</span>
                                    ${report.quality_score > 0 ? `<span class="badge bg-success">${report.quality_score.toFixed(1)}%</span>` : ''}
                                </div>
                                <div class="small text-muted mt-1">
                                    ${report.tickers.length > 0 ? `Tickers: ${report.tickers.join(', ')}` : ''}
                                </div>
                                <div class="report-excerpt mt-2">${report.excerpt}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            responseContent += `
                <div class="mt-3 small text-muted">
                    <i class="fas fa-database me-1"></i>
                    Sources: ${data.data_sources.join(', ')}
                    ${data.analysis.research_reports_found > 0 ? ` • ${data.analysis.research_reports_found} reports analyzed` : ''}
                </div>
                <div class="alert alert-warning mt-3 py-2" style="font-size: 0.8rem; border-left: 4px solid #ff9800;">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    <strong>AI-Generated Content Disclaimer:</strong> This analysis is generated by artificial intelligence and should not be considered as personalized investment advice. Please consult with a qualified financial advisor before making investment decisions. This content is for informational purposes only and does not constitute a recommendation to buy, sell, or hold any securities.
                </div>
            `;

            aiResponse.innerHTML = responseContent;

            // Display enhanced insights with icons
            keyInsights.innerHTML = data.insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-bullet"></div>
                    <div class="insight-text">${insight}</div>
                </div>
            `).join('');

            // Display enhanced recommendations with icons
            recommendations.innerHTML = data.recommendations.map(rec => `
                <div class="insight-item">
                    <div class="insight-bullet"></div>
                    <div class="insight-text">${rec}</div>
                </div>
            `).join('');

            // Display follow-up questions as clickable buttons
            followUpQuestions.innerHTML = data.follow_up_questions.map(question => `
                <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="askFollowUpQuestion('${question}')">
                    ${question}
                </button>
            `).join('');
        }

        // Format AI response text
        function formatAIResponse(response) {
            return response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Handle follow-up questions
        function askFollowUpQuestion(question) {
            queryInput.value = question;
            processEnhancedQuery();
        }

        // Add to query history
        function addToQueryHistory(query, response) {
            const historyItem = {
                query: query,
                timestamp: new Date(),
                confidence: response.analysis.confidence_level
            };
            
            queryHistory.unshift(historyItem);
            if (queryHistory.length > 5) {
                queryHistory.pop();
            }
            
            updateQueryHistoryDisplay();
        }

        // Update query history display
        function updateQueryHistoryDisplay() {
            const historyContainer = document.getElementById('queryHistory');
            if (queryHistory.length === 0) return;

            historyContainer.innerHTML = queryHistory.map(item => `
                <div class="query-history-item">
                    <div class="query-text">${item.query.substring(0, 120)}${item.query.length > 120 ? '...' : ''}</div>
                    <div class="query-meta">
                        <span>
                            <i class="fas fa-calendar me-1"></i>
                            ${item.timestamp.toLocaleTimeString()}
                        </span>
                        <span>
                            <i class="fas fa-chart-bar me-1"></i>
                            ${Math.round(item.confidence * 100)}% confidence
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Clear query
        function clearQuery() {
            queryInput.value = '';
            queryInput.focus();
            queryHint.textContent = "Pro tip: Be specific for better insights";
        }

        // Show error message
        function showErrorMessage(message) {
            const responseArea = document.getElementById('responseArea');
            responseArea.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${message}
                    <br><small>Please try again or contact support if the problem persists.</small>
                </div>
                <div class="alert alert-info mt-3 py-2" style="font-size: 0.8rem; border-left: 4px solid #2196f3;">
                    <i class="fas fa-info-circle me-2 text-info"></i>
                    <strong>Notice:</strong> This AI Research Assistant provides AI-generated content for informational purposes only. All analysis and recommendations are generated by artificial intelligence and should not be considered as investment advice.
                </div>
            `;
            responseArea.style.display = 'block';
        }

        // Auto-focus on query input
        document.addEventListener('DOMContentLoaded', function() {
            queryInput.focus();
            
            // Add some example queries on load
            const examples = [
                "What's the outlook for RELIANCE.NS?",
                "How is the banking sector performing?",
                "Should I invest in ESG funds?",
                "Technology vs Healthcare sector comparison"
            ];
            
            let exampleIndex = 0;
            setInterval(() => {
                if (queryInput.value === '' && !queryInput.matches(':focus')) {
                    queryInput.placeholder = `Try: "${examples[exampleIndex]}"`;
                    exampleIndex = (exampleIndex + 1) % examples.length;
                }
            }, 3000);
        });
    </script>
</body>
</html>
