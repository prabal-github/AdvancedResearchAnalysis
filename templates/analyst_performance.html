<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Performance Dashboard - {{ analyst_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .feature-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: none;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-4">
                    <h5 class="mb-4">{{ analyst_name }}</h5>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#overview">
                            <i class="bi bi-speedometer2 me-2"></i> Overview
                        </a>
                        <a class="nav-link" href="#reports">
                            <i class="bi bi-file-text me-2"></i> My Reports
                        </a>
                        <a class="nav-link" href="#improvements">
                            <i class="bi bi-graph-up me-2"></i> Improvements
                        </a>
                        <a class="nav-link" href="#analytics">
                            <i class="bi bi-bar-chart me-2"></i> Analytics
                        </a>
                        <a class="nav-link" href="#quality">
                            <i class="bi bi-award me-2"></i> Quality Trends
                        </a>
                        <a class="nav-link" href="#compliance">
                            <i class="bi bi-shield-check me-2"></i> Compliance
                        </a>
                        <hr class="my-3">
                        <a class="nav-link" href="/analyst/{{ analyst_name }}">
                            <i class="bi bi-house me-2"></i> Dashboard
                        </a>
                        <a class="nav-link" href="/">
                            <i class="bi bi-arrow-left me-2"></i> Main App
                        </a>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <div class="mb-4">
                    <h2 class="mb-1">Performance Dashboard</h2>
                    <p class="text-muted">Track your research quality and improvement journey</p>
                </div>

                <!-- 4 Main Feature Cards -->
                <div class="row mb-5" id="overview">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center p-4">
                                <div class="metric-icon bg-primary bg-opacity-10 text-primary mx-auto mb-3">
                                    <i class="bi bi-file-text"></i>
                                </div>
                                <h3 class="text-primary mb-2">{{ performance_metrics.total_reports }}</h3>
                                <h6 class="text-muted mb-3">Total Reports</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-primary" style="width: {{ (performance_metrics.total_reports / 50 * 100)|round(0) }}%"></div>
                                </div>
                                <small class="text-muted">Target: 50 reports</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center p-4">
                                <div class="metric-icon bg-success bg-opacity-10 text-success mx-auto mb-3">
                                    <i class="bi bi-award"></i>
                                </div>
                                <h3 class="text-success mb-2">{{ performance_metrics.avg_quality_score|round(1) }}%</h3>
                                <h6 class="text-muted mb-3">Quality Score</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: {{ performance_metrics.avg_quality_score }}%"></div>
                                </div>
                                <small class="text-muted">{{ performance_metrics.quality_trend }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center p-4">
                                <div class="metric-icon bg-info bg-opacity-10 text-info mx-auto mb-3">
                                    <i class="bi bi-graph-up"></i>
                                </div>
                                <h3 class="text-info mb-2">{{ performance_metrics.avg_quality_score|round(1) }}%</h3>
                                <h6 class="text-muted mb-3">Quality Score</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" style="width: {{ performance_metrics.avg_quality_score }}%"></div>
                                </div>
                                <small class="text-muted">{{ performance_metrics.quality_trend|default('No Data') }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center p-4">
                                <div class="metric-icon bg-warning bg-opacity-10 text-warning mx-auto mb-3">
                                    <i class="bi bi-shield-check"></i>
                                </div>
                                {% set sebi_scores = [] %}
                                {% for report_data in reports_data %}
                                    {% if report_data.analysis and report_data.analysis.get('sebi_compliance_detailed') %}
                                        {% set _ = sebi_scores.append(report_data.analysis.sebi_compliance_detailed.get('overall_compliance_score', 0)) %}
                                    {% endif %}
                                {% endfor %}
                                {% set avg_sebi = (sebi_scores|sum / sebi_scores|length * 100)|round(0) if sebi_scores else 0 %}
                                <h3 class="text-warning mb-2">{{ avg_sebi }}%</h3>
                                <h6 class="text-muted mb-3">SEBI Compliance</h6>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: {{ avg_sebi }}%"></div>
                                </div>
                                <small class="text-muted">Regulatory Score</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row mb-5" id="analytics">
                    <div class="col-lg-8 mb-4">
                        <div class="card feature-card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Quality Score Trend</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="qualityTrendChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card feature-card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Report Quality Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="qualityDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Reports Section -->
                <div class="mb-5" id="reports">
                    <div class="card feature-card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Reports Performance</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Report ID</th>
                                            <th>Date</th>
                                            <th>Quality Score</th>
                                            <th>AI Detection</th>
                                            <th>Issues</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for report in reports[:10] %}
                                        <tr>
                                            <td><code>{{ report.id[:8] }}...</code></td>
                                            <td>{{ report.created_at.strftime('%Y-%m-%d') }}</td>
                                            <td>
                                                {% set report_data = reports_data[loop.index0] if loop.index0 < reports_data|length else {'analysis': {}} %}
                                                {% set quality = report_data.analysis.get('composite_quality_score', 0) %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if quality >= 0.8 %}bg-success{% elif quality >= 0.6 %}bg-info{% elif quality >= 0.4 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         style="width: {{ (quality * 100) }}%">
                                                        {{ (quality * 100)|round(1) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if report.ai_probability >= 0.7 %}
                                                    <span class="badge bg-danger">AI Detected</span>
                                                {% elif report.ai_probability >= 0.4 %}
                                                    <span class="badge bg-warning">Uncertain</span>
                                                {% else %}
                                                    <span class="badge bg-success">Human</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% set report_data = reports_data[loop.index0] if loop.index0 < reports_data|length else {'analysis': {}} %}
                                                {% set alerts = report_data.analysis.get('flagged_alerts', {}).get('total_alerts', 0) %}
                                                {% if alerts > 0 %}
                                                    <span class="badge bg-warning">{{ alerts }} Issues</span>
                                                {% else %}
                                                    <span class="badge bg-success">Clean</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="/report/{{ report.id }}" class="btn btn-sm btn-outline-primary me-1" title="View Report">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="/improvement_analysis/{{ report.id }}" class="btn btn-sm btn-outline-info me-1" title="Improvement Analysis">
                                                    <i class="bi bi-graph-up"></i>
                                                </a>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Share Options">
                                                        <i class="fab fa-linkedin"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" href="https://www.linkedin.com/sharing/share-offsite/?url={{ url_for('public_report_view', report_id=report.id, _external=True) | urlencode }}" target="_blank">
                                                                <i class="fab fa-linkedin me-2"></i>Share on LinkedIn
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="copyToClipboard('{{ url_for('public_report_view', report_id=report.id, _external=True) }}')">
                                                                <i class="bi bi-clipboard me-2"></i>Copy Public Link
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item" href="{{ url_for('public_report_view', report_id=report.id) }}" target="_blank">
                                                                <i class="bi bi-box-arrow-up-right me-2"></i>View Public Page
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Improvements Section -->
                <div class="mb-5" id="improvements">
                    <div class="card feature-card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Improvement Journey</h5>
                        </div>
                        <div class="card-body">
                            {% if improvements %}
                            <div class="row">
                                {% for imp in improvements[:6] %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">{{ imp.created_at.strftime('%Y-%m-%d') }}</small>
                                                <span class="badge {% if imp.improvement_score >= 0.8 %}bg-success{% elif imp.improvement_score >= 0.6 %}bg-info{% elif imp.improvement_score >= 0.4 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ (imp.improvement_score * 100)|round(0) }}%
                                                </span>
                                            </div>
                                            <h6 class="mb-2">Report {{ imp.report_id[:8] }}...</h6>
                                            {% set analysis = {} %}
                                            {% if imp.improvement_analysis %}
                                                {% set analysis = imp.improvement_analysis|loads %}
                                            {% endif %}
                                            <ul class="list-unstyled mb-0">
                                                {% for summary in analysis.get('summary', [])[:2] %}
                                                <li class="small">{{ summary }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-graph-up display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">No Improvement Data Yet</h5>
                                <p class="text-muted">Submit more reports to see your improvement journey!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Quality Trend Chart
        const qualityCtx = document.getElementById('qualityTrendChart').getContext('2d');
        const reports = {{ reports_data|tojson|safe }};
        
        const qualityData = reports.slice(0, 10).reverse().map(report => ({
            date: new Date(report.created_at).toLocaleDateString(),
            score: (report.analysis.composite_quality_score || 0) * 100
        }));
        
        new Chart(qualityCtx, {
            type: 'line',
            data: {
                labels: qualityData.map(d => d.date),
                datasets: [{
                    label: 'Quality Score (%)',
                    data: qualityData.map(d => d.score),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#0d6efd',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Quality Distribution Chart
        const distributionCtx = document.getElementById('qualityDistributionChart').getContext('2d');
        
        const qualityRanges = {
            'Excellent (80-100%)': 0,
            'Good (60-79%)': 0,
            'Average (40-59%)': 0,
            'Poor (0-39%)': 0
        };
        
        reports.forEach(report => {
            const score = (report.analysis.composite_quality_score || 0) * 100;
            if (score >= 80) qualityRanges['Excellent (80-100%)']++;
            else if (score >= 60) qualityRanges['Good (60-79%)']++;
            else if (score >= 40) qualityRanges['Average (40-59%)']++;
            else qualityRanges['Poor (0-39%)']++;
        });
        
        new Chart(distributionCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(qualityRanges),
                datasets: [{
                    data: Object.values(qualityRanges),
                    backgroundColor: [
                        '#198754',
                        '#0dcaf0', 
                        '#ffc107',
                        '#dc3545'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Smooth scrolling for sidebar links
        document.querySelectorAll('.sidebar .nav-link[href^="#"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                    
                    // Update active link
                    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });
        
        // LinkedIn Sharing Functions
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show success message
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible fade show';
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    Public link copied to clipboard!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }).catch(function() {
                alert('Failed to copy link. Please try manually copying the URL.');
            });
        }
        
        function shareOnLinkedIn(reportId, reportTitle, qualityScore) {
            const publicUrl = `${window.location.origin}/public/report/${reportId}`;
            const title = encodeURIComponent(`Research Report: ${reportTitle}`);
            const summary = encodeURIComponent(`Quality Score: ${qualityScore}% - Professional research analysis by {{ analyst_name }}`);
            const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(publicUrl)}&title=${title}&summary=${summary}`;
            window.open(linkedinUrl, '_blank', 'width=600,height=400');
        }
    });
    </script>
</body>
</html>