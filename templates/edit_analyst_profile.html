{% extends "layout.html" %}
{% block title %}Edit Profile - {{ profile.name }}{% endblock %}

{% block header %}
<div class="d-flex justify-content-between align-items-center flex-wrap">
    <div>
        <h1 class="mb-0">Edit Your Profile</h1>
        <p class="text-muted mb-0">Update your professional information</p>
    </div>
    <div class="mt-2 mt-md-0">
        <a href="{{ url_for('analyst_dashboard_main') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row g-4">
        <!-- Left: Main Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Profile Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="profileForm">
                        <div class="row align-items-center mb-4">
                            <div class="col-md-3 text-center mb-3 mb-md-0">
                                <div class="profile-image-section">
                                    <div class="profile-image-container mb-2">
                                        {% if profile.profile_image %}
                                            <img src="{{ url_for('static', filename=profile.profile_image) }}" alt="Profile Picture" class="profile-image" id="profilePreview">
                                        {% else %}
                                            <img src="https://via.placeholder.com/150x150/6c757d/ffffff?text=Photo" alt="Profile Picture" class="profile-image" id="profilePreview">
                                        {% endif %}
                                    </div>
                                    <label for="profile_image" class="form-label mt-2">
                                        <i class="fas fa-camera me-1"></i>Professional Photo
                                    </label>
                                    <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*" onchange="previewImage(this)">
                                    <small class="text-muted">JPG, PNG, max 5MB</small>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="full_name" class="form-label"><i class="fas fa-user me-1"></i>Full Name</label>
                                        <input type="text" class="form-control" id="full_name" name="full_name" value="{{ profile.full_name or '' }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label"><i class="fas fa-envelope me-1"></i>Email</label>
                                        <input type="email" class="form-control" id="email" name="email" value="{{ profile.email or '' }}" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="date_of_birth" class="form-label"><i class="fas fa-calendar me-1"></i>Date of Birth</label>
                                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" value="{{ profile.date_of_birth.strftime('%Y-%m-%d') if profile.date_of_birth else '' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="age" class="form-label"><i class="fas fa-birthday-cake me-1"></i>Age</label>
                                        <input type="number" class="form-control" id="age" name="age" value="{{ profile.age or '' }}" min="18" max="100">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="university_name" class="form-label"><i class="fas fa-university me-1"></i>University</label>
                                        <input type="text" class="form-control" id="university_name" name="university_name" value="{{ profile.university_name or '' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="specialization" class="form-label"><i class="fas fa-graduation-cap me-1"></i>Specialization</label>
                                        <input type="text" class="form-control" id="specialization" name="specialization" value="{{ profile.specialization or '' }}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="experience_years" class="form-label"><i class="fas fa-briefcase me-1"></i>Experience (Years)</label>
                                        <input type="number" class="form-control" id="experience_years" name="experience_years" value="{{ profile.experience_years or '' }}" min="0" max="50">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="sebi_registration" class="form-label"><i class="fas fa-id-card me-1"></i>SEBI Registration</label>
                                        <input type="text" class="form-control" id="sebi_registration" name="sebi_registration" value="{{ profile.sebi_registration or '' }}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="corporate_field" class="form-label"><i class="fas fa-building me-1"></i>Corporate Field</label>
                                        <select class="form-control" id="corporate_field" name="corporate_field">
                                            <option value="">Select Field</option>
                                            <option value="Equity Research" {{ 'selected' if profile.corporate_field == 'Equity Research' else '' }}>Equity Research</option>
                                            <option value="Investment Banking" {{ 'selected' if profile.corporate_field == 'Investment Banking' else '' }}>Investment Banking</option>
                                            <option value="Private Equity" {{ 'selected' if profile.corporate_field == 'Private Equity' else '' }}>Private Equity</option>
                                            <option value="Asset Management" {{ 'selected' if profile.corporate_field == 'Asset Management' else '' }}>Asset Management</option>
                                            <option value="FinTech" {{ 'selected' if profile.corporate_field == 'FinTech' else '' }}>FinTech</option>
                                            <option value="Risk Management" {{ 'selected' if profile.corporate_field == 'Risk Management' else '' }}>Risk Management</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="field_specialization" class="form-label"><i class="fas fa-target me-1"></i>Field Specialization</label>
                                        <input type="text" class="form-control" id="field_specialization" name="field_specialization" value="{{ profile.field_specialization or '' }}" placeholder="e.g., Healthcare Sector, TMT Analysis">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="certifications" class="form-label"><i class="fas fa-certificate me-1"></i>Certifications</label>
                                    <input type="text" class="form-control" id="certifications" name="certifications" value="{{ (profile.certifications|loads)|join(', ') if profile.certifications else '' }}" placeholder="e.g., CFA, FRM, CAIA (comma separated)">
                                    <small class="text-muted">Separate multiple certifications with commas</small>
                                </div>
                                <div class="mb-3">
                                    <label for="brief_description" class="form-label"><i class="fas fa-info-circle me-1"></i>Brief Description</label>
                                    <textarea class="form-control" id="brief_description" name="brief_description" rows="3" placeholder="A brief professional summary (2-3 sentences)">{{ profile.brief_description or '' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="bio" class="form-label"><i class="fas fa-user-circle me-1"></i>Professional Bio</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="4" placeholder="Detailed professional background and expertise">{{ profile.bio or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('analyst_dashboard_main') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right: Side Cards -->
        <div class="col-lg-4">
            <!-- Talent Program Mapping -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Talent Program Path</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Corporate Field</label>
                        <select class="form-select" id="corporateField">
                            <option value="">Select Field</option>
                            <option value="Equity Research" {{ 'selected' if profile.corporate_field == 'Equity Research' }}>Equity Research</option>
                            <option value="IB/PE" {{ 'selected' if profile.corporate_field == 'IB/PE' }}>Investment Banking/Private Equity</option>
                            <option value="Asset Management" {{ 'selected' if profile.corporate_field == 'Asset Management' }}>Asset Management</option>
                            <option value="FinTech" {{ 'selected' if profile.corporate_field == 'FinTech' }}>FinTech</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Field Specialization</label>
                        <select class="form-select" id="fieldSpecialization">
                            <option value="">Select Specialization</option>
                        </select>
                    </div>
                    <div class="talent-path-preview" id="talentPathPreview" style="display: none;">
                        <div class="alert alert-info">
                            <strong>Your Path:</strong>
                            <div class="mt-2" id="pathDisplay"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Certifications -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-award me-2"></i>Certifications</h6>
                </div>
                <div class="card-body">
                    <div id="certificationsContainer">
                        {% if profile.certifications %}
                            {% set certs = profile.certifications|loads %}
                            {% for cert in certs %}
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control certification-input" value="{{ cert }}" placeholder="Certification name">
                                    <button class="btn btn-outline-danger" type="button" onclick="removeCertification(this)"><i class="bi bi-trash"></i></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCertification()"><i class="bi bi-plus me-1"></i> Add Certification</button>
                </div>
            </div>

            <!-- Additional Specializations -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-star me-2"></i>Additional Specializations</h6>
                </div>
                <div class="card-body">
                    <div id="specializationsContainer">
                        {% if profile.specializations %}
                            {% set specs = profile.specializations|loads %}
                            {% for spec in specs %}
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control specialization-input" value="{{ spec }}" placeholder="Specialization area">
                                    <button class="btn btn-outline-danger" type="button" onclick="removeSpecialization(this)"><i class="bi bi-trash"></i></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSpecialization()"><i class="bi bi-plus me-1"></i> Add Specialization</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.profile-image-container { position: relative; display: inline-block; }
.profile-image { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #e9ecef; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.profile-image-section { background: #f8f9fa; border-radius: 10px; padding: 20px 10px; margin-bottom: 10px; }
.card-header { border-radius: 0.375rem 0.375rem 0 0 !important; }
.form-label { font-weight: 500; color: #495057; }
.form-control:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }
.btn { border-radius: 0.375rem; font-weight: 500; }
.text-muted { font-size: 0.875rem; }
.talent-path { text-align: center; font-size: 0.9em; }
.path-step { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 8px 12px; margin: 4px 0; font-weight: 500; }
.path-arrow { color: #6c757d; font-size: 1.2em; margin: 2px 0; }
</style>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) { document.getElementById('profilePreview').src = e.target.result; };
        reader.readAsDataURL(input.files[0]);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Age auto-calc
    const dobEl = document.getElementById('date_of_birth');
    if (dobEl) {
        dobEl.addEventListener('change', function() {
            const dob = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) age--;
            if (age >= 0 && age <= 100) document.getElementById('age').value = age;
        });
    }

    // Simple validation
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            const requiredFields = ['full_name', 'email'];
            let isValid = true;
            requiredFields.forEach(function(id) {
                const el = document.getElementById(id);
                if (!el.value.trim()) { el.classList.add('is-invalid'); isValid = false; }
                else { el.classList.remove('is-invalid'); }
            });
            if (!isValid) { e.preventDefault(); alert('Please fill in all required fields.'); }
        });
    }

    // Talent mapping UI (right panel)
    const specializationMapping = {
        'Equity Research': ['Sector Analyst', 'Quantitative Analyst', 'ESG Analyst', 'Technical Analyst'],
        'IB/PE': ['Deal Execution', 'Valuation Specialist', 'Due Diligence', 'Portfolio Management'],
        'Asset Management': ['Portfolio Strategy', 'Risk Management', 'Fund Management', 'Alternative Investments'],
        'FinTech': ['Algo Trading', 'Blockchain Analysis', 'RegTech', 'Digital Banking']
    };

    function updateSpecializations() {
        const field = document.getElementById('corporateField').value;
        const specializationSelect = document.getElementById('fieldSpecialization');
        specializationSelect.innerHTML = '<option value="">Select Specialization</option>';
        if (field && specializationMapping[field]) {
            specializationMapping[field].forEach(spec => {
                const option = document.createElement('option');
                option.value = spec; option.textContent = spec;
                if (spec === '{{ profile.field_specialization }}') option.selected = true;
                specializationSelect.appendChild(option);
            });
        }
        updateTalentPath();
    }

    function updateTalentPath() {
        const field = document.getElementById('corporateField').value;
        const specialization = document.getElementById('fieldSpecialization').value;
        const preview = document.getElementById('talentPathPreview');
        const pathDisplay = document.getElementById('pathDisplay');
        if (field && specialization) {
            pathDisplay.innerHTML = '<div class="talent-path">\
                <div class="path-step">🎯 Talent Program</div>\
                <div class="path-arrow">↓</div>\
                <div class="path-step">' + field + '</div>\
                <div class="path-arrow">↓</div>\
                <div class="path-step">' + specialization + '</div>\
            </div>';
            preview.style.display = 'block';
        } else { preview.style.display = 'none'; }
    }

    const fieldEl = document.getElementById('corporateField');
    if (fieldEl) {
        fieldEl.addEventListener('change', updateSpecializations);
        updateSpecializations();
    }
    const specEl = document.getElementById('fieldSpecialization');
    if (specEl) specEl.addEventListener('change', updateTalentPath);
});

// Dynamic lists
function addCertification() {
    const container = document.getElementById('certificationsContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = '\
        <input type="text" class="form-control certification-input" placeholder="Certification name">\
        <button class="btn btn-outline-danger" type="button" onclick="removeCertification(this)"><i class="bi bi-trash"></i></button>';
    container.appendChild(div);
}
function removeCertification(btn) { btn.parentElement.remove(); }
function addSpecialization() {
    const container = document.getElementById('specializationsContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = '\
        <input type="text" class="form-control specialization-input" placeholder="Specialization area">\
        <button class="btn btn-outline-danger" type="button" onclick="removeSpecialization(this)"><i class="bi bi-trash"></i></button>';
    container.appendChild(div);
}
function removeSpecialization(btn) { btn.parentElement.remove(); }
</script>
{% endblock %}