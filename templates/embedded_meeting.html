{% extends 'layout.html' %}
{% block title %}Session Meeting{% endblock %}
{% block header %}
<style>
#meetingContainer { width:100%; height: calc(100vh - 120px); background:#000; }
body,html { overflow:hidden; }
.badge-role { position:fixed; top:70px; right:12px; z-index:10; }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid px-3">
  <div class="d-flex justify-content-between align-items-center mt-2 mb-2">
    <div>
      <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
      <span class="ms-2 fw-semibold">Session #{{ booking.id }} â€¢ {{ booking.start_utc.strftime('%Y-%m-%d %H:%M') }} UTC</span>
    </div>
    <div>
      <span class="badge bg-primary">Room: {{ room_name }}</span>
    </div>
  </div>
</div>
<span class="badge bg-info badge-role">{{ role|capitalize }}</span>
<div id="meetingRoot"
  data-room="{{ room_name }}"
  data-base="{{ base_url }}"
  data-display="{{ display_name }}"
  data-email="{{ email or '' }}"
  data-jwt="{{ jwt_token or '' }}"></div>
<div id="meetingContainer"></div>
<script src="https://meet.jit.si/external_api.js"></script>
<script>
(function(){
  const root = document.getElementById('meetingRoot');
  if(!root){ return; }
  const roomName = root.dataset.room;
  const base = root.dataset.base || 'https://meet.jit.si';
  const displayName = root.dataset.display || 'Participant';
  const email = root.dataset.email || undefined;
  const domain = base.replace(/^https?:\/\//,'');
  const jwtToken = root.dataset.jwt || null;
  const options = {
    roomName: roomName,
    parentNode: document.getElementById('meetingContainer'),
    userInfo: { displayName: displayName, email: email },
    configOverwrite: {
      prejoinPageEnabled: false,          // legacy flag
      prejoinConfig: { enabled: false },  // newer flag
      startWithAudioMuted: false,
      startWithVideoMuted: false,
      disableModeratorIndicator: true,
      toolbarConfig: { alwaysVisible: true }
    },
    interfaceConfigOverwrite: {
      DISABLE_JOIN_LEAVE_NOTIFICATIONS:false,
      HIDE_PREJOIN_DISPLAY_NAME:true,
      PREJOIN_PAGE_ENABLED:false
    },
    jwt: jwtToken || undefined
  };
  try {
    const api = new JitsiMeetExternalAPI(domain, options);
    api.addEventListener('videoConferenceJoined', () => {
      console.log('Joined meeting as', displayName);
      // Try to disable lobby if we are moderator
      try {
        if(api.isParticipantModerator){
          api.isParticipantModerator().then(isMod => {
            if(isMod && api.executeCommand){
              try { api.executeCommand('toggleLobby', false); console.log('Attempted lobby disable'); } catch(e){ /* ignore */ }
            }
          });
        }
      } catch(e){ console.warn('Lobby disable attempt failed', e); }
    });
  } catch(e){
    console.error('Jitsi init failed', e);
    document.getElementById('meetingContainer').innerHTML='<div class="text-danger p-4">Failed to load meeting.</div>';
  }
})();
</script>
{% endblock %}
