{% extends "layout.html" %}
{% block content %}
{% include 'partials/_brand_header.html' %}
<div class="container py-3">
  <h2 class="mb-3">Mutual Funds</h2>
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <label class="form-label">Search scheme</label>
          <input id="mfQuery" class="form-control" placeholder="Name or Code" />
          <div class="d-flex gap-2 mt-2">
            <button id="btnSearch" class="btn btn-primary btn-sm">Search</button>
            <button id="btnTop" class="btn btn-outline-secondary btn-sm">Top Returns (1Y)</button>
          </div>
        </div>
      </div>
      <div class="card mt-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Top Funds</span>
          <small class="text-muted">current & predicted</small>
        </div>
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-4">
              <label class="form-label small">Limit</label>
              <input id="topLimit" class="form-control form-control-sm" type="number" value="10" min="5" max="50" />
            </div>
            <div class="col-8">
              <label class="form-label small">Sample size</label>
              <input id="topSample" class="form-control form-control-sm" type="number" value="400" min="50" max="800" />
            </div>
          </div>
          <div class="d-flex gap-2 mt-2">
            <button id="btnLoadTop" class="btn btn-sm btn-success">Load Top</button>
            <button id="btnLoadPred" class="btn btn-sm btn-outline-success">Load Predicted</button>
          </div>
          <div class="mt-3 small text-muted">Uses query filter if provided; random sample to control API load.</div>
          <div class="row mt-3 g-2">
            <div class="col-12">
              <div><b>Top Current</b></div>
              <ul id="topCurrent" class="list-group" style="max-height: 240px; overflow:auto"></ul>
            </div>
            <div class="col-12">
              <div class="mt-2"><b>Top Predicted</b></div>
              <ul id="topPredicted" class="list-group" style="max-height: 240px; overflow:auto"></ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-header">Schemes</div>
        <div class="card-body" style="max-height: 400px; overflow:auto">
          <ul id="schemeList" class="list-group"></ul>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span id="schemeTitle">Select a scheme</span>
          <small id="schemeMeta" class="text-muted"></small>
        </div>
        <div class="card-body">
          <div id="latestNav" class="mb-2"></div>
          <div id="metrics" class="mb-3"></div>
          <div id="insights" class="mb-3"></div>
          <div class="mb-3 border rounded p-2 bg-light">
            <div class="d-flex align-items-end gap-2 flex-wrap">
              <div>
                <label class="form-label small">SIP Amount (₹)</label>
                <input id="sipAmount" class="form-control form-control-sm" type="number" value="1000" min="100" step="100" />
              </div>
              <div>
                <label class="form-label small">Period (years)</label>
                <input id="sipYears" class="form-control form-control-sm" type="number" value="3" min="1" max="10" />
              </div>
              <button id="btnSIP" class="btn btn-sm btn-primary">Calculate SIP</button>
              <div id="sipResult" class="small text-muted"></div>
            </div>
          </div>
          <canvas id="navChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function(){
  const el = (id)=>document.getElementById(id);
  const listEl = el('schemeList');
  const titleEl = el('schemeTitle');
  const metaEl = el('schemeMeta');
  const latestEl = el('latestNav');
  const metricsEl = el('metrics');
  const insightsEl = el('insights');
  const qEl = el('mfQuery');
  const topLimitEl = el('topLimit');
  const topSampleEl = el('topSample');
  const topCurrEl = el('topCurrent');
  const topPredEl = el('topPredicted');
  let chart;
  let currentCode = null;

  async function fetchJSON(url){
    const r = await fetch(url);
    return await r.json();
  }
  function formatPct(x){ return (x==null?'-':(x*100).toFixed(2)+'%'); }

  async function loadSchemes(q){
    const res = await fetchJSON('/api/mf/schemes'+(q?`?q=${encodeURIComponent(q)}`:''));
    listEl.innerHTML='';
    if(!res.ok){ listEl.innerHTML='<li class="list-group-item text-danger">Failed to load</li>'; return; }
    res.schemes.forEach(s=>{
      const li = document.createElement('li');
      li.className='list-group-item list-group-item-action';
      li.textContent = `${s.schemeName} (${s.schemeCode})`;
      li.onclick = ()=> selectScheme(s.schemeCode, s.schemeName);
      listEl.appendChild(li);
    });
  }

  async function selectScheme(code, name){
    titleEl.textContent = `${name} (${code})`;
    metaEl.textContent = '';
    latestEl.textContent = 'Loading...';
    metricsEl.innerHTML = '';
    insightsEl.innerHTML = '';
    currentCode = code;

    const [detail, latest, metrics] = await Promise.all([
      fetchJSON(`/api/mf/${code}`),
      fetchJSON(`/api/mf/${code}/latest`),
      fetchJSON(`/api/mf/${code}/metrics`)
    ]);

    if(detail.ok){
      const m = detail.meta||{};
      metaEl.textContent = `${m.fund_house||''} · ${m.scheme_category||''} · ${m.scheme_type||''}`;
      // Chart (oldest -> newest)
      const rows = (detail.data||[]).slice().reverse();
      const labels = rows.map(d=>d.date);
      const values = rows.map(d=>parseFloat(d.nav));
      if(chart) chart.destroy();
      const ctx = document.getElementById('navChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'NAV', data: values, borderColor: '#3a86ff', fill:false, tension: 0.1 }]},
        options: { scales: { x: { display:true }}} 
      });
    }
    if(latest.ok){
      const d = (latest.data||[])[0];
      if(d){ latestEl.innerHTML = `<b>Latest:</b> ₹${parseFloat(d.nav).toFixed(4)} <small class="text-muted">(${d.date})</small>`; }
    } else { latestEl.textContent = '—'; }

    if(metrics.ok){
      const mm = metrics.metrics || {};
      const r = mm.returns || {};
      metricsEl.innerHTML = `
        <div class="row g-2">
          <div class="col-6 col-md-3"><small>1M</small><div>${formatPct(r['1M'])}</div></div>
          <div class="col-6 col-md-3"><small>3M</small><div>${formatPct(r['3M'])}</div></div>
          <div class="col-6 col-md-3"><small>6M</small><div>${formatPct(r['6M'])}</div></div>
          <div class="col-6 col-md-3"><small>1Y</small><div>${formatPct(r['1Y'])}</div></div>
          <div class="col-6 col-md-3"><small>3Y</small><div>${formatPct(r['3Y'])}</div></div>
          <div class="col-6 col-md-3"><small>5Y</small><div>${formatPct(r['5Y'])}</div></div>
          <div class="col-6 col-md-3"><small>CAGR Max</small><div>${formatPct(r['CAGR_max'])}</div></div>
          <div class="col-6 col-md-3"><small>Vol (ann)</small><div>${mm.volatility_ann?mm.volatility_ann.toFixed(2):'-'}</div></div>
          <div class="col-6 col-md-3"><small>Sharpe</small><div>${mm.sharpe?mm.sharpe.toFixed(2):'-'}</div></div>
          <div class="col-6 col-md-3"><small>Max DD</small><div>${formatPct(mm.max_drawdown)}</div></div>
        </div>`;
    }

    // Load insights
    try {
      const ins = await fetchJSON(`/api/mf/${code}/insights`);
      if(ins.ok){
        const c = ins.insights?.consistency || {};
        const rec = ins.insights?.recovery_days_from_last_trough;
        insightsEl.innerHTML = `
          <div class="small"><b>Insights:</b> Positive months (1Y): ${c.positive_month_ratio_1Y!=null?(c.positive_month_ratio_1Y*100).toFixed(0)+'%':'-'} · Positive 3M rolls (1Y): ${c.positive_rolling3m_ratio_1Y!=null?(c.positive_rolling3m_ratio_1Y*100).toFixed(0)+'%':'-'} · Recovery from last trough: ${rec!=null?rec+' days':'—'}</div>
        `;
      }
    } catch(_){}
  }

  el('btnSearch').onclick = ()=> loadSchemes(qEl.value);
  async function loadTop(mode){
    const limit = parseInt(topLimitEl.value||'10');
    const sample = parseInt(topSampleEl.value||'400');
    const q = qEl.value?`&q=${encodeURIComponent(qEl.value)}`:'';
    const url = `/api/mf/top?mode=${mode}&limit=${limit}&sample=${sample}&randomize=1${q}`;
    topCurrEl.innerHTML = '<li class="list-group-item">Loading...</li>';
    topPredEl.innerHTML = '<li class="list-group-item">Loading...</li>';
    try{
      const res = await fetchJSON(url);
      if(!res.ok){
        topCurrEl.innerHTML = '<li class="list-group-item text-danger">Failed</li>';
        topPredEl.innerHTML = '<li class="list-group-item text-danger">Failed</li>';
        return;
      }
      function render(list, items, which){
        list.innerHTML='';
        (items||[]).forEach((it)=>{
          const li = document.createElement('li');
          li.className='list-group-item list-group-item-action';
          const r = it.returns||{};
          li.innerHTML = `<div class="d-flex justify-content-between align-items-center">
            <div>${it.schemeName} (${it.schemeCode})<br/><small class="text-muted">1M ${formatPct(r['1M'])} · 3M ${formatPct(r['3M'])} · 1Y ${formatPct(r['1Y'])}</small></div>
            <div class="text-end"><small>${which} score</small><div>${(which==='current'?it.scores?.current:it.scores?.predicted)?.toFixed? (which==='current'?it.scores.current:it.scores.predicted).toFixed(3) : '-'}</div></div>
          </div>`;
          li.onclick = ()=> selectScheme(it.schemeCode, it.schemeName);
          list.appendChild(li);
        });
        if(!items || items.length===0){
          list.innerHTML = '<li class="list-group-item">No results</li>';
        }
      }
      if(mode==='both' || mode==='current') render(topCurrEl, res.top_current, 'current');
      if(mode==='both' || mode==='predicted') render(topPredEl, res.top_predicted, 'predicted');
    } catch(err){
      topCurrEl.innerHTML = '<li class="list-group-item text-danger">Error</li>';
      topPredEl.innerHTML = '<li class="list-group-item text-danger">Error</li>';
    }
  }
  el('btnLoadTop').onclick = ()=> loadTop('both');
  el('btnLoadPred').onclick = ()=> loadTop('predicted');
  el('btnSIP').onclick = async ()=>{
    if(!currentCode){ el('sipResult').textContent='Select a scheme first.'; return; }
    const amt = parseFloat(el('sipAmount').value||'1000');
    const yrs = parseInt(el('sipYears').value||'3');
    el('sipResult').textContent = 'Calculating...';
    try{
      const res = await fetchJSON(`/api/mf/${currentCode}/sip?amount=${amt}&period_years=${yrs}`);
      if(res.ok){
        const s = res.sip;
        el('sipResult').innerHTML = `Invested ₹${s.invested.toFixed(0)} → Value ₹${s.value.toFixed(0)} · CAGR ~ ${s.cagr!=null?(s.cagr*100).toFixed(2)+'%':'-'} (${s.months} months)`;
      } else {
        el('sipResult').textContent = res.error||'SIP failed';
      }
    } catch(err){
      el('sipResult').textContent = 'SIP failed';
    }
  };
  el('btnTop').onclick = async ()=>{
    // naive top: filter by query then sort by 1Y
    const res = await fetchJSON('/api/mf/schemes?limit=300');
    const items = res.ok?res.schemes:[];
    // fetch metrics in small batches
    const sample = items.slice(0, 30);
    const scored = [];
    for(const s of sample){
      try {
        const m = await fetchJSON(`/api/mf/${s.schemeCode}/metrics`);
        const r = (m.metrics||{}).returns||{};
        const y = r['1Y'];
        if(y!=null) scored.push({s, score:y});
      } catch(_){}
    }
    scored.sort((a,b)=> (b.score||0) - (a.score||0));
    listEl.innerHTML='';
    scored.slice(0,20).forEach(({s, score})=>{
      const li = document.createElement('li');
      li.className='list-group-item list-group-item-action';
      li.textContent = `${s.schemeName} (${s.schemeCode}) · 1Y ${formatPct(score)}`;
      li.onclick = ()=> selectScheme(s.schemeCode, s.schemeName);
      listEl.appendChild(li);
    });
  };

  // initial with URL params
  const params = new URLSearchParams(location.search);
  const initQ = params.get('q');
  if(initQ){ qEl.value = initQ; }
  await loadSchemes(initQ || 'index');
  const initCode = params.get('code');
  if(initCode){
    try {
      const det = await fetchJSON(`/api/mf/${initCode}`);
      const name = det?.meta?.scheme_name || `${initCode}`;
      await selectScheme(initCode, name);
    } catch(_){ /* ignore */ }
  }
})();
</script>
{% endblock %}
