{% extends "layout.html" %}
{% block title %}RIMSI-T Terminal - Advanced AI Financial Intelligence{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-2">RIMSI-T Terminal: AI Risk Management Super Intelligence</h2>
      <p class="text-muted">Advanced LLM-powered financial analysis, code generation, and portfolio optimization</p>
    </div>
  </div>

  <div class="row">
    <!-- Main Terminal Panel -->
    <div class="col-lg-8 mb-4">
      <div class="card h-100">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <span><i class="fas fa-terminal me-2"></i>AI Terminal</span>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-light" onclick="clearTerminal()">
              <i class="fas fa-trash"></i> Clear
            </button>
            <button type="button" class="btn btn-outline-light" onclick="exportHistory()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
        <div class="card-body p-0" style="height: 450px;">
          <div id="terminalHistory" class="h-100 p-3" style="overflow-y: auto; background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;"></div>
        </div>
        <div class="card-footer">
          <div class="input-group">
            <span class="input-group-text bg-dark text-success" style="font-family: monospace;">RIMSI></span>
            <input id="terminalInput" type="text" class="form-control" 
                   placeholder="Type your query (e.g., 'Build me a moving average crossover strategy with stop-loss')" 
                   style="font-family: monospace;">
            <button id="terminalSubmit" class="btn btn-primary">
              <i class="fas fa-play"></i> Execute
            </button>
          </div>
          <div class="mt-2">
            <small class="text-muted">
              Examples: "Build RSI strategy", "Analyze AAPL risk", "Optimize portfolio", "Explain Sharpe ratio"
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="col-lg-4 mb-4">
      <div class="row">
        <!-- Quick Actions -->
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <i class="fas fa-bolt me-2"></i>Quick Actions
            </div>
            <div class="card-body p-2">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="runQuickCommand('code', 'Generate a moving average crossover strategy with stop-loss')">
                  <i class="fas fa-code"></i> Generate Trading Strategy
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runQuickCommand('risk', 'Analyze risk profile of AAPL stock')">
                  <i class="fas fa-shield-alt"></i> Analyze Stock Risk
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="runQuickCommand('portfolio', 'Optimize portfolio for maximum Sharpe ratio')">
                  <i class="fas fa-chart-pie"></i> Optimize Portfolio
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="runQuickCommand('explain', 'Explain what is the Sharpe ratio and how to improve it')">
                  <i class="fas fa-question-circle"></i> Explain Concepts
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- LLM Status -->
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header bg-info text-white">
              <i class="fas fa-brain me-2"></i>AI Engine Status
            </div>
            <div class="card-body">
              <div id="llmStatus" class="mb-2">
                <span class="badge bg-success">Ready</span>
                <small class="text-muted ms-2">Ollama/Mistral</small>
              </div>
              <div class="progress mb-2" style="height: 6px;">
                <div id="processingProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
              </div>
              <div id="llmOutput" style="min-height: 80px; max-height: 200px; overflow-y: auto; font-size: 12px;">
                <div class="text-muted">LLM responses will appear here...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Context -->
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header bg-secondary text-white">
              <i class="fas fa-database me-2"></i>Active Context
            </div>
            <div class="card-body">
              <div class="mb-2">
                <label class="form-label small">Symbol:</label>
                <input type="text" class="form-control form-control-sm" id="activeSymbol" placeholder="e.g., AAPL" value="SPY">
              </div>
              <div class="mb-2">
                <label class="form-label small">Portfolio Value:</label>
                <input type="number" class="form-control form-control-sm" id="portfolioValue" placeholder="100000" value="100000">
              </div>
              <div class="mb-2">
                <label class="form-label small">Risk Level:</label>
                <select class="form-select form-select-sm" id="riskLevel">
                  <option value="conservative">Conservative</option>
                  <option value="moderate" selected>Moderate</option>
                  <option value="aggressive">Aggressive</option>
                </select>
              </div>
              <button class="btn btn-outline-secondary btn-sm w-100" onclick="updateContext()">
                <i class="fas fa-sync"></i> Update Context
              </button>
            </div>
          </div>
        </div>

        <!-- TradingView Connection -->
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header bg-dark text-white">
              <i class="fas fa-chart-area me-2"></i>TradingView Connection
            </div>
            <div class="card-body">
              <div id="tradingViewStatus" class="mb-3">
                <div class="d-flex align-items-center">
                  <span id="tvConnectionBadge" class="badge bg-secondary me-2">Disconnected</span>
                  <small class="text-muted" id="tvStatusText">Not connected</small>
                </div>
              </div>
              
              <div id="tvConnectionForm">
                <div class="mb-2">
                  <label class="form-label small">TradingView Username:</label>
                  <input type="text" class="form-control form-control-sm" id="tvUsername" placeholder="Your TradingView username">
                </div>
                <div class="mb-2">
                  <label class="form-label small">Password:</label>
                  <input type="password" class="form-control form-control-sm" id="tvPassword" placeholder="Your TradingView password">
                  <small class="text-muted">For chart access and Pine Editor</small>
                </div>
                <div class="mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tvRememberMe" checked>
                    <label class="form-check-label small" for="tvRememberMe">
                      Remember credentials
                    </label>
                  </div>
                </div>
                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="connectTradingView()">
                  <i class="fas fa-link"></i> Connect to TradingView
                </button>
                <button class="btn btn-outline-danger btn-sm w-100" onclick="disconnectTradingView()" style="display:none;" id="tvDisconnectBtn">
                  <i class="fas fa-unlink"></i> Disconnect
                </button>
              </div>
              
              <div id="tvConnectedFeatures" style="display:none;">
                <div class="text-success mb-2">
                  <i class="fas fa-check-circle"></i> Connected successfully!
                </div>
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-success btn-sm" onclick="openTradingViewChart()">
                    <i class="fas fa-chart-line"></i> Open Chart Viewer
                  </button>
                  <button class="btn btn-outline-info btn-sm" onclick="openPineEditor()">
                    <i class="fas fa-code"></i> Open Pine Editor
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="openTradingViewDashboard()">
                    <i class="fas fa-external-link-alt"></i> Open TradingView
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="viewPortfolio()">
                    <i class="fas fa-briefcase"></i> View Portfolio
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Panel -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="resultTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="backtest-tab" data-bs-toggle="tab" data-bs-target="#backtest" type="button" role="tab">
                <i class="fas fa-chart-line"></i> Backtest Results
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk" type="button" role="tab">
                <i class="fas fa-exclamation-triangle"></i> Risk Analysis
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button" role="tab">
                <i class="fas fa-balance-scale"></i> Portfolio
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="code-tab" data-bs-toggle="tab" data-bs-target="#code" type="button" role="tab">
                <i class="fas fa-code"></i> Generated Code
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="resultTabContent">
            <!-- Backtest Results -->
            <div class="tab-pane fade show active" id="backtest" role="tabpanel">
              <div id="backtestResults">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-chart-line fa-3x mb-3"></i>
                  <p>Run a backtest to see performance metrics here</p>
                </div>
              </div>
            </div>

            <!-- Risk Analysis -->
            <div class="tab-pane fade" id="risk" role="tabpanel">
              <div id="riskResults">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-shield-alt fa-3x mb-3"></i>
                  <p>Risk analysis results will appear here</p>
                </div>
              </div>
            </div>

            <!-- Portfolio -->
            <div class="tab-pane fade" id="portfolio" role="tabpanel">
              <div id="portfolioResults">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-chart-pie fa-3x mb-3"></i>
                  <p>Portfolio optimization results will appear here</p>
                </div>
              </div>
            </div>

            <!-- Generated Code -->
            <div class="tab-pane fade" id="code" role="tabpanel">
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Generated Code</h6>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="copyCode()">
                      <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn btn-outline-primary" onclick="runGeneratedCode()">
                      <i class="fas fa-play"></i> Test
                    </button>
                    <button class="btn btn-outline-success" id="openTradingViewBtn" onclick="openInTradingView()" style="display:none;">
                      <i class="fas fa-external-link-alt"></i> Open in TradingView
                    </button>
                  </div>
                </div>
                <pre id="generatedCode" class="bg-dark text-light p-3 rounded" style="min-height: 200px; max-height: 400px; overflow-y: auto;"><code># Generated code will appear here
# Use the terminal to generate trading strategies, risk models, or analysis code</code></pre>
              </div>
              
              <!-- TradingView Chart Container (Hidden by default) -->
              <div id="tradingViewContainer" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">üìä TradingView Chart Preview</h6>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="refreshTradingViewChart()">
                      <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-outline-danger" onclick="hideTradingViewChart()">
                      <i class="fas fa-times"></i> Hide
                    </button>
                  </div>
                </div>
                <div id="tradingViewWidget" style="height: 500px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: #f8f9fa;">
                  <!-- TradingView widget will be loaded here -->
                </div>
                <div class="mt-2">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    This chart shows a sample visualization. Copy the Pine Script code above and paste it in TradingView's Pine Editor for live trading.
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='rimsi-terminal-api-enhanced.js') }}"></script>
<script>
// Global state
let currentContext = {};
let processingCommand = false;

// Terminal management
function appendToTerminal(text, type = 'system', timestamp = true) {
  const terminal = document.getElementById('terminalHistory');
  const time = timestamp ? new Date().toLocaleTimeString() : '';
  
  let className = 'terminal-system';
  let prefix = 'SYSTEM';
  let color = '#00ff00';
  
  switch(type) {
    case 'user':
      className = 'terminal-user';
      prefix = 'USER';
      color = '#00aaff';
      break;
    case 'ai':
      className = 'terminal-ai';
      prefix = 'RIMSI';
      color = '#ff6b00';
      break;
    case 'error':
      className = 'terminal-error';
      prefix = 'ERROR';
      color = '#ff4444';
      break;
    case 'success':
      className = 'terminal-success';
      prefix = 'SUCCESS';
      color = '#44ff44';
      break;
  }
  
  const div = document.createElement('div');
  div.className = className;
  div.style.marginBottom = '8px';
  div.innerHTML = `
    <span style="color: ${color}; font-weight: bold;">[${prefix}]</span>
    ${timestamp ? `<span style="color: #888; font-size: 11px;">${time}</span>` : ''}
    <div style="margin-left: 10px; margin-top: 2px;">${text}</div>
  `;
  
  terminal.appendChild(div);
  terminal.scrollTop = terminal.scrollHeight;
}

function clearTerminal() {
  document.getElementById('terminalHistory').innerHTML = '';
  appendToTerminal('Terminal cleared. Ready for new commands.', 'system');
}

// Command processing
async function processCommand(command) {
  if (processingCommand) {
    appendToTerminal('Another command is already being processed. Please wait.', 'error');
    return;
  }
  
  if (!command.trim()) {
    appendToTerminal('Please enter a command.', 'error');
    return;
  }
  
  processingCommand = true;
  updateLLMStatus('Processing...', 'warning');
  showProgress(20);
  
  try {
    appendToTerminal(command, 'user');
    
    // Use the enhanced API's RIMSITerminal class
    if (window.rimsiTerminal) {
      const result = await window.rimsiTerminal.sendCommand(command);
      handleGenericResult(result);
    } else {
      // Fallback to direct API call
      const result = await rimsiSendCommand(command, currentContext);
      handleGenericResult(result);
    }
    
    showProgress(100);
    updateLLMStatus('Ready', 'success');
    
  } catch (error) {
    appendToTerminal(`Error: ${error.message}`, 'error');
    updateLLMStatus('Error', 'danger');
  } finally {
    processingCommand = false;
    setTimeout(() => showProgress(0), 1000);
  }
}

function detectCommandType(command) {
  const cmd = command.toLowerCase();
  if (cmd.includes('generate') || cmd.includes('build') || cmd.includes('create') || cmd.includes('code')) {
    return 'codegen';
  } else if (cmd.includes('backtest') || cmd.includes('test') || cmd.includes('performance')) {
    return 'backtest';
  } else if (cmd.includes('risk') || cmd.includes('var') || cmd.includes('volatility')) {
    return 'risk';
  } else if (cmd.includes('portfolio') || cmd.includes('optimize') || cmd.includes('allocation')) {
    return 'portfolio';
  } else if (cmd.includes('explain') || cmd.includes('what is') || cmd.includes('how does')) {
    return 'explain';
  } else {
    return 'general';
  }
}

// Result handlers
function handleCodegenResult(result) {
  if (result.code) {
    document.getElementById('generatedCode').textContent = result.code;
    document.querySelector('#code-tab').click(); // Switch to code tab
    appendToTerminal(`Code generated successfully. Language: ${result.language || 'Python'}`, 'success');
    if (result.explanation) {
      appendToTerminal(result.explanation, 'ai');
    }
  } else {
    appendToTerminal('Code generation failed.', 'error');
  }
}

function handleBacktestResult(result) {
  if (result.results && !result.results.error) {
    displayBacktestResults(result.results);
    document.querySelector('#backtest-tab').click();
    appendToTerminal('Backtest completed successfully.', 'success');
  } else {
    appendToTerminal(`Backtest failed: ${result.results?.error || 'Unknown error'}`, 'error');
  }
}

function handleRiskResult(result) {
  if (result.summary) {
    displayRiskResults(result);
    document.querySelector('#risk-tab').click();
    appendToTerminal('Risk analysis completed.', 'success');
    appendToTerminal(result.summary, 'ai');
  } else {
    appendToTerminal('Risk analysis failed.', 'error');
  }
}

function handlePortfolioResult(result) {
  if (result.optimization) {
    displayPortfolioResults(result);
    document.querySelector('#portfolio-tab').click();
    appendToTerminal('Portfolio optimization completed.', 'success');
  } else {
    appendToTerminal('Portfolio optimization failed.', 'error');
  }
}

function handleExplainResult(result) {
  if (result.explanation) {
    appendToTerminal(result.explanation, 'ai');
  } else {
    appendToTerminal('Explanation failed.', 'error');
  }
}

function handleGenericResult(result) {
  // Check for Pine Script in the output text first
  const outputText = result.output || result.response || '';
  const pineScriptCode = extractPineScriptFromText(outputText);
  
  // Handle different types of results
  if (result.code && result.code.trim()) {
    // Code generation result
    document.getElementById('generatedCode').textContent = result.code;
    document.querySelector('#code-tab').click(); // Switch to code tab
    
    const codeLanguage = result.language || 'python';
    appendToTerminal(`Code generated successfully. Type: ${codeLanguage}`, 'success');
    
    // Check if it's Pine Script and show TradingView chart
    if (codeLanguage.toLowerCase().includes('pine') || result.code.includes('@version=5') || result.code.includes('strategy(')) {
      showTradingViewChart(result.code);
      appendToTerminal('üìä TradingView chart loaded below the code for visualization', 'success');
    }
    
    if (result.explanation || result.output) {
      appendToTerminal(result.explanation || result.output, 'ai');
    }
    
    // Store code in context for future operations
    currentContext.generatedCode = result.code;
    currentContext.codeLanguage = codeLanguage;
    
  } else if (pineScriptCode) {
    // Pine Script detected in text output
    document.getElementById('generatedCode').textContent = pineScriptCode;
    document.querySelector('#code-tab').click(); // Switch to code tab
    
    appendToTerminal('Pine Script code generated successfully!', 'success');
    appendToTerminal(outputText, 'ai'); // Show full response in terminal
    
    // Show TradingView chart
    showTradingViewChart(pineScriptCode);
    appendToTerminal('üìä TradingView chart loaded - click "Test" to view', 'success');
    
    // Store code in context for future operations
    currentContext.generatedCode = pineScriptCode;
    currentContext.codeLanguage = 'pinescript';
    
  } else if (result.backtest_results && !result.backtest_results.error) {
    // Backtest results
    displayBacktestResults(result.backtest_results);
    document.querySelector('#backtest-tab').click();
    appendToTerminal('Backtest completed successfully.', 'success');
    
  } else if (result.risk_metrics) {
    // Risk analysis results
    displayRiskResults(result);
    document.querySelector('#risk-tab').click();
    appendToTerminal('Risk analysis completed.', 'success');
    
  } else if (result.optimization) {
    // Portfolio optimization results
    displayPortfolioResults(result);
    document.querySelector('#portfolio-tab').click();
    appendToTerminal('Portfolio optimization completed.', 'success');
    
  } else if (result.output) {
    // General output
    appendToTerminal(result.output, 'ai');
    
  } else {
    appendToTerminal('Command processed but no output received.', 'error');
  }
  
  // Show any suggestions
  if (result.suggestions && result.suggestions.length > 0) {
    result.suggestions.forEach(suggestion => {
      appendToTerminal(`üí° ${suggestion}`, 'ai');
    });
  }
}

// Display functions
function displayBacktestResults(results) {
  const container = document.getElementById('backtestResults');
  
  if (results.error) {
    container.innerHTML = `<div class="alert alert-danger">${results.error}</div>`;
    return;
  }
  
  const html = `
    <div class="row">
      <div class="col-md-6">
        <h6>Performance Metrics</h6>
        <table class="table table-sm">
          <tr><td>Total Return</td><td class="text-end">${formatPercentage(results.total_return)}</td></tr>
          <tr><td>Annualized Return</td><td class="text-end">${formatPercentage(results.annualized_return)}</td></tr>
          <tr><td>Sharpe Ratio</td><td class="text-end">${formatNumber(results.sharpe_ratio)}</td></tr>
          <tr><td>Volatility</td><td class="text-end">${formatPercentage(results.volatility)}</td></tr>
        </table>
      </div>
      <div class="col-md-6">
        <h6>Risk Metrics</h6>
        <table class="table table-sm">
          <tr><td>Max Drawdown</td><td class="text-end">${formatPercentage(results.max_drawdown)}</td></tr>
          <tr><td>Win Rate</td><td class="text-end">${formatPercentage(results.win_rate)}</td></tr>
          <tr><td>Total Trades</td><td class="text-end">${results.total_trades || 'N/A'}</td></tr>
          <tr><td>Final Value</td><td class="text-end">$${formatNumber(results.final_value)}</td></tr>
        </table>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

function displayRiskResults(result) {
  const container = document.getElementById('riskResults');
  
  let html = `<div class="mb-3"><h6>Risk Summary</h6><p>${result.summary}</p></div>`;
  
  if (result.suggestions && result.suggestions.length > 0) {
    html += '<div class="mb-3"><h6>Recommendations</h6><ul>';
    result.suggestions.forEach(suggestion => {
      html += `<li>${suggestion}</li>`;
    });
    html += '</ul></div>';
  }
  
  if (result.risk_metrics) {
    html += '<div><h6>Risk Metrics</h6><pre class="bg-light p-2">' + 
            JSON.stringify(result.risk_metrics, null, 2) + '</pre></div>';
  }
  
  container.innerHTML = html;
}

function displayPortfolioResults(result) {
  const container = document.getElementById('portfolioResults');
  
  if (result.optimization && result.optimization.error) {
    container.innerHTML = `<div class="alert alert-danger">${result.optimization.error}</div>`;
    return;
  }
  
  const opt = result.optimization;
  let html = `
    <div class="row">
      <div class="col-md-6">
        <h6>Portfolio Optimization</h6>
        <table class="table table-sm">
          <tr><td>Expected Return</td><td class="text-end">${formatPercentage(opt.expected_return)}</td></tr>
          <tr><td>Volatility</td><td class="text-end">${formatPercentage(opt.volatility)}</td></tr>
          <tr><td>Sharpe Ratio</td><td class="text-end">${formatNumber(opt.sharpe_ratio)}</td></tr>
          <tr><td>Method</td><td class="text-end">${opt.method}</td></tr>
        </table>
      </div>
      <div class="col-md-6">
        <h6>Asset Allocation</h6>
  `;
  
  if (opt.weights) {
    html += '<table class="table table-sm">';
    Object.entries(opt.weights).forEach(([symbol, weight]) => {
      if (weight > 0.01) {
        html += `<tr><td>${symbol}</td><td class="text-end">${formatPercentage(weight)}</td></tr>`;
      }
    });
    html += '</table>';
  }
  
  html += '</div></div>';
  
  container.innerHTML = html;
}

// Pine Script extraction function
function extractPineScriptFromText(text) {
  if (!text || typeof text !== 'string') return null;
  
  // Look for Pine Script code blocks
  const patterns = [
    // Standard code blocks with pinescript
    /```pinescript\s*([\s\S]*?)```/gi,
    // Code blocks without language specification but with Pine Script indicators
    /```\s*(\/\/@version=5[\s\S]*?)```/gi,
    // Look for Pine Script indicators without code blocks
    /\/\/@version=5[\s\S]*?(?=\n\n|\n[A-Z]|\n\d+\.|\nRisk|\nAs with|$)/gi,
    // Look for indicator() or strategy() function calls
    /(indicator\([\s\S]*?plot\([^)]*\))/gi,
    // Look for strategy() function calls
    /(strategy\([\s\S]*?(?:strategy\.entry|strategy\.close)[^)]*\))/gi
  ];
  
  for (const pattern of patterns) {
    const matches = text.match(pattern);
    if (matches && matches.length > 0) {
      let code = matches[0];
      
      // Clean up the code
      code = code.replace(/```pinescript\s*/gi, '').replace(/```\s*$/g, '');
      code = code.trim();
      
      // Validate it looks like Pine Script
      if (code.includes('@version=5') || 
          code.includes('indicator(') || 
          code.includes('strategy(') ||
          code.includes('plot(') ||
          code.includes('hline(')) {
        return code;
      }
    }
  }
  
  return null;
}

// API calls
async function callPortfolioAPI(command) {
  const symbols = extractSymbolsFromCommand(command);
  const response = await fetch('/api/rimsi/portfolio', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      symbols: symbols.length > 0 ? symbols : ['SPY', 'QQQ', 'IWM'],
      method: 'auto',
      objective: 'sharpe',
      total_value: parseInt(document.getElementById('portfolioValue').value) || 100000
    })
  });
  return await response.json();
}

async function callExplainAPI(topic) {
  const response = await fetch('/api/rimsi/explain', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({topic})
  });
  return await response.json();
}

// Utility functions
function extractSymbolsFromCommand(command) {
  const matches = command.match(/\b[A-Z]{1,5}\b/g);
  return matches ? matches.filter(m => m.length <= 5) : [];
}

function formatPercentage(value) {
  if (value === undefined || value === null) return 'N/A';
  return (value * 100).toFixed(2) + '%';
}

function formatNumber(value) {
  if (value === undefined || value === null) return 'N/A';
  return parseFloat(value).toFixed(2);
}

function getContextCode() {
  // First try to get from current context (latest generated)
  if (currentContext.generatedCode) {
    return currentContext.generatedCode;
  }
  // Fallback to what's displayed in the UI
  return document.getElementById('generatedCode').textContent.trim();
}

function getActiveSymbol() {
  return document.getElementById('activeSymbol').value || 'SPY';
}

function updateLLMStatus(status, type) {
  const statusEl = document.getElementById('llmStatus');
  const badgeClass = type === 'success' ? 'bg-success' : 
                    type === 'warning' ? 'bg-warning' : 
                    type === 'danger' ? 'bg-danger' : 'bg-info';
  statusEl.innerHTML = `
    <span class="badge ${badgeClass}">${status}</span>
    <small class="text-muted ms-2">Ollama/Mistral</small>
  `;
}

function showProgress(percent) {
  document.getElementById('processingProgress').style.width = percent + '%';
}

function runQuickCommand(type, command) {
  document.getElementById('terminalInput').value = command;
  processCommand(command);
}

function updateContext() {
  currentContext = {
    symbol: document.getElementById('activeSymbol').value,
    portfolioValue: document.getElementById('portfolioValue').value,
    riskLevel: document.getElementById('riskLevel').value
  };
  appendToTerminal(`Context updated: ${JSON.stringify(currentContext)}`, 'system');
}

function copyCode() {
  const code = document.getElementById('generatedCode').textContent;
  navigator.clipboard.writeText(code).then(() => {
    appendToTerminal('Code copied to clipboard.', 'success');
  });
}

function runGeneratedCode() {
  const code = getContextCode();
  if (code.trim() && !code.includes('Generated code will appear here')) {
    
    // Check if it's Pine Script code
    if (currentContext.codeLanguage === 'pinescript' || 
        code.includes('@version=5') || 
        code.includes('indicator(') || 
        code.includes('strategy(')) {
      
      // For Pine Script, show the TradingView chart
      showTradingViewChart(code);
      appendToTerminal('üå≤ Pine Script visualization loaded in TradingView chart', 'success');
      appendToTerminal('üí° You can also click "Open in TradingView" to edit the code in Pine Editor', 'system');
      
    } else {
      // For other code types, run backtest
      processCommand(`backtest this code: ${code.substring(0, 100)}...`);
    }
  } else {
    appendToTerminal('No code available to test.', 'error');
  }
}

function exportHistory() {
  // Implementation for exporting terminal history
  appendToTerminal('Export functionality coming soon.', 'system');
}

// Event listeners
document.getElementById('terminalSubmit').onclick = function() {
  const command = document.getElementById('terminalInput').value;
  if (command.trim()) {
    processCommand(command);
    document.getElementById('terminalInput').value = '';
  }
};

document.getElementById('terminalInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    document.getElementById('terminalSubmit').click();
  }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  appendToTerminal('RIMSI Terminal initialized. Advanced AI financial intelligence ready.', 'system');
  appendToTerminal('Type your commands or use the quick actions panel.', 'system');
  updateContext();
  
  // Load TradingView widget script
  loadTradingViewScript();
  
  // Initialize TradingView connection
  initializeTradingViewConnection();
});

// TradingView Integration Functions
function loadTradingViewScript() {
  if (!window.TradingView) {
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
    script.async = true;
    document.head.appendChild(script);
  }
}

function showTradingViewChart(pineScriptCode) {
  const container = document.getElementById('tradingViewContainer');
  const widget = document.getElementById('tradingViewWidget');
  
  // Show the container
  container.style.display = 'block';
  
  // Show the "Open in TradingView" button
  document.getElementById('openTradingViewBtn').style.display = 'inline-block';
  
  // Extract symbol from Pine Script code if available
  const symbol = extractSymbolFromPineScript(pineScriptCode) || 'BTCUSD';
  
  // Create TradingView widget
  widget.innerHTML = `
    <div class="tradingview-widget-container" style="height:100%;width:100%">
      <div id="tradingview_chart" class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
      <div class="tradingview-widget-copyright">
        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
          <span class="blue-text">Track all markets on TradingView</span>
        </a>
      </div>
    </div>
  `;
  
  // Load TradingView widget script and initialize
  setTimeout(() => {
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
    script.async = true;
    script.innerHTML = JSON.stringify({
      "width": "100%",
      "height": "100%",
      "symbol": symbol,
      "interval": "240",
      "timezone": "Etc/UTC",
      "theme": "light",
      "style": "1",
      "locale": "en",
      "enable_publishing": false,
      "hide_top_toolbar": false,
      "hide_legend": false,
      "save_image": false,
      "container_id": "tradingview_chart"
    });
    widget.appendChild(script);
  }, 100);
  
  // Store the Pine Script code for opening in TradingView
  currentContext.pineScriptCode = pineScriptCode;
}

function extractSymbolFromPineScript(code) {
  // Try to extract symbol from strategy title or comments
  const lines = code.split('\n');
  for (const line of lines) {
    if (line.includes('for ') || line.includes('For ')) {
      const matches = line.match(/for ([A-Z]{2,6})/i);
      if (matches) return matches[1].toUpperCase();
    }
  }
  return null;
}

function openInTradingView() {
  if (currentContext.pineScriptCode) {
    // Create a pre-filled Pine Script URL
    const encodedCode = encodeURIComponent(currentContext.pineScriptCode);
    const tradingViewUrl = `https://www.tradingview.com/pine-editor/#${encodedCode}`;
    
    // Open in new tab
    window.open(tradingViewUrl, '_blank');
    
    appendToTerminal('üå≤ Pine Script opened in TradingView Pine Editor', 'success');
  } else {
    appendToTerminal('‚ùå No Pine Script code available to open', 'error');
  }
}

function refreshTradingViewChart() {
  if (currentContext.pineScriptCode) {
    showTradingViewChart(currentContext.pineScriptCode);
    appendToTerminal('üìä TradingView chart refreshed', 'success');
  }
}

function hideTradingViewChart() {
  document.getElementById('tradingViewContainer').style.display = 'none';
  document.getElementById('openTradingViewBtn').style.display = 'none';
  appendToTerminal('üìä TradingView chart hidden', 'system');
}

// TradingView Connection Functions
let tradingViewConnection = {
  connected: false,
  username: null,
  password: null,
  rememberMe: true
};

function connectTradingView() {
  const username = document.getElementById('tvUsername').value.trim();
  const password = document.getElementById('tvPassword').value.trim();
  const rememberMe = document.getElementById('tvRememberMe').checked;
  
  if (!username) {
    appendToTerminal('‚ùå Please enter your TradingView username', 'error');
    return;
  }
  
  if (!password) {
    appendToTerminal('‚ùå Please enter your TradingView password', 'error');
    return;
  }
  
  // Show connecting status
  appendToTerminal('üîó Connecting to TradingView...', 'system');
  updateTradingViewStatus('Authenticating...', 'warning');
  
  // Make API call to authenticate
  fetch('/api/rimsi/tradingview/connect', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      username: username,
      password: password,
      remember_me: rememberMe
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Store connection details
      tradingViewConnection = {
        connected: true,
        username: username,
        password: rememberMe ? password : null,
        rememberMe: rememberMe
      };
      
      // Save to localStorage if remember me is checked
      if (rememberMe) {
        localStorage.setItem('tradingViewConnection', JSON.stringify({
          username: username,
          rememberMe: true,
          connected: true
        }));
      }
      
      updateTradingViewUI(true);
      appendToTerminal(`‚úÖ ${data.message}`, 'success');
      appendToTerminal('ÔøΩ Chart viewer and Pine Editor access enabled', 'success');
      appendToTerminal('üí° Use the buttons below to access TradingView features', 'system');
    } else {
      throw new Error(data.error || 'Authentication failed');
    }
  })
  .catch(error => {
    appendToTerminal(`‚ùå Connection failed: ${error.message}`, 'error');
    appendToTerminal('üí° Please check your username and password', 'system');
    updateTradingViewStatus('Authentication failed', 'danger');
  });
}

function disconnectTradingView() {
  tradingViewConnection = {
    connected: false,
    username: null,
    password: null,
    rememberMe: true
  };
  
  localStorage.removeItem('tradingViewConnection');
  updateTradingViewUI(false);
  
  // Clear password field for security
  document.getElementById('tvPassword').value = '';
  
  appendToTerminal('‚ùå Disconnected from TradingView', 'system');
}

function openTradingViewChart() {
  if (!tradingViewConnection.connected) {
    appendToTerminal('‚ùå Please connect to TradingView first', 'error');
    return;
  }
  
  const symbol = document.getElementById('activeSymbol').value || 'SPY';
  const chartUrl = `https://www.tradingview.com/chart/?symbol=${symbol}`;
  
  window.open(chartUrl, '_blank');
  appendToTerminal(`üìä Opened TradingView chart for ${symbol}`, 'success');
  appendToTerminal('üí° You can now view advanced charts and indicators', 'system');
}

function openPineEditor() {
  if (!tradingViewConnection.connected) {
    appendToTerminal('‚ùå Please connect to TradingView first', 'error');
    return;
  }
  
  const code = getContextCode();
  let pineEditorUrl = 'https://www.tradingview.com/pine-editor/';
  
  // If we have Pine Script code, try to pre-fill it
  if (code && !code.includes('Generated code will appear here') && 
      (code.includes('@version=5') || code.includes('strategy(') || code.includes('indicator('))) {
    const encodedCode = encodeURIComponent(code);
    pineEditorUrl += `#${encodedCode}`;
    appendToTerminal('üå≤ Opening Pine Editor with current strategy code', 'success');
  } else {
    appendToTerminal('üå≤ Opening Pine Editor', 'success');
  }
  
  window.open(pineEditorUrl, '_blank');
  appendToTerminal('üí° You can now edit and test Pine Script strategies', 'system');
}

function viewPortfolio() {
  if (!tradingViewConnection.connected) {
    appendToTerminal('‚ùå Please connect to TradingView first', 'error');
    return;
  }
  
  const portfolioUrl = `https://www.tradingview.com/u/${tradingViewConnection.username}/`;
  window.open(portfolioUrl, '_blank');
  appendToTerminal(`üìà Opened portfolio for ${tradingViewConnection.username}`, 'success');
}

function updateTradingViewUI(connected) {
  const badge = document.getElementById('tvConnectionBadge');
  const statusText = document.getElementById('tvStatusText');
  const form = document.getElementById('tvConnectionForm');
  const features = document.getElementById('tvConnectedFeatures');
  const disconnectBtn = document.getElementById('tvDisconnectBtn');
  
  if (connected) {
    badge.className = 'badge bg-success me-2';
    badge.textContent = 'Connected';
    statusText.textContent = `Connected as ${tradingViewConnection.username}`;
    form.style.display = 'none';
    features.style.display = 'block';
    disconnectBtn.style.display = 'block';
  } else {
    badge.className = 'badge bg-secondary me-2';
    badge.textContent = 'Disconnected';
    statusText.textContent = 'Not connected';
    form.style.display = 'block';
    features.style.display = 'none';
    disconnectBtn.style.display = 'none';
  }
}

function updateTradingViewStatus(status, type) {
  const statusText = document.getElementById('tvStatusText');
  const badge = document.getElementById('tvConnectionBadge');
  
  statusText.textContent = status;
  badge.className = `badge bg-${type} me-2`;
}

function openTradingViewDashboard() {
  if (tradingViewConnection.connected) {
    const url = `https://www.tradingview.com/u/${tradingViewConnection.username}/`;
    window.open(url, '_blank');
    appendToTerminal(`üåê Opened TradingView dashboard for ${tradingViewConnection.username}`, 'success');
  } else {
    window.open('https://www.tradingview.com/', '_blank');
    appendToTerminal('üåê Opened TradingView homepage', 'system');
    appendToTerminal('üí° Sign in to access your account features', 'system');
  }
}

// Initialize TradingView connection on page load
function initializeTradingViewConnection() {
  const saved = localStorage.getItem('tradingViewConnection');
  if (saved) {
    try {
      const savedConnection = JSON.parse(saved);
      if (savedConnection.connected && savedConnection.username) {
        document.getElementById('tvUsername').value = savedConnection.username;
        document.getElementById('tvRememberMe').checked = savedConnection.rememberMe !== false;
        
        // Don't auto-connect, just restore the username
        appendToTerminal(`üíæ Username restored: ${savedConnection.username}`, 'system');
        appendToTerminal('üîê Please enter your password to reconnect', 'system');
      }
    } catch (e) {
      console.error('Failed to restore TradingView connection:', e);
    }
  }
}

function deployCurrentStrategy() {
  const code = getContextCode();
  
  if (!tradingViewConnection.connected) {
    appendToTerminal('‚ùå Please connect to TradingView first', 'error');
    return;
  }
  
  if (!tradingViewConnection.apiKey) {
    appendToTerminal('‚ùå API key required for strategy deployment', 'error');
    appendToTerminal('üí° Add your TradingView API key in connection settings', 'system');
    return;
  }
  
  if (!code || code.includes('Generated code will appear here')) {
    appendToTerminal('‚ùå No strategy code available to deploy', 'error');
    return;
  }
  
  // Check if it's Pine Script
  if (currentContext.codeLanguage === 'pinescript' || 
      code.includes('@version=5') || 
      code.includes('strategy(')) {
    
    appendToTerminal('üöÄ Deploying Pine Script strategy to TradingView...', 'system');
    
    // Make API call to deploy strategy
    fetch('/api/rimsi/tradingview/deploy', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        username: tradingViewConnection.username,
        api_key: tradingViewConnection.apiKey,
        pine_script: code,
        strategy_name: `RIMSI Strategy ${new Date().toISOString().split('T')[0]}`
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        appendToTerminal(`‚úÖ ${data.message}`, 'success');
        appendToTerminal(`üìä Strategy ID: ${data.deployment.strategy_id}`, 'success');
        appendToTerminal(`üîó Strategy URL: ${data.deployment.url}`, 'system');
        appendToTerminal('üí° Click "Open TradingView" to view your deployed strategy', 'system');
      } else {
        throw new Error(data.error || 'Deployment failed');
      }
    })
    .catch(error => {
      appendToTerminal(`‚ùå Deployment failed: ${error.message}`, 'error');
    });
    
  } else {
    appendToTerminal('‚ùå Only Pine Script strategies can be deployed to TradingView', 'error');
    appendToTerminal('üí° Generate a Pine Script strategy first', 'system');
  }
}

function syncTradingViewData() {
  if (!tradingViewConnection.connected) {
    appendToTerminal('‚ùå Please connect to TradingView first', 'error');
    return;
  }
  
  appendToTerminal('üîÑ Syncing real-time data from TradingView...', 'system');
  
  const symbol = document.getElementById('activeSymbol').value || 'SPY';
  
  // Make API call to sync data
  fetch('/api/rimsi/tradingview/sync', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      username: tradingViewConnection.username,
      symbols: [symbol]
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      appendToTerminal(`‚úÖ ${data.message}`, 'success');
      
      // Display synced data
      data.data.forEach(item => {
        appendToTerminal(`üìä ${item.symbol}: $${item.price} (${item.change > 0 ? '+' : ''}${item.change}%) Vol: ${item.volume.toLocaleString()}`, 'system');
      });
      
      appendToTerminal('ÔøΩ Market data synchronized and updated', 'success');
    } else {
      throw new Error(data.error || 'Sync failed');
    }
  })
  .catch(error => {
    appendToTerminal(`‚ùå Data sync failed: ${error.message}`, 'error');
  });
}

function openTradingViewDashboard() {
  if (tradingViewConnection.connected) {
    const url = `https://www.tradingview.com/u/${tradingViewConnection.username}/`;
    window.open(url, '_blank');
    appendToTerminal(`üåê Opened TradingView dashboard for ${tradingViewConnection.username}`, 'success');
  } else {
    window.open('https://www.tradingview.com/', '_blank');
    appendToTerminal('üåê Opened TradingView homepage', 'system');
  }
}

// Initialize TradingView connection on page load
function initializeTradingViewConnection() {
  const saved = localStorage.getItem('tradingViewConnection');
  if (saved) {
    try {
      tradingViewConnection = JSON.parse(saved);
      if (tradingViewConnection.connected) {
        document.getElementById('tvUsername').value = tradingViewConnection.username || '';
        document.getElementById('tvApiKey').value = tradingViewConnection.apiKey || '';
        document.getElementById('tvAutoSync').checked = tradingViewConnection.autoSync !== false;
        updateTradingViewUI(true);
        appendToTerminal(`üîó Restored TradingView connection for ${tradingViewConnection.username}`, 'system');
      }
    } catch (e) {
      console.error('Failed to restore TradingView connection:', e);
    }
  }
}
</script>

<style>
.terminal-user { color: #00aaff; }
.terminal-ai { color: #ff6b00; }
.terminal-error { color: #ff4444; }
.terminal-success { color: #44ff44; }
.terminal-system { color: #00ff00; }

#terminalHistory::-webkit-scrollbar {
  width: 8px;
}

#terminalHistory::-webkit-scrollbar-track {
  background: #2a2a2a;
}

#terminalHistory::-webkit-scrollbar-thumb {
  background: #4a4a4a;
  border-radius: 4px;
}

#terminalHistory::-webkit-scrollbar-thumb:hover {
  background: #6a6a6a;
}

.nav-tabs .nav-link {
  border: none;
  border-bottom: 2px solid transparent;
}

.nav-tabs .nav-link.active {
  border-bottom-color: #0d6efd;
  background: none;
}
</style>
{% endblock %}
