{% extends "layout.html" %}

{% block title %}Submit Research Report{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-file-alt text-primary me-2"></i>Submit Research Report
                </h2>
                <div>
                    <a href="{{ url_for('analyst_research_tasks') }}" class="btn btn-outline-primary">
                        <i class="fas fa-tasks me-2"></i>View Tasks
                    </a>
                    <a href="{{ url_for('analyst_my_reports') }}" class="btn btn-outline-info">
                        <i class="fas fa-history me-2"></i>My Reports
                    </a>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Report Submission Form
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="reportForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ticker" class="form-label">Stock Ticker *</label>
                                    <input type="text" class="form-control" id="ticker" name="ticker" 
                                           placeholder="e.g., RELIANCE, TCS, INFY" required style="text-transform: uppercase;">
                                    <div class="form-text">Enter the stock symbol for your analysis</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="task_id" class="form-label">Related Task (Optional)</label>
                                    <select class="form-select" id="task_id" name="task_id">
                                        <option value="">Select if this is for an assigned task</option>
                                        {% for task in assigned_tasks %}
                                            <option value="{{ task.id }}">
                                                {{ task.topic }} 
                                                {% if task.ticker %}({{ task.ticker }}){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="title" class="form-label">Report Title *</label>
                            <input type="text" class="form-control" id="title" name="title" 
                                   placeholder="e.g., Q3 FY24 Financial Analysis - Reliance Industries" required>
                        </div>

                        <div class="mb-3">
                            <label for="content" class="form-label">Report Content *</label>
                            <textarea class="form-control" id="content" name="content" rows="15" required
                                      placeholder="Write your detailed research analysis here..."></textarea>
                            <div class="form-text">
                                <small>
                                    Tip: Include executive summary, key findings, financial metrics, and recommendations. 
                                    Use <a href="{{ url_for('research_templates') }}" target="_blank">research templates</a> for guidance.
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Report Type</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="report_type" id="fundamental" value="fundamental" checked>
                                            <label class="form-check-label" for="fundamental">Fundamental</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="report_type" id="technical" value="technical">
                                            <label class="form-check-label" for="technical">Technical</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="report_type" id="sector" value="sector">
                                            <label class="form-check-label" for="sector">Sector</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confidence" class="form-label">Confidence Level</label>
                                    <select class="form-select" id="confidence" name="confidence">
                                        <option value="High">High - Very confident in analysis</option>
                                        <option value="Medium" selected>Medium - Moderately confident</option>
                                        <option value="Low">Low - Limited confidence</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save me-2"></i>Save Draft
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="previewReport()">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                            </div>
                            <div>
                                <a href="{{ url_for('analyst_dashboard') }}" class="btn btn-secondary me-2">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Report
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Tips Card -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Report Writing Tips
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Structure:</h6>
                            <ul class="small">
                                <li>Executive Summary</li>
                                <li>Company Overview</li>
                                <li>Financial Analysis</li>
                                <li>Key Risks</li>
                                <li>Recommendations</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Key Metrics:</h6>
                            <ul class="small">
                                <li>Revenue Growth</li>
                                <li>Profit Margins</li>
                                <li>ROE & ROCE</li>
                                <li>Debt Levels</li>
                                <li>Valuation Ratios</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Best Practices:</h6>
                            <ul class="small">
                                <li>Use data-driven insights</li>
                                <li>Include peer comparisons</li>
                                <li>Cite reliable sources</li>
                                <li>Clear recommendations</li>
                                <li>Risk assessment</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="$('#previewModal').modal('hide');">Continue Editing</button>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-save functionality
let autoSaveTimer;
document.getElementById('content').addEventListener('input', function() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(saveDraft, 30000); // Auto-save every 30 seconds
});

function saveDraft() {
    const formData = new FormData(document.getElementById('reportForm'));
    // Implement draft saving logic here
    console.log('Draft saved');
}

function previewReport() {
    const title = document.getElementById('title').value;
    const ticker = document.getElementById('ticker').value;
    const content = document.getElementById('content').value;
    
    if (!title || !ticker || !content) {
        alert('Please fill in all required fields before previewing');
        return;
    }
    
    const previewContent = `
        <div class="border-bottom pb-3 mb-3">
            <h3>${title}</h3>
            <p class="text-muted">Stock: <strong>${ticker}</strong> | Analyst: {{ analyst.name }}</p>
        </div>
        <div style="white-space: pre-wrap;">${content}</div>
    `;
    
    document.getElementById('previewContent').innerHTML = previewContent;
    $('#previewModal').modal('show');
}

// Form validation
document.getElementById('reportForm').addEventListener('submit', function(e) {
    const content = document.getElementById('content').value;
    if (content.length < 500) {
        e.preventDefault();
        alert('Report content should be at least 500 characters long for quality analysis.');
        return;
    }
});

// Auto-uppercase ticker
document.getElementById('ticker').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});
</script>

<style>
.form-text {
    font-size: 0.875em;
}
.card-header h6 {
    margin-bottom: 0;
}
</style>
{% endblock %}
