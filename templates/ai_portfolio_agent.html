<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portfolio Agent - MLClass Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .ai-agent-container {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 1px;
            background: #0f172a;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, #1e293b 0%, #475569 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 2px solid #60a5fa;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            font-size: 20px;
            font-weight: 700;
            color: #60a5fa;
        }

        .ai-agent-badge {
            background: linear-gradient(45deg, #10b981, #3b82f6);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            color: #cbd5e1;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tier-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .tier-retail {
            background: linear-gradient(45deg, #64748b, #475569);
            color: white;
        }

        .tier-pro {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .tier-pro-plus {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .back-button {
            background: #475569;
            color: #e2e8f0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #64748b;
        }

        /* Left Panel - Model Selection */
        .model-selection-panel {
            background: #1e293b;
            border-right: 1px solid #475569;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-header {
            padding: 20px;
            background: #0f172a;
            border-bottom: 1px solid #475569;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .panel-subtitle {
            font-size: 12px;
            color: #94a3b8;
        }

        .model-categories {
            padding: 20px;
        }

        .category-section {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-item {
            background: #334155;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .model-item:hover {
            background: #475569;
            border-color: #60a5fa;
        }

        .model-item.selected {
            background: #1e40af;
            border-color: #60a5fa;
        }

        .model-name {
            font-size: 13px;
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .model-description {
            font-size: 11px;
            color: #cbd5e1;
            line-height: 1.3;
        }

        .model-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        /* Model Selection Section */
        .model-selection-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .model-categories {
            margin-bottom: 16px;
        }

        .category-section {
            margin-bottom: 16px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #334155;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .category-count {
            background: #475569;
            color: #94a3b8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            min-width: 20px;
            text-align: center;
        }

        .category-count.active {
            background: #3b82f6;
            color: white;
        }

        .model-desc {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .create-agent-btn {
            width: 100%;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .create-agent-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .create-agent-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .create-agent-button {
            margin: 20px;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-agent-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .create-agent-button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        .selected-models-count {
            background: #1e40af;
            color: white;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: auto;
        }

        /* Main Content - AI Insights */
        .ai-insights-panel {
            background: #1e293b;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .insights-header {
            padding: 20px;
            background: #0f172a;
            border-bottom: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: #60a5fa;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .insights-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .insight-card {
            background: #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #60a5fa;
        }

        /* Workflow Steps */
        .workflow-steps {
            background: #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #475569;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .step-icon.active {
            background: #60a5fa;
            color: white;
        }

        .step-icon.completed {
            background: #10b981;
            color: white;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .step-desc {
            font-size: 12px;
            color: #94a3b8;
        }

        .step-status {
            margin-left: 12px;
        }

        .step-status i.completed {
            color: #10b981 !important;
        }

        .step-status i.active {
            color: #60a5fa !important;
        }

        /* Manual Generate Button */
        .manual-generate {
            text-align: center;
            margin: 20px 0;
        }

        .generate-insights-btn {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .generate-insights-btn:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .generate-insights-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .insight-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .confidence-score {
            background: #10b981;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: auto;
        }

        .insight-content {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.5;
        }

        .recommendation-item {
            background: #475569;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #10b981;
        }

        .recommendation-action {
            font-size: 13px;
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .recommendation-reasoning {
            font-size: 12px;
            color: #94a3b8;
        }

        .priority-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        .priority-high {
            background: #ef4444;
            color: white;
        }

        .priority-medium {
            background: #f59e0b;
            color: white;
        }

        .priority-low {
            background: #6b7280;
            color: white;
        }

        .loading-spinner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
            border-radius: 12px;
        }

        .loading-spinner.show {
            display: flex;
        }

        .spinner {
            border: 3px solid #475569;
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Right Panel - Portfolio Connection */
        .portfolio-panel {
            background: #1e293b;
            border-left: 1px solid #475569;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .portfolio-header {
            padding: 20px;
            background: #0f172a;
            border-bottom: 1px solid #475569;
        }

        .portfolio-title {
            font-size: 16px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .portfolio-list {
            padding: 20px;
        }

        .portfolio-item {
            background: #334155;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .portfolio-item:hover {
            background: #475569;
        }

        .portfolio-item.active {
            border-color: #10b981;
            background: #065f46;
        }

        .portfolio-name {
            font-size: 14px;
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .portfolio-value {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .portfolio-holdings {
            font-size: 11px;
            color: #64748b;
        }

        .refresh-button {
            background: #475569;
            color: #e2e8f0;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 16px;
            width: 100%;
        }

        .refresh-button:hover {
            background: #64748b;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .ai-agent-container {
                grid-template-columns: 280px 1fr 320px;
            }
        }

        @media (max-width: 768px) {
            .ai-agent-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr;
            }
            
            .model-selection-panel,
            .portfolio-panel {
                height: 200px;
            }
        }

        /* Pre-built Agents Grid */
        .prebuilt-agents-section {
            margin-bottom: 24px;
        }

        .section-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #475569;
        }

        .prebuilt-agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .prebuilt-agent-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .prebuilt-agent-card:hover {
            transform: translateY(-2px);
            border-color: #60a5fa;
            box-shadow: 0 8px 25px rgba(96, 165, 250, 0.15);
        }

        .prebuilt-agent-card:active {
            transform: translateY(0);
        }

        .agent-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .agent-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .agent-title {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
            margin: 0;
        }

        .agent-category {
            background: #475569;
            color: #e2e8f0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: auto;
        }

        .agent-description {
            color: #94a3b8;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .agent-features {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .feature-tag {
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .agent-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #475569;
        }

        .agent-speed {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #10b981;
            font-size: 12px;
            font-weight: 500;
        }

        .agent-complexity {
            color: #94a3b8;
            font-size: 12px;
        }

        .quick-action-btn {
            background: linear-gradient(45deg, #10b981, #3b82f6);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .insights-display {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
            border-left: 4px solid #60a5fa;
        }

        .insights-display h4 {
            color: #60a5fa;
            margin: 0 0 12px 0;
            font-size: 16px;
        }

        .insights-display p {
            color: #cbd5e1;
            margin: 0;
            line-height: 1.5;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .metric-card {
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 12px;
        }

        .metric-label {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .metric-value {
            color: #f1f5f9;
            font-size: 16px;
            font-weight: 600;
        }

        /* Admin Settings Styles */
        .admin-settings-section {
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }

        .settings-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1e293b;
            border-radius: 8px 8px 0 0;
            transition: background 0.2s;
        }

        .settings-header:hover {
            background: #334155;
        }

        .settings-header i:last-child {
            margin-left: auto;
            transition: transform 0.2s;
        }

        .settings-content {
            padding: 16px;
            border-top: 1px solid #334155;
        }

        .setting-item {
            margin-bottom: 16px;
        }

        .setting-item label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 6px;
        }

        .api-key-input-group {
            display: flex;
            gap: 8px;
        }

        .setting-item input, .setting-item select {
            flex: 1;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 8px 12px;
            color: #f1f5f9;
            font-size: 13px;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .toggle-btn {
            background: #475569;
            border: 1px solid #64748b;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-btn:hover {
            background: #64748b;
        }

        .setting-description {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 12px;
        }

        .test-api-btn {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 8px;
        }

        .test-api-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Quick Agents Styles */
        .quick-agents-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .quick-agent-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quick-agent-card:hover {
            background: #334155;
            border-color: #60a5fa;
            transform: translateY(-1px);
        }

        .quick-agent-card.locked {
            background: #0f172a;
            border: 1px solid #374151;
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .quick-agent-card.locked:hover {
            background: #0f172a;
            border-color: #374151;
            transform: none;
        }

        .quick-agent-card.locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 8px;
            right: 8px;
            color: #6b7280;
            font-size: 12px;
        }

        .tier-indicator {
            background: #374151;
            color: #9ca3af;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tier-indicator.pro {
            background: #f59e0b;
            color: white;
        }

        .tier-indicator.pro-plus {
            background: #8b5cf6;
            color: white;
        }

        .upgrade-prompt {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            text-align: center;
        }

        .upgrade-button {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .upgrade-button:hover {
            background: linear-gradient(45deg, #d97706, #b45309);
            transform: translateY(-1px);
        }

        /* Upgrade Modal Styles */
        .upgrade-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .upgrade-modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #475569;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #475569;
        }

        .upgrade-header h3 {
            color: #f59e0b;
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #f1f5f9;
        }

        .upgrade-body {
            padding: 20px;
        }

        .tier-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tier-column {
            background: #0f172a;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .tier-column.current {
            border-color: #10b981;
            background: linear-gradient(135deg, #0f172a 0%, #064e3b 100%);
        }

        .tier-column.recommended {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #0f172a 0%, #451a03 100%);
        }

        .tier-column h4 {
            color: #f1f5f9;
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .tier-price {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .tier-column ul {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }

        .tier-column li {
            color: #e2e8f0;
            font-size: 12px;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .tier-column li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .upgrade-tier-btn {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-tier-btn:hover {
            background: linear-gradient(45deg, #d97706, #b45309);
            transform: translateY(-1px);
        }

        .upgrade-tier-btn.pro-plus {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
        }

        .upgrade-tier-btn.pro-plus:hover {
            background: linear-gradient(45deg, #7c3aed, #6d28d9);
        }

        .agent-icon-small {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name-small {
            font-size: 13px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 2px;
        }

        .agent-desc-small {
            font-size: 11px;
            color: #94a3b8;
        }

        .agent-badge-small {
            background: #475569;
            color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        /* Enhanced Analysis Button */
        .enhanced-analysis-btn {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }

        .enhanced-analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .enhanced-analysis-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .claude-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            position: absolute;
            top: -4px;
            right: -4px;
        }

        /* Notification System */
        .notification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Enhanced Analysis Results */
        .enhanced-analysis {
            background: #0f172a;
            border-radius: 12px;
            padding: 20px;
        }

        .enhanced-analysis .analysis-section {
            background: #1e293b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .enhanced-analysis h5 {
            color: #60a5fa;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .enhanced-analysis .risk-metrics {
            display: grid;
            gap: 12px;
        }

        .enhanced-analysis .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #334155;
            border-radius: 6px;
        }

        .enhanced-analysis .metric-label {
            font-weight: 500;
            color: #f1f5f9;
        }

        .enhanced-analysis .metric-value {
            color: #10b981;
            font-weight: 600;
        }

        .enhanced-analysis .metric-desc {
            font-size: 12px;
            color: #94a3b8;
        }

        .enhanced-analysis .recommendations {
            display: grid;
            gap: 16px;
        }

        .enhanced-analysis .recommendation-item {
            background: #334155;
            padding: 12px;
            border-radius: 6px;
        }

        .enhanced-analysis .optimization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .enhanced-analysis .optimization-item {
            background: #334155;
            padding: 12px;
            border-radius: 6px;
        }

        .enhanced-analysis .optimization-item h6 {
            color: #10b981;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .enhanced-analysis .claude-signature {
            text-align: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #475569;
        }

        .enhanced-analysis .claude-signature em {
            color: #8b5cf6;
            font-style: italic;
        }

        /* Loading Animation */
        .loading-analysis {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .loading-analysis i {
            font-size: 24px;
            margin-bottom: 16px;
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="ai-agent-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <i class="fas fa-robot"></i> AI Portfolio Agent
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    {% if is_admin %}
                        <span class="admin-badge">Admin</span>
                    {% else %}
                        <span class="tier-badge tier-{{ user_tier.replace('+', '-plus') }}">{{ tier_display_name }}</span>
                    {% endif %}
                </div>
                <button class="back-button" onclick="window.location.href='/vs_terminal_MLClass'">
                    <i class="fas fa-arrow-left"></i> Back to MLClass
                </button>
            </div>
        </header>

        <!-- Left Panel - Ready-to-Use AI Agents -->
        <div class="model-selection-panel">
            <div class="panel-header">
                <div class="panel-title">Ready-to-Use AI Agents</div>
                <div class="panel-subtitle">Select an AI agent for instant analysis</div>
            </div>

            <!-- Admin Settings Section - Only for Admins -->
            {% if is_admin %}
            <div class="admin-settings-section" id="adminSettings">
                <div class="settings-header" onclick="toggleAdminSettings()">
                    <i class="fas fa-cog"></i>
                    <span>API Configuration</span>
                    <i class="fas fa-chevron-down" id="settingsChevron"></i>
                </div>
                <div class="settings-content" id="settingsContent" style="display: none;">
                    <div class="setting-item">
                        <label for="anthropicApiKey">Anthropic API Key:</label>
                        <div class="api-key-input-group">
                            <input type="password" id="anthropicApiKey" placeholder="sk-ant-..." 
                                   value="" onchange="updateApiKey()">
                            <button type="button" onclick="toggleApiKeyVisibility()" class="toggle-btn">
                                <i class="fas fa-eye" id="eyeIcon"></i>
                            </button>
                        </div>
                        <div class="setting-description">
                            Enter your Anthropic API key for Claude Sonnet 3.5/3.7 enhanced analysis
                        </div>
                        <div class="api-status" id="apiStatus">
                            <i class="fas fa-circle" style="color: #ef4444;"></i>
                            <span>API Key Not Set</span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="claudeModel">Claude Model:</label>
                        <select id="claudeModel" onchange="updateClaudeModel()">
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Latest)</option>
                            <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (June)</option>
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fast)</option>
                        </select>
                        <div class="setting-description">
                            Choose the Claude model for AI analysis
                        </div>
                    </div>
                    <button class="test-api-btn" onclick="testAnthropicConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Quick AI Agents -->
                    
                    <div class="quick-agents-section">
                <div class="section-title">
                    <i class="fas fa-bolt"></i>
                    Quick Analysis Agents
                </div>
                
                <!-- Tier Information Panel -->
                <div class="upgrade-prompt">
                    <div style="font-size: 12px; font-weight: 600; color: #f1f5f9; margin-bottom: 4px;">
                        Current Plan: {{ tier_display_name }}
                    </div>
                    <div style="font-size: 10px; color: #94a3b8;">
                        {% if user_tier == 'retail' %}
                            {{ tier_limits.daily_analyses }} analyses/day • {{ tier_limits.historical_data_years }} year data • 15min delay
                        {% elif user_tier == 'pro' %}
                            {{ tier_limits.daily_analyses }} analyses/day • {{ tier_limits.historical_data_years }} years data • Real-time
                        {% else %}
                            Unlimited analyses • {{ tier_limits.historical_data_years }}+ years data • Real-time + API
                        {% endif %}
                    </div>
                    {% if user_tier != 'pro+' %}
                        <button class="upgrade-button" onclick="showUpgradeModal()">
                            <i class="fas fa-arrow-up"></i> Upgrade
                        </button>
                    {% endif %}
                </div>
                
                <div class="agent-grid">
                    <!-- Retail Tier Agents (Always Available) -->
                    <div class="quick-agent-card" onclick="runQuickAgent('portfolio_analyzer')">
                        <div class="agent-icon-small" style="background: linear-gradient(45deg, #10b981, #3b82f6);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="agent-info">
                            <div class="agent-name-small">Portfolio Analyzer</div>
                            <div class="agent-desc-small">Performance & Risk Metrics</div>
                        </div>
                        <div class="agent-badge-small">Basic</div>
                    </div>

                    <div class="quick-agent-card" onclick="runQuickAgent('educational_assistant')">
                        <div class="agent-icon-small" style="background: linear-gradient(45deg, #059669, #047857);">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="agent-info">
                            <div class="agent-name-small">Educational Assistant</div>
                            <div class="agent-desc-small">Learning & Investment Basics</div>
                        </div>
                        <div class="agent-badge-small">Educational</div>
                    </div>

                    <!-- Pro Tier Agents -->
                    {% if 'technical_analysis' in tier_features %}
                        <div class="quick-agent-card" onclick="runQuickAgent('technical_analysis')">
                            <div class="agent-icon-small" style="background: linear-gradient(45deg, #f59e0b, #d97706);">
                                <i class="fas fa-chart-candlestick"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Technical Analysis</div>
                                <div class="agent-desc-small">Charts & Indicators</div>
                            </div>
                            <div class="tier-indicator pro">Pro</div>
                        </div>
                    {% else %}
                        <div class="quick-agent-card locked" onclick="showUpgradeModal('technical_analysis')">
                            <div class="agent-icon-small" style="background: #374151;">
                                <i class="fas fa-chart-candlestick"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Technical Analysis</div>
                                <div class="agent-desc-small">Charts & Indicators</div>
                            </div>
                            <div class="tier-indicator">Pro Required</div>
                        </div>
                    {% endif %}

                    {% if 'options_strategies' in tier_features %}
                        <div class="quick-agent-card" onclick="runQuickAgent('options_strategies')">
                            <div class="agent-icon-small" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Options Strategies</div>
                                <div class="agent-desc-small">Covered Calls & Puts</div>
                            </div>
                            <div class="tier-indicator pro">Pro</div>
                        </div>
                    {% else %}
                        <div class="quick-agent-card locked" onclick="showUpgradeModal('options_strategies')">
                            <div class="agent-icon-small" style="background: #374151;">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Options Strategies</div>
                                <div class="agent-desc-small">Covered Calls & Puts</div>
                            </div>
                            <div class="tier-indicator">Pro Required</div>
                        </div>
                    {% endif %}

                    <!-- Pro+ Tier Agents -->
                    {% if 'quantitative_models' in tier_features %}
                        <div class="quick-agent-card" onclick="runQuickAgent('quantitative_models')">
                            <div class="agent-icon-small" style="background: linear-gradient(45deg, #6366f1, #4f46e5);">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Quant Models</div>
                                <div class="agent-desc-small">Factor Analysis & Alpha</div>
                            </div>
                            <div class="tier-indicator pro-plus">Pro+</div>
                        </div>
                    {% else %}
                        <div class="quick-agent-card locked" onclick="showUpgradeModal('quantitative_models')">
                            <div class="agent-icon-small" style="background: #374151;">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Quant Models</div>
                                <div class="agent-desc-small">Factor Analysis & Alpha</div>
                            </div>
                            <div class="tier-indicator">Pro+ Required</div>
                        </div>
                    {% endif %}

                    {% if 'custom_ai_builder' in tier_features %}
                        <div class="quick-agent-card" onclick="runQuickAgent('custom_ai_builder')">
                            <div class="agent-icon-small" style="background: linear-gradient(45deg, #ec4899, #db2777);">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Custom AI Builder</div>
                                <div class="agent-desc-small">Build Your Own Models</div>
                            </div>
                            <div class="tier-indicator pro-plus">Pro+</div>
                        </div>
                    {% else %}
                        <div class="quick-agent-card locked" onclick="showUpgradeModal('custom_ai_builder')">
                            <div class="agent-icon-small" style="background: #374151;">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name-small">Custom AI Builder</div>
                                <div class="agent-desc-small">Build Your Own Models</div>
                            </div>
                            <div class="tier-indicator">Pro+ Required</div>
                        </div>
                    {% endif %}

                    <div class="quick-agent-card" onclick="runQuickAgent('risk_advisor')">
                        <div class="agent-icon-small" style="background: linear-gradient(45deg, #ef4444, #f59e0b);">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="agent-info">
                            <div class="agent-name-small">Risk Advisor</div>
                            <div class="agent-desc-small">VaR & Risk Assessment</div>
                        </div>
                        <div class="agent-badge-small">Advanced</div>
                    </div>

                    <div class="quick-agent-card" onclick="runQuickAgent('market_intelligence')">
                        <div class="agent-icon-small" style="background: linear-gradient(45deg, #06b6d4, #0891b2);">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="agent-info">
                            <div class="agent-name-small">Market Intel</div>
                            <div class="agent-desc-small">Sector & News Analysis</div>
                        </div>
                        <div class="agent-badge-small">Advanced</div>
                    </div>

                    <div class="quick-agent-card" onclick="runQuickAgent('rebalancing_optimizer')">
                        <div class="agent-icon-small" style="background: linear-gradient(45deg, #f97316, #ea580c);">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="agent-info">
                            <div class="agent-name-small">Rebalancer</div>
                            <div class="agent-desc-small">Portfolio Optimization</div>
                        </div>
                        <div class="agent-badge-small">Moderate</div>
                    </div>

                    <div class="quick-agent-card" onclick="runQuickAgent('quick_insights')">
                        <div class="agent-icon-small" style="background: linear-gradient(45deg, #84cc16, #65a30d);">
                            <i class="fas fa-lightning-bolt"></i>
                        </div>
                        <div class="agent-info">
                            <div class="agent-name-small">Quick Insights</div>
                            <div class="agent-desc-small">Instant Overview</div>
                        </div>
                        <div class="agent-badge-small">Instant</div>
                    </div>
                </div>
            </div>

            <!-- Traditional Model Selection Section -->
            <div class="model-selection-section" style="margin-top: 20px;">
                <div class="section-title">
                    <i class="fas fa-cogs"></i>
                    Custom AI Agent Builder
                </div>
                
                <!-- Model Categories -->
                <div class="model-categories">
                    <div class="category-section">
                        <div class="category-header">
                            <span>Volatility Models</span>
                            <span class="category-count" id="vol-count">0</span>
                        </div>
                        <div class="model-item" data-model-id="garch" data-category="volatility">
                            <div class="model-name">GARCH Model</div>
                            <div class="model-desc">Volatility Clustering</div>
                        </div>
                        <div class="model-item" data-model-id="egarch" data-category="volatility">
                            <div class="model-name">EGARCH Model</div>
                            <div class="model-desc">Asymmetric Volatility</div>
                        </div>
                    </div>
                    
                    <div class="category-section">
                        <div class="category-header">
                            <span>Performance Models</span>
                            <span class="category-count" id="perf-count">0</span>
                        </div>
                        <div class="model-item" data-model-id="sharpe" data-category="performance">
                            <div class="model-name">Sharpe Ratio</div>
                            <div class="model-desc">Risk-Adjusted Returns</div>
                        </div>
                        <div class="model-item" data-model-id="treynor" data-category="performance">
                            <div class="model-name">Treynor Ratio</div>
                            <div class="model-desc">Beta-Adjusted Returns</div>
                        </div>
                    </div>
                    
                    <div class="category-section">
                        <div class="category-header">
                            <span>Risk Models</span>
                            <span class="category-count" id="risk-count">0</span>
                        </div>
                        <div class="model-item" data-model-id="var" data-category="risk">
                            <div class="model-name">Value at Risk</div>
                            <div class="model-desc">Downside Risk</div>
                        </div>
                        <div class="model-item" data-model-id="cvar" data-category="risk">
                            <div class="model-name">Conditional VaR</div>
                            <div class="model-desc">Expected Shortfall</div>
                        </div>
                    </div>
                </div>
                
                <!-- Create Agent Button -->
                <button class="create-agent-btn" id="createAgentBtn" disabled>
                    <i class="fas fa-plus"></i>
                    <span>Select 2+ Models to Create Agent</span>
                </button>
            </div>

            <!-- Enhanced Analysis Button - Only for Admins -->
            {% if is_admin %}
            <button class="enhanced-analysis-btn" onclick="runEnhancedAnalysis()" id="enhancedAnalysisBtn">
                <i class="fas fa-magic"></i>
                <span>Enhanced AI Analysis</span>
                <div class="claude-badge">Claude 3.5</div>
            </button>
            
            <!-- Debug Test Button -->
            <button class="enhanced-analysis-btn" onclick="testQuickAgent()" style="background: #f59e0b; margin-top: 10px;">
                <i class="fas fa-bug"></i>
                <span>Test Quick Agent</span>
            </button>
            {% endif %}
        </div>

        <!-- Main Content - AI Insights -->
        <div class="ai-insights-panel">
            <div class="insights-header">
                <div class="insights-title">
                    <i class="fas fa-brain"></i> AI Portfolio Insights
                </div>
                <div class="agent-status" id="agentStatus">
                    <div class="status-indicator"></div>
                    <span>Ready to Create Agent</span>
                </div>
            </div>

            <div class="insights-content" id="insightsContent">
                <!-- Pre-built Agents Section -->
                <div class="prebuilt-agents-section" id="prebuiltAgentsSection">
                    <div class="section-header">
                        <h3 style="color: #60a5fa; margin: 0; font-size: 18px;">
                            <i class="fas fa-rocket"></i> Ready-to-Use AI Agents
                        </h3>
                        <p style="color: #94a3b8; margin: 4px 0 16px 0; font-size: 13px;">
                            Click any agent below for instant portfolio insights - No setup required!
                        </p>
                    </div>
                    
                    <div class="prebuilt-agents-grid" id="prebuiltAgentsGrid">
                        <!-- Pre-built agents will be loaded here -->
                    </div>
                </div>

                <!-- Workflow Steps (Original) -->
                <div class="workflow-steps" id="workflowSteps" style="display: none;">
                    <div class="step-item" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-content">
                            <div class="step-title">Select ML Models</div>
                            <div class="step-desc">Choose at least 2 models from the left panel</div>
                        </div>
                        <div class="step-status" id="step1Status">
                            <i class="fas fa-circle" style="color: #64748b;"></i>
                        </div>
                    </div>
                    
                    <div class="step-item" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-content">
                            <div class="step-title">Create AI Agent</div>
                            <div class="step-desc">Click "Create AI Agent" button</div>
                        </div>
                        <div class="step-status" id="step2Status">
                            <i class="fas fa-circle" style="color: #64748b;"></i>
                        </div>
                    </div>
                    
                    <div class="step-item" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-content">
                            <div class="step-title">Connect Portfolio</div>
                            <div class="step-desc">Select a portfolio from the right panel</div>
                        </div>
                        <div class="step-status" id="step3Status">
                            <i class="fas fa-circle" style="color: #64748b;"></i>
                        </div>
                    </div>
                    
                    <div class="step-item" id="step4">
                        <div class="step-icon">4</div>
                        <div class="step-content">
                            <div class="step-title">Generate Insights</div>
                            <div class="step-desc">AI insights will generate automatically</div>
                        </div>
                        <div class="step-status" id="step4Status">
                            <i class="fas fa-circle" style="color: #64748b;"></i>
                        </div>
                    </div>
                </div>

                <div class="manual-generate" id="manualGenerate" style="display: none;">
                    <button class="generate-insights-btn" onclick="generateInsights()">
                        <i class="fas fa-brain"></i> Generate AI Insights
                    </button>
                </div>

                <!-- Debug Test Button -->
                <div class="manual-generate" style="margin-top: 10px;">
                    <button class="generate-insights-btn" onclick="testAIAgentCreation()" style="background: #f59e0b;">
                        <i class="fas fa-bug"></i> Test AI Agent Creation
                    </button>
                </div>

                <!-- Dynamic Insights Container -->
                <div id="dynamicInsights"></div>
                
                <!-- Analysis Results Container -->
                <div id="analysisResults" style="display: none;"></div>
            </div>

            <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                <div class="spinner"></div>
                <div>Analyzing portfolio with AI agent...</div>
            </div>
        </div>

        <!-- Right Panel - Portfolio Connection -->
        <div class="portfolio-panel">
            <div class="portfolio-header">
                <div class="portfolio-title">Connect Portfolio</div>
                <div class="panel-subtitle">Select portfolio to analyze</div>
            </div>

            <div class="portfolio-list" id="portfolioList">
                {% if portfolios %}
                    {% for portfolio in portfolios %}
                    <div class="portfolio-item" data-portfolio-id="{{ portfolio.id }}">
                        <div class="portfolio-name">{{ portfolio.name or 'Portfolio ' + loop.index0|string }}</div>
                        <div class="portfolio-value">Value: ${{ "%.2f"|format(portfolio.total_value or 0) }}</div>
                        <div class="portfolio-holdings">{{ portfolio.holdings_count or 0 }} holdings</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="portfolio-item" data-portfolio-id="demo">
                        <div class="portfolio-name">Demo Portfolio</div>
                        <div class="portfolio-value">Value: $162,500.00</div>
                        <div class="portfolio-holdings">8 holdings</div>
                    </div>
                {% endif %}

                <button class="refresh-button" onclick="refreshPortfolios()">
                    <i class="fas fa-sync-alt"></i> Refresh Portfolios
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for admin state
        const isAdmin = {{ 'true' if is_admin else 'false' }};
        const userType = '{{ user_type or "investor" }}';
        const userTier = '{{ user_tier or "retail" }}';
        const tierFeatures = {{ tier_features | tojson }};
        const tierLimits = {{ tier_limits | tojson }};
        
        // State management
        let selectedModels = [];
        let selectedPortfolio = null;
        let aiAgent = null;

        // Tier-specific functionality
        function showUpgradeModal(featureName = null) {
            const modal = document.createElement('div');
            modal.className = 'upgrade-modal';
            modal.innerHTML = `
                <div class="upgrade-modal-content">
                    <div class="upgrade-header">
                        <h3><i class="fas fa-crown"></i> Upgrade Your Plan</h3>
                        <button onclick="closeUpgradeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="upgrade-body">
                        ${featureName ? `
                            <p><strong>${featureName.replace('_', ' ').toUpperCase()}</strong> requires a higher tier plan.</p>
                        ` : ''}
                        <div class="tier-comparison">
                            <div class="tier-column ${userTier === 'retail' ? 'current' : ''}">
                                <h4>Retail</h4>
                                <div class="tier-price">Current Plan</div>
                                <ul>
                                    <li>5 analyses/day</li>
                                    <li>Basic portfolio analysis</li>
                                    <li>Educational content</li>
                                    <li>15-minute data delay</li>
                                </ul>
                            </div>
                            <div class="tier-column ${userTier === 'pro' ? 'current' : 'recommended'}">
                                <h4>Pro</h4>
                                <div class="tier-price">Upgrade to Pro</div>
                                <ul>
                                    <li>25 analyses/day</li>
                                    <li>Technical analysis</li>
                                    <li>Options strategies</li>
                                    <li>Real-time data</li>
                                    <li>Advanced charting</li>
                                </ul>
                                <button class="upgrade-tier-btn" onclick="contactUpgrade('pro')">Upgrade to Pro</button>
                            </div>
                            <div class="tier-column ${userTier === 'pro+' ? 'current' : ''}">
                                <h4>Pro+</h4>
                                <div class="tier-price">Institutional Grade</div>
                                <ul>
                                    <li>Unlimited analyses</li>
                                    <li>Quantitative models</li>
                                    <li>Custom AI builder</li>
                                    <li>API access</li>
                                    <li>Priority support</li>
                                </ul>
                                <button class="upgrade-tier-btn pro-plus" onclick="contactUpgrade('pro+')">Upgrade to Pro+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function closeUpgradeModal() {
            const modal = document.querySelector('.upgrade-modal');
            if (modal) {
                modal.remove();
            }
        }

        function contactUpgrade(tier) {
            alert(`Contact us to upgrade to ${tier.toUpperCase()} tier: sales@mlclass.com`);
            closeUpgradeModal();
        }

        function checkTierAccess(feature) {
            return tierFeatures.includes(feature);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI Portfolio Agent page loaded');
            
            // Check if all required elements exist
            const requiredElements = [
                'loadingSpinner', 'insightsContent', 'agentStatus', 
                'createAgentBtn', 'vol-count', 'perf-count', 'risk-count'
            ];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`✅ Element found: ${id}`);
                } else {
                    console.error(`❌ Element missing: ${id}`);
                }
            });
            
            // Load pre-built agents
            loadPrebuiltAgents();
            
            // Initialize model selection
            initializeModelSelection();
            
            initializeModelSelection();
            initializePortfolioSelection();
            updateWorkflowDisplay(); // Initial workflow state
            
            // Initialize new admin settings and quick agents
            initializeAdminSettings();
            initializeQuickAgents();
        });

        function initializeModelSelection() {
            const modelItems = document.querySelectorAll('.model-item');
            const createButton = document.getElementById('createAgentBtn');

            modelItems.forEach(item => {
                item.addEventListener('click', function() {
                    const modelId = this.dataset.modelId;
                    const category = this.dataset.category;

                    if (this.classList.contains('selected')) {
                        // Deselect model
                        this.classList.remove('selected');
                        selectedModels = selectedModels.filter(m => m.id !== modelId);
                    } else {
                        // Select model
                        this.classList.add('selected');
                        selectedModels.push({
                            id: modelId,
                            name: this.querySelector('.model-name').textContent,
                            category: category
                        });
                    }

                    updateModelCounts();
                    updateCreateButton();
                    updateWorkflowDisplay();
                });
            });
        }

        function updateModelCounts() {
            // Update category counters with null checks
            const volCount = selectedModels.filter(m => m.category === 'volatility').length;
            const perfCount = selectedModels.filter(m => m.category === 'performance').length;
            const riskCount = selectedModels.filter(m => m.category === 'risk').length;

            const volCountEl = document.getElementById('vol-count');
            const perfCountEl = document.getElementById('perf-count');
            const riskCountEl = document.getElementById('risk-count');

            if (volCountEl) {
                volCountEl.textContent = volCount;
                volCountEl.classList.toggle('active', volCount > 0);
            }
            if (perfCountEl) {
                perfCountEl.textContent = perfCount;
                perfCountEl.classList.toggle('active', perfCount > 0);
            }
            if (riskCountEl) {
                riskCountEl.textContent = riskCount;
                riskCountEl.classList.toggle('active', riskCount > 0);
            }
        }

        function updateCreateButton() {
            const createButton = document.getElementById('createAgentBtn');
            
            if (!createButton) {
                console.warn('Create agent button not found');
                return;
            }
            
            if (selectedModels.length >= 2) {
                createButton.disabled = false;
                createButton.innerHTML = `<i class="fas fa-magic"></i> Create AI Agent (${selectedModels.length} models)`;
                createButton.onclick = createAIAgent;
            } else {
                createButton.disabled = true;
                createButton.innerHTML = `<i class="fas fa-magic"></i> Create AI Agent (Select ${2 - selectedModels.length} more)`;
            }
            
            // Update workflow step 1
            updateWorkflowStep(1, selectedModels.length >= 2);
        }

        // Workflow Management Functions
        function updateWorkflowStep(stepNumber, isCompleted, isActive = false) {
            const stepIcon = document.querySelector(`#step${stepNumber} .step-icon`);
            const stepStatus = document.getElementById(`step${stepNumber}Status`);
            
            if (!stepIcon || !stepStatus) return;
            
            // Reset classes
            stepIcon.classList.remove('active', 'completed');
            
            if (isCompleted) {
                stepIcon.classList.add('completed');
                stepStatus.innerHTML = '<i class="fas fa-check-circle completed"></i>';
            } else if (isActive) {
                stepIcon.classList.add('active');
                stepStatus.innerHTML = '<i class="fas fa-clock active"></i>';
            } else {
                stepStatus.innerHTML = '<i class="fas fa-circle" style="color: #64748b;"></i>';
            }
        }

        function updateWorkflowDisplay() {
            const step1Complete = selectedModels.length >= 2;
            const step2Complete = aiAgent !== null;
            const step3Complete = selectedPortfolio !== null;
            const step4Complete = step1Complete && step2Complete && step3Complete;
            
            updateWorkflowStep(1, step1Complete);
            updateWorkflowStep(2, step2Complete);
            updateWorkflowStep(3, step3Complete);
            updateWorkflowStep(4, step4Complete);
            
            // Show/hide workflow steps vs manual generate button
            const workflowSteps = document.getElementById('workflowSteps');
            const manualGenerate = document.getElementById('manualGenerate');
            
            if (step4Complete) {
                if (workflowSteps) workflowSteps.style.display = 'none';
                if (manualGenerate) manualGenerate.style.display = 'block';
            } else {
                if (workflowSteps) workflowSteps.style.display = 'block';
                if (manualGenerate) manualGenerate.style.display = 'none';
            }
        }

        function initializePortfolioSelection() {
            const portfolioItems = document.querySelectorAll('.portfolio-item');
            console.log('Found portfolio items:', portfolioItems.length);
            
            portfolioItems.forEach((item, index) => {
                console.log(`Portfolio ${index}:`, {
                    id: item.dataset.portfolioId,
                    name: item.querySelector('.portfolio-name')?.textContent,
                    value: item.querySelector('.portfolio-value')?.textContent
                });
                
                item.addEventListener('click', function() {
                    // Remove active class from all items
                    portfolioItems.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to selected item
                    this.classList.add('active');
                    
                    selectedPortfolio = {
                        id: this.dataset.portfolioId || 'demo',
                        name: this.querySelector('.portfolio-name').textContent,
                        value: this.querySelector('.portfolio-value').textContent
                    };

                    console.log('Portfolio selected:', selectedPortfolio);

                    // Update workflow display
                    updateWorkflowDisplay();

                    // If agent is created, refresh insights
                    if (aiAgent) {
                        generateInsights();
                    }
                });
            });

            // Select first portfolio by default
            if (portfolioItems.length > 0) {
                console.log('Auto-selecting first portfolio');
                portfolioItems[0].click();
            }
        }

        async function createAIAgent() {
            console.log('createAIAgent called with selectedModels:', selectedModels);
            
            if (selectedModels.length < 2) {
                alert('Please select at least 2 ML models');
                return;
            }

            try {
                // Update UI with null checks
                const agentStatus = document.getElementById('agentStatus');
                if (agentStatus) {
                    agentStatus.innerHTML = `
                        <div class="status-indicator"></div>
                        <span>Creating AI Agent...</span>
                    `;
                }

                console.log('Sending request to create AI agent...');
                
                // Create AI agent
                const response = await fetch('/api/ai_agent/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selected_models: selectedModels.map(m => m.id),
                        agent_config: {
                            role: 'Balanced Portfolio Analyst',
                            confidence_threshold: 0.70
                        }
                    })
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Create agent result:', result);

                if (result.success) {
                    aiAgent = result.agent;
                    
                    // Update workflow display
                    updateWorkflowDisplay();
                    
                    // Update UI with null checks
                    if (agentStatus) {
                        agentStatus.innerHTML = `
                            <div class="status-indicator" style="background: #10b981;"></div>
                            <span>AI Agent Active</span>
                        `;
                    }

                    // Generate initial insights if portfolio is selected
                    if (selectedPortfolio) {
                        await generateInsights();
                    }

                    // Show success message
                    showInsightCard('Agent Created', 'AI agent successfully created with selected models. Ready to analyze portfolios.', '95%');
                } else {
                    throw new Error(result.error || 'Failed to create AI agent');
                }

            } catch (error) {
                console.error('Error creating AI agent:', error);
                const agentStatus = document.getElementById('agentStatus');
                if (agentStatus) {
                    agentStatus.innerHTML = `
                        <div class="status-indicator" style="background: #ef4444;"></div>
                        <span>Agent Creation Failed</span>
                    `;
                }
                alert('Failed to create AI agent: ' + error.message);
            }
        }

        async function generateInsights() {
            if (!aiAgent || !selectedPortfolio) {
                return;
            }

            try {
                // Show loading
                showLoading(true);

                // Update status with null checks
                const agentStatus = document.getElementById('agentStatus');
                if (agentStatus) {
                    agentStatus.innerHTML = `
                        <div class="status-indicator" style="background: #f59e0b;"></div>
                        <span>Generating Insights...</span>
                    `;
                }

                // Get insights from AI agent
                const response = await fetch('/api/ai_agent/insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agent_id: aiAgent.agent_id,
                        portfolio_id: selectedPortfolio.id
                    })
                });

                const insights = await response.json();

                if (insights.success) {
                    displayInsights(insights.data);
                    
                    // Update status with null checks
                    if (agentStatus) {
                        agentStatus.innerHTML = `
                            <div class="status-indicator" style="background: #10b981;"></div>
                            <span>Insights Generated</span>
                        `;
                    }
                } else {
                    throw new Error(insights.error || 'Failed to generate insights');
                }

            } catch (error) {
                console.error('Error generating insights:', error);
                
                // Show demo insights if API fails but agent and portfolio are set
                if (error.message.includes('API') || error.message.includes('network')) {
                    showDemoInsights();
                } else {
                    showInsightCard('Error', 'Failed to generate insights: ' + error.message, '0%');
                }
                
                const agentStatus = document.getElementById('agentStatus');
                if (agentStatus) {
                    agentStatus.innerHTML = `
                        <div class="status-indicator" style="background: #f59e0b;"></div>
                        <span>Demo Mode</span>
                    `;
                }
            } finally {
                showLoading(false);
            }
        }

        function showDemoInsights() {
            const content = document.getElementById('dynamicInsights');
            if (!content) {
                console.error('Dynamic insights container not found');
                return;
            }
            content.innerHTML = '';

            // Demo Executive Summary
            showInsightCard(
                'Executive Summary', 
                `Based on analysis of your ${selectedPortfolio.name}, our AI agent using ${selectedModels.length} ML models has identified key opportunities. Portfolio shows moderate volatility with balanced risk-reward profile. Current allocation suggests defensive positioning with growth potential.`, 
                '85%'
            );

            // Demo Key Metrics
            showInsightCard(
                'Risk Analysis', 
                'Portfolio exhibits 12.3% annualized volatility with Sharpe ratio of 1.42. Risk-adjusted returns are above market average. Diversification score: 78/100. Recommended position sizing adjustments for 3 holdings.', 
                '78%'
            );

            // Demo Recommendations
            showInsightCard(
                'AI Recommendations', 
                'Consider increasing technology sector allocation by 5-8%. Current momentum indicators suggest entry opportunity in growth positions. Reduce exposure to defensive utilities. Monitor for breakout patterns in next 2-3 weeks.', 
                '92%'
            );
        }

        function displayInsights(insights) {
            const content = document.getElementById('dynamicInsights');
            if (!content) {
                console.error('Dynamic insights container not found');
                return;
            }
            content.innerHTML = '';

            // Executive Summary
            if (insights.ai_insights && insights.ai_insights.executive_summary) {
                showInsightCard('Executive Summary', insights.ai_insights.executive_summary, 
                               Math.round(insights.ai_insights.agent_confidence * 100) + '%');
            }

            // Key Insights
            if (insights.ai_insights && insights.ai_insights.key_insights) {
                const insightsList = insights.ai_insights.key_insights.map(insight => 
                    `<li style="margin-bottom: 8px;">${insight}</li>`
                ).join('');
                
                showInsightCard('Key Insights', `<ul style="margin-left: 20px;">${insightsList}</ul>`, 
                               Math.round(insights.ai_insights.agent_confidence * 100) + '%');
            }

            // Recommendations
            if (insights.ai_insights && insights.ai_insights.recommendations) {
                const recommendationsHtml = insights.ai_insights.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <div class="recommendation-action">${rec.action}</div>
                        <div class="recommendation-reasoning">${rec.reasoning}</div>
                        <span class="priority-badge priority-${rec.priority.toLowerCase()}">${rec.priority}</span>
                        <span class="confidence-score" style="margin-left: 8px;">${rec.confidence}%</span>
                    </div>
                `).join('');

                showInsightCard('Actionable Recommendations', recommendationsHtml, 
                               Math.round(insights.ai_insights.agent_confidence * 100) + '%');
            }

            // Risk Assessment
            if (insights.technical_analysis && insights.technical_analysis.risk_assessment) {
                const risk = insights.technical_analysis.risk_assessment;
                showInsightCard('Risk Assessment', 
                               `Risk Level: <strong>${risk.risk_level}</strong><br>Risk Score: ${Math.round(risk.risk_score * 100)}%`, 
                               '85%');
            }

            // Market Outlook
            if (insights.ai_insights && insights.ai_insights.market_outlook) {
                const outlook = insights.ai_insights.market_outlook;
                showInsightCard('Market Outlook', 
                               `<strong>Short-term:</strong> ${outlook.short_term}<br><strong>Medium-term:</strong> ${outlook.medium_term}`, 
                               '80%');
            }
        }

        function showInsightCard(title, content, confidence) {
            const container = document.getElementById('dynamicInsights');
            
            if (!container) {
                console.error('Dynamic insights container not found');
                return;
            }
            if (!container) {
                console.warn('Insights content container not found');
                return;
            }
            
            const card = document.createElement('div');
            card.className = 'insight-card';
            card.innerHTML = `
                <div class="insight-header">
                    <div class="insight-title">${title}</div>
                    <div class="confidence-score">${confidence} confidence</div>
                </div>
                <div class="insight-content">${content}</div>
            `;
            
            container.appendChild(card);
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            
            // Add null checks to prevent errors
            if (spinner) {
                if (show) {
                    spinner.classList.add('show');
                    console.log('Loading spinner shown');
                } else {
                    spinner.classList.remove('show');
                    console.log('Loading spinner hidden');
                }
            } else {
                console.warn('Loading spinner element not found');
            }
        }

        function refreshPortfolios() {
            window.location.reload();
        }

        // Test function for debugging AI agent creation
        async function testAIAgentCreation() {
            console.log('=== AI Agent Creation Test ===');
            console.log('Selected models:', selectedModels);
            console.log('Selected portfolio:', selectedPortfolio);
            console.log('AI Agent:', aiAgent);
            
            // Force select some models for testing
            selectedModels = [
                { id: 'advanced_volatility_v1', name: 'Advanced Volatility Model', category: 'volatility' },
                { id: 'advanced_sharpe_v1', name: 'Advanced Sharpe Ratio Model', category: 'performance' }
            ];
            
            console.log('Test models set:', selectedModels);
            
            try {
                const response = await fetch('/api/ai_agent/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selected_models: selectedModels.map(m => m.id),
                        agent_config: {
                            role: 'Test Portfolio Analyst',
                            confidence_threshold: 0.70
                        }
                    })
                });
                
                console.log('Test response status:', response.status);
                console.log('Test response headers:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('Test response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Test result:', result);
                    
                    if (result.success) {
                        alert('✅ AI Agent created successfully!\nAgent ID: ' + result.agent.agent_id);
                        aiAgent = result.agent;
                        updateWorkflowDisplay();
                    } else {
                        alert('❌ AI Agent creation failed:\n' + result.error);
                    }
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    alert('❌ Server response error:\n' + responseText);
                }
                
            } catch (error) {
                console.error('Test fetch error:', error);
                alert('❌ Network error:\n' + error.message);
            }
        }

        // Auto-refresh insights every 5 minutes
        setInterval(() => {
            if (aiAgent && selectedPortfolio) {
                generateInsights();
            }
        }, 300000);

        // Pre-built Agents Functionality
        async function loadPrebuiltAgents() {
            try {
                const response = await fetch('/api/vs_terminal_MLClass/prebuilt_agents');
                const data = await response.json();
                
                if (data.success) {
                    renderPrebuiltAgents(data.agents);
                } else {
                    console.error('Failed to load prebuilt agents:', data.error);
                }
            } catch (error) {
                console.error('Error loading prebuilt agents:', error);
            }
        }

        function renderPrebuiltAgents(agents) {
            const grid = document.getElementById('prebuiltAgentsGrid');
            if (!grid) return;
            
            grid.innerHTML = agents.map(agent => `
                <div class="prebuilt-agent-card" onclick="runPrebuiltAgent('${agent.id}')">
                    <div class="agent-card-header">
                        <div class="agent-icon">
                            <i class="${agent.icon}"></i>
                        </div>
                        <div>
                            <h3 class="agent-title">${agent.name}</h3>
                        </div>
                        <span class="agent-category">${agent.category}</span>
                    </div>
                    
                    <p class="agent-description">${agent.description}</p>
                    
                    <div class="agent-features">
                        ${agent.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                    </div>
                    
                    <div class="agent-footer">
                        <div class="agent-speed">
                            <i class="fas fa-bolt"></i>
                            ${agent.speed}
                        </div>
                        <div class="agent-complexity">${agent.complexity}</div>
                    </div>
                </div>
            `).join('');
        }

        async function runPrebuiltAgent(agentId) {
            console.log('runPrebuiltAgent called with agentId:', agentId);
            console.log('selectedPortfolio:', selectedPortfolio);
            
            if (!selectedPortfolio) {
                alert('Please select a portfolio first from the right panel.');
                return;
            }
            
            try {
                // Show loading
                showLoading(true);
                
                // Update status
                const agentStatus = document.getElementById('agentStatus');
                if (agentStatus) {
                    agentStatus.innerHTML = `
                        <div class="status-indicator" style="background: #f59e0b;"></div>
                        <span>Generating AI Insights...</span>
                    `;
                }
                
                const requestBody = {
                    agent_id: agentId,
                    portfolio_id: selectedPortfolio.id
                };
                
                console.log('Sending request with body:', requestBody);
                
                // Call the prebuilt insights API
                const response = await fetch('/api/vs_terminal_MLClass/prebuilt_insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    displayPrebuiltInsights(result.insights, agentId);
                    
                    // Update status
                    if (agentStatus) {
                        agentStatus.innerHTML = `
                            <div class="status-indicator" style="background: #10b981;"></div>
                            <span>AI Analysis Complete</span>
                        `;
                    }
                } else {
                    throw new Error(result.error || 'Failed to generate insights');
                }
                
            } catch (error) {
                console.error('Error running prebuilt agent:', error);
                alert('Failed to generate insights: ' + error.message);
                
                const agentStatus = document.getElementById('agentStatus');
                if (agentStatus) {
                    agentStatus.innerHTML = `
                        <div class="status-indicator" style="background: #ef4444;"></div>
                        <span>Analysis Failed</span>
                    `;
                }
            } finally {
                showLoading(false);
            }
        }

        function displayPrebuiltInsights(insights, agentId) {
            const content = document.getElementById('insightsContent');
            if (!content) return;
            
            // Hide pre-built agents section and show insights
            const prebuiltSection = document.getElementById('prebuiltAgentsSection');
            if (prebuiltSection) {
                prebuiltSection.style.display = 'none';
            }
            
            let html = `
                <div class="insights-display">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4><i class="fas fa-brain"></i> ${insights.analysis_type}</h4>
                        <button onclick="showPrebuiltAgents()" style="background: #475569; color: #e2e8f0; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-arrow-left"></i> Back to Agents
                        </button>
                    </div>
            `;
            
            // Display different content based on agent type
            if (agentId === 'portfolio_analyzer') {
                html += renderPortfolioAnalysisInsights(insights);
            } else if (agentId === 'risk_advisor') {
                html += renderRiskAdvisorInsights(insights);
            } else if (agentId === 'trading_signals') {
                html += renderTradingSignalsInsights(insights);
            } else if (agentId === 'market_intelligence') {
                html += renderMarketIntelligenceInsights(insights);
            } else if (agentId === 'rebalancing_optimizer') {
                html += renderRebalancingInsights(insights);
            } else if (agentId === 'quick_insights') {
                html += renderQuickInsights(insights);
            } else {
                html += `<p>Insights generated successfully for ${agentId}</p>`;
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function renderPortfolioAnalysisInsights(insights) {
            return `
                <div class="metrics-grid">
                    ${Object.entries(insights.metrics || {}).map(([key, value]) => `
                        <div class="metric-card">
                            <div class="metric-label">${key.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="metric-value">${value}</div>
                        </div>
                    `).join('')}
                </div>
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Sector Allocation</h5>
                <div class="metrics-grid">
                    ${Object.entries(insights.sector_allocation || {}).map(([sector, percentage]) => `
                        <div class="metric-card">
                            <div class="metric-label">${sector}</div>
                            <div class="metric-value">${percentage}</div>
                        </div>
                    `).join('')}
                </div>
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Top Performers</h5>
                ${(insights.top_performers || []).map(performer => `
                    <div style="background: #0f172a; border: 1px solid #475569; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <strong>${performer.symbol}</strong>: ${performer.return}
                    </div>
                `).join('')}
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Recommendations</h5>
                ${(insights.recommendations || []).map(rec => `
                    <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-lightbulb"></i> ${rec}
                    </div>
                `).join('')}
            `;
        }

        function renderRiskAdvisorInsights(insights) {
            return `
                <div class="metrics-grid">
                    ${Object.entries(insights.risk_metrics || {}).map(([key, value]) => `
                        <div class="metric-card">
                            <div class="metric-label">${key.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="metric-value">${value}</div>
                        </div>
                    `).join('')}
                </div>
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Risk Factors</h5>
                ${(insights.risk_factors || []).map(factor => `
                    <div style="background: #7c2d12; border: 1px solid #ea580c; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-exclamation-triangle"></i> ${factor}
                    </div>
                `).join('')}
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Risk Management Recommendations</h5>
                ${(insights.recommendations || []).map(rec => `
                    <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-shield-alt"></i> ${rec}
                    </div>
                `).join('')}
            `;
        }

        function renderTradingSignalsInsights(insights) {
            return `
                <h5 style="color: #60a5fa; margin: 0 0 16px 0;">Trading Signals</h5>
                ${(insights.signals || []).map(signal => `
                    <div style="background: #0f172a; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #f1f5f9;">${signal.symbol}</strong>
                            <span style="background: ${signal.signal === 'BUY' ? '#10b981' : signal.signal === 'SELL' ? '#ef4444' : '#f59e0b'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${signal.signal}
                            </span>
                        </div>
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">${signal.reasoning}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div>Current: ${signal.current_price}</div>
                            <div>Target: ${signal.target_price}</div>
                            <div>Confidence: ${signal.confidence}</div>
                        </div>
                    </div>
                `).join('')}
                
                <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-top: 16px;">
                    <strong>Market Sentiment: ${insights.market_sentiment || 'Neutral'}</strong>
                </div>
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Trading Recommendations</h5>
                ${(insights.recommendations || []).map(rec => `
                    <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-chart-line"></i> ${rec}
                    </div>
                `).join('')}
            `;
        }

        function renderMarketIntelligenceInsights(insights) {
            return `
                <div class="metrics-grid">
                    ${Object.entries(insights.market_overview || {}).map(([key, value]) => `
                        <div class="metric-card">
                            <div class="metric-label">${key.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="metric-value">${value}</div>
                        </div>
                    `).join('')}
                </div>
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Sector Performance</h5>
                <div class="metrics-grid">
                    ${Object.entries(insights.sector_insights || {}).map(([sector, performance]) => `
                        <div class="metric-card">
                            <div class="metric-label">${sector}</div>
                            <div class="metric-value" style="color: ${performance.includes('-') ? '#ef4444' : '#10b981'}">${performance}</div>
                        </div>
                    `).join('')}
                </div>
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Key Market Events</h5>
                ${(insights.key_events || []).map(event => `
                    <div style="background: #0f172a; border: 1px solid #475569; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-newspaper"></i> ${event}
                    </div>
                `).join('')}
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Market Intelligence Recommendations</h5>
                ${(insights.recommendations || []).map(rec => `
                    <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-brain"></i> ${rec}
                    </div>
                `).join('')}
            `;
        }

        function renderRebalancingInsights(insights) {
            return `
                <div style="background: ${insights.rebalancing_needed ? '#7c2d12' : '#065f46'}; border: 1px solid ${insights.rebalancing_needed ? '#ea580c' : '#10b981'}; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <h5 style="margin: 0; color: white;">
                        ${insights.rebalancing_needed ? 'Rebalancing Required' : 'Portfolio Well Balanced'}
                    </h5>
                    <p style="margin: 8px 0 0 0; color: #e2e8f0;">
                        Portfolio Optimization Score: ${insights.optimization_score || 0}%
                    </p>
                </div>
                
                ${insights.rebalancing_needed ? `
                    <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Rebalancing Actions</h5>
                    ${(insights.actions || []).map(action => `
                        <div style="background: #0f172a; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #f1f5f9;">${action.symbol}</strong>
                                <span style="background: ${action.action === 'REDUCE' ? '#ef4444' : '#10b981'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    ${action.action}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 12px; color: #94a3b8;">
                                <div>Current: ${action.current_weight}</div>
                                <div>Target: ${action.target_weight}</div>
                                <div>Deviation: ${action.deviation}</div>
                            </div>
                        </div>
                    `).join('')}
                ` : ''}
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Optimization Recommendations</h5>
                ${(insights.recommendations || []).map(rec => `
                    <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-balance-scale"></i> ${rec}
                    </div>
                `).join('')}
            `;
        }

        function renderQuickInsights(insights) {
            return `
                <div class="metrics-grid">
                    ${Object.entries(insights.key_metrics || {}).map(([key, value]) => `
                        <div class="metric-card">
                            <div class="metric-label">${key.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="metric-value">${value}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${(insights.alerts && insights.alerts.length > 0) ? `
                    <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Portfolio Alerts</h5>
                    ${insights.alerts.map(alert => `
                        <div style="background: #7c2d12; border: 1px solid #ea580c; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                            <i class="fas fa-exclamation-triangle"></i> ${alert}
                        </div>
                    `).join('')}
                ` : ''}
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Top Holdings</h5>
                ${(insights.top_holdings || []).map(holding => `
                    <div style="background: #0f172a; border: 1px solid #475569; border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <strong>${holding.symbol}</strong>
                        <div style="text-align: right;">
                            <div>${holding.value}</div>
                            <div style="font-size: 12px; color: #94a3b8;">${holding.weight}</div>
                        </div>
                    </div>
                `).join('')}
                
                <h5 style="color: #60a5fa; margin: 16px 0 8px 0;">Quick Recommendations</h5>
                ${(insights.quick_recommendations || []).map(rec => `
                    <div style="background: #1e40af; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                        <i class="fas fa-lightning-bolt"></i> ${rec}
                    </div>
                `).join('')}
            `;
        }

        function showPrebuiltAgents() {
            const prebuiltSection = document.getElementById('prebuiltAgentsSection');
            if (prebuiltSection) {
                prebuiltSection.style.display = 'block';
            }
            
            const content = document.getElementById('insightsContent');
            if (content) {
                content.innerHTML = `
                    <div class="prebuilt-agents-section" id="prebuiltAgentsSection">
                        <div class="section-header">
                            <h3 style="color: #60a5fa; margin: 0; font-size: 18px;">
                                <i class="fas fa-rocket"></i> Ready-to-Use AI Agents
                            </h3>
                            <p style="color: #94a3b8; margin: 4px 0 16px 0; font-size: 13px;">
                                Click any agent below for instant portfolio insights - No setup required!
                            </p>
                        </div>
                        
                        <div class="prebuilt-agents-grid" id="prebuiltAgentsGrid">
                            <!-- Pre-built agents will be loaded here -->
                        </div>
                    </div>
                `;
            }
            
            // Reload agents
            loadPrebuiltAgents();
        }

        // ========== NEW ADMIN SETTINGS & QUICK AGENTS FUNCTIONS ==========
        
        // Admin Settings Management
        function initializeAdminSettings() {
            // Toggle settings visibility
            $(document).on('click', '.settings-header', function() {
                const content = $(this).next('.settings-content');
                const icon = $(this).find('i:last-child');
                
                content.slideToggle(300);
                icon.toggleClass('fa-chevron-down fa-chevron-up');
            });
            
            // Toggle API key visibility
            $(document).on('click', '#toggleApiKey', function() {
                const input = $('#anthropicApiKey');
                const icon = $(this).find('i');
                
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
            
            // Test API connection
            $(document).on('click', '#testApiBtn', function() {
                const btn = $(this);
                const apiKey = $('#anthropicApiKey').val();
                const model = $('#claudeModel').val();
                
                if (!apiKey) {
                    showNotification('Please enter an API key', 'error');
                    return;
                }
                
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Testing...');
                
                // Simulate API test (replace with actual API test)
                setTimeout(() => {
                    btn.prop('disabled', false).html('<i class="fas fa-check"></i> Test API Connection');
                    showNotification('API connection successful!', 'success');
                    $('#apiStatus').html('<i class="fas fa-circle" style="color: #10b981;"></i> Connected');
                }, 2000);
            });
            
            // Load saved API settings
            loadApiSettings();
        }
        
        function loadApiSettings() {
            // Load from localStorage
            const savedApiKey = localStorage.getItem('anthropic_api_key');
            const savedModel = localStorage.getItem('claude_model');
            
            if (savedApiKey) {
                $('#anthropicApiKey').val(savedApiKey);
                $('#apiStatus').html('<i class="fas fa-circle" style="color: #10b981;"></i> Connected');
            }
            
            if (savedModel) {
                $('#claudeModel').val(savedModel);
            }
        }
        
        function saveApiSettings() {
            const apiKey = $('#anthropicApiKey').val();
            const model = $('#claudeModel').val();
            
            if (apiKey) {
                localStorage.setItem('anthropic_api_key', apiKey);
                localStorage.setItem('claude_model', model);
            }
        }

        // Quick Agents Management
        function initializeQuickAgents() {
            // Enhanced analysis button
            $(document).on('click', '#enhancedAnalysisBtn', function() {
                generateEnhancedAnalysis();
            });
        }
        
        function generateQuickInsights(agentType) {
            // Safety check for undefined agentType
            if (!agentType) {
                console.error('generateQuickInsights called with undefined agentType');
                showNotification('Error: Agent type not specified', 'error');
                return;
            }
            
            const selectedPortfolioEl = document.querySelector('.portfolio-item.active');
            
            if (!selectedPortfolioEl) {
                showNotification('Please select a portfolio first', 'error');
                return;
            }
            
            const selectedPortfolioId = selectedPortfolioEl.dataset.portfolioId;
            
            // Show loading state
            showLoadingAnalysis(`Generating ${agentType.replace('_', ' ')} insights...`);
            
            // Get portfolio data
            const portfolioData = getSelectedPortfolioData();
            
            fetch('/api/vs_terminal_MLClass/prebuilt_insights', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    portfolio_id: selectedPortfolioId,
                    agent_type: agentType,
                    portfolio_data: portfolioData
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingAnalysis();
                if (data.success) {
                    displayAgentInsights(data.insights, agentType);
                } else {
                    showNotification(data.error || 'Failed to generate insights', 'error');
                }
            })
            .catch(error => {
                hideLoadingAnalysis();
                console.error('Error generating insights:', error);
                showNotification('Error generating insights: ' + error.message, 'error');
            });
        }
        
        function displayAgentInsights(insights, agentType) {
            const agentNames = {
                'portfolio_analyzer': 'Portfolio Analyzer',
                'risk_advisor': 'Risk Advisor',
                'trading_signals': 'Trading Signals',
                'market_intelligence': 'Market Intelligence',
                'rebalancing_optimizer': 'Rebalancing Optimizer',
                'quick_insights': 'Quick Insights'
            };
            
            const agentName = agentNames[agentType] || agentType;
            
            // Handle case where insights is an object instead of HTML string
            let insightsContent;
            if (typeof insights === 'object') {
                console.warn('Insights received as object instead of HTML string:', insights);
                // Convert object to readable format
                insightsContent = `
                    <div class="fallback-insights">
                        <h4>Analysis Results</h4>
                        <pre style="background: #1e293b; padding: 12px; border-radius: 6px; color: #e2e8f0; white-space: pre-wrap; font-family: monospace; font-size: 12px;">
                            ${JSON.stringify(insights, null, 2)}
                        </pre>
                    </div>
                `;
            } else {
                insightsContent = insights;
            }
            
            const resultsHtml = `
                <div class="insights-header">
                    <h4><i class="fas fa-robot"></i> ${agentName} Results</h4>
                    <div class="analysis-timestamp">
                        Generated at ${new Date().toLocaleString()}
                    </div>
                </div>
                <div class="insights-content">
                    ${insightsContent}
                </div>
            `;
            
            const resultsDiv = document.getElementById('analysisResults') || document.getElementById('insightsContent');
            if (resultsDiv) {
                resultsDiv.innerHTML = resultsHtml;
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Enhanced Analysis with Claude
        function generateEnhancedAnalysis() {
            // Check if user is admin
            if (!isAdmin) {
                showNotification('Enhanced Claude analysis is only available for administrators', 'error');
                return;
            }
            
            const selectedPortfolioEl = document.querySelector('.portfolio-item.active');
            const apiKey = $('#anthropicApiKey').val();
            const model = $('#claudeModel').val();
            
            if (!selectedPortfolioEl) {
                showNotification('Please select a portfolio first', 'error');
                return;
            }
            
            if (!apiKey) {
                showNotification('Please configure Anthropic API key in admin settings', 'error');
                return;
            }
            
            const btn = $('#enhancedAnalysisBtn');
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing with Claude...');
            
            // Save API settings
            saveApiSettings();
            
            // Get comprehensive portfolio data
            const portfolioData = getSelectedPortfolioData();
            
            fetch('/api/vs_terminal_MLClass/enhanced_claude_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    portfolio_id: selectedPortfolioEl.dataset.portfolioId,
                    portfolio_data: portfolioData,
                    api_key: apiKey,
                    model: model
                })
            })
            .then(response => response.json())
            .then(data => {
                btn.prop('disabled', false).html('<i class="fas fa-brain"></i> Enhanced Analysis with Claude <span class="claude-badge">3.5</span>');
                
                if (data.success) {
                    displayEnhancedAnalysis(data.analysis);
                } else {
                    showNotification(data.error || 'Failed to generate enhanced analysis', 'error');
                }
            })
            .catch(error => {
                btn.prop('disabled', false).html('<i class="fas fa-brain"></i> Enhanced Analysis with Claude <span class="claude-badge">3.5</span>');
                console.error('Error generating enhanced analysis:', error);
                showNotification('Error generating enhanced analysis: ' + error.message, 'error');
            });
        }
        
        function displayEnhancedAnalysis(analysis) {
            const resultsHtml = `
                <div class="insights-header">
                    <h4><i class="fas fa-brain"></i> Enhanced Claude Analysis</h4>
                    <div class="analysis-timestamp">
                        Generated with Claude ${$('#claudeModel').val()} at ${new Date().toLocaleString()}
                    </div>
                </div>
                <div class="insights-content enhanced-analysis">
                    ${analysis}
                </div>
            `;
            
            const resultsDiv = document.getElementById('analysisResults') || document.getElementById('insightsContent');
            if (resultsDiv) {
                resultsDiv.innerHTML = resultsHtml;
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function getSelectedPortfolioData() {
            const selectedPortfolioEl = document.querySelector('.portfolio-item.active');
            if (!selectedPortfolioEl) return {};
            
            return {
                portfolio_id: selectedPortfolioEl.dataset.portfolioId,
                name: selectedPortfolioEl.querySelector('.portfolio-name')?.textContent,
                value: selectedPortfolioEl.querySelector('.portfolio-value')?.textContent,
                holdings: selectedPortfolioEl.querySelector('.portfolio-holdings')?.textContent,
                selected_at: new Date().toISOString()
            };
        }
        
        function showLoadingAnalysis(message) {
            const resultsDiv = document.getElementById('analysisResults') || document.getElementById('insightsContent');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="loading-analysis" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i>
                        <div>${message}</div>
                    </div>
                `;
                resultsDiv.style.display = 'block';
            }
        }
        
        function hideLoadingAnalysis() {
            // Loading will be replaced by results
        }
        
        function showNotification(message, type) {
            // Create notification element
            const notification = $(`
                <div class="notification ${type}" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : '#ef4444'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    min-width: 300px;
                ">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
                    ${message}
                </div>
            `);
            
            $('body').append(notification);
            
            setTimeout(() => {
                notification.fadeOut(() => notification.remove());
            }, 4000);
        }

        // ========== MISSING FUNCTIONS FOR QUICK AGENTS ==========
        
        // Function called by onclick in quick agent cards
        function runQuickAgent(agentType) {
            console.log('Running quick agent:', agentType);
            
            // Show immediate feedback
            showNotification(`Starting ${agentType.replace('_', ' ')} analysis...`, 'success');
            
            // Call the existing function
            generateQuickInsights(agentType);
        }
        
        // Function called by enhanced analysis button
        function runEnhancedAnalysis() {
            console.log('Running enhanced analysis');
            generateEnhancedAnalysis();
        }
        
        // Admin settings functions
        function toggleAdminSettings() {
            const content = document.getElementById('settingsContent');
            const chevron = document.getElementById('settingsChevron');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }
        
        function toggleApiKeyVisibility() {
            const input = document.getElementById('anthropicApiKey');
            const icon = document.getElementById('eyeIcon');
            
            if (!input || !icon) return; // Exit if elements don't exist
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        function updateApiKey() {
            const apiKeyInput = document.getElementById('anthropicApiKey');
            const status = document.getElementById('apiStatus');
            
            if (!apiKeyInput || !status) return; // Exit if elements don't exist
            
            const apiKey = apiKeyInput.value;
            
            if (apiKey) {
                localStorage.setItem('anthropic_api_key', apiKey);
                status.innerHTML = '<i class="fas fa-circle" style="color: #10b981;"></i> <span>API Key Set</span>';
            } else {
                localStorage.removeItem('anthropic_api_key');
                status.innerHTML = '<i class="fas fa-circle" style="color: #ef4444;"></i> <span>API Key Not Set</span>';
            }
        }
        
        function updateClaudeModel() {
            const claudeModelSelect = document.getElementById('claudeModel');
            if (!claudeModelSelect) return; // Exit if element doesn't exist
            
            const model = claudeModelSelect.value;
            localStorage.setItem('claude_model', model);
        }
        
        function testAnthropicConnection() {
            const apiKeyInput = document.getElementById('anthropicApiKey');
            
            if (!apiKeyInput) {
                showNotification('Admin access required for API configuration', 'error');
                return;
            }
            
            const apiKey = apiKeyInput.value;
            
            if (!apiKey) {
                showNotification('Please enter an API key first', 'error');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            btn.disabled = true;
            
            // Simulate API test
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check"></i> Test Connection';
                btn.disabled = false;
                showNotification('API connection test completed', 'success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }, 2000);
        }
        
        // Load saved settings on page load
        function loadSavedSettings() {
            const savedApiKey = localStorage.getItem('anthropic_api_key');
            const savedModel = localStorage.getItem('claude_model');
            
            // Check if elements exist (only available for admin users)
            const apiKeyInput = document.getElementById('anthropicApiKey');
            const apiStatusElement = document.getElementById('apiStatus');
            const claudeModelSelect = document.getElementById('claudeModel');
            
            if (savedApiKey && apiKeyInput && apiStatusElement) {
                apiKeyInput.value = savedApiKey;
                apiStatusElement.innerHTML = '<i class="fas fa-circle" style="color: #10b981;"></i> <span>API Key Set</span>';
            }
            
            if (savedModel && claudeModelSelect) {
                claudeModelSelect.value = savedModel;
            }
        }
        
        // Call loadSavedSettings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedSettings();
        });
        
        // Test function to verify quick agent functionality
        function testQuickAgent() {
            console.log('Testing quick agent functionality');
            
            // Test with demo portfolio selection
            const portfolioItems = document.querySelectorAll('.portfolio-item');
            if (portfolioItems.length > 0) {
                // Auto-select first portfolio
                portfolioItems[0].click();
                
                setTimeout(() => {
                    // Test portfolio analyzer
                    runQuickAgent('portfolio_analyzer');
                }, 1000);
            } else {
                showNotification('No portfolios available for testing', 'error');
            }
        }
    </script>
</body>
</html>