{% extends "layout.html" %}
{% block title %}Improvement Analysis - {{ report.analyst }}{% endblock %}
{% block header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="mb-0">Improvement Analysis</h1>
        <p class="text-muted mb-0">{{ report.analyst }} - Report {{ report.id }}</p>
    </div>
    <div>
        <a href="/report/{{ report.id }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Back to Report
        </a>
    </div>
</div>
{% endblock %}
{% block content %}

{% if no_improvement_data %}
<div class="alert alert-info" role="alert">
    <h5><i class="bi bi-info-circle me-2"></i>No Previous Reports</h5>
    <p class="mb-0">This appears to be the first report by {{ report.analyst }}, so no improvement comparison is available.</p>
</div>
{% else %}

<!-- Improvement Summary -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Improvement Summary</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="display-4 mb-2">
                        {% if improvement_record.improvement_score >= 0.8 %}
                            <span class="text-success">{{ (improvement_record.improvement_score * 100)|round(0) }}%</span>
                        {% elif improvement_record.improvement_score >= 0.6 %}
                            <span class="text-info">{{ (improvement_record.improvement_score * 100)|round(0) }}%</span>
                        {% elif improvement_record.improvement_score >= 0.4 %}
                            <span class="text-warning">{{ (improvement_record.improvement_score * 100)|round(0) }}%</span>
                        {% else %}
                            <span class="text-danger">{{ (improvement_record.improvement_score * 100)|round(0) }}%</span>
                        {% endif %}
                    </div>
                    <h6 class="text-muted">Improvement Score</h6>
                </div>
            </div>
            <div class="col-md-9">
                <h6>Key Improvements:</h6>
                <ul class="list-unstyled">
                    {% for summary_item in improvement_analysis.summary %}
                    <li class="mb-2">{{ summary_item }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Resolved Issues -->
{% if resolved_alerts %}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0 text-success">
            <i class="bi bi-check-circle me-2"></i>Resolved Issues ({{ resolved_alerts|length }})
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Previous Issue</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in resolved_alerts %}
                    <tr>
                        <td><span class="badge bg-success">{{ alert.category }}</span></td>
                        <td>{{ alert.type }}</td>
                        <td>{{ alert.message }}</td>
                        <td><span class="badge bg-success">‚úÖ Resolved</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- New Issues -->
{% if new_issues %}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0 text-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>New Issues Identified ({{ new_issues|length }})
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Issue Description</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for issue in new_issues %}
                    <tr>
                        <td><span class="badge bg-warning">{{ issue.category }}</span></td>
                        <td>{{ issue.type }}</td>
                        <td>{{ issue.message }}</td>
                        <td><span class="badge bg-warning">üîç New Issue</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Quality Metrics Comparison -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Quality Metrics Comparison</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Overall Quality Score</h6>
                <div class="d-flex align-items-center mb-3">
                    <span class="me-3">Change:</span>
                    {% if improvement_analysis.quality_improvement > 0 %}
                        <span class="badge bg-success">
                            +{{ (improvement_analysis.quality_improvement * 100)|round(1) }}%
                        </span>
                    {% elif improvement_analysis.quality_improvement < 0 %}
                        <span class="badge bg-danger">
                            {{ (improvement_analysis.quality_improvement * 100)|round(1) }}%
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">No Change</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <h6>SEBI Compliance</h6>
                <div class="d-flex align-items-center mb-3">
                    <span class="me-3">Change:</span>
                    {% if improvement_analysis.sebi_improvement > 0 %}
                        <span class="badge bg-success">
                            +{{ (improvement_analysis.sebi_improvement * 100)|round(1) }}%
                        </span>
                    {% elif improvement_analysis.sebi_improvement < 0 %}
                        <span class="badge bg-danger">
                            {{ (improvement_analysis.sebi_improvement * 100)|round(1) }}%
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">No Change</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Previous Report Reference -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Comparison Reference</h5>
    </div>
    <div class="card-body">
        <p><strong>Previous Report:</strong> {{ improvement_record.previous_report_id }}</p>
        <p><strong>Comparison Date:</strong> {{ improvement_record.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        <div class="mt-3">
            <a href="/report/{{ improvement_record.previous_report_id }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-eye me-1"></i> View Previous Report
            </a>
        </div>
    </div>
</div>

{% endif %}

<!-- Improvement History Chart -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Improvement Trend</h5>
    </div>
    <div class="card-body">
        <canvas id="improvementChart" height="300"></canvas>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load improvement history for the analyst
    fetch(`/api/analyst/{{ report.analyst }}/improvement_history`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('improvementChart').getContext('2d');
            
            const labels = data.map(item => new Date(item.created_at).toLocaleDateString());
            const scores = data.map(item => (item.improvement_score * 100).toFixed(1));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.reverse(),
                    datasets: [{
                        label: 'Improvement Score (%)',
                        data: scores.reverse(),
                        borderColor: 'rgba(13, 110, 253, 1)',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Improvement Score: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading improvement history:', error);
            document.getElementById('improvementChart').innerHTML = '<p class="text-muted text-center">Unable to load improvement history</p>';
        });
});
</script>

{% endblock %}